# 用户接口实现分析

## 一、需求概述

需要在 app-server 中实现以下用户相关接口：
1. `/user/info` - 无需参数，根据请求header获取用户信息
2. `/user/query` - 根据用户名称精确查询用户
3. `/user/search_fuzzy` - 模糊查询用户
4. `/user/usernames` - 根据用户列表批量获取用户

## 二、架构设计

### 2.1 网关侧（api-gateway）

**现状：**
- 当前网关只是转发请求头，没有解析token
- 在 `core/api-gateway/server/router.go` 中，`createProxy` 函数会转发所有请求头（包括 X-Token）

**需要实现：**
- 在网关侧添加中间件，解析 JWT token
- 从 token 中提取 username
- 将 username 设置到请求 header 中（建议使用 `X-Request-User` 或 `X-Username`）
- 转发给 app-server

**实现位置：**
- 在 `core/api-gateway/server/server.go` 的 `initRouter` 方法中添加 token 解析中间件
- 中间件应该：
  1. 从 `X-Token` header 获取 token
  2. 使用 JWT 服务解析 token（可以复用 `pkg/middleware/jwt_auth.go` 的逻辑）
  3. 提取 username
  4. 设置到 `X-Request-User` header
  5. 继续转发请求

### 2.2 app-server 侧

**现状：**
- 已有 `UserRepository`，支持：
  - `GetUserByUsername(username string)` - 精确查询
  - `GetUserByID(id int64)` - 根据ID查询
  - 其他查询方法
- 已有 `UserInfo` DTO 结构（`dto/auth.go`）
- 已有 `JWTAuth` 中间件，但根据需求，app-server 无需重复解析token

**需要实现：**

#### 1. 创建用户服务（UserService）
- 位置：`core/app-server/service/user_service.go`
- 功能：
  - `GetUserByUsername(username string)` - 精确查询
  - `SearchUsersFuzzy(keyword string, limit int)` - 模糊查询
  - `GetUsersByUsernames(usernames []string)` - 批量查询
  - `GetCurrentUser(username string)` - 获取当前用户信息（从header获取username）

#### 2. 扩展 UserRepository
- 位置：`core/app-server/repository/user_repository.go`
- 需要添加：
  - `SearchUsersFuzzy(keyword string, limit int) ([]*model.User, error)` - 模糊查询
  - `GetUsersByUsernames(usernames []string) ([]*model.User, error)` - 批量查询

#### 3. 创建用户API处理器
- 位置：`core/app-server/api/v1/user.go`
- 实现4个接口：
  - `GetUserInfo(c *gin.Context)` - GET `/api/v1/user/info`
  - `QueryUser(c *gin.Context)` - GET `/api/v1/user/query?username=xxx`
  - `SearchUsersFuzzy(c *gin.Context)` - GET `/api/v1/user/search_fuzzy?keyword=xxx&limit=10`
  - `GetUsersByUsernames(c *gin.Context)` - POST `/api/v1/user/usernames` (body: `{"usernames": ["user1", "user2"]}`)

#### 4. 创建DTO结构
- 位置：`dto/user.go`（新建）
- 定义：
  - `QueryUserReq` - 查询用户请求
  - `QueryUserResp` - 查询用户响应
  - `SearchUsersFuzzyReq` - 模糊查询请求
  - `SearchUsersFuzzyResp` - 模糊查询响应
  - `GetUsersByUsernamesReq` - 批量查询请求
  - `GetUsersByUsernamesResp` - 批量查询响应

#### 5. 添加路由
- 位置：`core/app-server/server/router.go`
- 添加用户相关路由组：
  ```go
  user := apiV1.Group("/user")
  user.Use(middleware2.JWTAuth()) // 需要认证
  userHandler := v1.NewUser(s.userService)
  user.GET("/info", userHandler.GetUserInfo)
  user.GET("/query", userHandler.QueryUser)
  user.GET("/search_fuzzy", userHandler.SearchUsersFuzzy)
  user.POST("/usernames", userHandler.GetUsersByUsernames)
  ```

#### 6. 修改中间件逻辑
- 由于网关已经解析token，app-server 的 `JWTAuth` 中间件需要调整：
  - 优先从 `X-Request-User` header 获取 username
  - 如果没有，再尝试解析 token（向后兼容）
  - 或者创建新的中间件 `WithUsernameFromHeader`，专门从header获取username

## 三、实现细节

### 3.1 网关侧实现

**方案1：在网关添加JWT解析中间件**
```go
// 在 core/api-gateway/server/server.go 的 initRouter 中
s.httpServer.Use(s.parseTokenAndSetUsername())
```

**方案2：在 proxy.Director 中解析**
```go
// 在 core/api-gateway/server/router.go 的 createProxy 中
// 在 Director 函数中解析 token 并设置 header
```

### 3.2 app-server 侧实现

**从header获取username的方式：**
```go
// 在 API handler 中
username := c.GetHeader("X-Request-User")
if username == "" {
    username = c.GetHeader("X-Username") // 备用
}
```

**模糊查询实现：**
```go
// 在 UserRepository 中
func (r *UserRepository) SearchUsersFuzzy(keyword string, limit int) ([]*model.User, error) {
    var users []*model.User
    err := r.db.Where("username LIKE ? OR email LIKE ?", 
        "%"+keyword+"%", "%"+keyword+"%").
        Limit(limit).
        Find(&users).Error
    return users, err
}
```

**批量查询实现：**
```go
// 在 UserRepository 中
func (r *UserRepository) GetUsersByUsernames(usernames []string) ([]*model.User, error) {
    var users []*model.User
    err := r.db.Where("username IN ?", usernames).Find(&users).Error
    return users, err
}
```

## 四、接口设计

### 4.1 GET /api/v1/user/info
- **描述**：获取当前登录用户信息
- **参数**：无（从header获取username）
- **响应**：`UserInfo` 对象

### 4.2 GET /api/v1/user/query
- **描述**：根据用户名精确查询
- **参数**：`username` (query参数)
- **响应**：`UserInfo` 对象

### 4.3 GET /api/v1/user/search_fuzzy
- **描述**：模糊查询用户
- **参数**：
  - `keyword` (query参数，必填) - 搜索关键词
  - `limit` (query参数，可选，默认10) - 返回数量限制
- **响应**：`UserInfo` 数组

### 4.4 POST /api/v1/user/usernames
- **描述**：批量获取用户信息
- **请求体**：
  ```json
  {
    "usernames": ["user1", "user2", "user3"]
  }
  ```
- **响应**：`UserInfo` 数组

## 五、注意事项

1. **安全性**：
   - 所有接口都需要认证（JWT验证）
   - 模糊查询需要限制返回数量，防止大量数据查询
   - 批量查询需要限制usernames数组长度

2. **性能**：
   - 模糊查询需要添加索引（username, email）
   - 批量查询使用 IN 查询，性能较好

3. **兼容性**：
   - 保持向后兼容，如果header中没有username，可以尝试解析token
   - 或者明确要求必须通过网关访问

4. **错误处理**：
   - 用户不存在时返回404或空数组
   - 参数验证失败返回400
   - 认证失败返回401

## 六、实现顺序

1. 先实现网关侧的token解析和username设置
2. 扩展 UserRepository，添加模糊查询和批量查询方法
3. 创建 UserService
4. 创建 DTO 结构
5. 创建 User API handler
6. 添加路由
7. 测试验证


# App Storage - å­˜å‚¨æœåŠ¡

åŸºäº MinIO çš„å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼Œæä¾›æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½ã€åˆ é™¤ç­‰åŠŸèƒ½ã€‚æ”¯æŒå¤šç§Ÿæˆ·éš”ç¦»ã€ç²¾ç¡®ç»Ÿè®¡å’Œæœªæ¥çš„ç§’ä¼ åŠŸèƒ½ã€‚

## æ¶æ„è¯´æ˜

éµå¾ªæ ‡å‡†ä¸‰å±‚æ¶æ„ï¼š

```
app-storage/
â”œâ”€â”€ api/v1/          # HTTP Handler å±‚ï¼ˆå¤„ç†è¯·æ±‚å“åº”ï¼‰
â”‚   â””â”€â”€ storage.go   # å­˜å‚¨ç›¸å…³ API
â”œâ”€â”€ service/         # ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆçº¯ Go ä»£ç ï¼‰
â”‚   â””â”€â”€ storage_service.go
â”œâ”€â”€ model/           # æ•°æ®æ¨¡å‹å±‚
â”‚   â”œâ”€â”€ file.go      # æ–‡ä»¶å…ƒæ•°æ®æ¨¡å‹ï¼ˆé¢„ç•™ï¼Œç”¨äºç§’ä¼ ï¼‰
â”‚   â””â”€â”€ init.go      # æ•°æ®åº“åˆå§‹åŒ–
â”œâ”€â”€ server/          # æœåŠ¡å™¨å±‚
â”‚   â”œâ”€â”€ server.go    # æœåŠ¡å™¨åˆå§‹åŒ–
â”‚   â””â”€â”€ router.go    # è·¯ç”±æ³¨å†Œ
â”œâ”€â”€ cmd/app/         # ç¨‹åºå…¥å£
â”‚   â””â”€â”€ main.go
â””â”€â”€ docs/            # æ–‡æ¡£
    â”œâ”€â”€ MULTI_TENANT_DESIGN.md       # å¤šç§Ÿæˆ·è®¾è®¡
    â”œâ”€â”€ DEDUPLICATION_DESIGN.md      # ç§’ä¼ è®¾è®¡
    â””â”€â”€ API_EXAMPLES.md              # API ç¤ºä¾‹
```

## ç‰¹æ€§

### âœ… å·²å®ç°

- âœ… **é¢„ç­¾åä¸Šä¼ **ï¼šå®¢æˆ·ç«¯ç›´æ¥ä¸Šä¼ åˆ° MinIOï¼Œå‡è½»åç«¯å‹åŠ›
- âœ… **é¢„ç­¾åä¸‹è½½**ï¼šå®‰å…¨çš„ä¸´æ—¶è®¿é—®é“¾æ¥
- âœ… **HTTP ç¼“å­˜**ï¼šæµè§ˆå™¨ç¼“å­˜ 1 å¹´ï¼Œç§’ä¸‹è½½ï¼ˆå·²å¯ç”¨ï¼‰
- âœ… **å¤šç§Ÿæˆ·éš”ç¦»**ï¼šæŒ‰ `{router}/{date}/{uuid}.{ext}` æ ¼å¼å­˜å‚¨
- âœ… **ç²¾ç¡®ç»Ÿè®¡**ï¼šæ”¯æŒæŒ‰ç§Ÿæˆ·/åº”ç”¨/å‡½æ•°ç»Ÿè®¡å­˜å‚¨å ç”¨
- âœ… **æ‰¹é‡ç®¡ç†**ï¼šæ”¯æŒåˆ—ä¸¾å’Œæ‰¹é‡åˆ é™¤
- âœ… **æ–‡ä»¶å¤§å°é™åˆ¶**ï¼šé»˜è®¤ 100MB
- âœ… **AGPLv3 éš”ç¦»**ï¼šé€šè¿‡ S3 API è°ƒç”¨ï¼Œæ— ä»£ç æ„ŸæŸ“

### ğŸ”® é¢„ç•™åŠŸèƒ½ï¼ˆæœªæ¥å¯ç”¨ï¼‰

- ğŸ”® **ç§’ä¼ **ï¼šç›¸åŒæ–‡ä»¶åªä¸Šä¼ ä¸€æ¬¡ï¼ˆæ•°æ®åº“è¡¨å·²åˆ›å»ºï¼‰
- ğŸ”® **å»é‡**ï¼šç‰©ç†å­˜å‚¨åªä¿ç•™ä¸€ä»½ï¼ŒèŠ‚çœæˆæœ¬ï¼ˆæ¶æ„å·²é¢„ç•™ï¼‰
- ğŸ”® **SeaweedFS æ”¯æŒ**ï¼šApache 2.0 è®¸å¯çš„å­˜å‚¨åç«¯

## å¿«é€Ÿå¼€å§‹

### 1. éƒ¨ç½² MinIO

```bash
bash scripts/podman/minio.sh
```

è®¿é—®æ§åˆ¶å°ï¼šhttp://localhost:9001
- ç”¨æˆ·åï¼šminioadmin
- å¯†ç ï¼šminioadmin123

### 2. å¯åŠ¨æœåŠ¡

```bash
bash scripts/start-app-storage.sh
```

æœåŠ¡åœ°å€ï¼šhttp://localhost:8083

### 3. æŸ¥çœ‹ API æ–‡æ¡£

è®¿é—® Swagger æ–‡æ¡£ï¼šhttp://localhost:8083/swagger/index.html

## API æ¥å£

### 1. è·å–ä¸Šä¼ å‡­è¯

```bash
POST /api/v1/storage/upload_token
Content-Type: application/json

{
  "router": "luobei/test88888/tools/cashier_desk",
  "file_name": "test.jpg",
  "content_type": "image/jpeg",
  "file_size": 102400,
  "hash": "abc123..."  // å¯é€‰ï¼Œç”¨äºç§’ä¼ ï¼ˆæœªæ¥ï¼‰
}
```

å“åº”ï¼š

```json
{
  "code": 0,
  "data": {
    "url": "http://localhost:9000/ai-agent-os/luobei/test88888/tools/cashier_desk/2025/01/03/xxx.jpg?X-Amz-...",
    "key": "luobei/test88888/plugins/cashier_desk/2025/01/03/xxx.jpg",
    "method": "PUT",
    "expire": "2025-01-03 15:30:00",
    "headers": {
      "Content-Type": "image/jpeg"
    },
    "bucket": "ai-agent-os"
  }
}
```

**è¯´æ˜**ï¼šæ–‡ä»¶å°†æŒ‰ç…§ `{router}/{date}/{uuid}.{ext}` çš„æ ¼å¼å­˜å‚¨ï¼Œå®ç°å¤šç§Ÿæˆ·éš”ç¦»ã€‚

### 2. ä¸Šä¼ æ–‡ä»¶ï¼ˆå®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨ï¼‰

```bash
curl -X PUT "ä¸Šé¢è¿”å›çš„ url" \
  -H "Content-Type: image/jpeg" \
  --data-binary "@test.jpg"
```

### 3. è·å–ä¸‹è½½é“¾æ¥

```bash
GET /api/v1/storage/download/luobei/test88888/plugins/cashier_desk/2025/01/03/xxx.jpg
```

**è¯´æ˜**ï¼šä¸‹è½½é“¾æ¥è‡ªåŠ¨åŒ…å« HTTP ç¼“å­˜å¤´ï¼ˆ`Cache-Control: max-age=31536000`ï¼‰ï¼Œæµè§ˆå™¨ä¼šç¼“å­˜ 1 å¹´ï¼Œå®ç°ç§’ä¸‹è½½ã€‚

### 4. åˆ é™¤æ–‡ä»¶

```bash
DELETE /api/v1/storage/files/luobei/test88888/plugins/cashier_desk/2025/01/03/xxx.jpg
```

### 5. è·å–æ–‡ä»¶ä¿¡æ¯

```bash
GET /api/v1/storage/files/luobei/test88888/plugins/cashier_desk/2025/01/03/xxx.jpg/info
```

### 6. è·å–å­˜å‚¨ç»Ÿè®¡ï¼ˆæŒ‰å‡½æ•°ï¼‰

```bash
GET /api/v1/storage/stats?router=luobei/test88888/plugins/cashier_desk
```

å“åº”ï¼š

```json
{
  "code": 0,
  "data": {
    "router": "luobei/test88888/plugins/cashier_desk",
    "file_count": 15,
    "total_size": 2048576,
    "size_human": "2.0 MB"
  }
}
```

### 7. åˆ—ä¸¾å‡½æ•°ä¸‹çš„æ‰€æœ‰æ–‡ä»¶

```bash
GET /api/v1/storage/files?router=luobei/test88888/plugins/cashier_desk
```

### 8. æ‰¹é‡åˆ é™¤å‡½æ•°ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼ˆå±é™©æ“ä½œï¼‰

```bash
POST /api/v1/storage/batch_delete
Content-Type: application/json

{
  "router": "luobei/test88888/tools/cashier_desk"
}
```

## é…ç½®è¯´æ˜

é…ç½®æ–‡ä»¶ï¼š`configs/app-storage.yaml`

```yaml
server:
  port: 8083
  log_level: "info"
  debug: true

minio:
  endpoint: "localhost:9000"
  access_key: "minioadmin"
  secret_key: "minioadmin123"
  use_ssl: false
  region: "us-east-1"
  default_bucket: "ai-agent-os"
  
  upload:
    max_size: 104857600        # 100MB
    token_expire: 3600         # 1å°æ—¶
    allowed_types:
      - "image/*"
      - "video/*"
      - "application/pdf"
  
  # ç§’ä¼ åŠŸèƒ½ï¼ˆé¢„ç•™ï¼Œæœªæ¥å¯ç”¨ï¼‰
  deduplication:
    enabled: false             # æ˜¯å¦å¯ç”¨ç§’ä¼ 
    hash_algorithm: "sha256"   # ä½¿ç”¨çš„ hash ç®—æ³•
  
  # ç¼“å­˜æ§åˆ¶ï¼ˆå·²å¯ç”¨ï¼‰
  cache:
    enabled: true              # æ˜¯å¦å¯ç”¨ HTTP ç¼“å­˜
    max_age: 31536000          # æµè§ˆå™¨ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼Œ1å¹´ï¼‰

# æ•°æ®åº“é…ç½®ï¼ˆå¯é€‰ï¼Œç”¨äºç§’ä¼ åŠŸèƒ½ï¼‰
db:
  type: "mysql"
  host: "127.0.0.1"
  port: 3306
  user: "app"
  password: "app"
  name: "app_storage"
```

## æŠ€æœ¯æ ˆ

- **MinIO SDK**: `github.com/minio/minio-go/v7` (Apache 2.0)
- **Web æ¡†æ¶**: Gin
- **é…ç½®ç®¡ç†**: Viper
- **æ•°æ®åº“**: GORM + MySQLï¼ˆå¯é€‰ï¼Œç”¨äºç§’ä¼ ï¼‰
- **æ—¥å¿—**: ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ

## å¤šç§Ÿæˆ·æ¶æ„

### æ–‡ä»¶å­˜å‚¨è·¯å¾„

```
{tenant}/{app}/{function_path}/{date}/{uuid}.{ext}

ç¤ºä¾‹ï¼š
luobei/test88888/tools/cashier_desk/2025/11/03/550e8400-e29b-41d4-a716-446655440000.jpg
â”‚      â”‚         â”‚                  â”‚          â”‚
â”‚      â”‚         â”‚                  â”‚          â””â”€ UUIDï¼ˆé˜²æ­¢æ–‡ä»¶åå†²çªï¼‰
â”‚      â”‚         â”‚                  â””â”€ æ—¥æœŸåˆ†ç»„ï¼ˆå¹´/æœˆ/æ—¥ï¼‰
â”‚      â”‚         â””â”€ å‡½æ•°è·¯å¾„
â”‚      â””â”€ åº”ç”¨åç§°
â””â”€ ç§Ÿæˆ·åç§°
```

### ä¼˜åŠ¿

- âœ… **ç§Ÿæˆ·éš”ç¦»**ï¼šæ¯ä¸ªç§Ÿæˆ·çš„æ–‡ä»¶å®Œå…¨ç‹¬ç«‹
- âœ… **ç²¾ç¡®ç»Ÿè®¡**ï¼šå¯ä»¥ç»Ÿè®¡ä»»æ„ç²’åº¦çš„å­˜å‚¨å ç”¨
- âœ… **æ‰¹é‡ç®¡ç†**ï¼šæ”¯æŒæŒ‰å‡½æ•°æ‰¹é‡åˆ é™¤
- âœ… **å®¡è®¡è¿½è¸ª**ï¼šçŸ¥é“æ¯ä¸ªæ–‡ä»¶å±äºå“ªä¸ªå‡½æ•°
- âœ… **æˆæœ¬åˆ†æ‘Š**ï¼šå¯ä»¥æŒ‰ç§Ÿæˆ·/åº”ç”¨/å‡½æ•°è®¡è´¹

## æ€§èƒ½ä¼˜åŒ–

### 1. HTTP ç¼“å­˜ï¼ˆå·²å¯ç”¨ï¼‰

ä¸‹è½½é“¾æ¥è‡ªåŠ¨æ·»åŠ ç¼“å­˜æ§åˆ¶å¤´ï¼š

```http
Cache-Control: public, max-age=31536000, immutable
Expires: Mon, 03 Nov 2026 12:00:00 GMT
```

**æ•ˆæœ**ï¼š
- æµè§ˆå™¨ç¼“å­˜ 1 å¹´
- å†æ¬¡è®¿é—®åŒä¸€æ–‡ä»¶ï¼Œç›´æ¥ä»æœ¬åœ°åŠ è½½ï¼ˆ0msï¼‰
- å‡å°‘ 90%+ çš„é‡å¤ä¸‹è½½è¯·æ±‚

### 2. ç§’ä¼ ï¼ˆé¢„ç•™ï¼Œæœªæ¥å¯ç”¨ï¼‰

- æ•°æ®åº“è¡¨å·²åˆ›å»ºï¼š`file_metadata`, `file_references`
- DTO å­—æ®µå·²é¢„ç•™ï¼š`hash` å­—æ®µ
- é…ç½®å¼€å…³å·²é¢„ç•™ï¼š`deduplication.enabled`

**é¢„æœŸæ•ˆæœ**ï¼š
- ç›¸åŒæ–‡ä»¶åªä¸Šä¼ ä¸€æ¬¡
- èŠ‚çœ 30-80% çš„å­˜å‚¨æˆæœ¬
- ç”¨æˆ·ä½“éªŒï¼šç§’ä¼ ï¼ˆ0sï¼‰

è¯¦è§ï¼š[ç§’ä¼ æ¶æ„è®¾è®¡](docs/DEDUPLICATION_DESIGN.md)

## å®‰å…¨è¯´æ˜

### AGPLv3 éš”ç¦»

æœ¬æœåŠ¡é€šè¿‡ **ç½‘ç»œè¾¹ç•Œ** ä¸ MinIO äº¤äº’ï¼Œä½¿ç”¨ Apache 2.0 è®¸å¯çš„ `minio-go` SDKï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  app-storage    â”‚  <- Apache 2.0 / BSL 1.1
â”‚  (Your Code)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ HTTP (S3 API)
         â”‚ ç½‘ç»œè¾¹ç•Œ = AGPLv3 éš”ç¦»
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MinIO Server   â”‚  <- AGPLv3 (ç‹¬ç«‹è¿›ç¨‹)
â”‚  (Podman)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- âœ… ä¸ç›´æ¥ import MinIO å†…éƒ¨åŒ…
- âœ… ä¸ä¿®æ”¹ MinIO æºç 
- âœ… ä»…é€šè¿‡ S3 åè®®é€šä¿¡
- âœ… ä»£ç ä¸å— AGPLv3 æ„ŸæŸ“

## æ–‡æ¡£

- [å¤šç§Ÿæˆ·è®¾è®¡](docs/MULTI_TENANT_DESIGN.md) - è¯¦ç»†çš„å¤šç§Ÿæˆ·æ¶æ„è¯´æ˜
- [ç§’ä¼ è®¾è®¡](docs/DEDUPLICATION_DESIGN.md) - ç§’ä¼ å’Œå»é‡çš„å®ç°æ–¹æ¡ˆ
- [API ç¤ºä¾‹](docs/API_EXAMPLES.md) - å®Œæ•´çš„ API ä½¿ç”¨ç¤ºä¾‹å’Œå‰ç«¯é›†æˆ

## å¼€å‘è®¡åˆ’

### å·²å®Œæˆ âœ…

- [x] åŸºç¡€å­˜å‚¨æœåŠ¡ï¼ˆä¸Šä¼ /ä¸‹è½½/åˆ é™¤ï¼‰
- [x] å¤šç§Ÿæˆ·éš”ç¦»
- [x] ç²¾ç¡®ç»Ÿè®¡
- [x] æ‰¹é‡ç®¡ç†
- [x] HTTP ç¼“å­˜ï¼ˆç§’ä¸‹è½½ï¼‰
- [x] æ•°æ®åº“è¡¨é¢„ç•™ï¼ˆç§’ä¼ ï¼‰

### è®¡åˆ’ä¸­ ğŸ“‹

- [ ] ç§’ä¼ åŠŸèƒ½ï¼ˆæŒ‰éœ€å¯ç”¨ï¼‰
- [ ] SeaweedFS Provider
- [ ] CDN åŠ é€Ÿé…ç½®
- [ ] å›¾ç‰‡å¤„ç†ï¼ˆç¼©ç•¥å›¾ã€æ°´å°ï¼‰
- [ ] è§†é¢‘è½¬ç 
- [ ] æ–‡ä»¶é¢„è§ˆ

## FAQ

### Q1: HTTP ç¼“å­˜å¦‚ä½•å·¥ä½œï¼Ÿ

A: å½“ç”¨æˆ·é¦–æ¬¡ä¸‹è½½æ–‡ä»¶æ—¶ï¼ŒMinIO è¿”å›çš„æ–‡ä»¶ä¼šåŒ…å« `Cache-Control: max-age=31536000` å“åº”å¤´ï¼Œæµè§ˆå™¨ä¼šå°†æ–‡ä»¶ç¼“å­˜ 1 å¹´ã€‚å½“ç”¨æˆ·å†æ¬¡è®¿é—®åŒä¸€æ–‡ä»¶æ—¶ï¼Œæµè§ˆå™¨ç›´æ¥ä»æœ¬åœ°ç¼“å­˜è¯»å–ï¼Œæ— éœ€è¯·æ±‚æœåŠ¡å™¨ã€‚

### Q2: ç§’ä¼ ä½•æ—¶å¯ç”¨ï¼Ÿ

A: å½“æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ï¼Œå»ºè®®å¯ç”¨ç§’ä¼ ï¼š
- æ–‡ä»¶æ•°é‡ > 10,000
- é‡å¤ä¸Šä¼ æ¯”ä¾‹ > 20%
- å¤§æ–‡ä»¶åœºæ™¯ï¼ˆè§†é¢‘ã€å‹ç¼©åŒ…ç­‰ï¼‰
- å­˜å‚¨æˆæœ¬ > $100/æœˆ

### Q3: å¦‚ä½•ç»Ÿè®¡æ¯ä¸ªç§Ÿæˆ·çš„å­˜å‚¨å ç”¨ï¼Ÿ

A: ä½¿ç”¨ç»Ÿè®¡ APIï¼š
```bash
GET /api/v1/storage/stats?router=tenant_name
```

### Q4: å¦‚ä½•æ¸…ç†æŸä¸ªå‡½æ•°çš„æ‰€æœ‰æ–‡ä»¶ï¼Ÿ

A: ä½¿ç”¨æ‰¹é‡åˆ é™¤ APIï¼š
```bash
POST /api/v1/storage/batch_delete
{"router": "tenant/app/function"}
```

### Q5: æ˜¯å¦æ”¯æŒå…¶ä»–å¯¹è±¡å­˜å‚¨ï¼Ÿ

A: å½“å‰æ”¯æŒ MinIOï¼ˆS3 åè®®ï¼‰ï¼Œæœªæ¥è®¡åˆ’æ”¯æŒï¼š
- SeaweedFSï¼ˆApache 2.0ï¼Œä¼˜å…ˆï¼‰
- é˜¿é‡Œäº‘ OSS
- ä¸ƒç‰›äº‘
- è…¾è®¯äº‘ COS

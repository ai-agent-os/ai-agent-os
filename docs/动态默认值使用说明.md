# 动态默认值使用说明

## 概述

为了提升用户体验，减少重复填写，我们支持在 Widget 配置中使用动态变量作为默认值。这些变量会在表单初始化时自动解析为实际值。

## 支持的动态变量

### 用户选择器（User Widget）

- **`$me`**：当前登录用户的用户名

**使用示例：**
```go
Booker string `json:"booker" gorm:"column:booker;comment:预约人" widget:"name:预约人;type:user;default:$me" search:"in" validate:"required"`
```

### 时间戳组件（Timestamp Widget）

- **`$now`**：当前时间（毫秒时间戳）
- **`$today`**：今天开始时间（00:00:00，毫秒时间戳）
- **`$tomorrow`**：明天开始时间（00:00:00，毫秒时间戳）
- **`$yesterday`**：昨天开始时间（00:00:00，毫秒时间戳）

**使用示例：**
```go
StartTime int `json:"start_time" gorm:"column:start_time;comment:开始时间" widget:"name:开始时间;type:timestamp;default:$now;format:YYYY-MM-DD HH:mm:ss" search:"gte,lte" validate:"required"`

// 或者使用 $today 表示今天开始
CreatedAt int `json:"created_at" gorm:"column:created_at;comment:创建时间" widget:"name:创建时间;type:timestamp;default:$today;format:YYYY-MM-DD HH:mm:ss" search:"gte,lte"`
```

## 工作原理

1. **后端配置**：在 Go 结构体的 `widget` 标签中设置 `default` 参数，值为动态变量（如 `$me`、`$now` 等）

2. **前端解析**：
   - 表单初始化时，`FormRenderer` 会调用 `getWidgetDefaultValue` 获取每个字段的默认值
   - `getWidgetDefaultValue` 会调用 `resolveDynamicDefaultValue` 解析动态变量
   - 解析后的值会被设置到表单数据中

3. **组件处理**：
   - **UserWidget**：如果默认值是 `$me`，会自动填充当前登录用户的用户名，并加载用户信息到选择器中
   - **TimestampWidget**：如果默认值是时间相关变量，会自动填充对应的时间戳

## 实现细节

### 文件结构

```
web/src/core/widgets-v2/
├── utils/
│   └── dynamicDefaultValue.ts      # 动态变量解析工具
├── composables/
│   └── useWidgetDefaultValue.ts    # 默认值处理（已更新，支持动态变量）
└── components/
    ├── UserWidget.vue              # 用户选择器（已更新，支持 $me）
    └── TimestampWidget.vue          # 时间戳组件（自动支持时间变量）
```

### 核心函数

**`resolveDynamicDefaultValue(defaultValue, widgetType)`**
- 解析动态变量为实际值
- 支持用户选择器和时间戳组件的动态变量

**`getWidgetDefaultValue(field, customConverter)`**
- 获取字段的默认值
- 自动调用 `resolveDynamicDefaultValue` 解析动态变量

## 使用场景

### 场景 1：会议室预约系统

```go
type CrmMeetingRoomBooking struct {
    // 预约人：默认当前登录用户
    Booker string `json:"booker" widget:"name:预约人;type:user;default:$me" validate:"required"`
    
    // 开始时间：默认当前时间
    StartTime int `json:"start_time" widget:"name:开始时间;type:timestamp;default:$now;format:YYYY-MM-DD HH:mm:ss" validate:"required"`
    
    // 结束时间：默认明天
    EndTime int `json:"end_time" widget:"name:结束时间;type:timestamp;default:$tomorrow;format:YYYY-MM-DD HH:mm:ss" validate:"required"`
}
```

### 场景 2：任务管理系统

```go
type Task struct {
    // 创建人：默认当前用户
    Creator string `json:"creator" widget:"name:创建人;type:user;default:$me"`
    
    // 创建时间：默认当前时间
    CreatedAt int `json:"created_at" widget:"name:创建时间;type:timestamp;default:$now;format:YYYY-MM-DD HH:mm:ss"`
    
    // 截止日期：默认明天
    DueDate int `json:"due_date" widget:"name:截止日期;type:timestamp;default:$tomorrow;format:YYYY-MM-DD"`
}
```

## 注意事项

1. **动态变量格式**：必须以 `$` 开头，区分大小写
2. **用户选择器**：`$me` 需要用户已登录，否则会返回 `null`
3. **时间戳组件**：所有时间变量返回的是毫秒级时间戳
4. **默认值优先级**：
   - 如果字段已有值（如编辑模式），不会覆盖
   - 只有在字段为空时，才会使用默认值

## 扩展性

如果需要添加新的动态变量，只需在 `dynamicDefaultValue.ts` 的 `resolveDynamicDefaultValue` 函数中添加对应的 case 即可。

例如，添加 `$nextWeek`（下周开始）：

```typescript
case '$nextWeek':
  // 下周开始时间（00:00:00）
  const nextWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 7)
  return nextWeek.getTime()
```

## 测试建议

1. **用户选择器测试**：
   - 测试 `$me` 在已登录状态下是否正确填充
   - 测试 `$me` 在未登录状态下是否返回 `null`
   - 测试用户信息是否正确加载到选择器中

2. **时间戳组件测试**：
   - 测试 `$now` 是否返回当前时间戳
   - 测试 `$today` 是否返回今天 00:00:00 的时间戳
   - 测试 `$tomorrow` 和 `$yesterday` 是否正确计算

3. **集成测试**：
   - 测试在新增表单中，动态默认值是否正确填充
   - 测试在编辑表单中，已有值不会被默认值覆盖


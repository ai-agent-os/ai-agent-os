# Function Generation æ•´ä½“æµç¨‹æ¢³ç†

## ğŸ“‹ æ¦‚è¿°

`function_gen` æ˜¯æ™ºèƒ½ä½“ä»£ç ç”ŸæˆåŠŸèƒ½çš„æ ¸å¿ƒæµç¨‹ï¼Œæ¶‰åŠå‰ç«¯ã€agent-serverã€app-server ä¸‰ä¸ªæœåŠ¡ï¼Œé€šè¿‡ HTTP å’Œ NATS è¿›è¡Œé€šä¿¡ã€‚

## ğŸ”„ å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯      â”‚
â”‚ AIChatPanel â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. POST /agent/api/v1/chat/function_gen
       â”‚    { agent_id, tree_id, message: { content, files } }
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              agent-server                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API: agent_chat.go                               â”‚  â”‚
â”‚  â”‚  FunctionGenChat()                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Service: agent_chat_service_function_gen.go      â”‚  â”‚
â”‚  â”‚  FunctionGenChat()                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ 1. éªŒè¯æ™ºèƒ½ä½“                                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ 2. ä¼šè¯ç®¡ç†ï¼ˆåˆ›å»º/è·å–ä¼šè¯ï¼‰                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ 3. åŠ è½½å†å²æ¶ˆæ¯                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ 4. æ„å»º LLM æ¶ˆæ¯åˆ—è¡¨                           â”‚  â”‚
â”‚  â”‚  â”‚   â”œâ”€ å¤„ç†æ’ä»¶ï¼ˆå¦‚æœæ˜¯ plugin ç±»å‹ï¼‰             â”‚  â”‚
â”‚  â”‚  â”‚   â”‚   â””â”€ è°ƒç”¨ Form APIï¼ˆé€šè¿‡ PluginFunctionPathï¼‰â”‚  â”‚
â”‚  â”‚  â”‚   â””â”€ æ·»åŠ å†å²æ¶ˆæ¯                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ 5. è·å– LLM é…ç½®å’Œå®¢æˆ·ç«¯                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ 6. åˆ›å»ºå‡½æ•°ç”Ÿæˆè®°å½•ï¼ˆFunctionGenRecordï¼‰        â”‚  â”‚
â”‚  â”‚  â”‚   â””â”€ çŠ¶æ€: generating                           â”‚  â”‚
â”‚  â”‚  â””â”€ 7. å¼‚æ­¥è°ƒç”¨ LLM                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  asyncCallLLM() (goroutine)                      â”‚  â”‚
â”‚  â”‚  â”œâ”€ è°ƒç”¨ LLM API                                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ ä¿å­˜ assistant æ¶ˆæ¯                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ æå–ä»£ç ï¼ˆextractCodeFromLLMResponseï¼‰         â”‚  â”‚
â”‚  â”‚  â”œâ”€ æ›´æ–°è®°å½•ä»£ç ï¼ˆUpdateCodeï¼‰                     â”‚  â”‚
â”‚  â”‚  â””â”€ å‘å¸ƒç»“æœåˆ° app-server                         â”‚  â”‚
â”‚  â”‚      â””â”€ PublishResult() (HTTP)                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚ 2. HTTP POST                          â”‚
â”‚                 â”‚    /workspace/api/v1/service_tree/    â”‚
â”‚                 â”‚    add_functions                      â”‚
â”‚                 â”‚    { RecordID, MessageID, AgentID,   â”‚
â”‚                 â”‚      TreeID, User, Code, Async:true } â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              app-server                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  HTTP API: AddFunctions()                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ æ¥æ”¶ HTTP è¯·æ±‚ï¼ˆAddFunctionsReqï¼‰             â”‚  â”‚
â”‚  â”‚  â”œâ”€ Async=true: å¼‚æ­¥æ¨¡å¼ï¼Œè¿”å› 202ï¼Œåå°å¤„ç†       â”‚  â”‚
â”‚  â”‚  â””â”€ è°ƒç”¨ ProcessFunctionGenResultAsync()          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Service: function_gen_service.go                â”‚  â”‚
â”‚  â”‚  ProcessFunctionGenResult()                      â”‚  â”‚
â”‚  â”‚  â”œâ”€ 1. è·å– ServiceTreeï¼ˆæ ¹æ® TreeIDï¼‰            â”‚  â”‚
â”‚  â”‚  â”œâ”€ 2. æå– package è·¯å¾„                         â”‚  â”‚
â”‚  â”‚  â”œâ”€ 3. æ„å»º CreateFunctionInfo                    â”‚  â”‚
â”‚  â”‚  â”‚   â”œâ”€ Package: ä» ServiceTree æå–              â”‚  â”‚
â”‚  â”‚  â”‚   â”œâ”€ GroupCode: æ–‡ä»¶åï¼ˆä» Code æå–ï¼‰         â”‚  â”‚
â”‚  â”‚  â”‚   â””â”€ SourceCode: ç”Ÿæˆçš„ä»£ç                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ 4. è°ƒç”¨ AppService.UpdateApp()               â”‚  â”‚
â”‚  â”‚  â”‚   â””â”€ åˆ›å»ºå‡½æ•°æ–‡ä»¶å¹¶æ›´æ–°å·¥ä½œç©ºé—´                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ 5. è·å–æ–°å¢çš„ FullCodePaths                   â”‚  â”‚
â”‚  â”‚  â”‚   â””â”€ ä» updateResp.Diff.Add æå–               â”‚  â”‚
â”‚  â”‚  â””â”€ 6. å‘é€å›è°ƒåˆ° agent-server                    â”‚  â”‚
â”‚  â”‚      â””â”€ NotifyWorkspaceUpdateComplete()           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ 3. HTTP POST
                  â”‚    /agent/api/v1/workspace/update/callback
                  â”‚    { RecordID, MessageID, Success,
                  â”‚      FullCodePaths, AppID, AppCode, Error }
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              agent-server                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API: server.go                                  â”‚  â”‚
â”‚  â”‚  HandleFunctionGenCallback()                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Service: function_gen_service.go                â”‚  â”‚
â”‚  â”‚  ProcessFunctionGenCallback()                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ å¦‚æœæˆåŠŸ:                                     â”‚  â”‚
â”‚  â”‚  â”‚   â””â”€ UpdateStatusWithFullCodePaths()          â”‚  â”‚
â”‚  â”‚  â”‚      â””â”€ çŠ¶æ€: completed                        â”‚  â”‚
â”‚  â”‚  â””â”€ å¦‚æœå¤±è´¥:                                     â”‚  â”‚
â”‚  â”‚      â””â”€ UpdateStatus()                           â”‚  â”‚
â”‚  â”‚         â””â”€ çŠ¶æ€: failed                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ 4. å‰ç«¯è½®è¯¢
                  â”‚    GET /agent/api/v1/chat/function_gen/status?record_id=xxx
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯      â”‚
â”‚ AIChatPanel â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  è½®è¯¢ç­–ç•¥:                                       â”‚  â”‚
â”‚  â”‚  - ç¬¬1æ¬¡: 8ç§’åè½®è¯¢                             â”‚  â”‚
â”‚  â”‚  - åç»­: æ¯3ç§’è½®è¯¢ä¸€æ¬¡                          â”‚  â”‚
â”‚  â”‚  - è¶…æ—¶ï¼ˆ>2åˆ†é’Ÿï¼‰: æ¯10ç§’è½®è¯¢ä¸€æ¬¡                â”‚  â”‚
â”‚  â”‚                                                 â”‚  â”‚
â”‚  â”‚  å½“çŠ¶æ€å˜ä¸º completed æ—¶:                       â”‚  â”‚
â”‚  â”‚  - æ˜¾ç¤ºç”ŸæˆæˆåŠŸé€šçŸ¥                              â”‚  â”‚
â”‚  â”‚  - æ˜¾ç¤ºå‡½æ•°é“¾æ¥ï¼ˆåŸºäº full_code_pathsï¼‰          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ è¯¦ç»†æ­¥éª¤è¯´æ˜

### é˜¶æ®µ 1: å‰ç«¯å‘èµ·è¯·æ±‚

**æ–‡ä»¶**: `web/src/architecture/presentation/components/AIChatPanel.vue`

1. ç”¨æˆ·è¾“å…¥æ¶ˆæ¯å’Œæ–‡ä»¶
2. è°ƒç”¨ `handleSend()` å‡½æ•°
3. å‘é€ POST è¯·æ±‚åˆ° `/agent/api/v1/chat/function_gen`
   - è¯·æ±‚ä½“åŒ…å«ï¼š`agent_id`, `tree_id`, `session_id`, `message: { content, files }`
4. ç«‹å³è¿”å›å“åº”ï¼ŒåŒ…å« `record_id` å’Œ `status: "generating"`
5. å¼€å§‹è½®è¯¢çŠ¶æ€ï¼ˆ`startPolling(record_id)`ï¼‰

### é˜¶æ®µ 2: agent-server å¤„ç†è¯·æ±‚

**æ–‡ä»¶**: `core/agent-server/api/v1/agent_chat.go` â†’ `core/agent-server/service/agent_chat_service_function_gen.go`

#### 2.1 åŒæ­¥å¤„ç†ï¼ˆFunctionGenChatï¼‰

1. **éªŒè¯æ™ºèƒ½ä½“**: æ£€æŸ¥æ™ºèƒ½ä½“æ˜¯å¦å­˜åœ¨ã€æ˜¯å¦å¯ç”¨
2. **ä¼šè¯ç®¡ç†**: åˆ›å»ºæˆ–è·å–ä¼šè¯ï¼Œä¿å­˜ç”¨æˆ·æ¶ˆæ¯
3. **åŠ è½½å†å²æ¶ˆæ¯**: è·å–ä¼šè¯å†å²ï¼Œç”¨äºä¸Šä¸‹æ–‡
4. **æ„å»º LLM æ¶ˆæ¯åˆ—è¡¨**:
   - å¦‚æœæ˜¯ `plugin` ç±»å‹æ™ºèƒ½ä½“ï¼Œå…ˆè°ƒç”¨æ’ä»¶ï¼ˆForm APIï¼‰
   - æ„å»ºç³»ç»Ÿæ¶ˆæ¯ï¼ˆåŒ…å«çŸ¥è¯†åº“å†…å®¹ï¼‰
   - æ·»åŠ å†å²æ¶ˆæ¯
   - æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯
5. **è·å– LLM é…ç½®**: ä»æ™ºèƒ½ä½“é…ç½®è·å– LLM å®¢æˆ·ç«¯
6. **åˆ›å»ºå‡½æ•°ç”Ÿæˆè®°å½•**: 
   - çŠ¶æ€: `generating`
   - ä¿å­˜åˆ° `function_gen_records` è¡¨
7. **å¼‚æ­¥è°ƒç”¨ LLM**: å¯åŠ¨ goroutineï¼Œä¸é˜»å¡å“åº”

#### 2.2 å¼‚æ­¥å¤„ç†ï¼ˆasyncCallLLMï¼‰

**æ–‡ä»¶**: `core/agent-server/service/agent_chat_service_function_gen.go`

1. **è°ƒç”¨ LLM API**: ä½¿ç”¨é…ç½®çš„ LLM å®¢æˆ·ç«¯ç”Ÿæˆä»£ç 
2. **ä¿å­˜ assistant æ¶ˆæ¯**: å°† LLM å›å¤ä¿å­˜åˆ°æ¶ˆæ¯è¡¨
3. **æå–ä»£ç **: ä» LLM å›å¤ä¸­æå–ä»£ç å—ï¼ˆ`extractCodeFromLLMResponse`ï¼‰
4. **æ›´æ–°è®°å½•ä»£ç **: å°†æå–çš„ä»£ç ä¿å­˜åˆ° `FunctionGenRecord.Code`
5. **å‘å¸ƒç»“æœåˆ° app-server**: 
   - è°ƒç”¨ `functionGenService.PublishResult()`
   - é€šè¿‡ HTTP è°ƒç”¨ `/workspace/api/v1/service_tree/add_functions`ï¼ˆå¼‚æ­¥æ¨¡å¼ï¼‰

### é˜¶æ®µ 3: app-server å¤„ç†ä»£ç ç”Ÿæˆ

**æ–‡ä»¶**: `core/app-server/api/v1/service_tree.go` â†’ `core/app-server/service/function_gen_service.go`

#### 3.1 HTTP æ¥å£å¤„ç†

1. **æ¥æ”¶ HTTP è¯·æ±‚**: `AddFunctions()` (POST `/workspace/api/v1/service_tree/add_functions`)
2. **è§£æè¯·æ±‚ä½“**: è½¬æ¢ä¸º `AddFunctionsReq`
3. **æ ¹æ® Async å‚æ•°å†³å®šå¤„ç†æ–¹å¼**:
   - `Async = true`: å¼‚æ­¥æ¨¡å¼ï¼Œç«‹å³è¿”å› 202ï¼Œåå°å¤„ç†ï¼Œé€šè¿‡å›è°ƒé€šçŸ¥
   - `Async = false`: åŒæ­¥æ¨¡å¼ï¼Œç­‰å¾…å¤„ç†å®Œæˆï¼Œç›´æ¥è¿”å›ç»“æœ

#### 3.2 æœåŠ¡å±‚å¤„ç†

1. **è·å– ServiceTree**: æ ¹æ® `TreeID` è·å–ç›®å½•ä¿¡æ¯
2. **æå– package è·¯å¾„**: ä» `ServiceTree` æå–ç”¨äºæ–‡ä»¶åˆ›å»ºçš„è·¯å¾„
3. **æ„å»º CreateFunctionInfo**:
   - `Package`: package è·¯å¾„
   - `GroupCode`: æ–‡ä»¶åï¼ˆä»ä»£ç ä¸­æå–æˆ–ä½¿ç”¨ ServiceTree.Codeï¼‰
   - `SourceCode`: ç”Ÿæˆçš„ä»£ç 
4. **è°ƒç”¨ AppService.UpdateApp()**: 
   - åˆ›å»ºå‡½æ•°æ–‡ä»¶
   - æ›´æ–°å·¥ä½œç©ºé—´
   - è¿”å› `DiffData`ï¼ˆåŒ…å«æ–°å¢çš„å‡½æ•°ä¿¡æ¯ï¼‰
5. **æå– FullCodePaths**: ä» `DiffData.Add` ä¸­æå–æ–°å¢å‡½æ•°çš„å®Œæ•´ä»£ç è·¯å¾„
6. **å‘é€å›è°ƒåˆ° agent-server**:
   - è°ƒç”¨ `NotifyWorkspaceUpdateComplete()`ï¼ˆHTTPï¼‰
   - ä¼ é€’ `FunctionGenCallback`ï¼ˆåŒ…å« `Success`, `FullCodePaths` ç­‰ï¼‰

### é˜¶æ®µ 4: agent-server å¤„ç†å›è°ƒ

**æ–‡ä»¶**: `core/agent-server/server/server.go` â†’ `core/agent-server/service/function_gen_service.go`

1. **æ¥æ”¶å›è°ƒ**: `HandleFunctionGenCallback()` (HTTP æ¥å£)
2. **å¤„ç†å›è°ƒ**: `ProcessFunctionGenCallback()`
   - å¦‚æœæˆåŠŸ: æ›´æ–°è®°å½•çŠ¶æ€ä¸º `completed`ï¼Œä¿å­˜ `FullCodePaths`
   - å¦‚æœå¤±è´¥: æ›´æ–°è®°å½•çŠ¶æ€ä¸º `failed`ï¼Œä¿å­˜é”™è¯¯ä¿¡æ¯

### é˜¶æ®µ 5: å‰ç«¯è½®è¯¢çŠ¶æ€

**æ–‡ä»¶**: `web/src/architecture/presentation/components/AIChatPanel.vue`

1. **è½®è¯¢ç­–ç•¥**:
   - ç¬¬1æ¬¡: 8ç§’åå¼€å§‹è½®è¯¢
   - åç»­: æ¯3ç§’è½®è¯¢ä¸€æ¬¡
   - è¶…æ—¶ï¼ˆ>2åˆ†é’Ÿï¼‰: æ¯10ç§’è½®è¯¢ä¸€æ¬¡
2. **è½®è¯¢æ¥å£**: `GET /agent/api/v1/chat/function_gen/status?record_id=xxx`
3. **çŠ¶æ€å¤„ç†**:
   - `generating`: ç»§ç»­è½®è¯¢
   - `completed`: 
     - åœæ­¢è½®è¯¢
     - æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
     - æ˜¾ç¤ºå‡½æ•°é“¾æ¥ï¼ˆåŸºäº `full_code_paths`ï¼‰
   - `failed`: 
     - åœæ­¢è½®è¯¢
     - æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

## ğŸ”‘ å…³é”®æ•°æ®ç»“æ„

### FunctionGenRecord (agent-server)

```go
type FunctionGenRecord struct {
    ID            int64
    MessageID     int64
    AgentID       int64
    TreeID        int64
    SessionID     string
    Status        string  // generating/completed/failed
    Code          string  // ç”Ÿæˆçš„ä»£ç 
    FullCodePaths string  // ç”Ÿæˆçš„å‡½æ•°å®Œæ•´ä»£ç è·¯å¾„åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰
    ErrorMsg      string
    Duration      int     // è€—æ—¶ï¼ˆç§’ï¼‰
    CreatedAt     time.Time
    UpdatedAt     time.Time
}
```

### AddFunctionsReq (agent-server â†’ app-server)

```go
type AddFunctionsReq struct {
    RecordID  int64
    MessageID int64
    AgentID   int64
    TreeID    int64
    User      string
    Code      string      // åŸå§‹ä»£ç 
    SourceCode string     // å¤„ç†åçš„ä»£ç ï¼ˆå¯é€‰ï¼‰
    FileName  string      // æå–çš„æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰
    Async     bool        // æ˜¯å¦å¼‚æ­¥å¤„ç†
}
```

### FunctionGenCallback (app-server â†’ agent-server)

```go
type FunctionGenCallback struct {
    RecordID      int64
    MessageID     int64
    Success       bool
    FullCodePaths []string  // ç”Ÿæˆçš„å‡½æ•°å®Œæ•´ä»£ç è·¯å¾„åˆ—è¡¨
    AppID         int64
    AppCode       string
    Error         string
}
```

## ğŸ”„ é€šä¿¡æ–¹å¼

### 1. HTTP è¯·æ±‚
- **å‰ç«¯ â†’ agent-server**: `/agent/api/v1/chat/function_gen`
- **å‰ç«¯ â†’ agent-server**: `/agent/api/v1/chat/function_gen/status` (è½®è¯¢)
- **app-server â†’ agent-server**: `/agent/api/v1/workspace/update/callback` (å›è°ƒ)

### 2. HTTP è¯·æ±‚ï¼ˆæœåŠ¡é—´è°ƒç”¨ï¼‰
- **agent-server â†’ app-server**: 
  - POST `/workspace/api/v1/service_tree/add_functions`
  - è¯·æ±‚ä½“: `AddFunctionsReq` (JSON)
  - æ¨¡å¼: å¼‚æ­¥ï¼ˆ`Async = true`ï¼‰ï¼Œé€šè¿‡å›è°ƒé€šçŸ¥ç»“æœ

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¼‚æ­¥å¤„ç†**: LLM è°ƒç”¨æ˜¯å¼‚æ­¥çš„ï¼Œå‰ç«¯ç«‹å³è¿”å›ï¼Œé€šè¿‡è½®è¯¢è·å–ç»“æœ
2. **çŠ¶æ€ç®¡ç†**: è®°å½•çŠ¶æ€ä» `generating` â†’ `completed`/`failed`
3. **é”™è¯¯å¤„ç†**: æ¯ä¸ªé˜¶æ®µéƒ½æœ‰é”™è¯¯å¤„ç†ï¼Œå¤±è´¥æ—¶æ›´æ–°è®°å½•çŠ¶æ€ä¸º `failed`
4. **Token ä¼ é€’**: æœåŠ¡é—´è°ƒç”¨éœ€è¦ä¼ é€’ tokenï¼Œç½‘å…³ä¼šè§£æå¹¶è®¾ç½®ç”¨æˆ·ä¿¡æ¯
5. **FullCodePaths**: ç”¨äºå‰ç«¯æ˜¾ç¤ºç”Ÿæˆçš„å‡½æ•°é“¾æ¥ï¼Œæ–¹ä¾¿ç”¨æˆ·è·³è½¬æŸ¥çœ‹

## ğŸ¯ ä¼˜åŒ–ç‚¹

1. **è½®è¯¢ç­–ç•¥**: å·²ä¼˜åŒ–ä¸º 8ç§’/3ç§’ï¼Œé€‚åº”æ¨¡å‹å‡çº§åçš„å¿«é€Ÿå“åº”
2. **å›è°ƒæœºåˆ¶**: ç¡®ä¿æ— è®ºæ˜¯å¦æœ‰æ–°å¢å‡½æ•°ç»„ï¼Œéƒ½ä¼šå‘é€å›è°ƒï¼Œä¿è¯çŠ¶æ€æ­£ç¡®æ›´æ–°
3. **æ–‡ä»¶æ ¼å¼ç»Ÿä¸€**: ä½¿ç”¨ `types.Files` ç»Ÿä¸€æ–‡ä»¶æ ¼å¼ï¼Œé¿å…è½¬æ¢é—®é¢˜
4. **æƒé™éªŒè¯**: ç½‘å…³ç»Ÿä¸€è§£æ tokenï¼Œç¡®ä¿æƒé™æ£€æŸ¥æ­£å¸¸å·¥ä½œ

# Promtail 性能优化配置示例
# 适用于多租户、动态应用场景

server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

# 位置文件：记录读取进度
positions:
  filename: /tmp/promtail-positions.yaml

# Loki 客户端配置（性能优化）
clients:
  - url: http://loki:3100/loki/api/v1/push
    # 批量发送配置
    batchwait: 1s          # 等待 1 秒批量发送（减少网络请求）
    batchsize: 1048576     # 1 MB 批量大小
    timeout: 10s
    backoff_config:
      min_period: 500ms
      max_period: 5m
      max_retries: 10

# 性能限制配置
limits_config:
  # 限制同时读取的文件数量（避免文件句柄过多）
  max_concurrent_tail: 50
  # 限制单次读取的最大行数
  max_line_size: 256KB
  # 限制标签数量
  max_label_names_per_series: 30

# 日志收集配置
scrape_configs:
  - job_name: ai-agent-os-apps
    # 文件系统发现配置
    static_configs:
      - targets:
          - localhost
        labels:
          job: ai-agent-os
          # 匹配所有租户和应用的日志文件
          __path__: /path/to/namespace/*/*/workplace/logs/*.log
    
    # 性能优化：降低扫描频率（从默认 5 秒调整为 10 秒）
    # 注意：这会影响新日志文件的发现延迟
    # 如果应用创建频繁，可以保持默认 5 秒
    # refresh_interval: 10s
    
    # 日志解析管道
    pipeline_stages:
      # 从文件路径提取元数据（tenant, app, version）
      - regex:
          expression: 'namespace/(?P<tenant>[^/]+)/(?P<app>[^/]+)/workplace/logs/(?P<tenant2>[^_]+)_(?P<app2>[^_]+)_(?P<version>v\d+)\.log'
      
      # 设置标签（只使用低基数标签）
      - labels:
          tenant: tenant      # ✅ 低基数：几十个租户
          application: app    # ✅ 低基数：几百个应用
          version: version     # ✅ 低基数：几个版本
          # ❌ 不要添加高基数标签：trace_id, request_id 等
      
      # 解析 JSON 日志（生产环境使用 JSON 格式）
      - json:
          expressions:
            level: level
            msg: msg
            ts: ts
            caller: caller
      
      # 设置日志级别标签
      - labels:
          log_level: level
      
      # 解析时间戳
      - timestamp:
          source: ts
          format: RFC3339Nano
      
      # 可选：采样策略（高日志量场景）
      # 只保留 100% 的 error 和 warn，10% 的 info
      # - drop:
      #     expression: 'log_level == "info"'
      #     drop_counter_reason: "sampled_info_logs"
      #     drop_ratio: 0.9  # 丢弃 90% 的 info 日志

# 性能监控配置
target_config:
  sync_period: 10s  # 同步位置文件的频率





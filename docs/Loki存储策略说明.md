# Loki 存储策略说明

## 工作流程详解

### 1. 日志写入（应用层）
```
应用代码
  ↓
logger.Info() / logger.Error()
  ↓
zap 日志库
  ↓
lumberjack 日志轮转
  ↓
写入文件：namespace/{user}/{app}/workplace/logs/{user}_{app}_{version}.log
```

**特点**：
- ✅ 应用正常写入日志文件
- ✅ 使用 lumberjack 自动轮转（100 MB/文件，保留 3 个备份，7 天）
- ✅ 不影响应用性能

### 2. 日志收集（Promtail）
```
Promtail 进程
  ↓
每 5 秒扫描目录：namespace/*/*/workplace/logs/*.log
  ↓
发现新日志文件或新内容
  ↓
读取日志文件（顺序读取，不影响应用写入）
  ↓
解析 JSON、提取标签（tenant, app, version, level）
  ↓
批量发送到 Loki（1 秒批量，1 MB 批量大小）
```

**特点**：
- ✅ **只读操作**：Promtail 只读取文件，不修改、不删除
- ✅ **解耦设计**：与应用写入完全独立，互不影响
- ✅ **资源消耗低**：约 50-200 MB 内存，0.1-1 CPU

### 3. 日志存储（Loki）
```
Loki 接收日志
  ↓
解析标签、构建索引
  ↓
压缩存储（压缩比约 10:1）
  ↓
存储到对象存储（文件系统/S3/MinIO 等）
```

**特点**：
- ✅ **压缩存储**：100 GB 原始日志 ≈ 10 GB Loki 存储
- ✅ **索引优化**：基于标签的索引，查询速度快
- ✅ **自动清理**：可配置保留策略，自动删除过期日志

## 存储空间分析

### 场景：每天 10 GB 日志，保留 7 天

#### 方案对比

| 方案 | 原始文件 | Loki 存储 | 总存储 | 说明 |
|------|---------|----------|--------|------|
| **只保留文件** | 70 GB | 0 GB | 70 GB | 当前方案 |
| **文件 + Loki** | 70 GB | 7 GB | 77 GB | 双重备份 |
| **只保留 Loki** | 0 GB | 7 GB | 7 GB | **节省 90%** |
| **混合策略** | 7 GB (1天) | 7 GB (7天) | 14 GB | **节省 80%** |

### 存储空间计算

假设：
- 每天日志量：10 GB
- 保留天数：7 天
- Loki 压缩比：10:1

```
原始文件存储 = 10 GB/天 × 7 天 = 70 GB
Loki 存储 = 10 GB/天 × 7 天 ÷ 10 = 7 GB

方案 A（文件 + Loki）= 70 GB + 7 GB = 77 GB
方案 B（只保留 Loki）= 7 GB（节省 90%）
方案 C（混合策略）= 10 GB + 7 GB = 17 GB（节省 76%）
```

## 推荐存储策略

### 策略 1：过渡期（推荐）

**配置**：
- 原始文件：保留 7 天（使用现有 lumberjack 配置）
- Loki：保留 7 天

**优点**：
- ✅ 双重备份，更安全
- ✅ 可以随时回退到文件日志
- ✅ 逐步验证 Loki 稳定性

**存储开销**：
- 原始文件：70 GB
- Loki：7 GB
- **总计：77 GB**

### 策略 2：生产环境（推荐）

**配置**：
- 原始文件：保留 1-3 天（用于快速排查）
- Loki：保留 30 天（用于历史查询和分析）

**优点**：
- ✅ 存储空间节省 80-90%
- ✅ 历史日志统一查询
- ✅ 自动清理，无需手动管理

**存储开销**（假设每天 10 GB）：
- 原始文件：10-30 GB（1-3 天）
- Loki：30 GB（30 天压缩后）
- **总计：40-60 GB**（相比 300 GB 原始文件，节省 80-87%）

### 策略 3：极致优化（高日志量场景）

**配置**：
- 原始文件：不保留（或只保留错误日志）
- Loki：保留 7-14 天
- 启用采样：info 级别日志采样 10%

**优点**：
- ✅ 存储空间最小
- ✅ 只保留关键日志
- ✅ 适合高日志量场景

**存储开销**（假设每天 100 GB）：
- 原始文件：0 GB
- Loki：7-14 GB（压缩后，含采样）
- **总计：7-14 GB**（相比 700-1400 GB 原始文件，节省 99%）

## 实施建议

### 阶段一：验证期（1-2 周）
```yaml
# 保留原始文件 + Loki
原始文件：保留 7 天（现有配置）
Loki：保留 7 天
```
**目的**：验证 Loki 稳定性和查询功能

### 阶段二：优化期（1 个月后）
```yaml
# 混合策略
原始文件：保留 3 天（减少到 3 天）
Loki：保留 14 天（增加到 14 天）
```
**目的**：平衡存储和可用性

### 阶段三：生产期（稳定后）
```yaml
# 生产策略
原始文件：保留 1 天（只保留最近 1 天）
Loki：保留 30 天（长期保留用于分析）
```
**目的**：最大化存储效率

## 配置示例

### Promtail 配置（读取日志）
```yaml
scrape_configs:
  - job_name: ai-agent-os-apps
    static_configs:
      - targets: [localhost]
        labels:
          job: ai-agent-os
          __path__: /path/to/namespace/*/*/workplace/logs/*.log
```

### Loki 配置（存储和清理）
```yaml
# 保留策略
limits_config:
  retention_period: 720h  # 保留 30 天

# 压缩配置
compactor:
  retention_enabled: true
  retention_period: 720h
  retention_delete_delay: 2h
```

### 应用日志配置（原始文件清理）
```go
// 现有配置（pkg/logger）
logConfig := logger.Config{
    MaxSize:    100,  // 单个文件最大 100 MB
    MaxBackups: 3,    // 保留 3 个备份（约 300 MB）
    MaxAge:     1,    // 建议改为 1 天（只保留最近 1 天）
    Compress:   true,
}
```

## 常见问题

### Q1: 原始文件可以删除吗？
**A**: 可以。Loki 已经存储了日志，原始文件可以删除以节省空间。建议：
- 过渡期：保留 3-7 天
- 生产期：保留 1 天或删除

### Q2: 如果 Loki 故障，日志会丢失吗？
**A**: 不会。因为：
- 应用继续写入原始文件
- Promtail 会缓存未发送的日志
- 可以配置原始文件保留策略作为备份

### Q3: 存储空间会增加多少？
**A**: 取决于策略：
- 如果保留原始文件：增加约 10%（Loki 压缩存储）
- 如果只保留 Loki：减少约 90%（压缩存储）

### Q4: 如何监控存储使用？
**A**: 
```bash
# 查看原始文件大小
du -sh namespace/*/*/workplace/logs/

# 查看 Loki 存储大小
du -sh /loki/chunks/

# 查看 Loki metrics
curl http://localhost:3100/metrics | grep loki_ingester_chunks_stored_bytes_total
```

## 总结

**关键点**：
1. ✅ Promtail **只读取**日志文件，不修改、不删除
2. ✅ Loki **会存储**日志（压缩格式，节省 90% 空间）
3. ✅ 原始文件**可以保留**（备份）或**删除**（节省空间）
4. ✅ **推荐策略**：原始文件保留 1-3 天，Loki 保留 7-30 天

**存储收益**：
- 如果只保留 Loki：节省 **90%** 存储空间
- 如果混合策略：节省 **80%** 存储空间
- 查询效率提升 **10-100 倍**





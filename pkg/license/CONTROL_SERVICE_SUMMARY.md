# Control Service（控制服务）设计方案总结

## 🎯 服务定位

**轻量级的系统控制服务，承担 License 管理和系统级控制职责**

- ✅ **核心职责**：License 管理（密钥分发）
- ✅ **扩展职责**：系统控制指令（下机、重启、维护模式等）
- ✅ **轻量级**：服务崩溃不影响其他服务进程
- ✅ **非关键路径**：其他服务可以独立运行，不依赖此服务

---

## 🏗️ 服务命名

**推荐名称**：**Control Service**（控制服务）

**理由**：
- ✅ 简洁明了
- ✅ 符合轻量级职责
- ✅ 易于理解

---

## 📋 服务职责

### 1. License 管理（核心职责）⭐⭐⭐⭐⭐

- ✅ 读取 License 文件
- ✅ 验证 License
- ✅ 加密并分发密钥（主题：`control.license.key`）

---

### 2. 系统控制指令（扩展职责）⭐⭐⭐⭐

**功能**：
- ✅ **下机指令**：优雅关闭所有服务
- ✅ **重启指令**：重启所有服务
- ✅ **维护模式**：进入/退出维护模式
- ✅ **配置更新**：通知配置更新
- ✅ **功能开关**：启用/禁用某些功能

**实现方式**：
- ✅ 通过 NATS 发布控制指令（主题：`control.command`）
- ✅ 各服务订阅并执行相应操作

**示例**：
```json
// 下机指令
{
  "type": "shutdown",
  "params": {
    "graceful": true,
    "timeout": 30
  },
  "timestamp": 1234567890
}
```

---

### 3. 系统通知/公告（扩展职责）⭐⭐⭐

**功能**：
- ✅ **系统维护通知**：通知系统维护时间
- ✅ **重要消息**：发布重要系统消息
- ✅ **版本更新通知**：通知新版本发布

**实现方式**：
- ✅ 通过 NATS 发布通知（主题：`control.notification`）

---

### 4. 配置分发（可选职责）⭐⭐

**功能**：
- ✅ **集中配置分发**：某些配置的集中分发
- ✅ **配置热更新**：通知配置更新

**注意**：
- ⚠️ 需要谨慎设计，避免与现有配置系统冲突
- ⚠️ 建议仅用于轻量级配置

---

## 🏗️ 架构设计

```
┌─────────────────────────────────────┐
│      Control Service（控制服务）      │
│                                     │
│  - License 管理                     │
│  - 控制指令处理                     │
│  - HTTP API 服务器                  │
└──────────────┬──────────────────────┘
               │
               │ NATS 发布
               │ 主题：
               │ - control.license.key
               │ - control.command
               │ - control.notification
               ↓
┌─────────────────────────────────────┐
│         NATS 消息中间件               │
└──────────────┬──────────────────────┘
               │
               │ NATS 订阅
               ↓
┌─────────────────────────────────────┐
│      所有服务实例（订阅并执行）        │
│                                     │
│  - 获取 License 密钥                │
│  - 接收控制指令并执行               │
│  - 接收系统通知                     │
└─────────────────────────────────────┘
```

---

## 🔄 工作流程

### 下机指令流程

```
管理员在 Control Service 点击下机
  ↓
Control Service 接收 HTTP 请求
  ↓
构建下机指令
  ↓
发布到 NATS（主题：control.command）
  ↓
所有服务订阅并收到指令
  ↓
各服务执行优雅关闭
```

---

## 💻 HTTP API 设计

### 控制指令 API

```
POST /api/v1/control/shutdown      # 下机指令
POST /api/v1/control/restart      # 重启指令
POST /api/v1/control/maintenance  # 维护模式
POST /api/v1/control/notification # 发布通知
```

---

## 🎯 服务特点

### 1. 轻量级

- ✅ **简单职责**：只承担轻量级职责
- ✅ **无状态**：服务本身无状态，易于重启
- ✅ **独立运行**：不依赖其他服务

---

### 2. 非关键路径

- ✅ **服务崩溃不影响其他服务**：其他服务可以独立运行
- ✅ **容错机制**：各服务可以检测 Control Service 是否可用
- ✅ **降级策略**：如果 Control Service 不可用，各服务降级到默认行为

---

### 3. 易于扩展

- ✅ **模块化设计**：各职责模块化，易于扩展
- ✅ **插件化**：可以轻松添加新的控制指令
- ✅ **配置化**：通过配置文件控制功能开关

---

## 📋 实施步骤

### 阶段一：基础功能

1. 创建 `core/control-service` 目录
2. 实现 License 管理（密钥分发）
3. 实现 HTTP API 服务器
4. 实现 NATS 发布逻辑

### 阶段二：控制指令

1. 实现下机指令
2. 实现重启指令
3. 实现维护模式
4. 实现 Control Client（各服务实例）

### 阶段三：扩展功能

1. 实现系统通知/公告
2. 实现配置分发（可选）
3. 实现健康检查协调（可选）

---

## 🎯 总结

### 核心设计

1. **服务名称**：Control Service（控制服务）
2. **核心职责**：License 管理（密钥分发）
3. **扩展职责**：系统控制指令（下机、重启、维护模式等）
4. **轻量级**：服务崩溃不影响其他服务进程

### 关键优势

- ✅ **集中管理**：License 和系统控制集中管理
- ✅ **轻量级**：服务简单，易于维护
- ✅ **非关键路径**：服务崩溃不影响其他服务
- ✅ **易于扩展**：可以轻松添加新的控制指令

---

## 📞 参考

- [Control Service 详细设计方案](./CONTROL_SERVICE_DESIGN.md)
- [License 密钥分发方案](./LICENSE_DISTRIBUTION_DESIGN.md)

# License 密钥分发方案总结

## 🎯 核心设计

**NATS 只用于密钥分发，各实例本地保存并自行验证**

- ✅ **NATS 分发密钥**：License 服务通过 NATS 分发加密的 License 密钥
- ✅ **本地保存**：各实例获取密钥后保存到本地文件
- ✅ **自行验证**：各实例使用本地密钥自行验证，不依赖 NATS
- ✅ **防止模拟**：即使有人模拟 NATS 消息，因为没有加密密钥，无法解密
- ✅ **无单点问题**：获取到密钥后，后续验证不依赖 NATS

---

## 🏗️ 架构图

```
┌─────────────────────────────────────┐
│      License 服务（独立服务）         │
│                                     │
│  - 读取 License 文件                │
│  - 验证 License                     │
│  - 加密 License（AES-256-GCM）     │
│  - 发布加密密钥到 NATS               │
│  - 定期发布（每5分钟）               │
└──────────────┬──────────────────────┘
               │
               │ NATS 发布
               │ 主题：license.key
               │ 消息：加密的 License 密钥
               ↓
┌─────────────────────────────────────┐
│         NATS 消息中间件               │
└──────────────┬──────────────────────┘
               │
               │ NATS 订阅（仅获取密钥）
               ↓
┌─────────────────────────────────────┐
│      所有服务实例（获取密钥后本地验证）│
│                                     │
│  app-server  ──┐                    │
│  agent-server ─┼── 订阅 license.key│
│  app-runtime  ─┘                    │
│                                     │
│  1. 启动时从 NATS 获取密钥           │
│  2. 保存密钥到本地（~/.ai-agent-os/ │
│     license.key）                   │
│  3. 使用本地密钥自行验证             │
│  4. 后续验证不依赖 NATS              │
└─────────────────────────────────────┘
```

---

## 🔄 工作流程

### License 服务

```
启动 → 读取 License → 验证 → 加密 → 发布到 NATS → 定期发布（每5分钟）
```

---

### 服务实例启动

```
启动
  ↓
连接 NATS
  ├─ 失败 → 默认社区版
  └─ 成功 → 继续
  ↓
检查本地密钥文件
  ├─ 有 → 使用本地密钥验证
  └─ 无 → 从 NATS 获取密钥
       ├─ 成功 → 保存到本地 → 使用密钥验证
       └─ 失败 → 默认社区版
  ↓
使用本地密钥自行验证
  ├─ 有效 → 启用企业功能
  └─ 无效 → 降级到社区版
```

---

### 新增实例启动

```
新增实例启动
  ↓
连接 NATS
  ↓
订阅 license.key 主题
  ↓
收到密钥消息（等待最多10秒）
  ↓
保存密钥到本地
  ↓
使用本地密钥自行验证
  ├─ 有效 → 启用企业功能
  └─ 无效 → 降级到社区版
```

---

## 🔐 安全设计

### 1. 密钥加密

**方案**：AES-256-GCM 对称加密

- License 服务和各实例共享同一个加密密钥
- 密钥通过配置文件或环境变量配置
- 加密后的密钥通过 NATS 分发

**优势**：
- ✅ 即使有人模拟 NATS 消息，因为没有加密密钥，无法解密
- ✅ 各实例获取密钥后，使用本地密钥自行验证（RSA 签名验证）

---

### 2. 防止模拟 NATS 消息

**防护措施**：
- ✅ **密钥加密**：即使有人模拟 NATS 消息，因为没有加密密钥，无法解密
- ✅ **本地验证**：各实例获取密钥后，使用本地密钥自行验证（RSA 签名验证）
- ✅ **密钥文件权限**：本地密钥文件设置严格权限（0600）

---

### 3. 密钥存储

**本地密钥文件路径**：
- 优先级1：环境变量 `LICENSE_KEY_PATH`
- 优先级2：`~/.ai-agent-os/license.key`
- 优先级3：`./license.key`

**文件权限**：`0600`（仅所有者可读写）

---

## ✅ 优势

1. **更安全**
   - 即使有人模拟 NATS 消息，因为没有加密密钥，无法解密
   - 各实例使用本地密钥自行验证，不依赖 NATS 状态

2. **无单点问题**
   - 获取到密钥后，后续验证不依赖 NATS
   - 即使 NATS 挂了，各实例仍可使用本地密钥验证

3. **简化实现**
   - 各实例只需在启动时获取一次密钥
   - 后续验证完全本地化，无需持续连接 NATS

4. **适合集群**
   - 新实例启动时自动从 NATS 获取密钥
   - 无需共享存储，无需手动配置

---

## ⚠️ 注意事项

1. **加密密钥管理**
   - License 服务和各实例需要共享同一个加密密钥
   - 密钥可以通过配置文件或环境变量配置
   - 建议使用密钥管理服务（如 Vault）

2. **密钥更新**
   - License 文件更新时，License 服务会发布新的密钥
   - 各实例收到新密钥后，会更新本地密钥文件

3. **密钥泄露**
   - 如果密钥泄露，需要重新生成密钥并重新分发
   - 建议定期轮换密钥

---

## 📋 实施步骤

### 阶段一：License 服务

1. 创建 `core/license-server` 目录
2. 实现 License 服务（读取、验证、加密）
3. 实现 NATS 发布逻辑（密钥分发）
4. 实现定期任务（每5分钟发布一次）

### 阶段二：License Client

1. 实现 License Client（订阅 NATS 主题）
2. 实现密钥获取逻辑（从 NATS 或本地）
3. 实现密钥保存逻辑（保存到本地文件）
4. 实现密钥解密和验证逻辑

### 阶段三：各服务集成

1. app-server 集成 License Client
2. agent-server 集成 License Client
3. app-runtime 集成 License Client
4. 其他服务集成 License Client

---

## 🎯 总结

### 核心设计

1. **NATS 只用于密钥分发**：License 服务通过 NATS 分发加密的 License 密钥
2. **本地保存**：各实例获取密钥后保存到本地
3. **自行验证**：各实例使用本地密钥自行验证，不依赖 NATS
4. **防止模拟**：即使有人模拟 NATS 消息，因为没有加密密钥，无法解密

### 关键优势

- ✅ **更安全**：即使有人模拟 NATS 消息，因为没有加密密钥，无法破解
- ✅ **无单点问题**：获取到密钥后，后续验证不依赖 NATS
- ✅ **简化实现**：各实例只需在启动时获取一次密钥
- ✅ **适合集群**：新实例启动时自动从 NATS 获取密钥

---

## 📞 参考

- [License 密钥分发详细设计方案](./LICENSE_DISTRIBUTION_DESIGN.md)
- [企业部署设计方案](./ENTERPRISE_DEPLOYMENT_DESIGN.md)

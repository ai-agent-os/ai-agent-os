# License å¯†é’¥åˆ†å‘æ–¹æ¡ˆï¼ˆåŸºäº NATSï¼‰

## ğŸ¯ æ ¸å¿ƒè®¾è®¡

**NATS åªç”¨äºå¯†é’¥åˆ†å‘ï¼Œå„å®ä¾‹æœ¬åœ°ä¿å­˜å¹¶è‡ªè¡ŒéªŒè¯**

- âœ… **NATS åˆ†å‘å¯†é’¥**ï¼šLicense æœåŠ¡é€šè¿‡ NATS åˆ†å‘ License å¯†é’¥
- âœ… **æœ¬åœ°ä¿å­˜**ï¼šå„å®ä¾‹è·å–å¯†é’¥åä¿å­˜åˆ°æœ¬åœ°
- âœ… **è‡ªè¡ŒéªŒè¯**ï¼šå„å®ä¾‹ä½¿ç”¨æœ¬åœ°å¯†é’¥è‡ªè¡ŒéªŒè¯ï¼Œä¸ä¾èµ– NATS
- âœ… **é˜²æ­¢æ¨¡æ‹Ÿ**ï¼šå³ä½¿æœ‰äººæ¨¡æ‹Ÿ NATS æ¶ˆæ¯ï¼Œå› ä¸ºæ²¡æœ‰å¯†é’¥ï¼Œæ— æ³•ç ´è§£
- âœ… **æ— å•ç‚¹é—®é¢˜**ï¼šè·å–åˆ°å¯†é’¥åï¼Œåç»­éªŒè¯ä¸ä¾èµ– NATS

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    License æœåŠ¡                          â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  License Manager                             â”‚      â”‚
â”‚  â”‚  - è¯»å– License æ–‡ä»¶                         â”‚      â”‚
â”‚  â”‚  - éªŒè¯ Licenseï¼ˆç­¾åã€è¿‡æœŸã€éƒ¨ç½²IDç­‰ï¼‰       â”‚      â”‚
â”‚  â”‚  - åŠ å¯† License å¯†é’¥                         â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                    â”‚                                    â”‚
â”‚                    â”‚ NATS å‘å¸ƒï¼ˆä»…åˆ†å‘å¯†é’¥ï¼‰            â”‚
â”‚                    â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  NATS ä¸»é¢˜ï¼šlicense.key                      â”‚      â”‚
â”‚  â”‚  - å‘å¸ƒåŠ å¯†çš„ License å¯†é’¥                   â”‚      â”‚
â”‚  â”‚  - å®šæœŸå‘å¸ƒï¼ˆç¡®ä¿æ–°å®ä¾‹èƒ½è·å–ï¼‰              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ NATS è®¢é˜…ï¼ˆä»…è·å–å¯†é’¥ï¼‰
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ‰€æœ‰æœåŠ¡å®ä¾‹ï¼ˆè·å–å¯†é’¥åæœ¬åœ°éªŒè¯ï¼‰            â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚app-serverâ”‚  â”‚agent-serverâ”‚ â”‚app-runtimeâ”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â”‚
â”‚       â”‚             â”‚             â”‚                   â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                    â”‚                                   â”‚
â”‚                    â”‚ è®¢é˜…ä¸»é¢˜ï¼šlicense.key             â”‚
â”‚                    â†“                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  License Client                               â”‚     â”‚
â”‚  â”‚  - è®¢é˜…è·å–å¯†é’¥                               â”‚     â”‚
â”‚  â”‚  - ä¿å­˜å¯†é’¥åˆ°æœ¬åœ°                             â”‚     â”‚
â”‚  â”‚  - ä½¿ç”¨æœ¬åœ°å¯†é’¥è‡ªè¡ŒéªŒè¯                       â”‚     â”‚
â”‚  â”‚  - å¦‚æœæ— æ³•è·å–å¯†é’¥ï¼Œé»˜è®¤ç¤¾åŒºç‰ˆ               â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” å¯†é’¥åˆ†å‘è®¾è®¡

### å¯†é’¥æ ¼å¼

**åŠ å¯†çš„ License å¯†é’¥**ï¼š
- License æœåŠ¡è¯»å– License æ–‡ä»¶
- ä½¿ç”¨**å¯¹ç§°åŠ å¯†**ï¼ˆAESï¼‰åŠ å¯†æ•´ä¸ª License å†…å®¹
- é€šè¿‡ NATS å‘å¸ƒåŠ å¯†åçš„å¯†é’¥

**å¯†é’¥åŠ å¯†æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ **AES-256-GCM** åŠ å¯†
- å¯†é’¥æ´¾ç”Ÿï¼šä» License æœåŠ¡é…ç½®çš„å¯†é’¥æ´¾ç”Ÿï¼ˆæˆ–ä½¿ç”¨é¢„å…±äº«å¯†é’¥ï¼‰
- æˆ–è€…ï¼šä½¿ç”¨ License æœåŠ¡çš„ç§é’¥ç­¾åï¼Œå„å®ä¾‹ç”¨å…¬é’¥éªŒè¯

---

### NATS ä¸»é¢˜è®¾è®¡

**ä¸»é¢˜åç§°**ï¼š`license.key`

**æ¶ˆæ¯æ ¼å¼**ï¼š

```go
// pkg/license/message.go

// LicenseKeyMessage License å¯†é’¥æ¶ˆæ¯
type LicenseKeyMessage struct {
    // åŠ å¯†çš„ License å†…å®¹ï¼ˆBase64 ç¼–ç ï¼‰
    EncryptedLicense string `json:"encrypted_license"`
    
    // åŠ å¯†ç®—æ³•ï¼ˆå¦‚ "aes-256-gcm"ï¼‰
    Algorithm string `json:"algorithm"`
    
    // æ—¶é—´æˆ³
    Timestamp int64 `json:"timestamp"`
}
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### 1. License æœåŠ¡å¯åŠ¨

```
License æœåŠ¡å¯åŠ¨
  â†“
è¿æ¥ NATS
  â†“
è¯»å– License æ–‡ä»¶
  â†“
éªŒè¯ Licenseï¼ˆç­¾åã€è¿‡æœŸç­‰ï¼‰
  â†“
åŠ å¯† License å†…å®¹ï¼ˆAES-256-GCMï¼‰
  â†“
å‘å¸ƒåŠ å¯†çš„ License å¯†é’¥åˆ° NATSï¼ˆä¸»é¢˜ï¼šlicense.keyï¼‰
  â†“
å®šæœŸå‘å¸ƒï¼ˆæ¯5åˆ†é’Ÿï¼Œç¡®ä¿æ–°å®ä¾‹èƒ½è·å–ï¼‰
```

---

### 2. æœåŠ¡å®ä¾‹å¯åŠ¨

```
æœåŠ¡å®ä¾‹å¯åŠ¨
  â†“
è¿æ¥ NATS
  â”œâ”€ æˆåŠŸï¼šç»§ç»­
  â””â”€ å¤±è´¥ï¼šé»˜è®¤ç¤¾åŒºç‰ˆï¼ˆä¸è·å–å¯†é’¥ï¼‰
  â†“
æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰å¯†é’¥æ–‡ä»¶
  â”œâ”€ æœ‰ï¼šä½¿ç”¨æœ¬åœ°å¯†é’¥éªŒè¯
  â””â”€ æ— ï¼šä» NATS è·å–å¯†é’¥
       â”œâ”€ æˆåŠŸï¼šä¿å­˜åˆ°æœ¬åœ°ï¼Œä½¿ç”¨å¯†é’¥éªŒè¯
       â””â”€ å¤±è´¥ï¼šé»˜è®¤ç¤¾åŒºç‰ˆ
  â†“
ä½¿ç”¨æœ¬åœ°å¯†é’¥è‡ªè¡ŒéªŒè¯
  â”œâ”€ æœ‰æ•ˆï¼šå¯ç”¨ä¼ä¸šåŠŸèƒ½
  â””â”€ æ— æ•ˆï¼šé™çº§åˆ°ç¤¾åŒºç‰ˆ
```

---

### 3. æ–°å¢å®ä¾‹å¯åŠ¨

```
æ–°å¢å®ä¾‹å¯åŠ¨
  â†“
è¿æ¥ NATS
  â†“
è®¢é˜… license.key ä¸»é¢˜ï¼ˆç­‰å¾…å¯†é’¥ï¼‰
  â†“
æ”¶åˆ°å¯†é’¥æ¶ˆæ¯
  â†“
ä¿å­˜å¯†é’¥åˆ°æœ¬åœ°
  â†“
ä½¿ç”¨æœ¬åœ°å¯†é’¥è‡ªè¡ŒéªŒè¯
  â”œâ”€ æœ‰æ•ˆï¼šå¯ç”¨ä¼ä¸šåŠŸèƒ½
  â””â”€ æ— æ•ˆï¼šé™çº§åˆ°ç¤¾åŒºç‰ˆ
```

---

## ğŸ’» å®ç°æ–¹æ¡ˆ

### 1. License æœåŠ¡ï¼ˆå¯†é’¥åˆ†å‘ï¼‰

```go
// core/license-server/server/server.go

// Server License æœåŠ¡
type Server struct {
    manager      *license.Manager
    natsConn     *nats.Conn
    licensePath  string
    encryptionKey []byte  // AES åŠ å¯†å¯†é’¥
    ticker       *time.Ticker
}

// NewServer åˆ›å»º License æœåŠ¡
func NewServer(natsURL, licensePath string, encryptionKey []byte) (*Server, error) {
    conn, err := nats.Connect(natsURL)
    if err != nil {
        return nil, err
    }
    
    manager := license.NewManager()
    
    server := &Server{
        manager: manager,
        natsConn: conn,
        licensePath: licensePath,
        encryptionKey: encryptionKey,
    }
    
    return server, nil
}

// Start å¯åŠ¨æœåŠ¡
func (s *Server) Start(ctx context.Context) error {
    // 1. åŠ è½½ License
    if err := s.loadLicense(); err != nil {
        logger.Warnf(ctx, "[License Service] Failed to load license: %v", err)
        return nil // å³ä½¿åŠ è½½å¤±è´¥ï¼Œä¹Ÿè¦ç»§ç»­è¿è¡Œï¼ˆç¤¾åŒºç‰ˆï¼‰
    }
    
    // 2. å‘å¸ƒåˆå§‹å¯†é’¥
    s.publishLicenseKey()
    
    // 3. å¯åŠ¨å®šæœŸä»»åŠ¡ï¼ˆæ¯5åˆ†é’Ÿå‘å¸ƒä¸€æ¬¡ï¼Œç¡®ä¿æ–°å®ä¾‹èƒ½è·å–ï¼‰
    s.ticker = time.NewTicker(5 * time.Minute)
    go s.startPeriodicTasks(ctx)
    
    return nil
}

// loadLicense åŠ è½½ License
func (s *Server) loadLicense() error {
    return s.manager.LoadLicense(s.licensePath)
}

// publishLicenseKey å‘å¸ƒ License å¯†é’¥
func (s *Server) publishLicenseKey() {
    lic := s.manager.GetLicense()
    if lic == nil {
        // æ²¡æœ‰ Licenseï¼Œä¸å‘å¸ƒå¯†é’¥ï¼ˆç¤¾åŒºç‰ˆï¼‰
        return
    }
    
    // åºåˆ—åŒ– License
    licenseData, err := json.Marshal(lic)
    if err != nil {
        logger.Errorf(nil, "[License Service] Failed to marshal license: %v", err)
        return
    }
    
    // åŠ å¯† License
    encrypted, err := s.encryptLicense(licenseData)
    if err != nil {
        logger.Errorf(nil, "[License Service] Failed to encrypt license: %v", err)
        return
    }
    
    // æ„å»ºæ¶ˆæ¯
    msg := &license.LicenseKeyMessage{
        EncryptedLicense: base64.StdEncoding.EncodeToString(encrypted),
        Algorithm: "aes-256-gcm",
        Timestamp: time.Now().Unix(),
    }
    
    // å‘å¸ƒåˆ° NATS
    data, _ := json.Marshal(msg)
    s.natsConn.Publish("license.key", data)
    
    logger.Infof(nil, "[License Service] Published license key to NATS")
}

// encryptLicense åŠ å¯† License
func (s *Server) encryptLicense(data []byte) ([]byte, error) {
    // ä½¿ç”¨ AES-256-GCM åŠ å¯†
    block, err := aes.NewCipher(s.encryptionKey)
    if err != nil {
        return nil, err
    }
    
    gcm, err := cipher.NewGCM(block)
    if err != nil {
        return nil, err
    }
    
    nonce := make([]byte, gcm.NonceSize())
    if _, err := io.ReadFull(rand.Reader, nonce); err != nil {
        return nil, err
    }
    
    ciphertext := gcm.Seal(nonce, nonce, data, nil)
    return ciphertext, nil
}

// startPeriodicTasks å¯åŠ¨å®šæœŸä»»åŠ¡
func (s *Server) startPeriodicTasks(ctx context.Context) {
    for {
        select {
        case <-s.ticker.C:
            // å®šæœŸå‘å¸ƒå¯†é’¥ï¼ˆç¡®ä¿æ–°å®ä¾‹èƒ½è·å–ï¼‰
            s.publishLicenseKey()
            
            // æ£€æŸ¥ License æ˜¯å¦è¿‡æœŸ
            lic := s.manager.GetLicense()
            if lic != nil && !lic.IsValid() {
                logger.Warnf(nil, "[License Service] License expired, stopping key distribution")
                // License è¿‡æœŸï¼Œåœæ­¢åˆ†å‘å¯†é’¥
                return
            }
            
        case <-ctx.Done():
            return
        }
    }
}
```

---

### 2. License Clientï¼ˆå„æœåŠ¡å®ä¾‹ï¼‰

```go
// pkg/license/client.go

// Client License å®¢æˆ·ç«¯
type Client struct {
    natsConn     *nats.Conn
    subscription *nats.Subscription
    manager      *Manager
    keyPath      string  // æœ¬åœ°å¯†é’¥æ–‡ä»¶è·¯å¾„
    encryptionKey []byte // AES è§£å¯†å¯†é’¥ï¼ˆä¸ License æœåŠ¡ç›¸åŒï¼‰
    mu           sync.RWMutex
}

// NewClient åˆ›å»º License å®¢æˆ·ç«¯
func NewClient(natsURL, keyPath string, encryptionKey []byte) (*Client, error) {
    // è¿æ¥ NATS
    conn, err := nats.Connect(natsURL)
    if err != nil {
        // æ— æ³•è¿æ¥ NATSï¼Œè¿”å› nilï¼ˆè§†ä¸ºç¤¾åŒºç‰ˆï¼‰
        logger.Warnf(nil, "[License Client] Failed to connect to NATS: %v, using community edition", err)
        return nil, nil
    }
    
    manager := NewManager()
    
    client := &Client{
        natsConn: conn,
        manager: manager,
        keyPath: keyPath,
        encryptionKey: encryptionKey,
    }
    
    // 1. å…ˆå°è¯•ä»æœ¬åœ°åŠ è½½å¯†é’¥
    if err := client.loadLocalKey(); err == nil {
        // æœ¬åœ°æœ‰å¯†é’¥ï¼Œä½¿ç”¨æœ¬åœ°å¯†é’¥éªŒè¯
        logger.Infof(nil, "[License Client] Loaded license key from local file")
        return client, nil
    }
    
    // 2. æœ¬åœ°æ²¡æœ‰å¯†é’¥ï¼Œä» NATS è·å–
    if err := client.fetchKeyFromNATS(); err != nil {
        // æ— æ³•è·å–å¯†é’¥ï¼Œè¿”å› nilï¼ˆè§†ä¸ºç¤¾åŒºç‰ˆï¼‰
        logger.Warnf(nil, "[License Client] Failed to fetch license key from NATS: %v, using community edition", err)
        conn.Close()
        return nil, nil
    }
    
    // 3. è®¢é˜…ä¸»é¢˜ï¼ˆç”¨äºæ¥æ”¶å¯†é’¥æ›´æ–°ï¼‰
    sub, err := conn.Subscribe("license.key", client.handleKeyMessage)
    if err != nil {
        conn.Close()
        return nil, err
    }
    
    client.subscription = sub
    
    return client, nil
}

// loadLocalKey ä»æœ¬åœ°åŠ è½½å¯†é’¥
func (c *Client) loadLocalKey() error {
    data, err := os.ReadFile(c.keyPath)
    if err != nil {
        return err
    }
    
    // è§£å¯†å¹¶éªŒè¯
    return c.setLicenseFromEncrypted(data)
}

// fetchKeyFromNATS ä» NATS è·å–å¯†é’¥
func (c *Client) fetchKeyFromNATS() error {
    // è®¢é˜…ä¸»é¢˜ï¼Œç­‰å¾…å¯†é’¥æ¶ˆæ¯
    sub, err := c.natsConn.SubscribeSync("license.key")
    if err != nil {
        return err
    }
    defer sub.Unsubscribe()
    
    // ç­‰å¾…æ¶ˆæ¯ï¼ˆè¶…æ—¶10ç§’ï¼‰
    msg, err := sub.NextMsg(10 * time.Second)
    if err != nil {
        return err
    }
    
    // å¤„ç†å¯†é’¥æ¶ˆæ¯
    return c.handleKeyMessage(msg)
}

// handleKeyMessage å¤„ç†å¯†é’¥æ¶ˆæ¯
func (c *Client) handleKeyMessage(msg *nats.Msg) {
    var keyMsg LicenseKeyMessage
    if err := json.Unmarshal(msg.Data, &keyMsg); err != nil {
        return
    }
    
    // è§£ç åŠ å¯†çš„ License
    encrypted, err := base64.StdEncoding.DecodeString(keyMsg.EncryptedLicense)
    if err != nil {
        return
    }
    
    // è§£å¯†å¹¶è®¾ç½® License
    if err := c.setLicenseFromEncrypted(encrypted); err != nil {
        logger.Errorf(nil, "[License Client] Failed to decrypt license: %v", err)
        return
    }
    
    // ä¿å­˜åˆ°æœ¬åœ°
    if err := os.WriteFile(c.keyPath, encrypted, 0600); err != nil {
        logger.Warnf(nil, "[License Client] Failed to save license key to local: %v", err)
    } else {
        logger.Infof(nil, "[License Client] Saved license key to local file")
    }
}

// setLicenseFromEncrypted ä»åŠ å¯†æ•°æ®è®¾ç½® License
func (c *Client) setLicenseFromEncrypted(encrypted []byte) error {
    // è§£å¯†
    decrypted, err := c.decryptLicense(encrypted)
    if err != nil {
        return err
    }
    
    // è§£æ License
    var lic License
    if err := json.Unmarshal(decrypted, &lic); err != nil {
        return err
    }
    
    // éªŒè¯ Licenseï¼ˆç­¾åã€è¿‡æœŸç­‰ï¼‰
    if err := c.manager.validateLicense(&lic); err != nil {
        return err
    }
    
    // è®¾ç½® License
    c.manager.setLicense(&lic)
    
    return nil
}

// decryptLicense è§£å¯† License
func (c *Client) decryptLicense(encrypted []byte) ([]byte, error) {
    block, err := aes.NewCipher(c.encryptionKey)
    if err != nil {
        return nil, err
    }
    
    gcm, err := cipher.NewGCM(block)
    if err != nil {
        return nil, err
    }
    
    nonceSize := gcm.NonceSize()
    if len(encrypted) < nonceSize {
        return nil, fmt.Errorf("ciphertext too short")
    }
    
    nonce, ciphertext := encrypted[:nonceSize], encrypted[nonceSize:]
    plaintext, err := gcm.Open(nil, nonce, ciphertext, nil)
    if err != nil {
        return nil, err
    }
    
    return plaintext, nil
}
```

---

## ğŸ” å®‰å…¨è®¾è®¡

### 1. å¯†é’¥åŠ å¯†

**æ–¹æ¡ˆAï¼šå¯¹ç§°åŠ å¯†ï¼ˆAES-256-GCMï¼‰**ï¼ˆæ¨èï¼‰

- âœ… License æœåŠ¡å’Œå„å®ä¾‹å…±äº«åŒä¸€ä¸ªåŠ å¯†å¯†é’¥
- âœ… å¯†é’¥é€šè¿‡é…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡é…ç½®
- âœ… åŠ å¯†åçš„å¯†é’¥é€šè¿‡ NATS åˆ†å‘

**æ–¹æ¡ˆBï¼šéå¯¹ç§°åŠ å¯†ï¼ˆRSAï¼‰**

- âœ… License æœåŠ¡ä½¿ç”¨ç§é’¥ç­¾å
- âœ… å„å®ä¾‹ä½¿ç”¨å…¬é’¥éªŒè¯
- âœ… å…¬é’¥å¯ä»¥åµŒå…¥åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­

---

### 2. é˜²æ­¢æ¨¡æ‹Ÿ NATS æ¶ˆæ¯

**é˜²æŠ¤æªæ–½**ï¼š
- âœ… **å¯†é’¥åŠ å¯†**ï¼šå³ä½¿æœ‰äººæ¨¡æ‹Ÿ NATS æ¶ˆæ¯ï¼Œå› ä¸ºæ²¡æœ‰åŠ å¯†å¯†é’¥ï¼Œæ— æ³•è§£å¯†
- âœ… **æœ¬åœ°éªŒè¯**ï¼šå„å®ä¾‹è·å–å¯†é’¥åï¼Œä½¿ç”¨æœ¬åœ°å¯†é’¥è‡ªè¡ŒéªŒè¯ï¼ˆRSA ç­¾åéªŒè¯ï¼‰
- âœ… **å¯†é’¥æ–‡ä»¶æƒé™**ï¼šæœ¬åœ°å¯†é’¥æ–‡ä»¶è®¾ç½®ä¸¥æ ¼æƒé™ï¼ˆ0600ï¼‰

---

### 3. å¯†é’¥å­˜å‚¨

**æœ¬åœ°å¯†é’¥æ–‡ä»¶è·¯å¾„**ï¼š
- ä¼˜å…ˆçº§1ï¼šç¯å¢ƒå˜é‡ `LICENSE_KEY_PATH`
- ä¼˜å…ˆçº§2ï¼š`~/.ai-agent-os/license.key`
- ä¼˜å…ˆçº§3ï¼š`./license.key`

**æ–‡ä»¶æƒé™**ï¼š`0600`ï¼ˆä»…æ‰€æœ‰è€…å¯è¯»å†™ï¼‰

---

## ğŸ¯ ä¼˜åŠ¿åˆ†æ

### âœ… ä¼˜åŠ¿

1. **æ›´å®‰å…¨**
   - å³ä½¿æœ‰äººæ¨¡æ‹Ÿ NATS æ¶ˆæ¯ï¼Œå› ä¸ºæ²¡æœ‰åŠ å¯†å¯†é’¥ï¼Œæ— æ³•è§£å¯†
   - å„å®ä¾‹ä½¿ç”¨æœ¬åœ°å¯†é’¥è‡ªè¡ŒéªŒè¯ï¼Œä¸ä¾èµ– NATS çŠ¶æ€

2. **æ— å•ç‚¹é—®é¢˜**
   - è·å–åˆ°å¯†é’¥åï¼Œåç»­éªŒè¯ä¸ä¾èµ– NATS
   - å³ä½¿ NATS æŒ‚äº†ï¼Œå„å®ä¾‹ä»å¯ä½¿ç”¨æœ¬åœ°å¯†é’¥éªŒè¯

3. **ç®€åŒ–å®ç°**
   - å„å®ä¾‹åªéœ€åœ¨å¯åŠ¨æ—¶è·å–ä¸€æ¬¡å¯†é’¥
   - åç»­éªŒè¯å®Œå…¨æœ¬åœ°åŒ–ï¼Œæ— éœ€æŒç»­è¿æ¥ NATS

4. **é€‚åˆé›†ç¾¤**
   - æ–°å®ä¾‹å¯åŠ¨æ—¶è‡ªåŠ¨ä» NATS è·å–å¯†é’¥
   - æ— éœ€å…±äº«å­˜å‚¨ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®

---

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **åŠ å¯†å¯†é’¥ç®¡ç†**
   - License æœåŠ¡å’Œå„å®ä¾‹éœ€è¦å…±äº«åŒä¸€ä¸ªåŠ å¯†å¯†é’¥
   - å¯†é’¥å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡é…ç½®
   - å»ºè®®ä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡ï¼ˆå¦‚ Vaultï¼‰

2. **å¯†é’¥æ›´æ–°**
   - License æ–‡ä»¶æ›´æ–°æ—¶ï¼ŒLicense æœåŠ¡ä¼šå‘å¸ƒæ–°çš„å¯†é’¥
   - å„å®ä¾‹æ”¶åˆ°æ–°å¯†é’¥åï¼Œä¼šæ›´æ–°æœ¬åœ°å¯†é’¥æ–‡ä»¶

3. **å¯†é’¥æ³„éœ²**
   - å¦‚æœå¯†é’¥æ³„éœ²ï¼Œéœ€è¦é‡æ–°ç”Ÿæˆå¯†é’¥å¹¶é‡æ–°åˆ†å‘
   - å»ºè®®å®šæœŸè½®æ¢å¯†é’¥

---

## ğŸ“‹ å®æ–½ Checklist

### License æœåŠ¡

- [ ] åˆ›å»º `core/license-server` ç›®å½•ç»“æ„
- [ ] å®ç° License æœåŠ¡ï¼ˆè¯»å–ã€éªŒè¯ã€åŠ å¯†ï¼‰
- [ ] å®ç° NATS å‘å¸ƒé€»è¾‘ï¼ˆå¯†é’¥åˆ†å‘ï¼‰
- [ ] å®ç°å®šæœŸä»»åŠ¡ï¼ˆæ¯5åˆ†é’Ÿå‘å¸ƒä¸€æ¬¡ï¼‰

### License Client

- [ ] å®ç° License Clientï¼ˆè®¢é˜… NATS ä¸»é¢˜ï¼‰
- [ ] å®ç°å¯†é’¥è·å–é€»è¾‘ï¼ˆä» NATS æˆ–æœ¬åœ°ï¼‰
- [ ] å®ç°å¯†é’¥ä¿å­˜é€»è¾‘ï¼ˆä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ï¼‰
- [ ] å®ç°å¯†é’¥è§£å¯†å’ŒéªŒè¯é€»è¾‘

### å„æœåŠ¡é›†æˆ

- [ ] app-server é›†æˆ License Client
- [ ] agent-server é›†æˆ License Client
- [ ] app-runtime é›†æˆ License Client
- [ ] å…¶ä»–æœåŠ¡é›†æˆ License Client

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒè®¾è®¡

1. **NATS åªç”¨äºå¯†é’¥åˆ†å‘**ï¼šLicense æœåŠ¡é€šè¿‡ NATS åˆ†å‘åŠ å¯†çš„ License å¯†é’¥
2. **æœ¬åœ°ä¿å­˜**ï¼šå„å®ä¾‹è·å–å¯†é’¥åä¿å­˜åˆ°æœ¬åœ°
3. **è‡ªè¡ŒéªŒè¯**ï¼šå„å®ä¾‹ä½¿ç”¨æœ¬åœ°å¯†é’¥è‡ªè¡ŒéªŒè¯ï¼Œä¸ä¾èµ– NATS
4. **é˜²æ­¢æ¨¡æ‹Ÿ**ï¼šå³ä½¿æœ‰äººæ¨¡æ‹Ÿ NATS æ¶ˆæ¯ï¼Œå› ä¸ºæ²¡æœ‰åŠ å¯†å¯†é’¥ï¼Œæ— æ³•è§£å¯†

### å…³é”®ä¼˜åŠ¿

- âœ… **æ›´å®‰å…¨**ï¼šå³ä½¿æœ‰äººæ¨¡æ‹Ÿ NATS æ¶ˆæ¯ï¼Œå› ä¸ºæ²¡æœ‰åŠ å¯†å¯†é’¥ï¼Œæ— æ³•ç ´è§£
- âœ… **æ— å•ç‚¹é—®é¢˜**ï¼šè·å–åˆ°å¯†é’¥åï¼Œåç»­éªŒè¯ä¸ä¾èµ– NATS
- âœ… **ç®€åŒ–å®ç°**ï¼šå„å®ä¾‹åªéœ€åœ¨å¯åŠ¨æ—¶è·å–ä¸€æ¬¡å¯†é’¥
- âœ… **é€‚åˆé›†ç¾¤**ï¼šæ–°å®ä¾‹å¯åŠ¨æ—¶è‡ªåŠ¨ä» NATS è·å–å¯†é’¥

---

## ğŸ“ å‚è€ƒ

- [ä¼ä¸šéƒ¨ç½²è®¾è®¡æ–¹æ¡ˆ](./ENTERPRISE_DEPLOYMENT_DESIGN.md)
- [è®¾è®¡æ–¹æ¡ˆæ€»ç»“](./DESIGN_SUMMARY.md)

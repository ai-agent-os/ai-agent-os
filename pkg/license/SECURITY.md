# License å®‰å…¨é˜²æŠ¤æ–¹æ¡ˆï¼ˆä¼ä¸šéƒ¨ç½²åœºæ™¯ï¼‰

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

**é˜²æ­¢ License è¢«ç ´è§£ï¼Œä¿æŠ¤ä¼ä¸šç‰ˆåŠŸèƒ½ä¸è¢«éæ³•ä½¿ç”¨**

**é‡è¦è¯´æ˜**ï¼š
- âœ… è¿™æ˜¯**ä¼ä¸šéƒ¨ç½²**ï¼Œä¸æ˜¯å•æœºè½¯ä»¶
- âœ… å¯èƒ½æ˜¯**å•æœºéƒ¨ç½²**ï¼Œä¹Ÿå¯èƒ½æ˜¯**é›†ç¾¤éƒ¨ç½²**
- âœ… License éªŒè¯æ˜¯**éƒ¨ç½²çº§**çš„ï¼Œä¸æ˜¯æœåŠ¡çº§çš„
- âœ… å¤šä¸ªæœåŠ¡å…±äº«åŒä¸€ä¸ª License

---

## ğŸ—ï¸ éƒ¨ç½²åœºæ™¯

### å•æœºéƒ¨ç½²

```
æ‰€æœ‰æœåŠ¡åœ¨åŒä¸€å°æœºå™¨
License æ–‡ä»¶ï¼š./license.json
```

### é›†ç¾¤éƒ¨ç½²

```
å¤šä¸ªæœåŠ¡åˆ†å¸ƒåœ¨å¤šå°æœºå™¨
License æ–‡ä»¶ï¼š/shared/license.jsonï¼ˆå…±äº«å­˜å‚¨ï¼‰
```

---

## ğŸ” å¸¸è§ç ´è§£æ–¹å¼åˆ†æ

### 1. ä¿®æ”¹ License æ–‡ä»¶

**ç ´è§£æ–¹å¼**ï¼š
- ä¿®æ”¹è¿‡æœŸæ—¶é—´ï¼ˆ`expires_at`ï¼‰
- ä¿®æ”¹åŠŸèƒ½å¼€å…³ï¼ˆ`features`ï¼‰
- ä¿®æ”¹èµ„æºé™åˆ¶ï¼ˆ`max_apps`ã€`max_users`ï¼‰

**é˜²æŠ¤æªæ–½**ï¼š
- âœ… **RSA ç­¾åéªŒè¯**ï¼ˆå·²å®ç°ï¼‰
- âœ… **ç­¾åéªŒè¯å¤±è´¥ä¼šæ‹’ç» License**

---

### 2. ç»•è¿‡ç­¾åéªŒè¯

**ç ´è§£æ–¹å¼**ï¼š
- ä¿®æ”¹éªŒè¯ä»£ç ï¼Œè·³è¿‡ç­¾åæ£€æŸ¥
- æ›¿æ¢å…¬é’¥æ–‡ä»¶
- ä¿®æ”¹å…¬é’¥åŠ è½½é€»è¾‘

**é˜²æŠ¤æªæ–½**ï¼š
- âš ï¸ **ä»£ç æ··æ·†**ï¼ˆéœ€è¦å®ç°ï¼‰
- âš ï¸ **åè°ƒè¯•**ï¼ˆéœ€è¦å®ç°ï¼‰
- âš ï¸ **å…¬é’¥åµŒå…¥**ï¼ˆéœ€è¦å®ç°ï¼‰

---

### 3. ä¿®æ”¹ä»£ç é€»è¾‘

**ç ´è§£æ–¹å¼**ï¼š
- ä¿®æ”¹ `HasFeature()` æ–¹æ³•ï¼Œæ€»æ˜¯è¿”å› `true`
- ä¿®æ”¹ `IsEnterprise()` æ–¹æ³•ï¼Œæ€»æ˜¯è¿”å› `true`
- è·³è¿‡ License æ£€æŸ¥

**é˜²æŠ¤æªæ–½**ï¼š
- âš ï¸ **ä»£ç æ··æ·†**ï¼ˆéœ€è¦å®ç°ï¼‰
- âš ï¸ **åè°ƒè¯•**ï¼ˆéœ€è¦å®ç°ï¼‰
- âš ï¸ **å…³é”®é€»è¾‘åŠ å¯†**ï¼ˆéœ€è¦å®ç°ï¼‰

---

### 4. æ—¶é—´å›é€€

**ç ´è§£æ–¹å¼**ï¼š
- ä¿®æ”¹ç³»ç»Ÿæ—¶é—´ï¼Œç»•è¿‡è¿‡æœŸæ£€æŸ¥
- ä½¿ç”¨æ—¶é—´å›é€€å·¥å…·

**é˜²æŠ¤æªæ–½**ï¼š
- âš ï¸ **åœ¨çº¿æ—¶é—´éªŒè¯**ï¼ˆéœ€è¦å®ç°ï¼‰
- âš ï¸ **æ—¶é—´æˆ³éªŒè¯**ï¼ˆéœ€è¦å®ç°ï¼‰

---

### 5. ç¡¬ä»¶IDä¼ªé€ 

**ç ´è§£æ–¹å¼**ï¼š
- ä¿®æ”¹ç¡¬ä»¶IDç”Ÿæˆé€»è¾‘
- ä¼ªé€ ç¡¬ä»¶ID

**é˜²æŠ¤æªæ–½**ï¼š
- âš ï¸ **ç¡¬ä»¶æŒ‡çº¹ç®—æ³•**ï¼ˆéœ€è¦å®ç°ï¼‰
- âš ï¸ **å¤šé‡ç¡¬ä»¶ä¿¡æ¯**ï¼ˆéœ€è¦å®ç°ï¼‰

---

## ğŸ›¡ï¸ å¤šå±‚é˜²æŠ¤æ–¹æ¡ˆ

### ç¬¬ä¸€å±‚ï¼šRSA ç­¾åéªŒè¯ï¼ˆå·²å®ç°ï¼‰âœ…

**é˜²æŠ¤èƒ½åŠ›**ï¼šâ­â­â­â­ï¼ˆé«˜ï¼‰

**å®ç°**ï¼š
- License æ–‡ä»¶åŒ…å« RSA ç­¾å
- ä½¿ç”¨å…¬é’¥éªŒè¯ç­¾å
- ç­¾åéªŒè¯å¤±è´¥ä¼šæ‹’ç» License

**ä¼˜ç‚¹**ï¼š
- âœ… é˜²æ­¢ä¿®æ”¹ License æ–‡ä»¶
- âœ… é˜²æ­¢ä¼ªé€  License

**ç¼ºç‚¹**ï¼š
- âš ï¸ å¦‚æœå…¬é’¥è¢«æ›¿æ¢ï¼Œå¯èƒ½è¢«ç»•è¿‡
- âš ï¸ å¦‚æœéªŒè¯ä»£ç è¢«ä¿®æ”¹ï¼Œå¯èƒ½è¢«ç»•è¿‡

---

### ç¬¬äºŒå±‚ï¼šéƒ¨ç½²æ ‡è¯†éªŒè¯ï¼ˆæ¨èï¼‰â­â­â­â­

**é˜²æŠ¤èƒ½åŠ›**ï¼šâ­â­â­â­ï¼ˆé«˜ï¼‰

**è®¾è®¡**ï¼š
- âœ… **éƒ¨ç½²çº§éªŒè¯**ï¼šä¸€ä¸ª License å¯¹åº”ä¸€ä¸ªéƒ¨ç½²
- âœ… **éƒ¨ç½²æ ‡è¯†**ï¼šä½¿ç”¨ `deployment_id` æ ‡è¯†éƒ¨ç½²
- âœ… **é˜²æ­¢ License å…±äº«**ï¼šä¸åŒéƒ¨ç½²ä¸èƒ½å…±äº« License

**å®ç°æ–¹æ¡ˆ**ï¼š

```go
// pkg/license/manager.go

// verifyDeploymentID éªŒè¯éƒ¨ç½²æ ‡è¯†
func (m *Manager) verifyDeploymentID(license *License) error {
    // å¦‚æœ License æœ‰ deployment_idï¼ŒéªŒè¯æ˜¯å¦åŒ¹é…
    if license.DeploymentID != "" {
        currentDeploymentID := getDeploymentID()
        if currentDeploymentID != license.DeploymentID {
            return fmt.Errorf("license deployment ID mismatch")
        }
    }
    return nil
}

// getDeploymentID è·å–éƒ¨ç½²æ ‡è¯†
func getDeploymentID() string {
    // ä¼˜å…ˆçº§1ï¼šç¯å¢ƒå˜é‡
    if id := os.Getenv("DEPLOYMENT_ID"); id != "" {
        return id
    }
    
    // ä¼˜å…ˆçº§2ï¼šé…ç½®æ–‡ä»¶
    // ...
    
    // ä¼˜å…ˆçº§3ï¼šKubernetes å‘½åç©ºé—´ï¼ˆå¦‚æœæ˜¯ K8s éƒ¨ç½²ï¼‰
    // ...
    
    return ""
}
```

**é›†ç¾¤éƒ¨ç½²è€ƒè™‘**ï¼š
- âœ… æ‰€æœ‰æœåŠ¡ä½¿ç”¨ç›¸åŒçš„ `DEPLOYMENT_ID`
- âœ… License ä¸­çš„ `deployment_id` å¿…é¡»åŒ¹é…
- âœ… é˜²æ­¢ License åœ¨ä¸åŒéƒ¨ç½²é—´å…±äº«

---

### ç¬¬ä¸‰å±‚ï¼šç¡¬ä»¶ç»‘å®šï¼ˆä»…å•æœºéƒ¨ç½²ï¼‰â­â­â­

**é˜²æŠ¤èƒ½åŠ›**ï¼šâ­â­â­ï¼ˆä¸­ï¼‰

**è®¾è®¡**ï¼š
- âœ… **å•æœºéƒ¨ç½²**ï¼šå¯ç”¨ç¡¬ä»¶ç»‘å®š
- âŒ **é›†ç¾¤éƒ¨ç½²**ï¼šä¸å¯ç”¨ç¡¬ä»¶ç»‘å®šï¼ˆæœåŠ¡å¯èƒ½åœ¨ä¸åŒæœºå™¨ï¼‰

**å®ç°æ–¹æ¡ˆ**ï¼š

```go
// pkg/license/manager.go

// verifyHardwareBinding éªŒè¯ç¡¬ä»¶ç»‘å®š
func (m *Manager) verifyHardwareBinding(license *License) error {
    // å¦‚æœ License æœ‰ hardware_idï¼ŒéªŒè¯æ˜¯å¦åŒ¹é…
    if license.HardwareID != "" {
        // æ£€æŸ¥éƒ¨ç½²ç±»å‹
        if license.DeploymentType == "cluster" {
            // é›†ç¾¤éƒ¨ç½²ï¼šä¸å¯ç”¨ç¡¬ä»¶ç»‘å®š
            return nil
        }
        
        // å•æœºéƒ¨ç½²ï¼šéªŒè¯ç¡¬ä»¶ID
        currentHardwareID := getHardwareID()
        if currentHardwareID != license.HardwareID {
            return fmt.Errorf("license hardware binding mismatch")
        }
    }
    return nil
}

// getHardwareID è·å–ç¡¬ä»¶IDï¼ˆä»…å•æœºéƒ¨ç½²ï¼‰
func getHardwareID() string {
    // åŸºäºå¤šä¸ªç¡¬ä»¶ä¿¡æ¯ç”Ÿæˆå”¯ä¸€ID
    // MAC åœ°å€ã€CPU IDã€ä¸»æ¿åºåˆ—å·ç­‰
    // ...
}
```

---

### ç¬¬ä¸‰å±‚ï¼šåœ¨çº¿éªŒè¯ï¼ˆæ¨èï¼‰â­â­â­â­â­

**é˜²æŠ¤èƒ½åŠ›**ï¼šâ­â­â­â­â­ï¼ˆæé«˜ï¼‰

**å®ç°æ–¹æ¡ˆ**ï¼š
- âœ… **å®šæœŸåœ¨çº¿éªŒè¯**ï¼ˆæ¯å¤©æˆ–æ¯å‘¨ï¼‰
- âœ… **æœåŠ¡å™¨ç«¯éªŒè¯**ï¼ˆLicense æœåŠ¡å™¨ï¼‰
- âœ… **License çŠ¶æ€åŒæ­¥**ï¼ˆæ’¤é”€ã€ç»­æœŸç­‰ï¼‰

**å®ç°æ–¹æ¡ˆ**ï¼š

```go
// pkg/license/online_verify.go
package license

import (
    "context"
    "crypto/tls"
    "encoding/json"
    "fmt"
    "net/http"
    "time"
)

// OnlineVerifier åœ¨çº¿éªŒè¯å™¨
type OnlineVerifier struct {
    verifyURL string
    client    *http.Client
    interval  time.Duration // éªŒè¯é—´éš”
}

// NewOnlineVerifier åˆ›å»ºåœ¨çº¿éªŒè¯å™¨
func NewOnlineVerifier(verifyURL string) *OnlineVerifier {
    return &OnlineVerifier{
        verifyURL: verifyURL,
        client: &http.Client{
            Timeout: 10 * time.Second,
            Transport: &http.Transport{
                TLSClientConfig: &tls.Config{
                    InsecureSkipVerify: false, // éªŒè¯æœåŠ¡å™¨è¯ä¹¦
                },
            },
        },
        interval: 24 * time.Hour, // æ¯24å°æ—¶éªŒè¯ä¸€æ¬¡
    }
}

// VerifyLicense åœ¨çº¿éªŒè¯ License
func (v *OnlineVerifier) VerifyLicense(ctx context.Context, licenseID string) (*VerifyResponse, error) {
    // æ„å»ºéªŒè¯è¯·æ±‚
    req, err := http.NewRequestWithContext(ctx, "POST", v.verifyURL, nil)
    if err != nil {
        return nil, err
    }
    
    // æ·»åŠ  License ID
    req.Header.Set("X-License-ID", licenseID)
    
    // æ·»åŠ ç¡¬ä»¶IDï¼ˆç”¨äºéªŒè¯ï¼‰
    req.Header.Set("X-Hardware-ID", getHardwareID())
    
    // å‘é€è¯·æ±‚
    resp, err := v.client.Do(req)
    if err != nil {
        return nil, fmt.Errorf("failed to verify license online: %w", err)
    }
    defer resp.Body.Close()
    
    // è§£æå“åº”
    var verifyResp VerifyResponse
    if err := json.NewDecoder(resp.Body).Decode(&verifyResp); err != nil {
        return nil, fmt.Errorf("failed to parse verify response: %w", err)
    }
    
    return &verifyResp, nil
}

// VerifyResponse éªŒè¯å“åº”
type VerifyResponse struct {
    Valid      bool      `json:"valid"`       // License æ˜¯å¦æœ‰æ•ˆ
    Revoked    bool      `json:"revoked"`     // License æ˜¯å¦è¢«æ’¤é”€
    ExpiresAt  time.Time `json:"expires_at"`  // è¿‡æœŸæ—¶é—´
    Message    string    `json:"message"`     // æ¶ˆæ¯
}

// StartPeriodicVerify å¯åŠ¨å®šæœŸéªŒè¯
func (v *OnlineVerifier) StartPeriodicVerify(ctx context.Context, licenseID string) {
    ticker := time.NewTicker(v.interval)
    defer ticker.Stop()
    
    for {
        select {
        case <-ctx.Done():
            return
        case <-ticker.C:
            // æ‰§è¡ŒéªŒè¯
            resp, err := v.VerifyLicense(ctx, licenseID)
            if err != nil {
                logger.Warnf(ctx, "[License] Online verification failed: %v", err)
                continue
            }
            
            // æ£€æŸ¥ License çŠ¶æ€
            if resp.Revoked {
                logger.Errorf(ctx, "[License] License has been revoked: %s", resp.Message)
                // å¯ä»¥åœ¨è¿™é‡Œç¦ç”¨ä¼ä¸šåŠŸèƒ½
            }
            
            if !resp.Valid {
                logger.Errorf(ctx, "[License] License is invalid: %s", resp.Message)
                // å¯ä»¥åœ¨è¿™é‡Œç¦ç”¨ä¼ä¸šåŠŸèƒ½
            }
        }
    }
}
```

---

### ç¬¬å››å±‚ï¼šä»£ç æ··æ·†å’Œåè°ƒè¯•ï¼ˆå¯é€‰ï¼‰â­â­â­

**é˜²æŠ¤èƒ½åŠ›**ï¼šâ­â­â­ï¼ˆä¸­ï¼‰

**å®ç°æ–¹æ¡ˆ**ï¼š
- âš ï¸ **ä»£ç æ··æ·†**ï¼ˆä½¿ç”¨å·¥å…·å¦‚ `garble`ï¼‰
- âš ï¸ **åè°ƒè¯•**ï¼ˆæ£€æµ‹è°ƒè¯•å™¨ï¼‰
- âš ï¸ **å…³é”®é€»è¾‘åŠ å¯†**ï¼ˆåŠ å¯† License æ£€æŸ¥é€»è¾‘ï¼‰

**å®ç°æ–¹æ¡ˆ**ï¼š

```go
// pkg/license/anti_debug.go
package license

import (
    "os"
    "runtime"
    "syscall"
)

// IsDebugging æ£€æµ‹æ˜¯å¦åœ¨è°ƒè¯•
func IsDebugging() bool {
    // æ£€æµ‹æ–¹æ³•1ï¼šæ£€æŸ¥çˆ¶è¿›ç¨‹
    ppid := os.Getppid()
    if ppid > 0 {
        // æ£€æŸ¥çˆ¶è¿›ç¨‹åç§°
        // ...
    }
    
    // æ£€æµ‹æ–¹æ³•2ï¼šæ£€æŸ¥è°ƒè¯•å™¨ï¼ˆLinuxï¼‰
    if runtime.GOOS == "linux" {
        // æ£€æŸ¥ /proc/self/status ä¸­çš„ TracerPid
        // ...
    }
    
    // æ£€æµ‹æ–¹æ³•3ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡
    if os.Getenv("GODEBUG") != "" {
        return true
    }
    
    return false
}

// CheckAntiDebug æ£€æŸ¥åè°ƒè¯•
func CheckAntiDebug() error {
    if IsDebugging() {
        return fmt.Errorf("debugging detected, license verification disabled")
    }
    return nil
}
```

---

### ç¬¬äº”å±‚ï¼šæ—¶é—´éªŒè¯ï¼ˆæ¨èï¼‰â­â­â­â­

**é˜²æŠ¤èƒ½åŠ›**ï¼šâ­â­â­â­ï¼ˆé«˜ï¼‰

**å®ç°æ–¹æ¡ˆ**ï¼š
- âœ… **åœ¨çº¿æ—¶é—´éªŒè¯**ï¼ˆä»æœåŠ¡å™¨è·å–æ—¶é—´ï¼‰
- âœ… **æ—¶é—´æˆ³éªŒè¯**ï¼ˆé˜²æ­¢æ—¶é—´å›é€€ï¼‰
- âœ… **æ—¶é—´çª—å£æ£€æŸ¥**ï¼ˆé˜²æ­¢æ—¶é—´è·³è·ƒï¼‰

**å®ç°æ–¹æ¡ˆ**ï¼š

```go
// pkg/license/time_verify.go
package license

import (
    "context"
    "time"
)

// TimeVerifier æ—¶é—´éªŒè¯å™¨
type TimeVerifier struct {
    lastServerTime time.Time
    lastLocalTime  time.Time
    verifyURL      string
}

// VerifyTime éªŒè¯æ—¶é—´ï¼ˆé˜²æ­¢æ—¶é—´å›é€€ï¼‰
func (v *TimeVerifier) VerifyTime(ctx context.Context) error {
    // 1. ä»æœåŠ¡å™¨è·å–æ—¶é—´
    serverTime, err := v.getServerTime(ctx)
    if err != nil {
        // å¦‚æœæ— æ³•è·å–æœåŠ¡å™¨æ—¶é—´ï¼Œä½¿ç”¨æœ¬åœ°æ—¶é—´ï¼ˆä½†è®°å½•è­¦å‘Šï¼‰
        logger.Warnf(ctx, "[License] Failed to get server time, using local time")
        return nil
    }
    
    // 2. æ£€æŸ¥æ—¶é—´æ˜¯å¦å›é€€
    if !v.lastServerTime.IsZero() && serverTime.Before(v.lastServerTime) {
        return fmt.Errorf("time rollback detected, license verification disabled")
    }
    
    // 3. æ£€æŸ¥æ—¶é—´å·®å¼‚ï¼ˆé˜²æ­¢æ—¶é—´è·³è·ƒï¼‰
    localTime := time.Now()
    diff := serverTime.Sub(localTime)
    if diff > 24*time.Hour || diff < -24*time.Hour {
        return fmt.Errorf("time difference too large, license verification disabled")
    }
    
    // 4. æ›´æ–°è®°å½•
    v.lastServerTime = serverTime
    v.lastLocalTime = localTime
    
    return nil
}

// getServerTime ä»æœåŠ¡å™¨è·å–æ—¶é—´
func (v *TimeVerifier) getServerTime(ctx context.Context) (time.Time, error) {
    // ä» License éªŒè¯æœåŠ¡å™¨è·å–æ—¶é—´
    // ...
}
```

---

### ç¬¬å…­å±‚ï¼šæœåŠ¡å™¨ç«¯éªŒè¯ï¼ˆæ¨èï¼‰â­â­â­â­â­

**é˜²æŠ¤èƒ½åŠ›**ï¼šâ­â­â­â­â­ï¼ˆæé«˜ï¼‰

**å®ç°æ–¹æ¡ˆ**ï¼š
- âœ… **License æœåŠ¡å™¨**ï¼ˆé›†ä¸­ç®¡ç†æ‰€æœ‰ Licenseï¼‰
- âœ… **å®šæœŸéªŒè¯**ï¼ˆæ¯å¤©æˆ–æ¯å‘¨ï¼‰
- âœ… **å®æ—¶æ’¤é”€**ï¼ˆå¯ä»¥ç«‹å³æ’¤é”€ Licenseï¼‰
- âœ… **ä½¿ç”¨ç»Ÿè®¡**ï¼ˆç›‘æ§ License ä½¿ç”¨æƒ…å†µï¼‰

**æ¶æ„è®¾è®¡**ï¼š

```
å®¢æˆ·ç«¯
  â†“
å®šæœŸè¯·æ±‚ License æœåŠ¡å™¨
  â†“
License æœåŠ¡å™¨éªŒè¯
  â”œâ”€ License æ˜¯å¦æœ‰æ•ˆ
  â”œâ”€ License æ˜¯å¦è¢«æ’¤é”€
  â”œâ”€ ç¡¬ä»¶IDæ˜¯å¦åŒ¹é…
  â””â”€ ä½¿ç”¨ç»Ÿè®¡
  â†“
è¿”å›éªŒè¯ç»“æœ
  â”œâ”€ æœ‰æ•ˆï¼šç»§ç»­ä½¿ç”¨
  â””â”€ æ— æ•ˆï¼šç¦ç”¨ä¼ä¸šåŠŸèƒ½
```

---

## ğŸ¯ æ¨èæ–¹æ¡ˆï¼ˆä¼ä¸šéƒ¨ç½²åœºæ™¯ï¼‰

### åŸºç¡€é˜²æŠ¤ï¼ˆå¿…é¡»å®ç°ï¼‰â­â­â­â­â­

1. âœ… **RSA ç­¾åéªŒè¯**ï¼ˆå·²å®ç°ï¼‰
2. âœ… **è¿‡æœŸæ£€æŸ¥**ï¼ˆå·²å®ç°ï¼‰
3. âœ… **éƒ¨ç½²æ ‡è¯†éªŒè¯**ï¼ˆéœ€è¦å®ç°ï¼‰

---

### å¢å¼ºé˜²æŠ¤ï¼ˆå¼ºçƒˆæ¨èï¼‰â­â­â­â­

4. âœ… **åœ¨çº¿éªŒè¯**ï¼ˆå®šæœŸéªŒè¯ï¼‰
5. âœ… **æ—¶é—´éªŒè¯**ï¼ˆé˜²æ­¢æ—¶é—´å›é€€ï¼‰

---

### å¯é€‰é˜²æŠ¤ï¼ˆæŒ‰éœ€å¯ç”¨ï¼‰â­â­â­

6. âš ï¸ **ç¡¬ä»¶ç»‘å®š**ï¼ˆä»…å•æœºéƒ¨ç½²ï¼‰
7. âš ï¸ **ä»£ç æ··æ·†**ï¼ˆå¯é€‰ï¼‰
8. âš ï¸ **åè°ƒè¯•**ï¼ˆå¯é€‰ï¼‰

---

## ğŸ’» å®ç°æ–¹æ¡ˆï¼ˆä¼ä¸šéƒ¨ç½²åœºæ™¯ï¼‰

### 1. éƒ¨ç½²æ ‡è¯†éªŒè¯ï¼ˆå¿…é¡»ï¼‰

```go
// pkg/license/hardware.go
package license

import (
    "crypto/sha256"
    "encoding/hex"
    "os"
    "os/exec"
    "runtime"
    "strings"
)

// getHardwareID è·å–ç¡¬ä»¶IDï¼ˆç”¨äºç¡¬ä»¶ç»‘å®šï¼‰
func getHardwareID() string {
    var parts []string
    
    // 1. MAC åœ°å€
    if mac := getMACAddress(); mac != "" {
        parts = append(parts, mac)
    }
    
    // 2. æœºå™¨IDï¼ˆLinuxï¼‰
    if machineID := getMachineID(); machineID != "" {
        parts = append(parts, machineID)
    }
    
    // 3. CPU IDï¼ˆLinuxï¼‰
    if cpuID := getCPUID(); cpuID != "" {
        parts = append(parts, cpuID)
    }
    
    // 4. ä¸»æ¿åºåˆ—å·ï¼ˆLinuxï¼‰
    if boardSerial := getBoardSerial(); boardSerial != "" {
        parts = append(parts, boardSerial)
    }
    
    // 5. ä¸»æœºåï¼ˆfallbackï¼‰
    if len(parts) == 0 {
        if hostname, err := os.Hostname(); err == nil {
            parts = append(parts, hostname)
        }
    }
    
    // ç»„åˆå¹¶å“ˆå¸Œ
    combined := strings.Join(parts, "|")
    hash := sha256.Sum256([]byte(combined))
    return hex.EncodeToString(hash[:16]) // ä½¿ç”¨å‰16å­—èŠ‚
}

// getMACAddress è·å– MAC åœ°å€
func getMACAddress() string {
    if runtime.GOOS == "linux" {
        // Linux: è·å–ç¬¬ä¸€ä¸ªéå›ç¯ç½‘ç»œæ¥å£çš„ MAC åœ°å€
        cmd := exec.Command("sh", "-c", "ip link show | grep -A 1 'state UP' | grep -oP 'link/ether \\K[^ ]+' | head -1")
        output, err := cmd.Output()
        if err == nil {
            return strings.TrimSpace(string(output))
        }
    }
    // TODO: å…¶ä»–å¹³å°
    return ""
}

// getMachineID è·å–æœºå™¨IDï¼ˆLinuxï¼‰
func getMachineID() string {
    if runtime.GOOS == "linux" {
        data, err := os.ReadFile("/etc/machine-id")
        if err == nil {
            return strings.TrimSpace(string(data))
        }
    }
    return ""
}

// getCPUID è·å– CPU IDï¼ˆLinuxï¼‰
func getCPUID() string {
    if runtime.GOOS == "linux" {
        // è¯»å– /proc/cpuinfo
        data, err := os.ReadFile("/proc/cpuinfo")
        if err == nil {
            lines := strings.Split(string(data), "\n")
            for _, line := range lines {
                if strings.HasPrefix(line, "Serial") {
                    parts := strings.Split(line, ":")
                    if len(parts) == 2 {
                        return strings.TrimSpace(parts[1])
                    }
                }
            }
        }
    }
    return ""
}

// getBoardSerial è·å–ä¸»æ¿åºåˆ—å·ï¼ˆLinuxï¼‰
func getBoardSerial() string {
    if runtime.GOOS == "linux" {
        data, err := os.ReadFile("/sys/class/dmi/id/board_serial")
        if err == nil {
            return strings.TrimSpace(string(data))
        }
    }
    return ""
}
```

---

### 2. å®ç°åœ¨çº¿éªŒè¯

```go
// pkg/license/online_verify.go
package license

import (
    "context"
    "crypto/tls"
    "encoding/json"
    "fmt"
    "net/http"
    "time"
)

// OnlineVerifier åœ¨çº¿éªŒè¯å™¨
type OnlineVerifier struct {
    verifyURL string
    client    *http.Client
    interval  time.Duration
}

// NewOnlineVerifier åˆ›å»ºåœ¨çº¿éªŒè¯å™¨
func NewOnlineVerifier(verifyURL string) *OnlineVerifier {
    return &OnlineVerifier{
        verifyURL: verifyURL,
        client: &http.Client{
            Timeout: 10 * time.Second,
            Transport: &http.Transport{
                TLSClientConfig: &tls.Config{
                    InsecureSkipVerify: false,
                },
            },
        },
        interval: 24 * time.Hour, // æ¯24å°æ—¶éªŒè¯ä¸€æ¬¡
    }
}

// VerifyLicense åœ¨çº¿éªŒè¯ License
func (v *OnlineVerifier) VerifyLicense(ctx context.Context, licenseID, hardwareID string) (*VerifyResponse, error) {
    // æ„å»ºéªŒè¯è¯·æ±‚
    url := fmt.Sprintf("%s/verify?license_id=%s&hardware_id=%s", v.verifyURL, licenseID, hardwareID)
    req, err := http.NewRequestWithContext(ctx, "GET", url, nil)
    if err != nil {
        return nil, err
    }
    
    // å‘é€è¯·æ±‚
    resp, err := v.client.Do(req)
    if err != nil {
        return nil, fmt.Errorf("failed to verify license online: %w", err)
    }
    defer resp.Body.Close()
    
    // è§£æå“åº”
    var verifyResp VerifyResponse
    if err := json.NewDecoder(resp.Body).Decode(&verifyResp); err != nil {
        return nil, fmt.Errorf("failed to parse verify response: %w", err)
    }
    
    return &verifyResp, nil
}

// VerifyResponse éªŒè¯å“åº”
type VerifyResponse struct {
    Valid     bool      `json:"valid"`      // License æ˜¯å¦æœ‰æ•ˆ
    Revoked   bool      `json:"revoked"`    // License æ˜¯å¦è¢«æ’¤é”€
    ExpiresAt time.Time `json:"expires_at"` // è¿‡æœŸæ—¶é—´
    Message   string    `json:"message"`    // æ¶ˆæ¯
}

// StartPeriodicVerify å¯åŠ¨å®šæœŸéªŒè¯
func (v *OnlineVerifier) StartPeriodicVerify(ctx context.Context, licenseID, hardwareID string, callback func(bool, string)) {
    go func() {
        ticker := time.NewTicker(v.interval)
        defer ticker.Stop()
        
        for {
            select {
            case <-ctx.Done():
                return
            case <-ticker.C:
                // æ‰§è¡ŒéªŒè¯
                resp, err := v.VerifyLicense(ctx, licenseID, hardwareID)
                if err != nil {
                    logger.Warnf(ctx, "[License] Online verification failed: %v", err)
                    // éªŒè¯å¤±è´¥æ—¶ï¼Œå¯ä»¥é€‰æ‹©ç¦ç”¨ä¼ä¸šåŠŸèƒ½æˆ–ç»§ç»­ä½¿ç”¨
                    continue
                }
                
                // æ£€æŸ¥ License çŠ¶æ€
                if resp.Revoked || !resp.Valid {
                    logger.Errorf(ctx, "[License] License is invalid or revoked: %s", resp.Message)
                    // å›è°ƒé€šçŸ¥
                    if callback != nil {
                        callback(false, resp.Message)
                    }
                } else {
                    logger.Infof(ctx, "[License] Online verification successful")
                    if callback != nil {
                        callback(true, "")
                    }
                }
            }
        }
    }()
}
```

---

### 3. é›†æˆåˆ° License ç®¡ç†å™¨

```go
// pkg/license/manager.goï¼ˆå¢å¼ºç‰ˆï¼‰

// Manager License ç®¡ç†å™¨ï¼ˆå¢å¼ºç‰ˆï¼‰
type Manager struct {
    license        *License
    licensePath    string
    publicKey      *rsa.PublicKey
    onlineVerifier *OnlineVerifier // â­ åœ¨çº¿éªŒè¯å™¨
    mu             sync.RWMutex
    lastVerifyTime time.Time // â­ ä¸Šæ¬¡éªŒè¯æ—¶é—´
}

// LoadLicense åŠ è½½ Licenseï¼ˆå¢å¼ºç‰ˆï¼‰
func (m *Manager) LoadLicense(path string) error {
    // ... åŸæœ‰é€»è¾‘ ...
    
    // â­ å¦‚æœ License æœ‰åœ¨çº¿éªŒè¯ URLï¼Œå¯åŠ¨å®šæœŸéªŒè¯
    if m.license.VerifyURL != "" {
        m.onlineVerifier = NewOnlineVerifier(m.license.VerifyURL)
        m.onlineVerifier.StartPeriodicVerify(
            context.Background(),
            m.license.ID,
            getHardwareID(),
            m.onLicenseStatusChanged, // å›è°ƒå‡½æ•°
        )
    }
    
    return nil
}

// onLicenseStatusChanged License çŠ¶æ€å˜æ›´å›è°ƒ
func (m *Manager) onLicenseStatusChanged(valid bool, message string) {
    m.mu.Lock()
    defer m.mu.Unlock()
    
    if !valid {
        // License æ— æ•ˆæˆ–è¢«æ’¤é”€ï¼Œæ¸…é™¤ License
        logger.Errorf(nil, "[License] License invalidated: %s", message)
        m.license = nil // é™çº§åˆ°ç¤¾åŒºç‰ˆ
    }
}
```

---

## ğŸ¯ æ¨èå®æ–½ç­–ç•¥

### é˜¶æ®µä¸€ï¼šåŸºç¡€é˜²æŠ¤ï¼ˆç«‹å³å®æ–½ï¼‰â­â­â­â­â­

1. âœ… **å®Œå–„ç¡¬ä»¶ç»‘å®š**
   - å®ç° `getHardwareID()` å‡½æ•°
   - åŸºäºå¤šä¸ªç¡¬ä»¶ä¿¡æ¯ç”Ÿæˆå”¯ä¸€ID

2. âœ… **å¢å¼ºç­¾åéªŒè¯**
   - ç¡®ä¿å…¬é’¥æ–‡ä»¶å®‰å…¨
   - è€ƒè™‘å°†å…¬é’¥åµŒå…¥åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­

---

### é˜¶æ®µäºŒï¼šå¢å¼ºé˜²æŠ¤ï¼ˆ3-6ä¸ªæœˆï¼‰â­â­â­â­

3. âœ… **å®ç°åœ¨çº¿éªŒè¯**
   - æ­å»º License éªŒè¯æœåŠ¡å™¨
   - å®ç°å®šæœŸéªŒè¯æœºåˆ¶

4. âœ… **å®ç°æ—¶é—´éªŒè¯**
   - é˜²æ­¢æ—¶é—´å›é€€
   - æ—¶é—´çª—å£æ£€æŸ¥

---

### é˜¶æ®µä¸‰ï¼šé«˜çº§é˜²æŠ¤ï¼ˆå¯é€‰ï¼‰â­â­â­

5. âš ï¸ **ä»£ç æ··æ·†**
   - ä½¿ç”¨ `garble` å·¥å…·
   - æ··æ·†å…³é”®ä»£ç 

6. âš ï¸ **åè°ƒè¯•**
   - æ£€æµ‹è°ƒè¯•å™¨
   - æ£€æµ‹ä»£ç ä¿®æ”¹

---

## ğŸ“Š é˜²æŠ¤æ•ˆæœè¯„ä¼°

### åŸºç¡€é˜²æŠ¤ï¼ˆRSA + ç¡¬ä»¶ç»‘å®šï¼‰

**é˜²æŠ¤èƒ½åŠ›**ï¼šâ­â­â­â­ï¼ˆé«˜ï¼‰
- âœ… é˜²æ­¢ä¿®æ”¹ License æ–‡ä»¶
- âœ… é˜²æ­¢ä¼ªé€  License
- âœ… é˜²æ­¢ License å…±äº«
- âš ï¸ å¯èƒ½è¢«ä»£ç ä¿®æ”¹ç»•è¿‡

---

### å¢å¼ºé˜²æŠ¤ï¼ˆ+ åœ¨çº¿éªŒè¯ï¼‰

**é˜²æŠ¤èƒ½åŠ›**ï¼šâ­â­â­â­â­ï¼ˆæé«˜ï¼‰
- âœ… é˜²æ­¢ä¿®æ”¹ License æ–‡ä»¶
- âœ… é˜²æ­¢ä¼ªé€  License
- âœ… é˜²æ­¢ License å…±äº«
- âœ… å¯ä»¥å®æ—¶æ’¤é”€ License
- âœ… å¯ä»¥ç›‘æ§ License ä½¿ç”¨æƒ…å†µ
- âš ï¸ éœ€è¦ç½‘ç»œè¿æ¥

---

### é«˜çº§é˜²æŠ¤ï¼ˆ+ ä»£ç æ··æ·† + åè°ƒè¯•ï¼‰

**é˜²æŠ¤èƒ½åŠ›**ï¼šâ­â­â­â­â­ï¼ˆæé«˜ï¼‰
- âœ… æ‰€æœ‰å¢å¼ºé˜²æŠ¤çš„åŠŸèƒ½
- âœ… é˜²æ­¢ä»£ç ä¿®æ”¹
- âœ… é˜²æ­¢è°ƒè¯•åˆ†æ
- âš ï¸ å¢åŠ å¼€å‘å¤æ‚åº¦

---

## ğŸ¯ æœ€ç»ˆå»ºè®®

### æ¨èæ–¹æ¡ˆï¼šåŸºç¡€é˜²æŠ¤ + åœ¨çº¿éªŒè¯

**ç†ç”±**ï¼š
1. âœ… **é˜²æŠ¤èƒ½åŠ›å¼º**ï¼šå¯ä»¥é˜²æ­¢å¤§éƒ¨åˆ†ç ´è§£æ–¹å¼
2. âœ… **å®æ–½æˆæœ¬é€‚ä¸­**ï¼šä¸éœ€è¦å¤æ‚çš„ä»£ç æ··æ·†
3. âœ… **å¯ç»´æŠ¤æ€§å¥½**ï¼šä»£ç æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
4. âœ… **å¯æ‰©å±•æ€§å¼º**ï¼šå¯ä»¥åç»­æ·»åŠ é«˜çº§é˜²æŠ¤

**å®æ–½ä¼˜å…ˆçº§**ï¼š
1. â­â­â­â­â­ **å®Œå–„ç¡¬ä»¶ç»‘å®š**ï¼ˆç«‹å³å®æ–½ï¼‰
2. â­â­â­â­â­ **å®ç°åœ¨çº¿éªŒè¯**ï¼ˆ3-6ä¸ªæœˆï¼‰
3. â­â­â­ **ä»£ç æ··æ·†**ï¼ˆå¯é€‰ï¼‰

---

## ğŸ“‹ å®æ–½ Checklist

### ç«‹å³å®æ–½

- [ ] å®Œå–„ `getHardwareID()` å‡½æ•°
- [ ] å®ç°åŸºäºå¤šä¸ªç¡¬ä»¶ä¿¡æ¯çš„ç¡¬ä»¶æŒ‡çº¹ç®—æ³•
- [ ] æµ‹è¯•ç¡¬ä»¶ç»‘å®šåŠŸèƒ½

### 3-6ä¸ªæœˆå®æ–½

- [ ] æ­å»º License éªŒè¯æœåŠ¡å™¨
- [ ] å®ç°åœ¨çº¿éªŒè¯æœºåˆ¶
- [ ] å®ç°å®šæœŸéªŒè¯
- [ ] å®ç° License æ’¤é”€åŠŸèƒ½

### å¯é€‰å®æ–½

- [ ] ä»£ç æ··æ·†ï¼ˆä½¿ç”¨ `garble`ï¼‰
- [ ] åè°ƒè¯•æ£€æµ‹
- [ ] å…³é”®é€»è¾‘åŠ å¯†

---

## ğŸ“ å‚è€ƒ

- [License ç³»ç»Ÿè®¾è®¡](./README.md)
- [ç¡¬ä»¶ç»‘å®šå®ç°](./hardware.go)ï¼ˆå¾…å®ç°ï¼‰
- [åœ¨çº¿éªŒè¯å®ç°](./online_verify.go)ï¼ˆå¾…å®ç°ï¼‰

<!--
  FormView - è¡¨å•è§†å›¾
  æ–°æ¶æ„çš„å±•ç¤ºå±‚ç»„ä»¶
  
  ============================================
  ğŸ“‹ éœ€æ±‚è¯´æ˜
  ============================================
  
  1. **è¡¨å•æ¸²æŸ“**ï¼š
     - æ ¹æ®å­—æ®µé…ç½®ï¼ˆ`functionDetail.request`ï¼‰æ¸²æŸ“è¡¨å•
     - æ”¯æŒå¤šç§å­—æ®µç±»å‹ï¼ˆinputã€selectã€formã€table ç­‰ï¼‰
     - æ”¯æŒåµŒå¥—ç»“æ„ï¼ˆform åµŒå¥— tableï¼Œtable åµŒå¥— formï¼‰
  
  2. **æ•°æ®åˆå§‹åŒ–**ï¼š
     - ç¼–è¾‘æ¨¡å¼ï¼šä½¿ç”¨ `initialData` å›æ˜¾æ•°æ®
     - æ–°å¢æ¨¡å¼ï¼šä» URL å‚æ•°æˆ–å­—æ®µé»˜è®¤å€¼åˆå§‹åŒ–
     - æ”¯æŒä» URL å‚æ•°æ¢å¤è¡¨å•çŠ¶æ€ï¼ˆä»…æ–°å¢æ¨¡å¼ï¼Œ`_tab=OnTableAddRow`ï¼‰
  
  3. **URL å‚æ•°åŒæ­¥**ï¼š
     - ä»…åœ¨æ–°å¢æ¨¡å¼ä¸‹åŒæ­¥è¡¨å•æ•°æ®åˆ° URLï¼ˆ`_tab=OnTableAddRow`ï¼‰
     - ç¼–è¾‘æ¨¡å¼å’Œè¯¦æƒ…æ¨¡å¼ä¸åŒæ­¥ URLï¼ˆ`_tab=detail` æˆ–ä¸è®¾ç½® `_tab`ï¼‰
     - åŒæ­¥æ—¶ä¿ç•™è¡¨æ ¼å‚æ•°ã€æœç´¢å‚æ•°ç­‰å…¶ä»–å‚æ•°
  
  4. **è¡¨å•éªŒè¯**ï¼š
     - æäº¤æ—¶éªŒè¯æ‰€æœ‰å­—æ®µ
     - éªŒè¯é”™è¯¯ä½¿ç”¨å­—æ®µçš„ä¸­æ–‡åç§°ï¼ˆ`field.name`ï¼‰
     - éªŒè¯é”™è¯¯æ˜¾ç¤ºåœ¨å­—æ®µä¸‹æ–¹
  
  ============================================
  ğŸ¯ è®¾è®¡æ€è·¯
  ============================================
  
  1. **åˆ†å±‚æ¶æ„**ï¼š
     - Presentation Layerï¼šçº¯ UI å±•ç¤ºï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
     - é€šè¿‡ FormApplicationService è°ƒç”¨ä¸šåŠ¡é€»è¾‘
     - ä» FormStateManager è·å–çŠ¶æ€å¹¶æ¸²æŸ“
  
  2. **æ•°æ®æµ**ï¼š
     - åˆå§‹åŒ–ï¼šFormApplicationService.initializeForm â†’ FormDomainService.initializeForm
     - æ›´æ–°ï¼šç”¨æˆ·è¾“å…¥ â†’ updateFieldValue â†’ StateManager â†’ äº‹ä»¶æ€»çº¿
     - æäº¤ï¼šFormApplicationService.submitForm â†’ FormDomainService.validateForm â†’ API
  
  3. **URL åŒæ­¥æ§åˆ¶**ï¼š
     - ä½¿ç”¨ `shouldSyncURL` computed åˆ¤æ–­æ˜¯å¦éœ€è¦åŒæ­¥
     - åªåœ¨ `_tab=OnTableAddRow` æ—¶åŒæ­¥ URL
     - å…¶ä»–æ¨¡å¼ï¼ˆ`_tab=detail` æˆ–ä¸è®¾ç½® `_tab`ï¼‰ä¸åŒæ­¥
  
  ============================================
  ğŸ“ å…³é”®åŠŸèƒ½
  ============================================
  
  1. **è¡¨å•åˆå§‹åŒ–**ï¼š
     - `initializeFormWithData`ï¼šç¼–è¾‘æ¨¡å¼ï¼Œä½¿ç”¨ `initialData` åˆå§‹åŒ–
     - `initializeFormNormal`ï¼šæ–°å¢æ¨¡å¼ï¼Œä» URL æˆ–é»˜è®¤å€¼åˆå§‹åŒ–
  
  2. **å­—æ®µæ¸²æŸ“**ï¼š
     - ä½¿ç”¨ `WidgetComponent` æ¸²æŸ“å­—æ®µ
     - æ ¹æ®å­—æ®µçš„ `widget.type` é€‰æ‹©å¯¹åº”çš„ç»„ä»¶
     - æ”¯æŒå¤šç§æ¸²æŸ“æ¨¡å¼ï¼ˆeditã€responseã€table-cellã€detailã€searchï¼‰
  
  3. **è¡¨å•éªŒè¯**ï¼š
     - `validateForm`ï¼šéªŒè¯æ‰€æœ‰å­—æ®µï¼Œè¿”å›éªŒè¯ç»“æœ
     - `getFieldError`ï¼šè·å–å­—æ®µçš„éªŒè¯é”™è¯¯ä¿¡æ¯
     - éªŒè¯é”™è¯¯ä½¿ç”¨å­—æ®µçš„ä¸­æ–‡åç§°
  
  ============================================
  âš ï¸ æ³¨æ„äº‹é¡¹
  ============================================
  
  1. **URL åŒæ­¥æ—¶æœº**ï¼š
     - åªåœ¨æ–°å¢æ¨¡å¼ä¸‹åŒæ­¥ï¼ˆ`_tab=OnTableAddRow`ï¼‰
     - ç¼–è¾‘æ¨¡å¼å’Œè¯¦æƒ…æ¨¡å¼ä¸åŒæ­¥ï¼Œé¿å… URL æ±¡æŸ“
  
  2. **åˆå§‹æ•°æ®ä¼˜å…ˆçº§**ï¼š
     - ç¼–è¾‘æ¨¡å¼ï¼š`initialData` > å­—æ®µé»˜è®¤å€¼
     - æ–°å¢æ¨¡å¼ï¼šURL å‚æ•° > å­—æ®µé»˜è®¤å€¼
  
  3. **å­—æ®µ ID ç”Ÿæˆ**ï¼š
     - ä½¿ç”¨ `:prop="field.code"` ç¡®ä¿ Element Plus ç”Ÿæˆæ­£ç¡®çš„ `id` å±æ€§
     - åµŒå¥—å­—æ®µä½¿ç”¨ `:prop="`${fieldPath}.${subField.code}`"` æ ¼å¼
  
  4. **éªŒè¯é”™è¯¯æ˜¾ç¤º**ï¼š
     - ä½¿ç”¨å­—æ®µçš„ä¸­æ–‡åç§°ï¼ˆ`field.name`ï¼‰æ˜¾ç¤ºé”™è¯¯
     - éªŒè¯é”™è¯¯æ˜¾ç¤ºåœ¨å­—æ®µä¸‹æ–¹ï¼Œä½¿ç”¨ `:error` å±æ€§
-->

<template>
  <div class="form-view">
    <!-- â­ æƒé™ä¸è¶³æç¤ºï¼šä½¿ç”¨ PermissionDeniedView ç»„ä»¶ -->
    <PermissionDeniedView v-if="permissionError" />

    <!-- ä¸»å†…å®¹åŒºåŸŸï¼šä½¿ç”¨ flex å¸ƒå±€ï¼Œå·¦ä¾§è¡¨å•ï¼Œå³ä¾§è¯¦æƒ… -->
    <div class="form-view-container">
      <!-- å·¦ä¾§ï¼šè¡¨å•å†…å®¹ -->
      <div class="form-view-main">
        <!-- è¯·æ±‚å‚æ•°è¡¨å• -->
        <el-form
          v-if="requestFields.length > 0"
          :model="formData"
          label-width="100px"
          class="function-form"
        >
      <div class="section-title">è¯·æ±‚å‚æ•°</div>
      <el-form-item
        v-for="field in requestFields"
        :key="field.code"
        :label="field.name"
        :required="isFieldRequired(field)"
        :error="getFieldError(field.code)"
      >
        <WidgetComponent
          :field="field"
          :value="fieldValues[field.code]"
          :field-path="field.code"
          :form-renderer="formRendererContext"
          :function-method="functionDetail?.method || 'GET'"
          :function-router="functionDetail?.router || ''"
          @update:model-value="(v: FieldValue) => handleFieldUpdate(field.code, v)"
        />
      </el-form-item>
    </el-form>

    <!-- æäº¤æŒ‰é’® -->
    <div v-if="showSubmitButton || showResetButton" class="form-actions-section">
      <div class="form-actions-row">
        <!-- â­ æäº¤æŒ‰é’®ï¼šéœ€è¦ form:write æƒé™ -->
        <!-- å¦‚æœæ²¡æœ‰æƒé™ï¼Œæ˜¾ç¤ºç¦ç”¨çŠ¶æ€çš„æŒ‰é’®ï¼Œç‚¹å‡»åè·³è½¬åˆ°æƒé™ç”³è¯·é¡µé¢ -->
        <el-button
          v-if="showSubmitButton && canSubmit"
          type="primary"
          size="large"
          @click="handleSubmit"
          :loading="submitting"
          class="submit-button-full-width"
        >
          <el-icon><Promotion /></el-icon>
          æäº¤
        </el-button>
        <el-button
          v-else-if="showSubmitButton"
          type="primary"
          size="large"
          :disabled="false"
          plain
          class="submit-button-full-width action-btn-no-permission"
          @click="handleApplyPermissionForSubmit"
        >
          <el-icon><Lock /></el-icon>
          æäº¤ï¼ˆéœ€æƒé™ï¼‰
        </el-button>
        <el-button v-if="showResetButton" size="large" @click="handleReset">
          <el-icon><RefreshLeft /></el-icon>
          é‡ç½®
        </el-button>
        <el-button size="large" @click="showDebugDialog = true" type="info">
          <el-icon><View /></el-icon>
          Debug
        </el-button>
      </div>
    </div>

    <!-- å“åº”å‚æ•°å±•ç¤ºï¼šæäº¤å‰å°±æ˜¾ç¤ºï¼Œæ˜¾ç¤º"ç­‰å¾…æäº¤"æ ‡ç­¾ -->
    <div v-if="responseFields.length > 0" class="response-section">
      <div class="section-title">
        å“åº”å‚æ•°
        <el-tag v-if="!hasResponseData" type="info" size="small" style="margin-left: 12px">
          ç­‰å¾…æäº¤
        </el-tag>
        <el-tag v-else type="success" size="small" style="margin-left: 12px">
          å·²è¿”å›
        </el-tag>
      </div>
      <el-form 
        label-width="100px"
        :class="{ 'is-empty': !hasResponseData }"
      >
        <el-form-item
          v-for="field in responseFields"
          :key="field.code"
          :label="field.name"
        >
          <WidgetComponent
            :field="field"
            :value="responseFieldValues[field.code]"
            :field-path="field.code"
            mode="response"
          />
        </el-form-item>
      </el-form>
    </div>

    <!-- æ‰§è¡Œä¿¡æ¯ï¼ˆå…ƒæ•°æ®ï¼‰ï¼šæ˜¾ç¤ºå‡½æ•°æ‰§è¡Œè€—æ—¶ç­‰ä¿¡æ¯ï¼Œæ˜ç¡®åŒºåˆ†ä¸æ˜¯å“åº”å‚æ•° -->
    <div v-if="responseMetadata && responseMetadata.total_cost_mill !== undefined" class="metadata-section">
      <div class="metadata-title">
        <el-icon class="metadata-icon"><InfoFilled /></el-icon>
        <span>æ‰§è¡Œä¿¡æ¯</span>
      </div>
      <div class="metadata-content">
        <span class="metadata-label">æ‰§è¡Œè€—æ—¶ï¼š</span>
        <span class="metadata-value">
          {{ formatCostTime(responseMetadata.total_cost_mill) }}
        </span>
      </div>
    </div>

    <!-- Debug å¼¹çª— -->
    <el-dialog
      v-model="showDebugDialog"
      title="Debug - è¯·æ±‚å’Œå“åº”æ•°æ®"
      width="80%"
      :close-on-click-modal="false"
    >
      <el-tabs v-model="debugActiveTab">
        <!-- è¯·æ±‚å‚æ•° -->
        <el-tab-pane label="è¯·æ±‚å‚æ•°" name="request">
          <div class="debug-section">
            <div class="debug-header">
              <span class="debug-label">æäº¤æ•°æ®ï¼ˆå®æ—¶ï¼‰</span>
              <el-button
                size="small"
                type="primary"
                @click="copyToClipboard(debugRequestData)"
              >
                <el-icon><DocumentCopy /></el-icon>
                å¤åˆ¶
              </el-button>
            </div>
            <el-input
              v-model="debugRequestData"
              type="textarea"
              :rows="20"
              readonly
              class="debug-json-input"
            />
          </div>
        </el-tab-pane>

        <!-- å“åº”å‚æ•° -->
        <el-tab-pane label="å“åº”å‚æ•°" name="response">
          <div class="debug-section">
            <div class="debug-header">
              <span class="debug-label">å“åº”æ•°æ®</span>
              <el-button
                v-if="debugResponseData"
                size="small"
                type="primary"
                @click="copyToClipboard(debugResponseData)"
              >
                <el-icon><DocumentCopy /></el-icon>
                å¤åˆ¶
              </el-button>
            </div>
            <el-input
              v-if="debugResponseData"
              v-model="debugResponseData"
              type="textarea"
              :rows="20"
              readonly
              class="debug-json-input"
            />
            <el-empty v-else description="æš‚æ— å“åº”æ•°æ®ï¼Œè¯·å…ˆæäº¤è¡¨å•" />
          </div>
        </el-tab-pane>

        <!-- åŸå§‹çŠ¶æ€ -->
        <el-tab-pane label="åŸå§‹çŠ¶æ€" name="raw">
          <div class="debug-section">
            <div class="debug-header">
              <span class="debug-label">FormDataStore åŸå§‹æ•°æ®</span>
              <el-button
                size="small"
                type="primary"
                @click="copyToClipboard(debugRawData)"
              >
                <el-icon><DocumentCopy /></el-icon>
                å¤åˆ¶
              </el-button>
            </div>
            <el-input
              v-model="debugRawData"
              type="textarea"
              :rows="20"
              readonly
              class="debug-json-input"
            />
          </div>
        </el-tab-pane>
      </el-tabs>
    </el-dialog>
      </div>
      <!-- å³ä¾§ï¼šå‡½æ•°è¯¦æƒ…é¢æ¿ -->
      <div class="form-view-sidebar" v-if="functionDetail && currentFunctionNode">
        <el-card class="function-detail-card" shadow="hover">
          <template #header>
            <div class="function-detail-header">
              <el-icon><InfoFilled /></el-icon>
              <span>å‡½æ•°ä»‹ç»</span>
            </div>
          </template>
          
          <!-- åˆ›å»ºç”¨æˆ·ä¿¡æ¯ -->
          <div class="detail-section" v-if="functionDetail.created_by">
            <div class="detail-section-title">
              <el-icon><User /></el-icon>
              <span>åˆ›å»ºè€…</span>
            </div>
            <div class="creator-info">
              <UserDisplay 
                :username="functionDetail.created_by" 
                mode="rich"
                layout="horizontal"
              />
            </div>
          </div>
          
          <!-- å‡½æ•°åç§° -->
          <div class="detail-section">
            <div class="function-name">{{ functionDetail.name || currentFunctionNode.name || '-' }}</div>
          </div>

          <!-- å‡½æ•°æè¿° -->
          <div class="detail-section" v-if="currentFunctionNode.description">
            <div class="description-wrapper">
              <div class="description-content">{{ currentFunctionNode.description }}</div>
            </div>
          </div>

          <!-- æ ‡ç­¾ -->
          <div class="detail-section" v-if="currentFunctionNode.tags">
            <div class="detail-section-title">
              <el-icon><PriceTag /></el-icon>
              <span>æ ‡ç­¾</span>
            </div>
            <div class="tags-list">
              <el-tag
                v-for="tag in (currentFunctionNode.tags?.split(',') || []).filter((t: string) => t.trim())"
                :key="tag"
                size="small"
                class="tag-item"
              >
                {{ tag.trim() }}
              </el-tag>
            </div>
          </div>

          <!-- å¦‚æœæ²¡æœ‰æè¿°å’Œæ ‡ç­¾ï¼Œæ˜¾ç¤ºæç¤º -->
          <div v-if="!currentFunctionNode.description && !currentFunctionNode.tags" class="empty-tip">
            <el-empty description="æš‚æ— ä»‹ç»ä¿¡æ¯" :image-size="80" />
          </div>
        </el-card>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed, onMounted, onUnmounted, watch, ref, nextTick, withDefaults } from 'vue'
import type { ComputedRef } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { Promotion, RefreshLeft, View, DocumentCopy, InfoFilled, Lock, Document, List, PriceTag, User } from '@element-plus/icons-vue'
import { ElIcon, ElTag, ElNotification, ElMessage, ElAlert, ElMessageBox, ElText, ElCheckbox, ElCard, ElEmpty } from 'element-plus'
import { eventBus, FormEvent, WorkspaceEvent } from '../../infrastructure/eventBus'
import { serviceFactory } from '../../infrastructure/factories'
import WidgetComponent from '../widgets/WidgetComponent.vue'
import UserDisplay from '../widgets/UserDisplay.vue'
import { Logger } from '@/core/utils/logger'
import { TEMPLATE_TYPE } from '@/utils/functionTypes'
import type { FunctionDetail, FieldConfig, FieldValue } from '../../domain/types'
import { hasAnyRequiredRule } from '@/core/utils/validationUtils'
import { useFormDataStore } from '@/core/stores-v2/formData'
import { useResponseDataStore } from '@/core/stores-v2/responseData'
import { useFunctionParamInitialization } from '../composables/useFunctionParamInitialization'
import { useFormParamURLSync } from '../composables/useFormParamURLSync'
import { hasPermission, FormPermissions, buildPermissionApplyURL } from '@/utils/permission'
import { usePermissionErrorStore } from '@/stores/permissionError'
import type { PermissionInfo } from '@/utils/permission'
import PermissionDeniedView from '../components/PermissionDeniedView.vue'

const props = withDefaults(defineProps<{
  functionDetail?: FunctionDetail  // ğŸ”¥ æ”¹ä¸ºå¯é€‰ï¼Œå› ä¸ºä¼šåœ¨ onMounted ä¸­ä¸»åŠ¨è·å–
  showSubmitButton?: boolean  // ğŸ”¥ æ˜¯å¦æ˜¾ç¤ºæäº¤æŒ‰é’®ï¼ˆç”¨äº FormDialog ç­‰åœºæ™¯ï¼‰
  showResetButton?: boolean  // ğŸ”¥ æ˜¯å¦æ˜¾ç¤ºé‡ç½®æŒ‰é’®
  initialData?: Record<string, any>  // ğŸ”¥ åˆå§‹æ•°æ®ï¼ˆç”¨äºç¼–è¾‘æ¨¡å¼ï¼‰
}>(), {
  showSubmitButton: true,
  showResetButton: true,
  initialData: () => ({}),
})

// è·¯ç”±
const route = useRoute()
const router = useRouter()

// ä¾èµ–æ³¨å…¥ï¼ˆä½¿ç”¨ IServiceProvider æ¥å£ï¼Œéµå¾ªä¾èµ–å€’ç½®åŸåˆ™ï¼‰
const serviceProvider: IServiceProvider = serviceFactory
const stateManager = serviceProvider.getFormStateManager() as FormStateManager  // ğŸ”¥ ç±»å‹æ–­è¨€ï¼šFormStateManager æœ‰ setResponse æ–¹æ³•
const domainService = serviceProvider.getFormDomainService()
const applicationService = serviceProvider.getFormApplicationService()
const workspaceStateManager = serviceProvider.getWorkspaceStateManager()  // ğŸ”¥ ç”¨äºè·å–å½“å‰å‡½æ•°èŠ‚ç‚¹
const workspaceDomainService = serviceProvider.getWorkspaceDomainService()  // ğŸ”¥ ç”¨äºè·å–å‡½æ•°è¯¦æƒ…

// ğŸ”¥ å†…éƒ¨ç»´æŠ¤ functionDetailï¼ˆåœ¨ onMounted ä¸­ä¸»åŠ¨è·å–ï¼‰
const functionDetail = ref<FunctionDetail | null>(props.functionDetail || null)

// ğŸ”¥ è·å–å…¨å±€ formDataStore å’Œ responseDataStoreï¼ˆç”¨äºæ¸…ç†ï¼Œå› ä¸º WidgetComponent å†…éƒ¨ä½¿ç”¨çš„ç»„ä»¶ä¼šç›´æ¥ä½¿ç”¨è¿™äº› storeï¼‰
const formDataStore = useFormDataStore()
const responseDataStore = useResponseDataStore()

// ä»çŠ¶æ€ç®¡ç†å™¨è·å–çŠ¶æ€
const formData = computed(() => {
  const state = stateManager.getState()
  const data: Record<string, any> = {}
  if (state.data) {
    state.data.forEach((value, key) => {
      if (value) {
        data[key] = value.raw
      }
    })
  }
  return data
})

const requestFields = computed(() => (functionDetail.value?.request || []) as FieldConfig[])
const responseFields = computed(() => (functionDetail.value?.response || []) as FieldConfig[])

// â­ æƒé™æ£€æŸ¥ï¼šè·å–å½“å‰å‡½æ•°èŠ‚ç‚¹çš„æƒé™ä¿¡æ¯
const currentFunctionNode = computed(() => {
  return workspaceStateManager.getCurrentFunction()
})

// â­ æ˜¯å¦æœ‰æäº¤æƒé™
const canSubmit = computed(() => {
  const node = currentFunctionNode.value
  if (!node) return true  // å¦‚æœæ²¡æœ‰èŠ‚ç‚¹ä¿¡æ¯ï¼Œé»˜è®¤å…è®¸ï¼ˆå‘åå…¼å®¹ï¼‰
  return hasPermission(node, FormPermissions.write)
})

// â­ æƒé™é”™è¯¯çŠ¶æ€
const permissionErrorStore = usePermissionErrorStore()
const permissionError = computed<PermissionInfo | null>(() => permissionErrorStore.currentError)

// â­ å¤„ç†æäº¤æŒ‰é’®çš„æƒé™ç”³è¯·ï¼ˆPermissionDeniedView ç»„ä»¶å·²å¤„ç†æƒé™é”™è¯¯æ˜¾ç¤ºï¼‰
const handleApplyPermissionForSubmit = () => {
  const node = currentFunctionNode.value
  if (!node || !node.full_code_path) return
  
  // æ„å»ºæƒé™ç”³è¯· URLï¼ˆä¼ é€’ template_type ä»¥ä¾¿æ­£ç¡®æ˜¾ç¤ºæƒé™é€‰é¡¹ï¼‰
        const applyUrl = buildPermissionApplyURL(node.full_code_path, 'function:write', node.template_type)
  router.push(applyUrl)
}

// ğŸ”¥ ç§»é™¤ formInitialData computedï¼Œæ”¹ä¸ºä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®åˆå§‹åŒ–æ¡†æ¶
// URL å‚æ•°ä¼šåœ¨ useFunctionParamInitialization ä¸­ç»Ÿä¸€å¤„ç†

// ğŸ”¥ ä¸ºæ‰€æœ‰å­—æ®µåˆ›å»ºå“åº”å¼çš„å€¼ Map
const fieldValues = computed(() => {
  const state = stateManager.getState()
  const values: Record<string, FieldValue> = {}
  requestFields.value.forEach((field: FieldConfig) => {
    const fieldValue = state.data?.get(field.code) || { raw: null, display: '', meta: {} }
    values[field.code] = fieldValue
  })
  return values
})

const submitting = computed(() => {
  const state = stateManager.getState()
  return state.submitting
})

// ğŸ”¥ ä¸ºæ‰€æœ‰å“åº”å­—æ®µåˆ›å»ºå“åº”å¼çš„å€¼ Map
const responseFieldValues = computed(() => {
  const state = stateManager.getState()
  const values: Record<string, FieldValue> = {}
  responseFields.value.forEach((field: FieldConfig) => {
    const rawValue = state.response?.[field.code]
    values[field.code] = {
      raw: rawValue !== undefined ? rawValue : null,
      display: rawValue !== null && rawValue !== undefined 
        ? (typeof rawValue === 'object' ? JSON.stringify(rawValue) : String(rawValue))
        : '',
      meta: {}
    }
  })
  return values
})

const hasResponseData = computed(() => {
  const state = stateManager.getState()
  return state.response !== null && state.response !== undefined
})

// ğŸ”¥ è·å–å“åº”å…ƒæ•°æ®ï¼ˆå¦‚ total_cost_millã€trace_id ç­‰ï¼‰
const responseMetadata = computed(() => {
  const state = stateManager.getState()
  return state.metadata || null
})

// ğŸ”¥ æ ¼å¼åŒ–è€—æ—¶æ˜¾ç¤º
const formatCostTime = (milliseconds: number): string => {
  if (milliseconds < 1000) {
    return `${milliseconds}ms`
  } else if (milliseconds < 60000) {
    return `${(milliseconds / 1000).toFixed(2)}s`
  } else {
    const minutes = Math.floor(milliseconds / 60000)
    const seconds = ((milliseconds % 60000) / 1000).toFixed(2)
    return `${minutes}åˆ†${seconds}ç§’`
  }
}

// Debug ç›¸å…³
const showDebugDialog = ref(false)
const debugActiveTab = ref('request')


// å®æ—¶è·å–æäº¤æ•°æ®ï¼ˆç”¨äº Debugï¼‰
const debugRequestData = computed(() => {
  try {
    const submitData = domainService.getSubmitData(requestFields.value)
    return JSON.stringify(submitData, null, 2)
  } catch (error) {
    return JSON.stringify({ error: 'è·å–æäº¤æ•°æ®å¤±è´¥' }, null, 2)
  }
})

// è·å–å“åº”æ•°æ®ï¼ˆç”¨äº Debugï¼‰
const debugResponseData = computed(() => {
  const state = stateManager.getState()
  if (state.response) {
    try {
      return JSON.stringify(state.response, null, 2)
    } catch (error) {
      return JSON.stringify({ error: 'æ ¼å¼åŒ–å“åº”æ•°æ®å¤±è´¥' }, null, 2)
    }
  }
  return ''
})

// è·å–åŸå§‹çŠ¶æ€æ•°æ®ï¼ˆç”¨äº Debugï¼‰
const debugRawData = computed(() => {
  const state = stateManager.getState()
  try {
    const rawData: Record<string, any> = {}
    state.data.forEach((value, key) => {
      // ğŸ”¥ dataType å’Œ widgetType å·²ç»æ˜¯é€šç”¨å­—æ®µï¼Œç›´æ¥æ˜¾ç¤º
      rawData[key] = {
        raw: value.raw,
        display: value.display,
        dataType: value.dataType || 'unknown',  // ğŸ”¥ é€šç”¨å­—æ®µï¼Œå’Œ display åŒçº§åˆ«
        widgetType: value.widgetType || 'unknown',  // ğŸ”¥ é€šç”¨å­—æ®µï¼Œå’Œ display åŒçº§åˆ«
        meta: value.meta
      }
    })
    return JSON.stringify(rawData, null, 2)
  } catch (error) {
    return JSON.stringify({ error: 'æ ¼å¼åŒ–åŸå§‹æ•°æ®å¤±è´¥' }, null, 2)
  }
})

// å¤åˆ¶åˆ°å‰ªè´´æ¿
const copyToClipboard = async (text: string): Promise<void> => {
  try {
    await navigator.clipboard.writeText(text)
    ElMessage.success('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
  } catch (error) {
    ElMessage.error('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶')
  }
}


// FormRenderer ä¸Šä¸‹æ–‡ï¼ˆç”¨äº OnSelectFuzzy å›è°ƒï¼‰
// æ³¨æ„ï¼šä½¿ç”¨ computed ç¡®ä¿å“åº”å¼æ›´æ–°ï¼Œå¹¶ä¸”æ¯æ¬¡è®¿é—®éƒ½è¿”å›æ–°çš„å¯¹è±¡ï¼ˆä½†æ–¹æ³•å¼•ç”¨ç¨³å®šï¼‰
const formRendererContext = computed(() => {
  return {
    getFunctionMethod: () => functionDetail.value?.method || 'GET',
    getFunctionRouter: () => functionDetail.value?.router || '',
    getSubmitData: () => {
      const state = stateManager.getState()
      const data: Record<string, any> = {}
      if (state.data) {
        state.data.forEach((value, key) => {
          if (value) {
            data[key] = value.raw
          }
        })
      }
      return data
    },
    registerWidget: () => {},
    unregisterWidget: () => {},
    getFieldError: (fieldPath: string) => {
      const errors = domainService.getFieldError(fieldPath)
      return errors[0]?.message || null
    }
  }
})

// æ–¹æ³•
const getFieldValue = (fieldCode: string): FieldValue => {
  return fieldValues.value[fieldCode] || { raw: null, display: '', meta: {} }
}

const getFieldError = (fieldCode: string): string => {
  // ğŸ”¥ åªåœ¨æäº¤æ—¶æ˜¾ç¤ºéªŒè¯é”™è¯¯
  const errors = domainService.getFieldError(fieldCode)
  return errors[0]?.message || ''
}

const getResponseFieldValue = (fieldCode: string): FieldValue => {
  return responseFieldValues.value[fieldCode] || { raw: null, display: '', meta: {} }
}

const isFieldRequired = (field: FieldConfig): boolean => {
  return hasAnyRequiredRule(field)
}

const handleFieldUpdate = (fieldCode: string, value: FieldValue): void => {
  // ğŸ”¥ è°ƒè¯•æ—¥å¿—ï¼šæ£€æŸ¥å€¼æ˜¯å¦æ­£ç¡®ä¼ é€’
  if (!value || value.raw === null || value.raw === undefined) {
    // ç©ºå€¼å¤„ç†
  }
  applicationService.updateFieldValue(fieldCode, value)
}

const handleSubmit = async (): Promise<void> => {
  try {
    if (!functionDetail.value) {
      ElNotification.error({
        title: 'æäº¤å¤±è´¥',
        message: 'å‡½æ•°è¯¦æƒ…æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åé‡è¯•',
        duration: 3000
      })
      return
    }
    await applicationService.submitForm(functionDetail.value)
    
    // ğŸ”¥ å¦‚æœæ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜ API è°ƒç”¨æˆåŠŸï¼ˆrequest.ts çš„å“åº”æ‹¦æˆªå™¨åœ¨ code !== 0 æ—¶ä¼š rejectï¼‰
    // request.ts åœ¨ code === 0 æ—¶è¿”å› dataï¼Œæ‰€ä»¥è¿™é‡Œ response æ˜¯ data éƒ¨åˆ†
    // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
    ElNotification.success({
      title: 'æäº¤æˆåŠŸ',
      message: 'æ“ä½œæˆåŠŸ',
      duration: 3000
    })
  } catch (error: any) {
    // ğŸ”¥ ä»é”™è¯¯å¯¹è±¡ä¸­æå–é”™è¯¯æ¶ˆæ¯
    // request.ts çš„å“åº”æ‹¦æˆªå™¨åœ¨ code !== 0 æ—¶ä¼š rejectï¼Œå¹¶åˆ›å»ºé”™è¯¯å¯¹è±¡
    // é”™è¯¯å¯¹è±¡åŒ…å« response å±æ€§ï¼Œå…¶ä¸­åŒ…å«å®Œæ•´çš„å“åº”æ•°æ®
    let errorMessage = 'æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
    
    // ğŸ”¥ ç»Ÿä¸€ä½¿ç”¨ msg å­—æ®µ
    // å°è¯•ä» error.response.data ä¸­è·å–é”™è¯¯æ¶ˆæ¯ï¼ˆrequest.ts ç¬¬ 99-101 è¡Œï¼‰
    if (error?.response?.data) {
      const responseData = error.response.data
      errorMessage = responseData.msg || errorMessage
    } else if (error?.message) {
      // å¦‚æœé”™è¯¯å¯¹è±¡æœ¬èº«æœ‰ messageï¼ˆrequest.ts ç¬¬ 99 è¡Œåˆ›å»ºçš„ï¼‰
      errorMessage = error.message
    }
    
    ElNotification.error({
      title: 'æäº¤å¤±è´¥',
      message: errorMessage,
      duration: 3000
    })
  }
}

const handleReset = (): void => {
  // ğŸ”¥ é‡ç½®æ—¶æ¸…ç† store æ•°æ®
  formDataStore.clear()
  responseDataStore.clear()
  
  applicationService.clearForm()
  // é‡æ–°åˆå§‹åŒ–è¡¨å•
  const fields = requestFields.value
  if (fields.length > 0) {
    applicationService.initializeForm(fields)
  }
}

/**
 * å‡†å¤‡æäº¤æ•°æ®ï¼ˆå¸¦ç±»å‹è½¬æ¢ï¼‰
 * è¿™ä¸ªæ–¹æ³•ä¼šè¢« FormDialog ç­‰å¤–éƒ¨ç»„ä»¶è°ƒç”¨
 * ğŸ”¥ å…¼å®¹ FormRenderer çš„æ¥å£
 */
function prepareSubmitDataWithTypeConversion(): Record<string, any> {
  const request = functionDetail.value?.request
  if (!Array.isArray(request) || request.length === 0) {
    return {}
  }
  
  // ä½¿ç”¨ domainService çš„ getSubmitData æ–¹æ³•é€’å½’æ”¶é›†æ‰€æœ‰å­—æ®µçš„æ•°æ®
  const submitData = domainService.getSubmitData(request)
  
  // ğŸ”¥ è°ƒè¯•æ—¥å¿—ï¼šæ£€æŸ¥æäº¤æ•°æ®ä¸­æ˜¯å¦åŒ…å«æ‰€æœ‰å¿…å¡«å­—æ®µ
  const requiredFields = request.filter(f => f.validation && f.validation.includes('required'))
  const missingFields = requiredFields.filter(f => submitData[f.code] === undefined || submitData[f.code] === null || submitData[f.code] === '')
  
  if (missingFields.length > 0) {
    Logger.warn('[FormView]', 'æäº¤æ•°æ®ä¸­ç¼ºå°‘å¿…å¡«å­—æ®µ', {
      missingFields: missingFields.map(f => f.code),
      submitDataKeys: Object.keys(submitData),
      allFieldCodes: request.map(f => f.code)
    })
  }
  
  Logger.info('[FormView]', 'å‡†å¤‡æäº¤æ•°æ®', {
    submitData,
    fieldCount: request.length,
    submitDataKeys: Object.keys(submitData),
    allFieldCodes: request.map(f => f.code)
  })
  
  return submitData
}

/**
 * éªŒè¯è¡¨å•
 * è¿™ä¸ªæ–¹æ³•ä¼šè¢« FormDialog ç­‰å¤–éƒ¨ç»„ä»¶è°ƒç”¨
 */
function validateForm(): boolean {
  if (!functionDetail.value) {
    Logger.warn('[FormView]', 'functionDetail ä¸å­˜åœ¨ï¼Œæ— æ³•éªŒè¯')
    return false
  }
  
  const fields = (Array.isArray(functionDetail.value.request) ? functionDetail.value.request : []) as FieldConfig[]
  const isValid = domainService.validateForm(fields)
  
  Logger.debug('[FormView]', 'è¡¨å•éªŒè¯ç»“æœ', {
    isValid,
    fieldsCount: fields.length,
    fieldCodes: fields.map(f => f.code)
  })
  
  return isValid
}

// ğŸ”¥ æš´éœ²æ–¹æ³•ç»™å¤–éƒ¨ç»„ä»¶è°ƒç”¨ï¼ˆå…¼å®¹ FormRenderer çš„æ¥å£ï¼‰
defineExpose({
  prepareSubmitDataWithTypeConversion,
  validateForm
})


// æ ¼å¼åŒ–æ—¥æœŸ
const formatDate = (dateStr: string): string => {
  if (!dateStr) return ''
  const date = new Date(dateStr)
  return date.toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  })
}

// ç”Ÿå‘½å‘¨æœŸ
let unsubscribeFunctionLoaded: (() => void) | null = null
let unsubscribeFormInitialized: (() => void) | null = null

/**
 * åŒæ­¥ formDataStore çš„æ•°æ®åˆ° stateManager
 * ğŸ”¥ ç¡®ä¿ SelectWidgetInitializer æ›´æ–°åçš„ display å€¼ä¸ä¸¢å¤±
 * 
 * @param fields å­—æ®µé…ç½®åˆ—è¡¨
 */
function syncFormDataStoreToStateManager(fields: FieldConfig[]): void {
  const state = stateManager.getState()
  const newData = new Map<string, FieldValue>()
  
  fields.forEach((field: FieldConfig) => {
    const fieldValue = formDataStore.getValue(field.code)
    if (fieldValue) {
      // ğŸ”¥ ç›´æ¥ä½¿ç”¨ formDataStore ä¸­çš„å®Œæ•´ FieldValueï¼ˆåŒ…å« displayï¼‰
      newData.set(field.code, fieldValue)
    } else {
      // å¦‚æœæ²¡æœ‰å€¼ï¼Œä½¿ç”¨é»˜è®¤å€¼
      newData.set(field.code, { raw: null, display: '', meta: {} })
    }
  })
  
  // ğŸ”¥ åŒæ­¥æ›´æ–° stateManagerï¼Œç¡®ä¿ fieldValues computed èƒ½è·å–åˆ°æœ€æ–°çš„ display å€¼
  stateManager.setState({
    ...state,
    data: newData
  })
}

/**
 * ä» formDataStore æ„å»º initialDataï¼ˆåªåŒ…å« raw å€¼ï¼‰
 * ç”¨äºä¼ é€’ç»™ applicationService.initializeForm
 * 
 * @param fields å­—æ®µé…ç½®åˆ—è¡¨
 * @returns initialData å¯¹è±¡
 */
function buildInitialDataFromFormDataStore(fields: FieldConfig[]): Record<string, any> {
  const initialData: Record<string, any> = {}
  fields.forEach((field: FieldConfig) => {
    const fieldValue = formDataStore.getValue(field.code)
    if (fieldValue) {
      initialData[field.code] = fieldValue.raw
    }
  })
  return initialData
}

// ğŸ”¥ ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®åˆå§‹åŒ–æ¡†æ¶
const { initialize: initializeParams } = useFunctionParamInitialization({
  functionDetail: computed(() => functionDetail.value),
  formDataStore: {
    getValue: (fieldCode: string) => formDataStore.getValue(fieldCode),
    setValue: (fieldCode: string, value: any) => formDataStore.setValue(fieldCode, value),
    getAllValues: () => {
      const allValues: Record<string, any> = {}
      const state = stateManager.getState()
      if (state.data) {
        state.data.forEach((value, key) => {
          allValues[key] = value
        })
      }
      return allValues
    },
    clear: () => formDataStore.clear()
  }
})

// ğŸ”¥ ä½¿ç”¨ Form å‚æ•° URL åŒæ­¥
// âš ï¸ å…³é”®ï¼šå¿…é¡»ç›´æ¥ä» formDataStore.data è·å–æ•°æ®ï¼Œç¡®ä¿å“åº”å¼è¿½è¸ª
const formDataStoreForURLSync = {
  getValue: (fieldCode: string) => formDataStore.getValue(fieldCode),
  getAllValues: () => {
    // ğŸ”¥ ç›´æ¥ä» formDataStore.data è·å–ï¼Œç¡®ä¿å“åº”å¼è¿½è¸ª
    const allValues: Record<string, FieldValue> = {}
    const data = formDataStore.data
    if (data) {
      data.forEach((value, key) => {
        allValues[key] = value
      })
    }
    return allValues
  }
}

/**
 * ğŸ”¥ åˆ¤æ–­æ˜¯å¦åº”è¯¥å¯ç”¨ URL åŒæ­¥
 * åªæœ‰æ–°å¢æ¨¡å¼ï¼ˆ_tab=OnTableAddRowï¼‰æ‰éœ€è¦åŒæ­¥ URL å‚æ•°
 * å…¶ä»–æ‰€æœ‰æƒ…å†µï¼ˆç¼–è¾‘æ¨¡å¼ã€è¯¦æƒ…æ¨¡å¼ç­‰ï¼‰éƒ½ä¸éœ€è¦åŒæ­¥
 */
const shouldSyncURL = computed(() => {
  // ğŸ”¥ åªæœ‰ _tab=OnTableAddRow æ—¶æ‰å¯ç”¨ URL åŒæ­¥
  return route.query._tab === 'OnTableAddRow'
})

const { watchFormData } = useFormParamURLSync({
  functionDetail: computed(() => functionDetail.value),
  formDataStore: formDataStoreForURLSync,
  enabled: shouldSyncURL,
  debounceMs: 300
})

onMounted(async () => {
  // ğŸ”¥ æŒ‚è½½æ—¶æ¸…ç† storeï¼Œé¿å…ä¹‹å‰å‡½æ•°çš„æ•°æ®æ±¡æŸ“
  formDataStore.clear()
  responseDataStore.clear()
  // â­ æ¸…é™¤ä¹‹å‰çš„æƒé™é”™è¯¯ï¼ˆåˆ‡æ¢å‡½æ•°æ—¶æ¸…é™¤ï¼‰
  permissionErrorStore.clearError()
  
  // ğŸ”¥ åœ¨ onMounted ä¸­ä¸»åŠ¨è·å– functionDetail
  // å¦‚æœ prop å·²ç»æä¾›äº† functionDetailï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦åˆ™ä» WorkspaceStateManager è·å–å½“å‰å‡½æ•°èŠ‚ç‚¹å¹¶åŠ è½½è¯¦æƒ…
  // âš ï¸ æ³¨æ„ï¼šid å¯èƒ½ä¸º 0ï¼ˆFormDialog ä¸­è®¾ç½®ï¼‰ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ç”¨ truthy åˆ¤æ–­
  if (props.functionDetail && (props.functionDetail.id !== undefined && props.functionDetail.id !== null)) {
    // å¦‚æœ prop å·²ç»æä¾›äº† functionDetailï¼Œç›´æ¥ä½¿ç”¨
    functionDetail.value = props.functionDetail
    Logger.debug('FormView', 'onMounted æ—¶ä½¿ç”¨ prop æä¾›çš„ functionDetail', {
      functionId: props.functionDetail.id,
      requestFieldsCount: Array.isArray(props.functionDetail.request) ? props.functionDetail.request.length : 0
    })
  } else {
    // å¦åˆ™ï¼Œä» WorkspaceStateManager è·å–å½“å‰å‡½æ•°èŠ‚ç‚¹å¹¶åŠ è½½è¯¦æƒ…
    const currentFunction = workspaceStateManager.getCurrentFunction()
    if (currentFunction && currentFunction.type === 'function') {
      Logger.debug('FormView', 'onMounted æ—¶ä¸»åŠ¨åŠ è½½ functionDetail', {
        functionNodeId: currentFunction.id,
        refId: currentFunction.ref_id,  // ğŸ”¥ è®°å½• ref_idï¼ˆå‡½æ•° IDï¼‰
        functionPath: currentFunction.full_code_path,
        hasRefId: !!(currentFunction.ref_id && currentFunction.ref_id > 0)
      })
      try {
        // ğŸ”¥ loadFunction ä¼šä¼˜å…ˆä½¿ç”¨ ref_id åŠ è½½å‡½æ•°è¯¦æƒ…
        const detail = await workspaceDomainService.loadFunction(currentFunction)
        functionDetail.value = detail
        Logger.info('FormView', 'onMounted æ—¶æˆåŠŸåŠ è½½ functionDetail', {
          functionId: detail.id,
          refId: currentFunction.ref_id,  // ğŸ”¥ è®°å½•ä½¿ç”¨çš„ ref_id
          requestFieldsCount: detail.request?.length || 0,
          requestFields: Array.isArray(detail.request) ? detail.request.map((f: any) => ({
            code: f.code,
            name: f.name,
            widgetType: f.widget?.type,
            hasDefault: !!(f.widget?.config as any)?.default,
            defaultValue: (f.widget?.config as any)?.default
          })) : []
        })
      } catch (error) {
        Logger.error('FormView', 'onMounted æ—¶åŠ è½½ functionDetail å¤±è´¥', error)
        return
      }
    } else {
      Logger.debug('FormView', 'onMounted æ—¶æ²¡æœ‰å½“å‰å‡½æ•°èŠ‚ç‚¹ï¼Œç­‰å¾… watch è§¦å‘', {
        hasCurrentFunction: !!currentFunction,
        functionType: currentFunction?.type
      })
      return
    }
  }
  
  /**
   * ğŸ”¥ ä½¿ç”¨ initialData åˆå§‹åŒ–è¡¨å•ï¼ˆç”¨äºç¼–è¾‘æ¨¡å¼ï¼‰
   * å…ˆæ¸…ç©º stateManagerï¼Œç„¶åç›´æ¥ä½¿ç”¨ initialData åˆå§‹åŒ–ï¼Œé¿å…é»˜è®¤å€¼å¹²æ‰°
   */
  const initializeFormWithData = (fields: FieldConfig[], initialData: Record<string, any>) => {
    // ğŸ”¥ é‡è¦ï¼šå…ˆæ¸…ç©º stateManagerï¼Œé¿å…å·²æœ‰å€¼å½±å“ initialData çš„åˆå§‹åŒ–
    const currentState = stateManager.getState()
    stateManager.setState({
      ...currentState,
      data: new Map(),
      errors: new Map(),
      submitting: false
    })
    
    // ğŸ”¥ ç›´æ¥è°ƒç”¨ initializeFormï¼Œä¸ä½¿ç”¨ syncFormDataStoreToStateManager
    // å› ä¸º formDataStore å¯èƒ½æ˜¯ç©ºçš„ï¼Œä¼šè®¾ç½®é»˜è®¤å€¼ï¼Œå½±å“ initialData çš„åˆå§‹åŒ–
    applicationService.initializeForm(fields, initialData)
  }

  /**
   * ğŸ”¥ ä½¿ç”¨æ­£å¸¸æµç¨‹åˆå§‹åŒ–è¡¨å•ï¼ˆç”¨äºæ–°å»ºæ¨¡å¼ï¼‰
   * å…ˆåˆå§‹åŒ–å‚æ•°ï¼Œç„¶åä» formDataStore æˆ– props.initialData æ„å»ºåˆå§‹æ•°æ®
   */
  const initializeFormNormal = async (fields: FieldConfig[]) => {
    Logger.debug('FormView', 'onMounted æ—¶åˆå§‹åŒ–å‚æ•°', {
      functionId: functionDetail.value?.id,
      requestFieldsCount: fields.length
    })
    const metadata = await initializeParams()
    
    // åˆå§‹åŒ–è¡¨å•ï¼šåœ¨å‚æ•°åˆå§‹åŒ–å®Œæˆåï¼Œåˆå§‹åŒ–è¡¨å•ç»“æ„
    if (fields.length > 0) {
      // ğŸ”¥ åŒæ­¥ formDataStore çš„æ•°æ®åˆ° stateManagerï¼Œç¡®ä¿ display å€¼ä¸ä¸¢å¤±
      syncFormDataStoreToStateManager(fields)
      
      // ğŸ”¥ ä¼˜å…ˆä½¿ç”¨ props.initialDataï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ formDataStore ä¸­çš„æ•°æ®
      const initialData = Object.keys(props.initialData).length > 0 
        ? props.initialData 
        : buildInitialDataFromFormDataStore(fields)
      applicationService.initializeForm(fields, initialData)
    }
    
    // ğŸ”¥ æ¢å¤å“åº”æ•°æ®ï¼ˆåœ¨è¡¨å•åˆå§‹åŒ–ä¹‹åï¼Œé¿å…è¢«è¦†ç›–ï¼‰
    if (metadata?.responseParams && stateManager) {
      stateManager.setResponse(metadata.responseParams)
      Logger.debug('FormView', 'å·²æ¢å¤å“åº”æ•°æ®', {
        responseParamsKeys: Object.keys(metadata.responseParams)
      })
    }
  }

  // ğŸ”¥ åˆå§‹åŒ–å‚æ•°ï¼ˆæ­¤æ—¶ functionDetail å·²ç»åŠ è½½å®Œæˆï¼‰
  // âš ï¸ æ³¨æ„ï¼šid å¯èƒ½ä¸º 0ï¼ˆFormDialog ä¸­è®¾ç½®ï¼‰ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ç”¨ truthy åˆ¤æ–­
  if (functionDetail.value && (functionDetail.value.id !== undefined && functionDetail.value.id !== null) && functionDetail.value.request) {
    const fields = Array.isArray(functionDetail.value.request) ? functionDetail.value.request : []
    
    // ğŸ”¥ å¦‚æœ props.initialData æœ‰å€¼ï¼Œç›´æ¥ä½¿ç”¨å®ƒåˆå§‹åŒ–ï¼Œè·³è¿‡ initializeParams
    // è¿™æ ·å¯ä»¥é¿å… initializeParams ä½¿ç”¨é»˜è®¤å€¼è¦†ç›– initialData
    if (Object.keys(props.initialData).length > 0 && fields.length > 0) {
      initializeFormWithData(fields, props.initialData)
    } else {
      // ğŸ”¥ å¦‚æœæ²¡æœ‰ initialDataï¼Œä½¿ç”¨æ­£å¸¸çš„åˆå§‹åŒ–æµç¨‹
      await initializeFormNormal(fields)
    }
  }

  // ç›‘å¬å‡½æ•°åŠ è½½å®Œæˆäº‹ä»¶
  let lastInitializedFunctionId: number | null = null // ğŸ”¥ è®°å½•ä¸Šæ¬¡åˆå§‹åŒ–çš„å‡½æ•° IDï¼Œé˜²æ­¢é‡å¤åˆå§‹åŒ–
  unsubscribeFunctionLoaded = eventBus.on(WorkspaceEvent.functionLoaded, async (payload: { detail: FunctionDetail }) => {
    if (payload.detail.template_type === TEMPLATE_TYPE.FORM && functionDetail.value && payload.detail.id === functionDetail.value.id) {
      // ğŸ”¥ é˜²é‡å¤åˆå§‹åŒ–ï¼šå¦‚æœå·²ç»åˆå§‹åŒ–è¿‡è¿™ä¸ªå‡½æ•°ï¼Œè·³è¿‡
      if (lastInitializedFunctionId === payload.detail.id) {
        Logger.debug('FormView', 'è·³è¿‡é‡å¤çš„ functionLoaded äº‹ä»¶', { functionId: payload.detail.id })
        return
      }
      lastInitializedFunctionId = payload.detail.id
      
      // ğŸ”¥ åˆ‡æ¢å‡½æ•°æ—¶ï¼Œå…ˆæ¸…ç†å…¨å±€ storeï¼ˆå› ä¸º WidgetComponent å†…éƒ¨ä½¿ç”¨çš„ç»„ä»¶ä¼šç›´æ¥ä½¿ç”¨è¿™äº› storeï¼‰
      formDataStore.clear()
      responseDataStore.clear()
      
      // ğŸ”¥ ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®åˆå§‹åŒ–æ¡†æ¶åˆå§‹åŒ–å‚æ•°
      const metadata = await initializeParams()
      
      // ğŸ”¥ ä½¿ç”¨ nextTick ç¡®ä¿å‚æ•°åˆå§‹åŒ–å®Œæˆ
      nextTick(() => {
        // é‡æ–°åˆå§‹åŒ–è¡¨å•ï¼ˆä» formDataStore è·å–å·²åˆå§‹åŒ–çš„æ•°æ®ï¼‰
        // ğŸ”¥ ç¡®ä¿ fields æ˜¯æ•°ç»„ï¼Œé˜²æ­¢ç±»å‹é”™è¯¯
        const fields = (Array.isArray(payload.detail.request) ? payload.detail.request : []) as FieldConfig[]
        if (fields.length > 0) {
          // ğŸ”¥ åŒæ­¥ formDataStore çš„æ•°æ®åˆ° stateManagerï¼Œç¡®ä¿ display å€¼ä¸ä¸¢å¤±
          syncFormDataStoreToStateManager(fields)
          
          // ğŸ”¥ æ„å»º initialData å¹¶è°ƒç”¨ initializeForm
          const initialData = buildInitialDataFromFormDataStore(fields)
          applicationService.initializeForm(fields, initialData)
        }
        
        // ğŸ”¥ æ¢å¤å“åº”æ•°æ®ï¼ˆåœ¨è¡¨å•åˆå§‹åŒ–ä¹‹åï¼Œé¿å…è¢«è¦†ç›–ï¼‰
        if (metadata?.responseParams && stateManager && typeof (stateManager as any).setResponse === 'function') {
          (stateManager as any).setResponse(metadata.responseParams)
          Logger.debug('FormView', 'å·²æ¢å¤å“åº”æ•°æ®', {
            responseParamsKeys: Object.keys(metadata.responseParams),
            responseParams: metadata.responseParams,
            stateResponse: stateManager.getState().response
          })
        }
      })
    }
  })

  // ç›‘å¬è¡¨å•åˆå§‹åŒ–å®Œæˆäº‹ä»¶
  unsubscribeFormInitialized = eventBus.on(FormEvent.initialized, () => {
    // è¡¨å•å·²åˆå§‹åŒ–ï¼Œå¯ä»¥æ¸²æŸ“
  })
  
  // ğŸ”¥ å¼€å§‹ç›‘å¬è¡¨å•æ•°æ®å˜åŒ–ï¼Œè‡ªåŠ¨åŒæ­¥åˆ° URL
  watchFormData()
})

  // ğŸ”¥ ç›‘å¬ props.functionDetail å˜åŒ–ï¼ŒåŒæ­¥åˆ°å†…éƒ¨çš„ functionDetail ref
  // æ³¨æ„ï¼šåªåœ¨ props.functionDetail çœŸæ­£å˜åŒ–æ—¶ï¼ˆid æˆ– router å˜åŒ–ï¼‰æ‰é‡æ–°åˆå§‹åŒ–
  // åˆå§‹åŒ–é€»è¾‘åœ¨ onMounted ä¸­å¤„ç†ï¼Œè¿™é‡Œåªå¤„ç†å‡½æ•°åˆ‡æ¢çš„åœºæ™¯
  watch(() => props.functionDetail, async (newDetail: FunctionDetail | undefined, oldDetail?: FunctionDetail) => {
    // â­ åˆ‡æ¢å‡½æ•°æ—¶æ¸…é™¤æƒé™é”™è¯¯
    permissionErrorStore.clearError()
    
    // ğŸ”¥ åŒæ­¥åˆ°å†…éƒ¨çš„ functionDetail ref
    // âš ï¸ æ³¨æ„ï¼šid å¯èƒ½ä¸º 0ï¼ˆFormDialog ä¸­è®¾ç½®ï¼‰ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ç”¨ truthy åˆ¤æ–­
    if (newDetail && (newDetail.id !== undefined && newDetail.id !== null)) {
      functionDetail.value = newDetail
    }
    
    // ğŸ”¥ æ£€æŸ¥ functionDetail æ˜¯å¦æœ‰æ•ˆï¼ˆå¿…é¡»è¦æœ‰ id å’Œ request å­—æ®µï¼‰
    // âš ï¸ æ³¨æ„ï¼šid å¯èƒ½ä¸º 0ï¼ˆFormDialog ä¸­è®¾ç½®ï¼‰ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ç”¨ truthy åˆ¤æ–­
    if (!newDetail || (newDetail.id === undefined || newDetail.id === null) || !newDetail.request) {
      Logger.debug('FormView', 'props.functionDetail æ— æ•ˆæˆ–æœªåŠ è½½å®Œæˆï¼Œè·³è¿‡åˆå§‹åŒ–', {
        hasDetail: !!newDetail,
        hasId: !!newDetail?.id,
        hasRequest: !!newDetail?.request,
        requestCount: newDetail?.request?.length || 0
      })
      return
    }
    
    // ğŸ”¥ åªåœ¨ functionDetail çš„ id æˆ– router çœŸæ­£å˜åŒ–æ—¶é‡æ–°åˆå§‹åŒ–
    // å¦‚æœåªæ˜¯å…¶ä»–å±æ€§å˜åŒ–ï¼ˆå¦‚å­—æ®µé…ç½®ï¼‰ï¼Œä¸åº”è¯¥é‡æ–°åˆå§‹åŒ–
    // æ³¨æ„ï¼šoldDetail ä¸º undefined æ—¶ï¼Œè¯´æ˜æ˜¯é¦–æ¬¡è®¾ç½®ï¼Œæ­¤æ—¶ onMounted å·²ç»å¤„ç†è¿‡äº†ï¼Œä¸éœ€è¦é‡å¤åˆå§‹åŒ–
    if (oldDetail && (newDetail.id !== oldDetail.id || newDetail.router !== oldDetail.router)) {
      Logger.debug('FormView', 'props.functionDetail å˜åŒ–ï¼ˆå‡½æ•°åˆ‡æ¢ï¼‰ï¼Œå¼€å§‹é‡æ–°åˆå§‹åŒ–', {
        oldId: oldDetail.id,
        newId: newDetail.id,
        oldRouter: oldDetail.router,
        newRouter: newDetail.router,
        requestFieldsCount: newDetail.request?.length || 0
      })
      
      // ğŸ”¥ åˆ‡æ¢å‡½æ•°æ—¶ï¼Œå…ˆæ¸…ç†å…¨å±€ storeï¼ˆå› ä¸º WidgetComponent å†…éƒ¨ä½¿ç”¨çš„ç»„ä»¶ä¼šç›´æ¥ä½¿ç”¨è¿™äº› storeï¼‰
      formDataStore.clear()
      responseDataStore.clear()
      
      // ğŸ”¥ ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®åˆå§‹åŒ–æ¡†æ¶åˆå§‹åŒ–å‚æ•°ï¼ˆæ­¤æ—¶ functionDetail å·²ç»åŠ è½½å®Œæˆï¼‰
      const metadata = await initializeParams()
      
      const fields = (newDetail.request || []) as FieldConfig[]
      if (fields.length > 0) {
        // ğŸ”¥ ä½¿ç”¨ nextTick ç¡®ä¿å‚æ•°åˆå§‹åŒ–å®Œæˆ
        nextTick(() => {
          // ğŸ”¥ åŒæ­¥ formDataStore çš„æ•°æ®åˆ° stateManagerï¼Œç¡®ä¿ display å€¼ä¸ä¸¢å¤±
          syncFormDataStoreToStateManager(fields)
          
          // ğŸ”¥ æ„å»º initialData å¹¶è°ƒç”¨ initializeForm
          // ğŸ”¥ ä¼˜å…ˆä½¿ç”¨ props.initialDataï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ formDataStore ä¸­çš„æ•°æ®
          const initialData = Object.keys(props.initialData).length > 0 
            ? props.initialData 
            : buildInitialDataFromFormDataStore(fields)
          console.log('[FormView] å‡½æ•°åˆ‡æ¢ååˆå§‹åŒ–è¡¨å•', {
            fieldsCount: fields.length,
            fieldCodes: fields.map((f: FieldConfig) => f.code),
            initialDataKeys: Object.keys(initialData),
            initialData,
            propsInitialDataKeys: Object.keys(props.initialData),
            propsInitialData: props.initialData,
            fromProps: Object.keys(props.initialData).length > 0
          })
          applicationService.initializeForm(fields, initialData)
          
          // ğŸ”¥ æ¢å¤å“åº”æ•°æ®ï¼ˆåœ¨è¡¨å•åˆå§‹åŒ–ä¹‹åï¼Œé¿å…è¢«è¦†ç›–ï¼‰
          if (metadata?.responseParams && stateManager && typeof (stateManager as any).setResponse === 'function') {
            (stateManager as any).setResponse(metadata.responseParams)
            Logger.debug('FormView', 'å·²æ¢å¤å“åº”æ•°æ®', {
              responseParamsKeys: Object.keys(metadata.responseParams),
              responseParams: metadata.responseParams,
              stateResponse: stateManager.getState().response
            })
          }
        })
      }
    }
  }, { deep: false }) // ğŸ”¥ ç§»é™¤ immediate: trueï¼Œé¿å…ä¸ onMounted é‡å¤åˆå§‹åŒ–

  /**
   * ğŸ”¥ æ£€æŸ¥ initialData æ˜¯å¦çœŸçš„å˜åŒ–äº†
   */
  const hasInitialDataChanged = (
    newData: Record<string, any>,
    oldData?: Record<string, any>
  ): boolean => {
    const newKeys = Object.keys(newData || {})
    const oldKeys = Object.keys(oldData || {})
    
    // å¦‚æœ key æ•°é‡ä¸åŒï¼Œæˆ–è€…æœ‰æ–°çš„ keyï¼Œæˆ–è€…å€¼æœ‰å˜åŒ–ï¼Œæ‰é‡æ–°åˆå§‹åŒ–
    return newKeys.length !== oldKeys.length || 
      newKeys.some(key => newData[key] !== oldData?.[key])
  }

  // ğŸ”¥ ç›‘å¬ initialData å˜åŒ–ï¼Œå½“åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼æ—¶é‡æ–°åˆå§‹åŒ–è¡¨å•
  watch(() => props.initialData, async (newInitialData: Record<string, any>, oldInitialData?: Record<string, any>) => {
    // åªåœ¨ initialData çœŸæ­£å˜åŒ–æ—¶ï¼ˆä¸”ä¸æ˜¯é¦–æ¬¡è®¾ç½®ï¼‰æ‰é‡æ–°åˆå§‹åŒ–
    if (!functionDetail.value || !functionDetail.value.request) {
      return
    }
    
    if (!hasInitialDataChanged(newInitialData, oldInitialData)) {
      return
    }
    
    const fields = (functionDetail.value.request || []) as FieldConfig[]
    if (fields.length > 0 && newInitialData && Object.keys(newInitialData).length > 0) {
      // ğŸ”¥ ä½¿ç”¨æ–°çš„ initialData é‡æ–°åˆå§‹åŒ–è¡¨å•
      nextTick(() => {
        syncFormDataStoreToStateManager(fields)
        applicationService.initializeForm(fields, newInitialData)
      })
    }
  }, { deep: true })

  // ğŸ”¥ ç›‘å¬ functionDetail å’Œ initialData çš„ç»„åˆå˜åŒ–ï¼Œç¡®ä¿åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹èƒ½å¤Ÿæ­£ç¡®åˆå§‹åŒ–
  // å½“åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼æ—¶ï¼ŒfunctionDetail å¯èƒ½ä¼šå˜åŒ–ï¼Œæ­¤æ—¶éœ€è¦é‡æ–°åˆå§‹åŒ–è¡¨å•
  watch(
    () => [props.functionDetail?.id, props.functionDetail?.request, Object.keys(props.initialData || {})],
    async ([newId, newRequest, newInitialDataKeys], [oldId, oldRequest, oldInitialDataKeys]) => {
      // åªåœ¨ functionDetail å‡†å¤‡å¥½ä¸”æœ‰ initialData æ—¶æ‰åˆå§‹åŒ–
      // âš ï¸ æ³¨æ„ï¼šid å¯èƒ½ä¸º 0ï¼ˆFormDialog ä¸­è®¾ç½®ï¼‰ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ç”¨ truthy åˆ¤æ–­
      if (!functionDetail.value || !functionDetail.value.request || (functionDetail.value.id === undefined || functionDetail.value.id === null)) {
        return
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„ initialDataï¼ˆä»ç©ºå˜ä¸ºæœ‰å€¼ï¼‰
      const hasNewInitialData = newInitialDataKeys && newInitialDataKeys.length > 0 && 
        (!oldInitialDataKeys || oldInitialDataKeys.length === 0)
      
      // æ£€æŸ¥ functionDetail æ˜¯å¦å˜åŒ–äº†ï¼ˆid æˆ– request å˜åŒ–ï¼‰
      const functionDetailChanged = newId !== oldId || 
        (newRequest && oldRequest && JSON.stringify(newRequest) !== JSON.stringify(oldRequest))
      
      // å¦‚æœ functionDetail å˜åŒ–äº†ï¼Œæˆ–è€…æœ‰æ–°çš„ initialDataï¼Œé‡æ–°åˆå§‹åŒ–
      if (functionDetailChanged || hasNewInitialData) {
        const fields = (functionDetail.value.request || []) as FieldConfig[]
        if (fields.length > 0) {
          const initialData = Object.keys(props.initialData).length > 0 
            ? props.initialData 
            : buildInitialDataFromFormDataStore(fields)
          
          if (Object.keys(initialData).length > 0) {
            nextTick(() => {
              syncFormDataStoreToStateManager(fields)
              applicationService.initializeForm(fields, initialData)
            })
          }
        }
      }
    },
    { deep: true, immediate: false }
  )

  // ğŸ”¥ ç§»é™¤ watch route.queryï¼Œæ”¹ä¸ºä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®åˆå§‹åŒ–æ¡†æ¶å¤„ç† URL å‚æ•°
  // URL å‚æ•°ä¼šåœ¨ initializeParams æ—¶ç»Ÿä¸€å¤„ç†ï¼ŒåŒ…æ‹¬ç±»å‹è½¬æ¢å’Œç»„ä»¶è‡ªæ²»åˆå§‹åŒ–

onUnmounted(() => {
  if (unsubscribeFunctionLoaded) {
    unsubscribeFunctionLoaded()
  }
  if (unsubscribeFormInitialized) {
    unsubscribeFormInitialized()
  }
})
</script>

<style scoped lang="scss">
.form-view {
  padding: 20px;
}

.form-view-container {
  display: flex;
  gap: 20px;
  align-items: flex-start;
}

.form-view-main {
  flex: 1;
  min-width: 0; // é˜²æ­¢ flex å­å…ƒç´ æº¢å‡º
}

.form-view-sidebar {
  width: 360px;
  flex-shrink: 0;
  position: sticky;
  top: 20px;
  max-height: calc(100vh - 40px);
  overflow-y: auto;
}

.function-detail-card {
  .function-detail-header {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    font-size: 16px;
    color: var(--el-text-color-primary);
  }
}

.detail-section {
  margin-bottom: 24px;
  
  .detail-section-title {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    font-weight: 500;
    color: var(--el-text-color-regular);
    margin-bottom: 12px;
  }
  
  .creator-info {
    display: flex;
    align-items: flex-start;
    width: 100%;
  }
  
  &:last-child {
    margin-bottom: 0;
  }
}

.function-name {
  font-size: 18px;
  font-weight: 600;
  color: var(--el-text-color-primary);
  margin-bottom: 16px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--el-border-color-lighter);
}

.detail-section-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  font-size: 14px;
  color: var(--el-text-color-primary);
  margin-bottom: 12px;
}

.description-wrapper {
  position: relative;
}

.description-content {
  font-size: 14px;
  color: var(--el-text-color-primary);
  line-height: 1.8;
  white-space: pre-wrap;
  word-break: break-word;
  padding: 16px 20px;
  background: linear-gradient(135deg, rgba(64, 158, 255, 0.05) 0%, rgba(64, 158, 255, 0.02) 100%);
  border-radius: 8px;
  border-left: 3px solid var(--el-color-primary);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  position: relative;
  
  &::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(180deg, var(--el-color-primary) 0%, rgba(64, 158, 255, 0.6) 100%);
    border-radius: 8px 0 0 8px;
  }
}

.tags-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.tag-item {
  margin: 0;
}

.empty-tip {
  padding: 20px 0;
}

/* ğŸ”¥ æƒé™é”™è¯¯æ˜¾ç¤ºæ ·å¼å·²ç§»è‡³ PermissionDeniedView ç»„ä»¶ */

/* Debug å¼¹çª—æ ·å¼ */
.debug-section {
  margin-bottom: 20px;
}

.debug-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.debug-label {
  font-weight: 600;
  color: #606266;
}

.debug-json-input {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
  font-size: 13px;
  line-height: 1.5;
}

.debug-json-input :deep(.el-textarea__inner) {
  background-color: #f5f7fa;
  border: 1px solid #dcdfe6;
  color: #303133;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
  resize: none;
}

.debug-json-input :deep(.el-textarea__inner):focus {
  border-color: #409eff;
  background-color: #fff;
}

.section-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 20px;
  color: var(--el-text-color-primary);
}

.form-actions {
  margin-top: 20px;
  display: flex;
  gap: 10px;
}

.form-actions-section {
  margin-top: 20px;
}

.form-actions-row {
  display: flex;
  gap: 12px;
}

.submit-button-full-width {
  flex: 1;
}

.response-section {
  margin-top: 40px;
  padding-top: 20px;
  border-top: 1px solid var(--el-border-color);
}

.response-section .is-empty {
  opacity: 0.6;
}

.metadata-section {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid var(--el-border-color);
}

.metadata-title {
  font-size: 14px;
  font-weight: 500;
  color: var(--el-text-color-regular);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.metadata-icon {
  color: var(--el-color-info);
  font-size: 16px;
}

.metadata-content {
  padding: 12px 16px;
  background: var(--el-fill-color-lighter);
  border: 1px solid var(--el-border-color-lighter);
  border-radius: var(--el-border-radius-base);
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.metadata-label {
  color: var(--el-text-color-regular);
  font-weight: 500;
}

.metadata-value {
  color: var(--el-color-primary);
  font-weight: 600;
  font-size: 14px;
}

.dialog-footer {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.loading-container {
  padding: 20px;
}

.empty-container {
  padding: 40px 0;
}
</style>


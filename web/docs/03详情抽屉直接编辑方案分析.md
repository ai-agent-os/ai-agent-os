# è¯¦æƒ…æŠ½å±‰ç›´æ¥ç¼–è¾‘æ–¹æ¡ˆåˆ†æ

## ğŸ“‹ éœ€æ±‚åˆ†æ

### å½“å‰æµç¨‹
1. ç‚¹å‡»è®°å½• ID â†’ æ‰“å¼€è¯¦æƒ…æŠ½å±‰ï¼ˆåªè¯»ï¼‰
2. æŸ¥çœ‹è¯¦æƒ…
3. å…³é—­è¯¦æƒ…æŠ½å±‰
4. ç‚¹å‡»"ç¼–è¾‘"æŒ‰é’® â†’ æ‰“å¼€ç¼–è¾‘å¼¹çª—
5. ç¼–è¾‘å­—æ®µ
6. ç‚¹å‡»"ç¡®å®š" â†’ æäº¤

**é—®é¢˜**ï¼šæµç¨‹ç¹çï¼Œéœ€è¦"å…³é—­è¯¦æƒ… â†’ æ‰“å¼€ç¼–è¾‘"çš„é¢å¤–æ­¥éª¤

### æœŸæœ›æµç¨‹
1. ç‚¹å‡»è®°å½• ID â†’ æ‰“å¼€è¯¦æƒ…æŠ½å±‰ï¼ˆæŸ¥çœ‹æ¨¡å¼ï¼‰
2. ç‚¹å‡»"ç¼–è¾‘"æŒ‰é’® â†’ åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
3. ç›´æ¥ç¼–è¾‘å­—æ®µ
4. ç‚¹å‡»"ä¿å­˜" â†’ æäº¤
5. è‡ªåŠ¨åˆ‡æ¢å›æŸ¥çœ‹æ¨¡å¼

**ä¼˜åŠ¿**ï¼šæµç¨‹æ›´é¡ºç•…ï¼Œå‡å°‘æ“ä½œæ­¥éª¤

## ğŸ¯ å¯è¡Œæ€§åˆ†æ

### âœ… æŠ€æœ¯å¯è¡Œæ€§ï¼šå®Œå…¨å¯è¡Œ

#### 1. FormRenderer å·²æ”¯æŒç¼–è¾‘æ¨¡å¼

`FormRenderer` å·²ç»æ”¯æŒï¼š
- âœ… `mode="edit"` - å¯ç¼–è¾‘æ¨¡å¼
- âœ… `initialData` prop - åˆå§‹æ•°æ®å¡«å……
- âœ… `prepareSubmitDataWithTypeConversion()` - æäº¤æ•°æ®å‡†å¤‡
- âœ… è¡¨å•éªŒè¯å’Œæäº¤é€»è¾‘

#### 2. è¯¦æƒ…æŠ½å±‰å¯ä»¥åˆ‡æ¢æ¨¡å¼

å¯ä»¥åœ¨è¯¦æƒ…æŠ½å±‰ä¸­ï¼š
- âœ… æ·»åŠ "æŸ¥çœ‹/ç¼–è¾‘"æ¨¡å¼åˆ‡æ¢
- âœ… æŸ¥çœ‹æ¨¡å¼ï¼šä½¿ç”¨å½“å‰çš„ `renderDetailField`ï¼ˆåªè¯»ï¼‰
- âœ… ç¼–è¾‘æ¨¡å¼ï¼šä½¿ç”¨ `FormRenderer`ï¼ˆå¯ç¼–è¾‘ï¼‰

#### 3. å¯ä»¥å¤ç”¨ç°æœ‰èƒ½åŠ›

- âœ… **FormRenderer**ï¼šç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€ä¿®æ”¹
- âœ… **FormDialog çš„æäº¤é€»è¾‘**ï¼šå¯ä»¥å¤ç”¨
- âœ… **æƒé™è¿‡æ»¤**ï¼š`table_permission` é€»è¾‘å·²å®ç°
- âœ… **ç”¨æˆ·ä¿¡æ¯æ˜ å°„**ï¼š`userInfoMap` å·²æ”¯æŒ

## ğŸ“Š å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šæ¨¡å¼åˆ‡æ¢ï¼ˆæ¨èï¼‰

åœ¨è¯¦æƒ…æŠ½å±‰ä¸­æ”¯æŒ"æŸ¥çœ‹"å’Œ"ç¼–è¾‘"ä¸¤ç§æ¨¡å¼ï¼Œå¯ä»¥åˆ‡æ¢ã€‚

#### 1. æ•°æ®ç»“æ„

```typescript
// è¯¦æƒ…æŠ½å±‰çŠ¶æ€
const showDetailDrawer = ref(false)
const detailMode = ref<'view' | 'edit'>('view')  // æŸ¥çœ‹/ç¼–è¾‘æ¨¡å¼
const currentDetailRow = ref<Record<string, any> | null>(null)
const formRendererRef = ref<InstanceType<typeof FormRenderer>>()
```

#### 2. æ¨¡æ¿ç»“æ„

```vue
<el-drawer v-model="showDetailDrawer" title="è®°å½•è¯¦æƒ…" size="900px">
  <template #header>
    <div class="drawer-header">
      <span class="drawer-title">è®°å½•è¯¦æƒ…</span>
      
      <!-- æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
      <div class="drawer-actions">
        <el-button
          v-if="detailMode === 'view' && hasUpdateCallback"
          type="primary"
          @click="switchToEditMode"
        >
          <el-icon><Edit /></el-icon>
          ç¼–è¾‘
        </el-button>
        <el-button
          v-if="detailMode === 'edit'"
          @click="switchToViewMode"
        >
          å–æ¶ˆ
        </el-button>
        <el-button
          v-if="detailMode === 'edit'"
          type="primary"
          :loading="submitting"
          @click="handleSave"
        >
          ä¿å­˜
        </el-button>
      </div>
    </div>
  </template>

  <!-- æŸ¥çœ‹æ¨¡å¼ -->
  <div v-if="detailMode === 'view'" class="detail-content">
    <!-- å½“å‰çš„åªè¯»å±•ç¤ºé€»è¾‘ -->
    <div class="fields-grid">
      <div v-for="field in visibleFields" :key="field.code" class="field-row">
        <div class="field-label">{{ field.name }}</div>
        <div class="field-value">
          <component :is="renderDetailField(field, currentDetailRow[field.code])" />
        </div>
      </div>
    </div>
  </div>

  <!-- ç¼–è¾‘æ¨¡å¼ -->
  <div v-else-if="detailMode === 'edit'" class="edit-content">
    <FormRenderer
      ref="formRendererRef"
      :function-detail="editFunctionDetail"
      :initial-data="currentDetailRow"
      :user-info-map="userInfoMap"
      :show-submit-button="false"
      :show-reset-button="false"
    />
  </div>
</el-drawer>
```

#### 3. æ ¸å¿ƒé€»è¾‘

```typescript
// åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
function switchToEditMode() {
  detailMode.value = 'edit'
  // FormRenderer ä¼šè‡ªåŠ¨ä½¿ç”¨ initialData å¡«å……æ•°æ®
}

// åˆ‡æ¢å›æŸ¥çœ‹æ¨¡å¼
function switchToViewMode() {
  detailMode.value = 'view'
}

// ä¿å­˜ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
async function handleSave() {
  if (!formRendererRef.value) {
    ElMessage.error('è¡¨å•å¼•ç”¨ä¸å­˜åœ¨')
    return
  }
  
  try {
    submitting.value = true
    
    // 1. å‡†å¤‡æäº¤æ•°æ®
    const submitData = formRendererRef.value.prepareSubmitDataWithTypeConversion()
    
    // 2. è°ƒç”¨æ›´æ–°æ¥å£ï¼ˆå¤ç”¨ FormDialog çš„é€»è¾‘ï¼‰
    await handleDialogSubmit(submitData)
    
    // 3. åˆ‡æ¢å›æŸ¥çœ‹æ¨¡å¼
    detailMode.value = 'view'
    
    // 4. åˆ·æ–°å½“å‰è®°å½•æ•°æ®
    await refreshCurrentDetailRow()
    
    ElMessage.success('ä¿å­˜æˆåŠŸ')
  } catch (error) {
    console.error('ä¿å­˜å¤±è´¥:', error)
    ElMessage.error('ä¿å­˜å¤±è´¥')
  } finally {
    submitting.value = false
  }
}

// æ„å»ºç¼–è¾‘ç”¨çš„ FunctionDetail
const editFunctionDetail = computed<FunctionDetail>(() => {
  // è¿‡æ»¤å­—æ®µï¼ˆåªæ˜¾ç¤ºå¯ç¼–è¾‘çš„å­—æ®µï¼‰
  const editableFields = props.functionData.response.filter(field => {
    const permission = field.table_permission
    // ç¼–è¾‘æ¨¡å¼ï¼šæ˜¾ç¤ºç©ºã€update æƒé™çš„å­—æ®µ
    return !permission || permission === '' || permission === 'update'
  })
  
  return {
    id: 0,
    app_id: 0,
    tree_id: 0,
    method: 'PUT',  // ç¼–è¾‘ä½¿ç”¨ PUT æ–¹æ³•
    router: props.functionData.router,
    has_config: false,
    create_tables: '',
    callbacks: props.functionData.callbacks,
    template_type: 'form',
    request: editableFields,  // ä½¿ç”¨è¿‡æ»¤åçš„å­—æ®µ
    response: [],
    created_at: '',
    updated_at: '',
    full_code_path: ''
  }
})
```

### æ–¹æ¡ˆ Bï¼šç›´æ¥ç¼–è¾‘æ¨¡å¼ï¼ˆå¤‡é€‰ï¼‰

è¯¦æƒ…æŠ½å±‰é»˜è®¤å°±æ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œä¸éœ€è¦åˆ‡æ¢ã€‚

**ä¼˜åŠ¿**ï¼š
- âœ… æ›´ç®€å•ï¼Œä¸éœ€è¦æ¨¡å¼åˆ‡æ¢
- âœ… ç›´æ¥ç¼–è¾‘ï¼Œæ›´ç›´è§‚

**åŠ£åŠ¿**ï¼š
- âŒ å¦‚æœç”¨æˆ·åªæƒ³æŸ¥çœ‹ï¼Œä¹Ÿéœ€è¦çœ‹åˆ°ç¼–è¾‘æ¡†
- âŒ å¯èƒ½è¯¯æ“ä½œ

## ğŸ”„ å¤ç”¨ç°æœ‰èƒ½åŠ›åˆ†æ

### âœ… å¯ä»¥å®Œå…¨å¤ç”¨

#### 1. FormRenderer
- âœ… ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€ä¿®æ”¹
- âœ… æ”¯æŒ `initialData` å¡«å……
- âœ… æ”¯æŒ `mode="edit"` ç¼–è¾‘æ¨¡å¼
- âœ… æ”¯æŒè¡¨å•éªŒè¯å’Œæäº¤

#### 2. FormDialog çš„æäº¤é€»è¾‘
```typescript
// FormDialog çš„æäº¤é€»è¾‘
async function handleSubmit() {
  const submitData = formRendererRef.value.prepareSubmitDataWithTypeConversion()
  emit('submit', submitData)
}

// å¯ä»¥ç›´æ¥å¤ç”¨
async function handleSave() {
  const submitData = formRendererRef.value.prepareSubmitDataWithTypeConversion()
  await handleDialogSubmit(submitData)  // å¤ç”¨ TableRenderer çš„æäº¤é€»è¾‘
}
```

#### 3. æƒé™è¿‡æ»¤é€»è¾‘
```typescript
// FormDialog å·²ç»å®ç°äº†æƒé™è¿‡æ»¤
const filteredFields = computed(() => {
  return props.fields.filter(field => {
    const permission = field.table_permission
    if (props.mode === 'update') {
      return !permission || permission === '' || permission === 'update'
    }
    return true
  })
})

// å¯ä»¥ç›´æ¥å¤ç”¨è¿™ä¸ªé€»è¾‘
```

#### 4. ç”¨æˆ·ä¿¡æ¯æ˜ å°„
```typescript
// FormRenderer å·²ç»æ”¯æŒ userInfoMap
<FormRenderer
  :user-info-map="userInfoMap"  // ç›´æ¥ä¼ é€’
/>
```

## ğŸ“ æ”¹é€ èŒƒå›´

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

#### 1. TableRenderer.vueï¼ˆä¸»è¦ä¿®æ”¹ï¼‰

**æ–°å¢çŠ¶æ€**ï¼š
```typescript
const detailMode = ref<'view' | 'edit'>('view')
const formRendererRef = ref<InstanceType<typeof FormRenderer>>()
const submitting = ref(false)
```

**æ–°å¢æ–¹æ³•**ï¼š
```typescript
function switchToEditMode()
function switchToViewMode()
async function handleSave()
const editFunctionDetail = computed<FunctionDetail>()
```

**ä¿®æ”¹æ¨¡æ¿**ï¼š
- åœ¨ drawer header æ·»åŠ "ç¼–è¾‘/å–æ¶ˆ/ä¿å­˜"æŒ‰é’®
- æ·»åŠ ç¼–è¾‘æ¨¡å¼çš„ FormRenderer
- ä¿æŒæŸ¥çœ‹æ¨¡å¼çš„ç°æœ‰é€»è¾‘

**ä¿®æ”¹é€»è¾‘**ï¼š
- `handleShowDetail`ï¼šæ‰“å¼€è¯¦æƒ…æ—¶ï¼Œé‡ç½®ä¸ºæŸ¥çœ‹æ¨¡å¼
- `handleNavigate`ï¼šåˆ‡æ¢è®°å½•æ—¶ï¼Œé‡ç½®ä¸ºæŸ¥çœ‹æ¨¡å¼

#### 2. æ— éœ€ä¿®æ”¹çš„æ–‡ä»¶

- âœ… `FormRenderer.vue` - æ— éœ€ä¿®æ”¹ï¼Œç›´æ¥ä½¿ç”¨
- âœ… `FormDialog.vue` - æ— éœ€ä¿®æ”¹ï¼ˆç¼–è¾‘å¼¹çª—å¯ä»¥ä¿ç•™ï¼Œä½œä¸ºå¤‡é€‰ï¼‰
- âœ… Widget ç»„ä»¶ - æ— éœ€ä¿®æ”¹ï¼Œå·²æ”¯æŒ edit æ¨¡å¼

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ¨¡å¼åˆ‡æ¢æ—¶çš„æ•°æ®åŒæ­¥

```typescript
// åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼æ—¶ï¼Œç¡®ä¿æ•°æ®å·²åŠ è½½
function switchToEditMode() {
  if (!currentDetailRow.value) {
    ElMessage.error('è®°å½•æ•°æ®ä¸å­˜åœ¨')
    return
  }
  detailMode.value = 'edit'
  // FormRenderer ä¼šè‡ªåŠ¨ä½¿ç”¨ initialData å¡«å……
}

// åˆ‡æ¢å›æŸ¥çœ‹æ¨¡å¼æ—¶ï¼Œåˆ·æ–°æ•°æ®
async function switchToViewMode() {
  detailMode.value = 'view'
  // å¯é€‰ï¼šåˆ·æ–°å½“å‰è®°å½•æ•°æ®ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°
  await refreshCurrentDetailRow()
}
```

### 2. å¯¼èˆªæ—¶çš„æ¨¡å¼é‡ç½®

```typescript
// åˆ‡æ¢è®°å½•æ—¶ï¼Œé‡ç½®ä¸ºæŸ¥çœ‹æ¨¡å¼
async function handleNavigate(direction: 'prev' | 'next') {
  // ... å¯¼èˆªé€»è¾‘ ...
  detailMode.value = 'view'  // é‡ç½®ä¸ºæŸ¥çœ‹æ¨¡å¼
}
```

### 3. æäº¤åçš„æ•°æ®åˆ·æ–°

```typescript
async function handleSave() {
  // ... æäº¤é€»è¾‘ ...
  
  // æäº¤æˆåŠŸåï¼Œåˆ·æ–°å½“å‰è®°å½•æ•°æ®
  await refreshCurrentDetailRow()
  
  // åˆ‡æ¢å›æŸ¥çœ‹æ¨¡å¼
  detailMode.value = 'view'
}
```

### 4. æƒé™æ§åˆ¶

```typescript
// åªæœ‰æœ‰æ›´æ–°æƒé™æ—¶æ‰æ˜¾ç¤ºç¼–è¾‘æŒ‰é’®
const hasUpdateCallback = computed(() => {
  return props.functionData?.callbacks?.update !== undefined
})

// ç¼–è¾‘æ¨¡å¼åªæ˜¾ç¤ºå¯ç¼–è¾‘çš„å­—æ®µ
const editFunctionDetail = computed(() => {
  const editableFields = props.functionData.response.filter(field => {
    const permission = field.table_permission
    return !permission || permission === '' || permission === 'update'
  })
  // ...
})
```

## ğŸ¯ æ¨èæ–¹æ¡ˆ

### æ¨èï¼šæ–¹æ¡ˆ Aï¼ˆæ¨¡å¼åˆ‡æ¢ï¼‰

**ç†ç”±**ï¼š
1. âœ… **ç”¨æˆ·ä½“éªŒå¥½**ï¼šæŸ¥çœ‹å’Œç¼–è¾‘åˆ†ç¦»ï¼Œé¿å…è¯¯æ“ä½œ
2. âœ… **å®ç°ç®€å•**ï¼šå¯ä»¥å®Œå…¨å¤ç”¨ç°æœ‰èƒ½åŠ›
3. âœ… **æ”¹é€ èŒƒå›´å°**ï¼šä¸»è¦ä¿®æ”¹ TableRenderer.vue
4. âœ… **å‘åå…¼å®¹**ï¼šä¿ç•™ç¼–è¾‘å¼¹çª—ä½œä¸ºå¤‡é€‰

**å®ç°æ­¥éª¤**ï¼š
1. åœ¨ TableRenderer ä¸­æ·»åŠ  `detailMode` çŠ¶æ€
2. åœ¨ drawer header æ·»åŠ "ç¼–è¾‘/å–æ¶ˆ/ä¿å­˜"æŒ‰é’®
3. æ·»åŠ ç¼–è¾‘æ¨¡å¼çš„ FormRenderer
4. å®ç°æ¨¡å¼åˆ‡æ¢å’Œä¿å­˜é€»è¾‘
5. å¤„ç†å¯¼èˆªæ—¶çš„æ¨¡å¼é‡ç½®

## ğŸ“Š å¯¹æ¯”åˆ†æ

| ç»´åº¦ | å½“å‰æ–¹æ¡ˆï¼ˆç¼–è¾‘å¼¹çª—ï¼‰ | æ–°æ–¹æ¡ˆï¼ˆè¯¦æƒ…ç¼–è¾‘ï¼‰ |
|------|---------------------|-------------------|
| **æ“ä½œæ­¥éª¤** | 5 æ­¥ï¼ˆæŸ¥çœ‹ â†’ å…³é—­ â†’ æ‰“å¼€ç¼–è¾‘ â†’ ç¼–è¾‘ â†’ æäº¤ï¼‰ | 3 æ­¥ï¼ˆæŸ¥çœ‹ â†’ ç¼–è¾‘ â†’ æäº¤ï¼‰ |
| **ç”¨æˆ·ä½“éªŒ** | â­â­â­ éœ€è¦åˆ‡æ¢çª—å£ | â­â­â­â­â­ æµç•…æ— ç¼ |
| **å®ç°å¤æ‚åº¦** | â­â­ å·²å®ç° | â­â­â­ éœ€è¦æ¨¡å¼åˆ‡æ¢é€»è¾‘ |
| **æ”¹é€ èŒƒå›´** | - | ä¸»è¦ä¿®æ”¹ TableRenderer.vue |
| **å¤ç”¨èƒ½åŠ›** | - | âœ… å®Œå…¨å¤ç”¨ FormRenderer |

## ğŸ‰ ç»“è®º

**åœ¨è¯¦æƒ…æŠ½å±‰ä¸­ç›´æ¥ç¼–è¾‘å®Œå…¨å¯è¡Œï¼**

**ä¼˜åŠ¿**ï¼š
- âœ… å¯ä»¥å®Œå…¨å¤ç”¨ FormRenderer å’Œç°æœ‰é€»è¾‘
- âœ… æ”¹é€ èŒƒå›´å°ï¼Œä¸»è¦ä¿®æ”¹ TableRenderer.vue
- âœ… ç”¨æˆ·ä½“éªŒæ›´å¥½ï¼Œæ“ä½œæ›´æµç•…
- âœ… å‘åå…¼å®¹ï¼Œå¯ä»¥ä¿ç•™ç¼–è¾‘å¼¹çª—ä½œä¸ºå¤‡é€‰

**å®ç°éš¾åº¦**ï¼šâ­â­â­ ä¸­ç­‰ï¼ˆä¸»è¦æ˜¯çŠ¶æ€ç®¡ç†å’Œæ¨¡å¼åˆ‡æ¢ï¼‰

**æ¨èå®ç°**ï¼šé‡‡ç”¨æ¨¡å¼åˆ‡æ¢æ–¹æ¡ˆï¼Œåœ¨è¯¦æƒ…æŠ½å±‰ä¸­æ”¯æŒæŸ¥çœ‹/ç¼–è¾‘ä¸¤ç§æ¨¡å¼ã€‚


# æ–°æ—§æ¸²æŸ“ç³»ç»Ÿé›†æˆæ–¹æ¡ˆ

## ğŸ“Š ç³»ç»Ÿå¯¹æ¯”

### æ—§æ¸²æŸ“ç³»ç»Ÿï¼ˆ`LegacyFormRenderer.vue`ï¼‰

**ç‰¹ç‚¹**ï¼š
- âœ… ç®€å•ç›´æ¥ï¼ŒåŸºäº Element Plus æ¨¡æ¿
- âœ… å·²æ”¯æŒåŸºç¡€ç»„ä»¶ï¼š`input`, `number`, `text_area`, `select`, `timestamp`
- âœ… å·²å®ç°åŸºç¡€éªŒè¯è§„åˆ™
- âŒ **ä¸æ”¯æŒåµŒå¥—ç»“æ„**ï¼ˆ`children`ï¼‰
- âŒ ä¸æ”¯æŒ List/Table å†…çš„å¤æ‚å­—æ®µ
- âŒ æ¶æ„è€¦åˆï¼Œéš¾ä»¥æ‰©å±•

**ä½¿ç”¨ä½ç½®**ï¼š
- å·²åºŸå¼ƒï¼Œè¢«æ–°ç³»ç»Ÿæ›¿ä»£

### æ–°æ¸²æŸ“ç³»ç»Ÿï¼ˆ`FormRenderer.vue` + Widget ç³»ç»Ÿï¼‰

**ç‰¹ç‚¹**ï¼š
- âœ… **å®Œæ•´æ”¯æŒåµŒå¥—ç»“æ„**ï¼ˆ`children`ï¼‰
- âœ… OOP æ¶æ„ï¼Œæ˜“äºæ‰©å±•
- âœ… äº‹ä»¶é©±åŠ¨ï¼Œç»„ä»¶è§£è€¦
- âœ… æ”¯æŒå¿«ç…§/åˆ†äº«åŠŸèƒ½
- âœ… æ”¯æŒå›è°ƒç³»ç»Ÿï¼ˆ`OnSelectFuzzy` ç­‰ï¼‰
- âœ… æ”¯æŒèšåˆè®¡ç®—
- âš ï¸ **è¿˜ç¼ºå°‘éƒ¨åˆ† Widget ç±»å‹**ï¼ˆè§ä¸‹æ–‡ï¼‰

**å·²å®ç°çš„ Widget**ï¼š
- `InputWidget` - æ–‡æœ¬è¾“å…¥
- `SelectWidget` - ä¸‹æ‹‰é€‰æ‹©ï¼ˆæ”¯æŒå›è°ƒï¼‰
- `ListWidget` - åˆ—è¡¨/è¡¨æ ¼ï¼ˆæ”¯æŒåµŒå¥—ï¼‰
- `TextAreaWidget` - å¤šè¡Œæ–‡æœ¬

**ç¼ºå¤±çš„ Widget**ï¼š
- `NumberWidget` - æ•°å­—è¾“å…¥ï¼ˆ`number`, `float`, `int` ç±»å‹ï¼‰
- `DateWidget` - æ—¥æœŸé€‰æ‹©ï¼ˆ`date`, `datetime`, `timestamp` ç±»å‹ï¼‰
- `MultiSelectWidget` - å¤šé€‰ä¸‹æ‹‰ï¼ˆ`multiple: true`ï¼‰
- `CheckboxWidget` - å¤é€‰æ¡†
- `RadioWidget` - å•é€‰æ¡†
- `FileWidget` - æ–‡ä»¶ä¸Šä¼ ï¼ˆæœªæ¥ï¼‰

---

## ğŸ¯ é›†æˆç­–ç•¥

### æ–¹æ¡ˆ1ï¼š**æ¸è¿›å¼æ›¿æ¢ï¼ˆæ¨èï¼‰** â­

**ç­–ç•¥**ï¼š
1. **å…ˆè¡¥å……ç¼ºå¤±çš„ Widget**ï¼ˆ`NumberWidget` ä¼˜å…ˆï¼Œå› ä¸ºæ”¶é“¶å°ç”¨åˆ°ï¼‰
2. **åœ¨ Workspace ä¸­æ·»åŠ é€‰æ‹©é€»è¾‘**ï¼š
   - å¦‚æœæœ‰ `children`ï¼ˆåµŒå¥—ç»“æ„ï¼‰â†’ ä½¿ç”¨æ–°ç³»ç»Ÿ
   - å¦åˆ™ â†’ ä½¿ç”¨æ—§ç³»ç»Ÿï¼ˆä¿æŒå…¼å®¹ï¼‰
3. **é€æ­¥éªŒè¯**ï¼Œå‘ç°é—®é¢˜åŠæ—¶ä¿®å¤
4. **å®Œå…¨ç¨³å®šå**ï¼Œå…¨é¢æ›¿æ¢

**ä¼˜ç‚¹**ï¼š
- âœ… é£é™©ä½ï¼Œå¯é€æ­¥éªŒè¯
- âœ… ä¿æŒæ—§ç³»ç»Ÿå¯ç”¨ï¼Œé¿å…å½±å“ç°æœ‰åŠŸèƒ½
- âœ… å¯ä»¥å¹¶è¡Œæµ‹è¯•

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦ç»´æŠ¤ä¸¤å¥—ç³»ç»Ÿï¼ˆçŸ­æœŸï¼‰
- âš ï¸ éœ€è¦å¢åŠ åˆ¤æ–­é€»è¾‘

---

### æ–¹æ¡ˆ2ï¼š**ç›´æ¥å…¨é¢æ›¿æ¢**

**ç­–ç•¥**ï¼š
1. è¡¥å……æ‰€æœ‰ç¼ºå¤±çš„ Widget
2. åœ¨æ–°ç³»ç»Ÿä¸­å®ç°æ—§ç³»ç»Ÿçš„æ‰€æœ‰åŠŸèƒ½
3. ç›´æ¥æ›¿æ¢ `Workspace` å’Œ `TableRenderer` ä¸­çš„ `FormRenderer`

**ä¼˜ç‚¹**ï¼š
- âœ… å½»åº•ï¼Œæ— å†å²åŒ…è¢±
- âœ… æ¶æ„ç»Ÿä¸€

**ç¼ºç‚¹**ï¼š
- âŒ é£é™©é«˜ï¼Œå¯èƒ½å½±å“ç°æœ‰åŠŸèƒ½
- âŒ éœ€è¦å®Œæ•´æµ‹è¯•æ‰€æœ‰åœºæ™¯
- âŒ å¼€å‘å‘¨æœŸé•¿

---

## ğŸš€ æ¨èå®æ–½æ­¥éª¤ï¼ˆæ–¹æ¡ˆ1ï¼‰

### Step 1: è¡¥å……å…³é”® Widgetï¼ˆä¼˜å…ˆçº§æ’åºï¼‰

#### 1.1 `NumberWidget` ğŸ”¥ **æœ€é«˜ä¼˜å…ˆçº§**
**åŸå› **ï¼šæ”¶é“¶å°çš„ `quantity` å­—æ®µæ˜¯ `number` ç±»å‹ï¼Œå¿…é¡»æ”¯æŒ

```typescript
// web/src/core/widgets/NumberWidget.ts
export class NumberWidget extends BaseWidget {
  render(props: WidgetRenderProps) {
    return h(ElInputNumber, {
      modelValue: this.getValue()?.raw || 0,
      placeholder: this.config.placeholder || `è¯·è¾“å…¥${this.field.name}`,
      min: this.config.min,
      max: this.config.max,
      step: this.config.step || 1,
      precision: this.config.precision,
      style: { width: '100%' },
      onChange: (value: number) => {
        this.handleChange(value)
      }
    })
  }
}
```

#### 1.2 `DateWidget` / `TimestampWidget` âš ï¸ **ä¸­ä¼˜å…ˆçº§**
**åŸå› **ï¼šå¾ˆå¤šä¸šåŠ¡åœºæ™¯ä¼šç”¨åˆ°

#### 1.3 `MultiSelectWidget` âš ï¸ **ä¸­ä¼˜å…ˆçº§**
**åŸå› **ï¼šèšåˆåœºæ™¯éœ€è¦ï¼ˆå¦‚ç”¨æˆ·é‡‡è´­åˆ—è¡¨ï¼‰

---

### Step 2: åœ¨ Workspace ä¸­æ·»åŠ æ™ºèƒ½é€‰æ‹©é€»è¾‘

```typescript
// web/src/views/Workspace/index.vue (ä¿®æ”¹ç¬¬ 97-109 è¡Œ)

<!-- Formç±»å‹ï¼šæ™ºèƒ½é€‰æ‹©æ¸²æŸ“å™¨ -->
<div v-else-if="functionDetail.template_type === 'form'" class="form-container">
  <div class="form-header">
    <h2>{{ currentFunction.name || currentFunction.code }}</h2>
    <p v-if="currentFunction.description" class="form-description">
      {{ currentFunction.description }}
    </p>
  </div>
  
  <!-- ğŸ”¥ æ–°å¢ï¼šæ™ºèƒ½é€‰æ‹©æ¸²æŸ“å™¨ -->
  <!-- å¦‚æœæœ‰åµŒå¥—ç»“æ„ï¼ˆchildrenï¼‰ï¼Œä½¿ç”¨æ–°æ¸²æŸ“å™¨ -->
  <FormRenderer
    v-if="hasNestedStructure(functionDetail.request)"
    :function-detail="functionDetail"
  />
  
  <!-- å¦åˆ™ä½¿ç”¨æ—§æ¸²æŸ“å™¨ï¼ˆä¿æŒå…¼å®¹ï¼‰ -->
  <LegacyFormRenderer
    v-else
    :fields="functionDetail.request || []"
    :response-fields="functionDetail.response || []"
    :method="functionDetail.method"
    :router="functionDetail.router"
    mode="form"
  />
</div>
```

**åˆ¤æ–­é€»è¾‘**ï¼š
```typescript
// åˆ¤æ–­æ˜¯å¦æœ‰åµŒå¥—ç»“æ„
const hasNestedStructure = (fields: FieldConfig[]): boolean => {
  if (!fields) return false
  
  return fields.some(field => {
    // æ£€æŸ¥æ˜¯å¦æœ‰ children
    if (field.children && field.children.length > 0) {
      return true
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ list/table ç±»å‹ï¼ˆå³ä½¿ children ä¸ºç©ºä¹Ÿè®¤ä¸ºæ˜¯åµŒå¥—ï¼‰
    if (['table', 'list', 'form'].includes(field.widget?.type)) {
      return true
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰å›è°ƒï¼ˆå›è°ƒé€šå¸¸éœ€è¦æ–°ç³»ç»Ÿçš„äº‹ä»¶æœºåˆ¶ï¼‰
    if (field.callbacks && field.callbacks.length > 0) {
      return true
    }
    
    return false
  })
}
```

---

### Step 3: æ³¨å†Œæ–° Widget åˆ° WidgetFactory

```typescript
// web/src/core/factories/WidgetFactory.ts

import { NumberWidget } from "../widgets/NumberWidget"

export class WidgetFactory {
  private static widgetMap = new Map<string, typeof BaseWidget>([
    ['input', InputWidget],
    ['text', InputWidget],  // åˆ«å
    ['text_area', TextAreaWidget],
    ['textarea', TextAreaWidget],  // åˆ«å
    ['select', SelectWidget],
    ['table', ListWidget],
    ['list', ListWidget],
    ['number', NumberWidget],  // ğŸ”¥ æ–°å¢
    ['float', NumberWidget],   // ğŸ”¥ åˆ«å
    ['int', NumberWidget],     // ğŸ”¥ åˆ«å
  ])
  
  // ... å…¶ä½™ä»£ç ä¸å˜
}
```

---

### Step 4: æ›´æ–° SimpleFormRenderer çš„ Props

ç¡®ä¿ `SimpleFormRenderer` å¯ä»¥æ¥æ”¶å®Œæ•´çš„ `FunctionDetail`ï¼š

```typescript
// web/src/core/renderers/SimpleFormRenderer.vue

interface Props {
  functionDetail: FunctionDetail  // å®Œæ•´çš„å‡½æ•°è¯¦æƒ…
}

const props = defineProps<Props>()

// ä» functionDetail.request ä¸­æå– fields
const fields = computed(() => props.functionDetail.request || [])
```

---

### Step 5: æµ‹è¯•éªŒè¯

#### 5.1 æµ‹è¯•æ”¶é“¶å°åŠŸèƒ½
```
http://localhost:5174/workspace/luobei/testcmp/tools/cashier_desk
```

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… è‡ªåŠ¨ä½¿ç”¨æ–°æ¸²æŸ“å™¨ï¼ˆå› ä¸ºæœ‰ `children`ï¼‰
- âœ… å•†å“æ¸…å•è¡¨æ ¼å¯ä»¥æ·»åŠ /åˆ é™¤è¡Œ
- âœ… æ¯è¡Œæœ‰ Selectï¼ˆå•†å“ï¼‰+ Numberï¼ˆæ•°é‡ï¼‰
- âœ… ä¼šå‘˜å¡ä¸‹æ‹‰é€‰æ‹©æ­£å¸¸
- âœ… å¤‡æ³¨æ–‡æœ¬æ¡†æ­£å¸¸

#### 5.2 æµ‹è¯•ç®€å•è¡¨å•ï¼ˆæ— åµŒå¥—ï¼‰
é€‰æ‹©ä¸€ä¸ªç®€å•çš„ form ç±»å‹å‡½æ•°ï¼ˆå¦‚åˆ›å»ºå·¥å•ï¼‰

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… è‡ªåŠ¨ä½¿ç”¨æ—§æ¸²æŸ“å™¨ï¼ˆå› ä¸ºæ—  `children`ï¼‰
- âœ… åŠŸèƒ½æ­£å¸¸ï¼Œä¸å—å½±å“

---

## ğŸ“ éœ€è¦ç«‹å³å¼€å‘çš„å†…å®¹

### ä¼˜å…ˆçº§ P0ï¼ˆå¿…é¡»ç«‹å³å®Œæˆï¼‰

1. **`NumberWidget`** - æ”¶é“¶å°éœ€è¦
2. **åœ¨ Workspace ä¸­æ·»åŠ æ™ºèƒ½é€‰æ‹©é€»è¾‘**
3. **åœ¨ WidgetFactory ä¸­æ³¨å†Œ `NumberWidget`**

### ä¼˜å…ˆçº§ P1ï¼ˆçŸ­æœŸå®Œæˆï¼‰

1. **`MultiSelectWidget`** - èšåˆåœºæ™¯éœ€è¦
2. **å®Œå–„ `SelectWidget` çš„å›è°ƒé€»è¾‘**ï¼ˆ`OnSelectFuzzy`ï¼‰
3. **å®ç° `ListWidget` çš„èšåˆè®¡ç®—**

### ä¼˜å…ˆçº§ P2ï¼ˆä¸­æœŸå®Œæˆï¼‰

1. **`DateWidget` / `TimestampWidget`**
2. **å®Œå–„æ¡ä»¶æ¸²æŸ“**ï¼ˆ`required_if`, `excluded_if`ï¼‰
3. **å®Œå–„å‰ç«¯éªŒè¯**ï¼ˆ`ValidatorEngine`ï¼‰

---

## ğŸ¯ ä»Šå¤©çš„ç›®æ ‡

1. âœ… åˆ›å»º `NumberWidget`
2. âœ… åœ¨ `WidgetFactory` ä¸­æ³¨å†Œ
3. âœ… åœ¨ `Workspace` ä¸­æ·»åŠ æ™ºèƒ½é€‰æ‹©é€»è¾‘
4. âœ… å¯¼å…¥ `SimpleFormRenderer`
5. âœ… æµ‹è¯•æ”¶é“¶å°åŠŸèƒ½

**å®Œæˆå**ï¼Œæ”¶é“¶å°åº”è¯¥å¯ä»¥æ­£å¸¸æ¸²æŸ“äº†ï¼ğŸ‰

---

## ğŸ’¡ ä¸‹ä¸€æ­¥å±•æœ›

### çŸ­æœŸç›®æ ‡ï¼ˆ1-2å¤©ï¼‰
- å®Œå–„å›è°ƒç³»ç»Ÿï¼ˆ`OnSelectFuzzy`ï¼‰
- å®ç°èšåˆè®¡ç®—
- æ”¯æŒ URL åˆ†äº«è§†å›¾

### ä¸­æœŸç›®æ ‡ï¼ˆ1å‘¨ï¼‰
- è¡¥å……æ‰€æœ‰ç¼ºå¤±çš„ Widget
- å…¨é¢æ›¿æ¢æ—§æ¸²æŸ“ç³»ç»Ÿ
- å®Œå–„æ–‡æ¡£å’Œæµ‹è¯•

### é•¿æœŸç›®æ ‡ï¼ˆ1-2å‘¨ï¼‰
- å®ç°æ–‡ä»¶ä¸Šä¼ 
- å®ç°æ¡ä»¶æ¸²æŸ“å¼•æ“
- å®ç°å®Œæ•´çš„éªŒè¯ç³»ç»Ÿ


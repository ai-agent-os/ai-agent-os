# 聚合统计功能测试指南

## 功能概述

聚合统计系统已实现，支持对 `ListWidget` 中的数据进行实时聚合计算。

## 实现的功能

### 1. 表达式解析器 (`ExpressionParser`)

支持以下表达式：

#### 基础聚合
- `sum(字段)` - 求和
- `count(字段)` - 计数
- `avg(字段)` - 平均值
- `min(字段)` - 最小值
- `max(字段)` - 最大值

#### 乘法聚合（场景 2-3）
- `sum(价格,*数量)` - 求 价格×数量 的总和
- `sum(价格,*数量,*0.9)` - 求 价格×数量×0.9 的总和
- `avg(价格,*数量)` - 求 价格×数量 的平均值

#### List 层聚合（场景 4）
- `list_sum(用户总价)` - 对 MultiSelect 返回的"用户总价"字段求和
- `list_avg(用户总价)` - 对 MultiSelect 返回的"用户总价"字段求平均值
- `list_count()` - 统计总行数

### 2. 事件驱动架构

- 子组件（如 `SelectWidget`）发出 `field:search` 和 `field:change` 事件
- `ListWidget` 监听事件，调用后端回调，获取 `statistics` 配置
- 自动计算聚合结果并实时更新 UI

### 3. UI 展示

- 聚合结果显示在表格下方、表单上方
- 采用浅灰色背景卡片，多个统计项横向排列
- 标签 + 数值的清晰显示

## 测试场景

### 场景 1：基础聚合（Select 下拉）

**后端返回示例：**
```json
{
  "items": [
    {"value": 1, "label": "薯条", "display_info": {"价格": 10}},
    {"value": 2, "label": "可乐", "display_info": {"价格": 5}},
    {"value": 3, "label": "汉堡", "display_info": {"价格": 15}}
  ],
  "statistics": {
    "总价": "sum(价格)"
  }
}
```

**测试步骤：**
1. 打开包含 `ListWidget` 的表单
2. 点击"添加"按钮
3. 在 Select 下拉中搜索并选择商品（如"薯条"）
4. 点击"保存"
5. 重复添加多个商品
6. **验证**：表格下方应显示 `总价: XX.XX`

### 场景 2：乘法聚合（带数量字段）

**后端返回示例：**
```json
{
  "items": [
    {"value": 1, "label": "薯条", "display_info": {"价格": 10}},
    {"value": 2, "label": "可乐", "display_info": {"价格": 5}}
  ],
  "statistics": {
    "总价": "sum(价格,*数量)",
    "平均单价": "avg(价格)"
  }
}
```

**测试步骤：**
1. 添加商品，填写"数量"字段（如 3）
2. 保存后，添加更多商品
3. **验证**：
   - `总价` 应该是 `价格1×数量1 + 价格2×数量2 + ...`
   - `平均单价` 应该是所有商品价格的平均值

### 场景 3：带折扣系数

**后端返回示例：**
```json
{
  "statistics": {
    "折后总价": "sum(价格,*数量,*0.9)",
    "原价总额": "sum(价格,*数量)"
  }
}
```

**测试步骤：**
1. 添加多个商品
2. **验证**：
   - `折后总价` 应该是 `原价总额 × 0.9`

### 场景 4：List 层聚合（MultiSelect）

**后端返回示例：**
```json
{
  "items": [
    {
      "value": 1,
      "label": "用户A",
      "display_info": {
        "订单数": 10,
        "用户总价": 1000
      }
    },
    {
      "value": 2,
      "label": "用户B",
      "display_info": {
        "订单数": 5,
        "用户总价": 500
      }
    }
  ],
  "statistics": {
    "所有用户总额": "list_sum(用户总价)",
    "平均用户消费": "list_avg(用户总价)",
    "总订单数": "sum(订单数)"
  }
}
```

**测试步骤：**
1. 使用 `MultiSelect` 选择多个用户
2. 保存
3. **验证**：
   - `所有用户总额` = 所有行的"用户总价"之和
   - `平均用户消费` = 所有行的"用户总价"的平均值
   - `总订单数` = 所有行的"订单数"之和

## 实时更新测试

### 新增数据
1. 点击"添加"，填写并保存
2. **验证**：统计结果立即更新

### 编辑数据
1. 点击某行的"编辑"按钮
2. 修改字段值（如修改"数量"）
3. 点击"保存"
4. **验证**：统计结果立即更新

### 删除数据
1. 点击某行的"删除"按钮
2. **验证**：统计结果立即更新

### Select 下拉变化
1. 在表单中修改 Select 字段（触发 `field:change` 事件）
2. **验证**：统计结果立即重新计算

## 调试日志

打开浏览器控制台，应该能看到：

```
[ListWidget] 开始订阅子组件事件
[ListWidget] 订阅搜索事件: field:search:products[].product_id
[ListWidget] 订阅变化事件: field:change:products[].product_id
[ListWidget] 收到搜索事件 (query=薯条)
[ListWidget] 保存聚合配置: {总价: "sum(价格)"}
[ListWidget] 开始计算聚合统计
[ListWidget] 数据行数: 2
[ListWidget] 聚合配置: {总价: "sum(价格)"}
[ListWidget]   总价: sum(价格) = 25
[ListWidget] 聚合统计完成: {总价: 25}
```

## 已知限制

1. **嵌套字段**：目前支持中文字段名和 `displayInfo` 中的字段，暂不支持深层嵌套（如 `product.detail.price`）
2. **表达式验证**：后端需要确保 `statistics` 配置中的表达式合法
3. **数据类型**：字段值需要能转换为数字，否则计算结果为 0

## 架构亮点

1. **解耦**：使用事件总线，子组件无需知道父组件的聚合逻辑
2. **可扩展**：新增聚合函数只需修改 `ExpressionParser`
3. **实时性**：任何数据变化都会自动触发重新计算
4. **配置驱动**：聚合规则由后端回调返回，前端无需硬编码

## 下一步优化（可选）

1. 支持条件聚合：`sum(价格, where: 类型=A)`
2. 支持更复杂的表达式：`(sum(价格) - 100) * 0.95`
3. 支持自定义格式化：货币符号、千位分隔符等
4. 缓存计算结果，避免重复计算


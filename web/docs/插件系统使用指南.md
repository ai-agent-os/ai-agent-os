# Widget æ’ä»¶ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

Widget æ’ä»¶ç³»ç»Ÿæä¾›äº†ä¸€ç§ç»Ÿä¸€çš„æ–¹å¼æ¥æ‰©å±•ç³»ç»Ÿçš„ Widget ç»„ä»¶ã€å­—æ®µæå–å™¨å’Œåˆå§‹åŒ–å™¨ã€‚é€šè¿‡æ’ä»¶ç³»ç»Ÿï¼Œä½ å¯ä»¥ï¼š

- âœ… æ³¨å†Œè‡ªå®šä¹‰ Widget ç»„ä»¶
- âœ… æ³¨å†Œè‡ªå®šä¹‰å­—æ®µæå–å™¨
- âœ… æ³¨å†Œè‡ªå®šä¹‰ç»„ä»¶åˆå§‹åŒ–å™¨
- âœ… ä¸€æ¬¡æ€§æ³¨å†Œæ‰€æœ‰ç›¸å…³ç»„ä»¶ï¼ˆç»„ä»¶ã€æå–å™¨ã€åˆå§‹åŒ–å™¨ï¼‰

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆ›å»ºè‡ªå®šä¹‰ Widget ç»„ä»¶

```vue
<!-- CustomWidget.vue -->
<template>
  <div class="custom-widget">
    <el-input
      v-if="mode === 'edit'"
      :model-value="value?.raw"
      @update:model-value="handleUpdate"
    />
    <span v-else>{{ value?.display || '' }}</span>
  </div>
</template>

<script setup lang="ts">
import type { FieldValue } from '@/architecture/domain/types'
import type { WidgetComponentProps } from '@/architecture/presentation/widgets/types'

const props = defineProps<WidgetComponentProps>()
const emit = defineEmits<{
  'update:modelValue': [value: FieldValue]
}>()

function handleUpdate(newValue: any): void {
  emit('update:modelValue', {
    raw: newValue,
    display: String(newValue),
    meta: {}
  })
}
</script>
```

### 2. ï¼ˆå¯é€‰ï¼‰åˆ›å»ºè‡ªå®šä¹‰å­—æ®µæå–å™¨

å¦‚æœä½ çš„ç»„ä»¶æœ‰ç‰¹æ®Šçš„å€¼æå–é€»è¾‘ï¼Œå¯ä»¥å®ç° `IFieldExtractor` æ¥å£ï¼š

```typescript
// CustomFieldExtractor.ts
import type { IFieldExtractor, FieldExtractorRegistry } from '@/core/stores-v2/extractors/FieldExtractor'
import type { FieldConfig, FieldValue } from '@/types/field'

export class CustomFieldExtractor implements IFieldExtractor {
  extract(
    field: FieldConfig,
    fieldPath: string,
    getValue: (path: string) => FieldValue | undefined,
    extractorRegistry: FieldExtractorRegistry
  ): any {
    const value = getValue(fieldPath)
    // è‡ªå®šä¹‰æå–é€»è¾‘
    return value?.raw
  }
}
```

### 3. ï¼ˆå¯é€‰ï¼‰åˆ›å»ºè‡ªå®šä¹‰åˆå§‹åŒ–å™¨

å¦‚æœä½ çš„ç»„ä»¶éœ€è¦åŠ¨æ€åˆå§‹åŒ–ï¼ˆå¦‚ä» API åŠ è½½é€‰é¡¹ï¼‰ï¼Œå¯ä»¥å®ç° `IWidgetInitializer` æ¥å£ï¼š

```typescript
// CustomWidgetInitializer.ts
import type { IWidgetInitializer, WidgetInitContext } from '@/architecture/presentation/widgets/interfaces/IWidgetInitializer'
import type { FieldValue } from '@/architecture/domain/types'

export class CustomWidgetInitializer implements IWidgetInitializer {
  async initialize(context: WidgetInitContext): Promise<FieldValue | null> {
    // å¦‚æœå·²ç»æœ‰å€¼ï¼Œä¸éœ€è¦åˆå§‹åŒ–
    if (context.currentValue.raw !== null && context.currentValue.raw !== undefined) {
      return null
    }
    
    // ä» API åŠ è½½é»˜è®¤å€¼
    const defaultValue = await this.loadDefaultValue(context)
    
    return {
      raw: defaultValue,
      display: String(defaultValue),
      meta: {}
    }
  }
  
  private async loadDefaultValue(context: WidgetInitContext): Promise<any> {
    // å®ç°åŠ è½½é€»è¾‘
    return null
  }
}
```

### 4. æ³¨å†Œæ’ä»¶

åœ¨åº”ç”¨å¯åŠ¨æ—¶ï¼ˆå¦‚ `main.ts`ï¼‰æ³¨å†Œæ’ä»¶ï¼š

```typescript
// main.ts
import { registerWidgetPlugin } from '@/architecture/infrastructure/plugins'
import CustomWidget from './components/CustomWidget.vue'
import { CustomFieldExtractor } from './extractors/CustomFieldExtractor'
import { CustomWidgetInitializer } from './initializers/CustomWidgetInitializer'

// æ³¨å†Œæ’ä»¶
registerWidgetPlugin({
  name: 'Custom Widget',
  widgetType: 'custom',
  requestComponent: CustomWidget,
  responseComponent: CustomWidget, // å¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨ requestComponent
  extractor: new CustomFieldExtractor(), // å¯é€‰
  initializer: new CustomWidgetInitializer(), // å¯é€‰
  metadata: {
    description: 'è‡ªå®šä¹‰ Widget ç»„ä»¶',
    version: '1.0.0',
    author: 'Your Name'
  }
})
```

## ğŸ“š API å‚è€ƒ

### `registerWidgetPlugin(plugin: WidgetPlugin)`

æ³¨å†Œå•ä¸ª Widget æ’ä»¶ã€‚

**å‚æ•°**ï¼š
- `plugin.name`: æ’ä»¶åç§°ï¼ˆç”¨äºæ ‡è¯†å’Œè°ƒè¯•ï¼‰
- `plugin.widgetType`: Widget ç±»å‹ï¼ˆå¯¹åº”åç«¯ `widget.type`ï¼‰
- `plugin.requestComponent`: è¯·æ±‚å‚æ•°ç»„ä»¶ï¼ˆå¿…éœ€ï¼‰
- `plugin.responseComponent`: å“åº”å‚æ•°ç»„ä»¶ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨ `requestComponent`ï¼‰
- `plugin.extractor`: å­—æ®µæå–å™¨ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨ `BasicFieldExtractor`ï¼‰
- `plugin.initializer`: ç»„ä»¶åˆå§‹åŒ–å™¨ï¼ˆå¯é€‰ï¼‰
- `plugin.metadata`: æ’ä»¶å…ƒæ•°æ®ï¼ˆå¯é€‰ï¼‰

**ç¤ºä¾‹**ï¼š
```typescript
registerWidgetPlugin({
  name: 'My Custom Widget',
  widgetType: 'my_custom',
  requestComponent: MyCustomWidget,
  extractor: new MyCustomExtractor(),
  initializer: new MyCustomInitializer()
})
```

### `registerWidgetPlugins(plugins: WidgetPlugin[])`

æ‰¹é‡æ³¨å†Œå¤šä¸ª Widget æ’ä»¶ã€‚

**ç¤ºä¾‹**ï¼š
```typescript
registerWidgetPlugins([
  {
    name: 'Widget 1',
    widgetType: 'widget1',
    requestComponent: Widget1
  },
  {
    name: 'Widget 2',
    widgetType: 'widget2',
    requestComponent: Widget2
  }
])
```

### `unregisterWidgetPlugin(widgetType: string)`

å–æ¶ˆæ³¨å†Œ Widget æ’ä»¶ã€‚

**ç¤ºä¾‹**ï¼š
```typescript
unregisterWidgetPlugin('my_custom')
```

### `getWidgetPlugin(widgetType: string)`

è·å–å·²æ³¨å†Œçš„æ’ä»¶ä¿¡æ¯ã€‚

**ç¤ºä¾‹**ï¼š
```typescript
const plugin = getWidgetPlugin('my_custom')
console.log(plugin?.name) // 'My Custom Widget'
```

### `getRegisteredPluginTypes()`

è·å–æ‰€æœ‰å·²æ³¨å†Œçš„æ’ä»¶ç±»å‹ã€‚

**ç¤ºä¾‹**ï¼š
```typescript
const types = getRegisteredPluginTypes()
console.log(types) // ['my_custom', 'widget1', 'widget2']
```

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šç®€å•çš„è‡ªå®šä¹‰ç»„ä»¶

å¦‚æœä½ åªéœ€è¦ä¸€ä¸ªç®€å•çš„è‡ªå®šä¹‰ç»„ä»¶ï¼Œä¸éœ€è¦ç‰¹æ®Šçš„æå–é€»è¾‘æˆ–åˆå§‹åŒ–é€»è¾‘ï¼š

```typescript
registerWidgetPlugin({
  name: 'Simple Custom Widget',
  widgetType: 'simple_custom',
  requestComponent: SimpleCustomWidget
})
```

### åœºæ™¯ 2ï¼šéœ€è¦ç‰¹æ®Šæå–é€»è¾‘çš„ç»„ä»¶

å¦‚æœä½ çš„ç»„ä»¶æœ‰ç‰¹æ®Šçš„å€¼æå–é€»è¾‘ï¼ˆå¦‚éœ€è¦æ ¼å¼åŒ–ã€è½¬æ¢ç­‰ï¼‰ï¼š

```typescript
registerWidgetPlugin({
  name: 'Custom Widget with Extractor',
  widgetType: 'custom_with_extractor',
  requestComponent: CustomWidget,
  extractor: new CustomFieldExtractor()
})
```

### åœºæ™¯ 3ï¼šéœ€è¦åŠ¨æ€åˆå§‹åŒ–çš„ç»„ä»¶

å¦‚æœä½ çš„ç»„ä»¶éœ€è¦ä» API åŠ è½½é€‰é¡¹æˆ–é»˜è®¤å€¼ï¼š

```typescript
registerWidgetPlugin({
  name: 'Custom Widget with Initializer',
  widgetType: 'custom_with_initializer',
  requestComponent: CustomWidget,
  initializer: new CustomWidgetInitializer()
})
```

### åœºæ™¯ 4ï¼šå®Œæ•´çš„è‡ªå®šä¹‰ç»„ä»¶

å¦‚æœä½ éœ€è¦æ‰€æœ‰åŠŸèƒ½ï¼ˆç»„ä»¶ã€æå–å™¨ã€åˆå§‹åŒ–å™¨ï¼‰ï¼š

```typescript
registerWidgetPlugin({
  name: 'Full Custom Widget',
  widgetType: 'full_custom',
  requestComponent: FullCustomWidget,
  responseComponent: FullCustomWidgetResponse, // ä¸åŒçš„å“åº”ç»„ä»¶
  extractor: new FullCustomExtractor(),
  initializer: new FullCustomInitializer(),
  metadata: {
    description: 'å®Œæ•´çš„è‡ªå®šä¹‰ç»„ä»¶',
    version: '1.0.0',
    author: 'Your Name'
  }
})
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ’ä»¶ç±»å‹å”¯ä¸€æ€§**ï¼šæ¯ä¸ª `widgetType` åªèƒ½æ³¨å†Œä¸€æ¬¡ï¼Œé‡å¤æ³¨å†Œä¼šæŠ›å‡ºé”™è¯¯ã€‚

2. **æ³¨å†Œæ—¶æœº**ï¼šæ’ä»¶åº”è¯¥åœ¨åº”ç”¨å¯åŠ¨æ—¶ï¼ˆ`main.ts`ï¼‰æ³¨å†Œï¼Œç¡®ä¿åœ¨ä½¿ç”¨å‰å·²ç»æ³¨å†Œã€‚

3. **ç»„ä»¶è§„èŒƒ**ï¼šè‡ªå®šä¹‰ç»„ä»¶å¿…é¡»éµå¾ª `WidgetComponentProps` æ¥å£è§„èŒƒï¼Œå®ç° `update:modelValue` äº‹ä»¶ã€‚

4. **å€¼æ ¼å¼**ï¼šç»„ä»¶å¿…é¡»ä½¿ç”¨ `FieldValue` æ ¼å¼ï¼š
   ```typescript
   {
     raw: any,        // åŸå§‹å€¼ï¼ˆæäº¤ç»™åç«¯ï¼‰
     display: string, // æ˜¾ç¤ºå€¼ï¼ˆå‰ç«¯å±•ç¤ºï¼‰
     meta: object     // å…ƒæ•°æ®
   }
   ```

5. **æå–å™¨é€’å½’**ï¼šå¦‚æœç»„ä»¶åŒ…å«åµŒå¥—ç»“æ„ï¼ˆå¦‚ formã€tableï¼‰ï¼Œæå–å™¨éœ€è¦é€’å½’è°ƒç”¨ `extractorRegistry.extractField`ã€‚

## ğŸ” è°ƒè¯•

æ’ä»¶ç³»ç»Ÿæä¾›äº†è¯¦ç»†çš„æ—¥å¿—ï¼Œå¯ä»¥é€šè¿‡æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹ï¼š

- æ’ä»¶æ³¨å†ŒæˆåŠŸ/å¤±è´¥
- æ’ä»¶ä½¿ç”¨æƒ…å†µ
- æå–å™¨å’Œåˆå§‹åŒ–å™¨è°ƒç”¨æƒ…å†µ

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [Widget ç»„ä»¶å¼€å‘æŒ‡å—](../README.md#widget-ç»„ä»¶å¼€å‘)
- [å­—æ®µæå–é€»è¾‘åˆ†ææŠ¥å‘Š](./è¡¨å•å€¼æå–é€»è¾‘åˆ†ææŠ¥å‘Š.md)
- [æ–°æ¶æ„æ‰©å±•æ€§åˆ†ææŠ¥å‘Š](./æ–°æ¶æ„æ‰©å±•æ€§åˆ†ææŠ¥å‘Š.md)


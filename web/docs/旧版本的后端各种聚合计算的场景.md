```go
package formexample

/*
【文件元数据】
- 用户需求：表单示例系统，展示OnInputFuzzyMap的各种用法和功能
- 业务场景：表单示例，提供OnInputFuzzyMap智能搜索功能演示
- 文件名称：formexample_input_fuzzy.go
- 引用关系：无外部文件依赖，可独立fork
- 核心功能：OnInputFuzzyMap智能搜索、表单示例、聚合计算
- 技术特点：OnInputFuzzy智能搜索、聚合计算、事务处理

【OnInputFuzzyMap改造说明】
- 改造原因：从旧用法升级为新用法，提升性能和用户体验
- 性能优化：三层查询逻辑（精确查询→批量查询→模糊查询）
- 用户体验：根据用户操作场景自动选择最优查询策略
- 业务价值：支持聚合计算，提供实时统计信息
- 框架标准化：统一回调函数实现模式，便于大模型理解维护

【改造前后对比】
旧用法问题：
❌ 所有查询都走模糊搜索，性能差
❌ 没有查询限制，可能返回大量数据
❌ 缺少聚合计算，用户体验差
❌ 代码结构不统一，难以维护

新用法优势：
✅ 三层查询逻辑，性能最优
✅ 自动识别用户场景，智能选择查询策略
✅ 支持聚合计算，提供实时统计
✅ 统一代码结构，便于维护扩展
*/

import (
	"fmt"

	"github.com/yunhanshu-net/function-go/pkg/dto/response"
	"github.com/yunhanshu-net/function-go/pkg/dto/usercall"
	"github.com/yunhanshu-net/function-go/runner"
	"gorm.io/gorm"
)

// ================ 函数组配置 ================
var FormexampleGroup = &runner.FunctionGroup{
	CnName: "表单示例",
	EnName: "formexample",
}

// ================ 数据模型 ================

// FormexampleProduct 商品数据模型
type FormexampleProduct struct {
	ID        int            `json:"id" gorm:"primaryKey;autoIncrement" runner:"name:商品ID" permission:"read"`
	CreatedAt int64          `json:"created_at" gorm:"autoCreateTime:milli" runner:"name:创建时间" widget:"type:datetime;kind:datetime" permission:"read"`
	UpdatedAt int64          `json:"updated_at" gorm:"autoUpdateTime:milli" runner:"name:更新时间" widget:"type:datetime;kind:datetime" permission:"read"`
	DeletedAt gorm.DeletedAt `json:"deleted_at" gorm:"index" runner:"-"`

	Name        string  `json:"name" gorm:"column:name;comment:商品名称" runner:"name:商品名称" widget:"type:input" search:"like" validate:"required,min=2,max=50"`
	Price       float64 `json:"price" gorm:"column:price;comment:商品价格" runner:"name:商品价格" widget:"type:number;min:0;precision:2;prefix:￥" search:"gte,lte" validate:"required,min=0"`
	Stock       int     `json:"stock" gorm:"column:stock;comment:库存数量" runner:"name:库存数量" widget:"type:number;min:0;unit:件" search:"gte,lte" validate:"required,min=0"`
	Category    string  `json:"category" gorm:"column:category;comment:商品分类" runner:"name:商品分类" widget:"type:select;options:电子产品,服装,食品,图书,其他" search:"in" validate:"required"`
	Description string  `json:"description" gorm:"column:description;comment:商品描述" runner:"name:商品描述" widget:"type:input;mode:text_area" search:"like"`
	Status      string  `json:"status" gorm:"column:status;comment:商品状态" runner:"name:商品状态" widget:"type:select;options:上架,下架,缺货" data:"default_value:上架" search:"in" validate:"required"`
}

func (FormexampleProduct) TableName() string { return "formexample_product" }

// FormexampleOrder 订单数据模型
type FormexampleOrder struct {
	ID        int            `json:"id" gorm:"primaryKey;autoIncrement" runner:"name:订单ID" permission:"read"`
	CreatedAt int64          `json:"created_at" gorm:"autoCreateTime:milli" runner:"name:创建时间" widget:"type:datetime;kind:datetime" permission:"read"`
	UpdatedAt int64          `json:"updated_at" gorm:"autoUpdateTime:milli" runner:"name:更新时间" widget:"type:datetime;kind:datetime" permission:"read"`
	DeletedAt gorm.DeletedAt `json:"deleted_at" gorm:"index" runner:"-"`

	OrderNumber  string  `json:"order_number" gorm:"column:order_number;comment:订单号" runner:"name:订单号" widget:"type:input" search:"like" validate:"required"`
	CustomerName string  `json:"customer_name" gorm:"column:customer_name;comment:客户姓名" runner:"name:客户姓名" widget:"type:input" search:"like" validate:"required,min=2,max=50"`
	TotalAmount  float64 `json:"total_amount" gorm:"column:total_amount;comment:订单总额" runner:"name:订单总额" widget:"type:number;precision:2;prefix:￥" search:"gte,lte" validate:"required,min=0"`
	Status       string  `json:"status" gorm:"column:status;comment:订单状态" runner:"name:订单状态" widget:"type:select;options:待支付,已支付,已发货,已完成,已取消" data:"default_value:待支付" search:"in" validate:"required"`
	Remark       string  `json:"remark" gorm:"column:remark;comment:备注" runner:"name:备注" widget:"type:input;mode:text_area" search:"like"`
}

func (FormexampleOrder) TableName() string { return "formexample_order" }

// FormexampleConfig 配置数据模型
type FormexampleConfig struct {
	ID        int            `json:"id" gorm:"primaryKey;autoIncrement" runner:"name:ID" permission:"read"`
	CreatedAt int64          `json:"created_at" gorm:"autoCreateTime:milli" runner:"name:创建时间" widget:"type:datetime;kind:datetime" permission:"read"`
	UpdatedAt int64          `json:"updated_at" gorm:"autoUpdateTime:milli" runner:"name:更新时间" widget:"type:datetime;kind:datetime" permission:"read"`
	DeletedAt gorm.DeletedAt `json:"deleted_at" gorm:"index" runner:"-"`

	Type        string `json:"type" gorm:"column:type;comment:配置类型" runner:"name:配置类型" widget:"type:select;options:theme,language,difficulty,relationship,preference" search:"in" validate:"required"`
	Value       string `json:"value" gorm:"column:value;comment:配置值" runner:"name:配置值" widget:"type:input" search:"like" validate:"required"`
	Label       string `json:"label" gorm:"column:label;comment:显示标签" runner:"name:显示标签" widget:"type:input" search:"like" validate:"required"`
	Description string `json:"description" gorm:"column:description;comment:描述" runner:"name:描述" widget:"type:input;mode:text_area" search:"like"`
}

func (FormexampleConfig) TableName() string { return "formexample_config" }

// ================ 演示函数1：List内单选字段聚合计算 ================

// FormexampleListSingleSelectReq List内单选字段聚合演示请求
type FormexampleListSingleSelectReq struct {
	// 商品数量列表（List组件，每行选择一个商品）
	ProductQuantities []FormexampleProductQuantity `json:"product_quantities" runner:"name:商品清单" widget:"type:list" validate:"required,min=1"`
	// 备注信息
	Remarks string `json:"remarks" runner:"name:备注" widget:"type:input;mode:text_area"`
}

// FormexampleProductQuantity 商品数量结构体
type FormexampleProductQuantity struct {
	ProductID int `json:"product_id" runner:"name:商品" widget:"type:select" validate:"required"`
	Quantity  int `json:"quantity" runner:"name:数量" widget:"type:number;min:1" data:"example:1;default_value:1" validate:"required,min=1"`
}

// FormexampleListSingleSelectResp List内单选字段聚合演示响应
type FormexampleListSingleSelectResp struct {
	// 计算结果 - 放在第一位，用户第一时间看到
	TotalAmount    float64 `json:"total_amount" runner:"name:商品总额" widget:"type:number;precision:2"`
	DiscountAmount float64 `json:"discount_amount" runner:"name:折扣金额" widget:"type:number;precision:2"`
	FinalAmount    float64 `json:"final_amount" runner:"name:实付金额" widget:"type:number;precision:2"`
	ProductCount   int     `json:"product_count" runner:"name:商品种类" widget:"type:number"`
	TotalQuantity  int     `json:"total_quantity" runner:"name:商品总数" widget:"type:number"`
	// 商品清单
	ProductList []FormexampleCartItem `json:"product_list" runner:"name:商品清单" widget:"type:list"`
	// 处理结果
	Message string `json:"message" runner:"name:处理结果" widget:"type:input;mode:text_area"`
}

// FormexampleCartItem 购物车商品
type FormexampleCartItem struct {
	ProductID   int     `json:"product_id" runner:"name:商品ID" widget:"type:number"`
	ProductName string  `json:"product_name" runner:"name:商品名称" widget:"type:input"`
	Price       float64 `json:"price" runner:"name:单价" widget:"type:number;precision:2"`
	Quantity    int     `json:"quantity" runner:"name:数量" widget:"type:number;min:1"`
	TotalPrice  float64 `json:"total_price" runner:"name:小计" widget:"type:number;precision:2"`
}

// FormexampleListSingleSelect List内单选字段聚合演示处理函数
func FormexampleListSingleSelect(ctx *runner.Context, req *FormexampleListSingleSelectReq, resp response.Response) error {
	db := ctx.MustGetOrInitDB()

	// 验证商品清单
	if len(req.ProductQuantities) == 0 {
		return resp.Form(&FormexampleListSingleSelectResp{
			Message: "请选择商品",
		}).Build()
	}

	// 获取商品信息并验证
	var totalAmount float64
	productList := make([]FormexampleCartItem, 0)

	for _, pq := range req.ProductQuantities {
		var product FormexampleProduct
		if err := db.Where("id = ?", pq.ProductID).First(&product).Error; err != nil {
			return resp.Form(&FormexampleListSingleSelectResp{
				Message: fmt.Sprintf("商品ID %d 不存在", pq.ProductID),
			}).Build()
		}

		// 检查库存
		if product.Stock < pq.Quantity {
			return resp.Form(&FormexampleListSingleSelectResp{
				Message: fmt.Sprintf("商品 %s 库存不足，需要 %d，库存 %d", product.Name, pq.Quantity, product.Stock),
			}).Build()
		}

		// 计算小计
		itemTotal := product.Price * float64(pq.Quantity)
		item := FormexampleCartItem{
			ProductID:   pq.ProductID,
			ProductName: product.Name,
			Price:       product.Price,
			Quantity:    pq.Quantity,
			TotalPrice:  itemTotal,
		}
		productList = append(productList, item)
		totalAmount += itemTotal
	}

	// 计算会员折扣（9折）
	discountAmount := totalAmount * 0.1
	finalAmount := totalAmount - discountAmount

	// 计算统计信息
	productCount := len(req.ProductQuantities)
	totalQuantity := 0
	for _, pq := range req.ProductQuantities {
		totalQuantity += pq.Quantity
	}

	return resp.Form(&FormexampleListSingleSelectResp{
		ProductList:    productList,
		TotalAmount:    totalAmount,
		DiscountAmount: discountAmount,
		FinalAmount:    finalAmount,
		ProductCount:   productCount,
		TotalQuantity:  totalQuantity,
		Message:        "处理成功！",
	}).Build()
}

// FormexampleListSingleSelectOption List内单选字段聚合演示配置
var FormexampleListSingleSelectOption = &runner.FormFunctionOptions{
	BaseConfig: runner.BaseConfig{
		EnglishName:  "formexample_list_single_select",
		ChineseName:  "List内单选字段聚合演示",
		ApiDesc:      "List组件内单选字段的聚合计算演示，支持商品选择、数量输入、实时价格计算",
		Tags:         []string{"聚合计算", "List组件", "单选字段"},
		Request:      &FormexampleListSingleSelectReq{},
		Response:     &FormexampleListSingleSelectResp{},
		CreateTables: []interface{}{&FormexampleProduct{}, &FormexampleConfig{}},
		Group:        FormexampleGroup,
	},

	// 【框架说明】OnInputFuzzyMap 为请求结构体字段提供模糊搜索数据
	// 触发时机：用户输入时    数据去向：挂载到对应的请求字段
	OnInputFuzzyMap: map[string]runner.OnInputFuzzy{
		"product_id": func(ctx *runner.Context, req *usercall.OnInputFuzzyReq) (*usercall.OnInputFuzzyResp, error) {
			// 【当前场景】product_id是List内单选字段，支持聚合计算
			// 【目标字段】为 FormexampleListSingleSelectReq.ProductQuantities[].ProductID 提供商品选择数据
			var products []FormexampleProduct
			db := ctx.MustGetOrInitDB()

			if req.IsByFiledValues() {
				// 多值查询：使用 IN 查询，这里必须用 db = db.Where
				db = db.Where("id in ?", req.GetFiledValues())
			} else if req.IsByFiledValue() {
				// 单值查询：使用等值查询，性能最优
				db = db.Where("id = ?", req.GetFiledValue()).Limit(1)
			} else {
				// 模糊查询：关键字搜索
				db = db.Where("name LIKE ? OR category LIKE ?", "%"+req.Keyword()+"%", "%"+req.Keyword()+"%").
					Where("status = ?", "上架").
					Where("stock > ?", 0).
					Limit(20)
			}
			db.Find(&products)

			items := make([]*usercall.InputFuzzyItem, 0)
			for _, p := range products {
				items = append(items, &usercall.InputFuzzyItem{
					Value: p.ID,
					Label: fmt.Sprintf("%s - ¥%.2f (库存:%d)", p.Name, p.Price, p.Stock),
					DisplayInfo: map[string]interface{}{
						"商品名称": p.Name,
						"价格":   p.Price,
						"库存":   p.Stock,
						"分类":   p.Category,
					},
				})
			}

			return &usercall.OnInputFuzzyResp{
				Statistics: map[string]interface{}{
					// ✅ List内字段：支持聚合计算
					"商品原价(元)": "sum(价格,*quantity)",      // 用户选择的所有商品总价
					"会员价格(元)": "sum(价格,*quantity,*0.9)", // 会员9折后的总价
					"优惠金额(元)": "sum(价格,*quantity,*0.1)", // 节省的金额
					"商品种类":    "count(价格)",              // 选了几种商品
					"商品总数":    "sum(quantity)",          // 商品总数量

					// ✅ 有用的静态信息
					"会员折扣": "9折优惠",
					"配送说明": "满99元包邮",
				},
				Values: items,
			}, nil
		},
	},
}

// ================ 演示函数2：多选字段聚合计算 ================

// FormexampleMultiSelectReq 多选字段聚合演示请求
type FormexampleMultiSelectReq struct {
	// 多选商品（multiselect组件，用户可以选择多个商品）
	ProductIDs []int `json:"product_ids" runner:"name:商品选择" widget:"type:multiselect" validate:"required,min=1"`
	// 数量
	Quantity int `json:"quantity" runner:"name:数量" widget:"type:number;min:1" data:"example:1;default_value:1" validate:"required,min=1"`
	// 折扣系数
	Discount float64 `json:"discount" runner:"name:折扣系数" widget:"type:number;min:0;max:1;precision:2" data:"example:0.9;default_value:0.9" validate:"required,min=0,max=1"`
	// 备注
	Remarks string `json:"remarks" runner:"name:备注" widget:"type:input;mode:text_area"`
}

// FormexampleMultiSelectResp 多选字段聚合演示响应
type FormexampleMultiSelectResp struct {
	// 计算结果
	TotalAmount    float64 `json:"total_amount" runner:"name:商品总额" widget:"type:number;precision:2"`
	DiscountAmount float64 `json:"discount_amount" runner:"name:折扣金额" widget:"type:number;precision:2"`
	FinalAmount    float64 `json:"final_amount" runner:"name:实付金额" widget:"type:number;precision:2"`
	ProductCount   int     `json:"product_count" runner:"name:商品种类" widget:"type:number"`
	TotalQuantity  int     `json:"total_quantity" runner:"name:商品总数" widget:"type:number"`
	// 商品清单
	ProductList []FormexampleCartItem `json:"product_list" runner:"name:商品清单" widget:"type:list"`
	// 处理结果
	Message string `json:"message" runner:"name:处理结果" widget:"type:input;mode:text_area"`
}

// FormexampleMultiSelect 多选字段聚合演示处理函数
func FormexampleMultiSelect(ctx *runner.Context, req *FormexampleMultiSelectReq, resp response.Response) error {
	db := ctx.MustGetOrInitDB()

	// 验证商品选择
	if len(req.ProductIDs) == 0 {
		return resp.Form(&FormexampleMultiSelectResp{
			Message: "请选择商品",
		}).Build()
	}

	// 获取商品信息并验证
	var products []FormexampleProduct
	if err := db.Where("id IN ?", req.ProductIDs).Find(&products).Error; err != nil {
		return resp.Form(&FormexampleMultiSelectResp{
			Message: "查询商品失败",
		}).Build()
	}

	if len(products) != len(req.ProductIDs) {
		return resp.Form(&FormexampleMultiSelectResp{
			Message: "部分商品不存在",
		}).Build()
	}

	// 构建商品清单
	var totalAmount float64
	productList := make([]FormexampleCartItem, 0)

	for _, product := range products {
		// 检查库存
		if product.Stock < req.Quantity {
			return resp.Form(&FormexampleMultiSelectResp{
				Message: fmt.Sprintf("商品 %s 库存不足，需要 %d，库存 %d", product.Name, req.Quantity, product.Stock),
			}).Build()
		}

		// 计算小计
		itemTotal := product.Price * float64(req.Quantity)
		item := FormexampleCartItem{
			ProductID:   product.ID,
			ProductName: product.Name,
			Price:       product.Price,
			Quantity:    req.Quantity,
			TotalPrice:  itemTotal,
		}
		productList = append(productList, item)
		totalAmount += itemTotal
	}

	// 计算折扣
	discountAmount := totalAmount * (1 - req.Discount)
	finalAmount := totalAmount - discountAmount

	// 计算统计信息
	productCount := len(req.ProductIDs)
	totalQuantity := len(req.ProductIDs) * req.Quantity

	return resp.Form(&FormexampleMultiSelectResp{
		ProductList:    productList,
		TotalAmount:    totalAmount,
		DiscountAmount: discountAmount,
		FinalAmount:    finalAmount,
		ProductCount:   productCount,
		TotalQuantity:  totalQuantity,
		Message:        "处理成功！",
	}).Build()
}

// FormexampleMultiSelectOption 多选字段聚合演示配置
var FormexampleMultiSelectOption = &runner.FormFunctionOptions{
	BaseConfig: runner.BaseConfig{
		EnglishName:  "formexample_multi_select",
		ChineseName:  "多选字段聚合演示",
		ApiDesc:      "多选字段的聚合计算演示，支持多选商品、数量输入、折扣计算",
		Tags:         []string{"聚合计算", "多选字段", "折扣计算"},
		Request:      &FormexampleMultiSelectReq{},
		Response:     &FormexampleMultiSelectResp{},
		CreateTables: []interface{}{&FormexampleProduct{}},
		Group:        FormexampleGroup,
	},

	// 【框架说明】OnApiCreated 在API创建时初始化数据库数据
	// 触发时机：API首次创建时    用途：初始化商品数据
	OnApiCreated: func(ctx *runner.Context, req *usercall.OnApiCreatedReq) error {
		db := ctx.MustGetOrInitDB()

		// 初始化联想产品数据
		lenovoProducts := []FormexampleProduct{
			{Name: "联想ThinkPad X1 Carbon", Price: 12999.00, Stock: 50, Category: "电子产品", Description: "商务笔记本电脑，轻薄便携，性能强劲", Status: "上架"},
			{Name: "联想拯救者Y7000P", Price: 8999.00, Stock: 30, Category: "电子产品", Description: "游戏笔记本电脑，RTX显卡，高刷新率屏幕", Status: "上架"},
			{Name: "联想小新Air 14", Price: 4999.00, Stock: 80, Category: "电子产品", Description: "轻薄本，适合办公学习，性价比高", Status: "上架"},
			{Name: "联想ThinkPad E15", Price: 5999.00, Stock: 60, Category: "电子产品", Description: "商务本，15.6英寸大屏，接口丰富", Status: "上架"},
			{Name: "联想拯救者R7000", Price: 6999.00, Stock: 40, Category: "电子产品", Description: "游戏本，AMD处理器，独立显卡", Status: "上架"},
			{Name: "联想小新Pro 16", Price: 6999.00, Stock: 35, Category: "电子产品", Description: "创作本，16英寸2.5K屏幕，适合设计", Status: "上架"},
			{Name: "联想ThinkBook 14", Price: 4599.00, Stock: 70, Category: "电子产品", Description: "商务本，14英寸，轻薄便携", Status: "上架"},
			{Name: "联想拯救者Y9000P", Price: 11999.00, Stock: 25, Category: "电子产品", Description: "高端游戏本，RTX3070显卡，2K屏幕", Status: "上架"},
			{Name: "联想小新Air 15", Price: 5299.00, Stock: 45, Category: "电子产品", Description: "大屏轻薄本，15.6英寸，数字小键盘", Status: "上架"},
			{Name: "联想ThinkPad T14", Price: 8999.00, Stock: 20, Category: "电子产品", Description: "专业商务本，军工级品质，稳定可靠", Status: "上架"},
		}

		// 初始化其他品牌产品数据
		otherProducts := []FormexampleProduct{
			{Name: "苹果MacBook Pro 14", Price: 14999.00, Stock: 15, Category: "电子产品", Description: "苹果笔记本电脑，M2芯片，专业创作", Status: "上架"},
			{Name: "华为MateBook X Pro", Price: 9999.00, Stock: 25, Category: "电子产品", Description: "华为旗舰笔记本，3K触控屏，轻薄设计", Status: "上架"},
			{Name: "戴尔XPS 13", Price: 8999.00, Stock: 30, Category: "电子产品", Description: "戴尔超极本，13.4英寸，4K屏幕", Status: "上架"},
			{Name: "华硕ROG幻16", Price: 12999.00, Stock: 20, Category: "电子产品", Description: "华硕游戏本，RTX显卡，高刷新率", Status: "上架"},
			{Name: "小米笔记本Pro 15", Price: 5999.00, Stock: 40, Category: "电子产品", Description: "小米笔记本，3.5K屏幕，性价比高", Status: "上架"},
		}

		allProducts := append(lenovoProducts, otherProducts...)

		for _, product := range allProducts {
			var existing FormexampleProduct
			if err := db.Where("name = ?", product.Name).First(&existing).Error; err != nil {
				if err := db.Create(&product).Error; err != nil {
					ctx.Logger.Errorf("创建商品数据失败: %v", err)
				}
			}
		}

		return nil
	},

	// 【框架说明】OnInputFuzzyMap 为请求结构体字段提供模糊搜索数据
	// 触发时机：用户输入时    数据去向：挂载到对应的请求字段
	OnInputFuzzyMap: map[string]runner.OnInputFuzzy{
		"product_ids": func(ctx *runner.Context, req *usercall.OnInputFuzzyReq) (*usercall.OnInputFuzzyResp, error) {
			// 【当前场景】product_ids是多选字段，支持聚合计算
			// 【目标字段】为 FormexampleMultiSelectReq.ProductIDs 提供商品多选数据
			var products []FormexampleProduct
			db := ctx.MustGetOrInitDB()

			if req.IsByFiledValues() {
				// 多值查询：使用 IN 查询，这里必须用 db = db.Where
				db = db.Where("id in ?", req.GetFiledValues())
			} else if req.IsByFiledValue() {
				// 单值查询：使用等值查询，性能最优
				db = db.Where("id = ?", req.GetFiledValue()).Limit(1)
			} else {
				// 模糊查询：关键字搜索
				db = db.Where("name LIKE ? OR category LIKE ?", "%"+req.Keyword()+"%", "%"+req.Keyword()+"%").
					Where("status = ?", "上架").
					Where("stock > ?", 0).
					Limit(20)
			}
			db.Find(&products)

			items := make([]*usercall.InputFuzzyItem, 0)
			for _, p := range products {
				items = append(items, &usercall.InputFuzzyItem{
					Value: p.ID,
					Label: fmt.Sprintf("%s - ¥%.2f (库存:%d)", p.Name, p.Price, p.Stock),
					DisplayInfo: map[string]interface{}{
						"商品名称": p.Name,
						"价格":   p.Price,
						"库存":   p.Stock,
						"分类":   p.Category,
					},
				})
			}

			return &usercall.OnInputFuzzyResp{
				Statistics: map[string]interface{}{
					// ✅ 多选场景：支持聚合计算
					"选中商品数":  "count(价格)",         // 选了几个商品
					"选中商品总价": "sum(价格,*quantity)", // 总价格
					"最低单价":   "min(价格)",           // 选中商品中最便宜的
					"平均单价":   "avg(价格)",           // 选中商品平均价格

					// ✅ 静态信息
					"会员折扣": "9折优惠",
					"配送说明": "满99元包邮",
				},
				Values: items,
			}, nil
		},
	},
}

// ================ 演示函数3：单选字段静态信息展示 ================

// FormexampleSingleSelectReq 单选字段静态信息演示请求
type FormexampleSingleSelectReq struct {
	// 单选商品（select组件，用户只能选择一个商品）
	ProductID int `json:"product_id" runner:"name:商品选择" widget:"type:select" validate:"required"`
	// 数量
	Quantity int `json:"quantity" runner:"name:数量" widget:"type:number;min:1" data:"example:1;default_value:1" validate:"required,min=1"`
	// 备注
	Remarks string `json:"remarks" runner:"name:备注" widget:"type:input;mode:text_area"`
}

// FormexampleSingleSelectResp 单选字段静态信息演示响应
type FormexampleSingleSelectResp struct {
	// 计算结果
	TotalAmount float64 `json:"total_amount" runner:"name:商品总额" widget:"type:number;precision:2"`
	// 商品信息
	ProductName  string  `json:"product_name" runner:"name:商品名称" widget:"type:input"`
	ProductPrice float64 `json:"product_price" runner:"name:商品单价" widget:"type:number;precision:2"`
	ProductStock int     `json:"product_stock" runner:"name:商品库存" widget:"type:number"`
	// 处理结果
	Message string `json:"message" runner:"name:处理结果" widget:"type:input;mode:text_area"`
}

// FormexampleSingleSelect 单选字段静态信息演示处理函数
func FormexampleSingleSelect(ctx *runner.Context, req *FormexampleSingleSelectReq, resp response.Response) error {
	db := ctx.MustGetOrInitDB()

	// 验证商品选择
	if req.ProductID == 0 {
		return resp.Form(&FormexampleSingleSelectResp{
			Message: "请选择商品",
		}).Build()
	}

	// 获取商品信息并验证
	var product FormexampleProduct
	if err := db.Where("id = ?", req.ProductID).First(&product).Error; err != nil {
		return resp.Form(&FormexampleSingleSelectResp{
			Message: "商品不存在",
		}).Build()
	}

	// 检查库存
	if product.Stock < req.Quantity {
		return resp.Form(&FormexampleSingleSelectResp{
			Message: fmt.Sprintf("商品 %s 库存不足，需要 %d，库存 %d", product.Name, req.Quantity, product.Stock),
		}).Build()
	}

	// 计算总价
	totalAmount := product.Price * float64(req.Quantity)

	return resp.Form(&FormexampleSingleSelectResp{
		TotalAmount:  totalAmount,
		ProductName:  product.Name,
		ProductPrice: product.Price,
		ProductStock: product.Stock,
		Message:      "处理成功！",
	}).Build()
}

// FormexampleSingleSelectOption 单选字段静态信息演示配置
var FormexampleSingleSelectOption = &runner.FormFunctionOptions{
	BaseConfig: runner.BaseConfig{
		EnglishName:  "formexample_single_select",
		ChineseName:  "单选字段静态信息演示",
		ApiDesc:      "单选字段的静态信息展示演示，支持商品选择、数量输入、静态信息展示",
		Tags:         []string{"静态信息", "单选字段", "商品选择"},
		Request:      &FormexampleSingleSelectReq{},
		Response:     &FormexampleSingleSelectResp{},
		CreateTables: []interface{}{&FormexampleProduct{}},
		Group:        FormexampleGroup,
	},

	// 【框架说明】OnApiCreated 在API创建时初始化数据库数据
	// 触发时机：API首次创建时    用途：初始化商品数据
	OnApiCreated: func(ctx *runner.Context, req *usercall.OnApiCreatedReq) error {
		db := ctx.MustGetOrInitDB()

		// 初始化联想产品数据
		lenovoProducts := []FormexampleProduct{
			{Name: "联想ThinkPad X1 Carbon", Price: 12999.00, Stock: 50, Category: "电子产品", Description: "商务笔记本电脑，轻薄便携，性能强劲", Status: "上架"},
			{Name: "联想拯救者Y7000P", Price: 8999.00, Stock: 30, Category: "电子产品", Description: "游戏笔记本电脑，RTX显卡，高刷新率屏幕", Status: "上架"},
			{Name: "联想小新Air 14", Price: 4999.00, Stock: 80, Category: "电子产品", Description: "轻薄本，适合办公学习，性价比高", Status: "上架"},
			{Name: "联想ThinkPad E15", Price: 5999.00, Stock: 60, Category: "电子产品", Description: "商务本，15.6英寸大屏，接口丰富", Status: "上架"},
			{Name: "联想拯救者R7000", Price: 6999.00, Stock: 40, Category: "电子产品", Description: "游戏本，AMD处理器，独立显卡", Status: "上架"},
			{Name: "联想小新Pro 16", Price: 6999.00, Stock: 35, Category: "电子产品", Description: "创作本，16英寸2.5K屏幕，适合设计", Status: "上架"},
			{Name: "联想ThinkBook 14", Price: 4599.00, Stock: 70, Category: "电子产品", Description: "商务本，14英寸，轻薄便携", Status: "上架"},
			{Name: "联想拯救者Y9000P", Price: 11999.00, Stock: 25, Category: "电子产品", Description: "高端游戏本，RTX3070显卡，2K屏幕", Status: "上架"},
			{Name: "联想小新Air 15", Price: 5299.00, Stock: 45, Category: "电子产品", Description: "大屏轻薄本，15.6英寸，数字小键盘", Status: "上架"},
			{Name: "联想ThinkPad T14", Price: 8999.00, Stock: 20, Category: "电子产品", Description: "专业商务本，军工级品质，稳定可靠", Status: "上架"},
		}

		// 初始化其他品牌产品数据
		otherProducts := []FormexampleProduct{
			{Name: "苹果MacBook Pro 14", Price: 14999.00, Stock: 15, Category: "电子产品", Description: "苹果笔记本电脑，M2芯片，专业创作", Status: "上架"},
			{Name: "华为MateBook X Pro", Price: 9999.00, Stock: 25, Category: "电子产品", Description: "华为旗舰笔记本，3K触控屏，轻薄设计", Status: "上架"},
			{Name: "戴尔XPS 13", Price: 8999.00, Stock: 30, Category: "电子产品", Description: "戴尔超极本，13.4英寸，4K屏幕", Status: "上架"},
			{Name: "华硕ROG幻16", Price: 12999.00, Stock: 20, Category: "电子产品", Description: "华硕游戏本，RTX显卡，高刷新率", Status: "上架"},
			{Name: "小米笔记本Pro 15", Price: 5999.00, Stock: 40, Category: "电子产品", Description: "小米笔记本，3.5K屏幕，性价比高", Status: "上架"},
		}

		allProducts := append(lenovoProducts, otherProducts...)

		for _, product := range allProducts {
			var existing FormexampleProduct
			if err := db.Where("name = ?", product.Name).First(&existing).Error; err != nil {
				if err := db.Create(&product).Error; err != nil {
					ctx.Logger.Errorf("创建商品数据失败: %v", err)
				}
			}
		}

		return nil
	},

	// 【框架说明】OnInputFuzzyMap 为请求结构体字段提供模糊搜索数据
	// 触发时机：用户输入时    数据去向：挂载到对应的请求字段
	OnInputFuzzyMap: map[string]runner.OnInputFuzzy{
		"product_id": func(ctx *runner.Context, req *usercall.OnInputFuzzyReq) (*usercall.OnInputFuzzyResp, error) {
			// 【当前场景】product_id是单选字段，只返回静态信息，不做聚合计算
			// 【目标字段】为 FormexampleSingleSelectReq.ProductID 提供商品选择数据
			var products []FormexampleProduct
			db := ctx.MustGetOrInitDB()

			ctx.Logger.Infof("formexample_single_select product_id :%+v val:%v", req, req.GetFiledValue())
			if req.IsByFiledValues() {
				// 多值查询：使用 IN 查询，这里必须用 db = db.Where
				db = db.Where("id in ?", req.GetFiledValues())
			} else if req.IsByFiledValue() {
				// 单值查询：使用等值查询，性能最优
				db = db.Where("id = ?", req.GetFiledValue()).Limit(1)
			} else {
				// 模糊查询：关键字搜索
				db = db.Where("name LIKE ? OR category LIKE ?", "%"+req.Keyword()+"%", "%"+req.Keyword()+"%").
					Where("status = ?", "上架").
					Where("stock > ?", 0).
					Limit(20)
			}
			db.Find(&products)

			items := make([]*usercall.InputFuzzyItem, 0)
			for _, p := range products {
				items = append(items, &usercall.InputFuzzyItem{
					Value: p.ID,
					Label: fmt.Sprintf("%s - ¥%.2f (库存:%d)", p.Name, p.Price, p.Stock),
					DisplayInfo: map[string]interface{}{
						"商品名称": p.Name,
						"价格":   p.Price,
						"库存":   p.Stock,
						"分类":   p.Category,
					},
				})
			}

			return &usercall.OnInputFuzzyResp{
				Statistics: map[string]interface{}{
					// ✅ 单选场景：只返回有用的静态信息
					"配送方式": "顺丰快递",
					"保质期":  "12个月",
					"退换政策": "7天无理由退换",
					"客服电话": "400-123-4567",
				},
				Values: items,
			}, nil
		},
	},
}

// ================ 演示函数4：Struct内单选字段（配置数据） ================

// FormexampleStructSingleSelectReq Struct内单选字段演示请求
type FormexampleStructSingleSelectReq struct {
	// 配置信息（Form组件，包含多个单选字段）
	Config FormexampleStructSingleSelectConfig `json:"config" runner:"name:配置信息" widget:"type:form" validate:"required"`
	// 备注
	Remarks string `json:"remarks" runner:"name:备注" widget:"type:input;mode:text_area"`
}

// FormexampleStructSingleSelectConfig 配置信息结构体
type FormexampleStructSingleSelectConfig struct {
	Theme      string `json:"theme" runner:"name:主题" widget:"type:select" validate:"required"`
	Language   string `json:"language" runner:"name:语言" widget:"type:select" validate:"required"`
	Difficulty string `json:"difficulty" runner:"name:难度" widget:"type:select" validate:"required"`
}

// FormexampleStructSingleSelectResp Struct内单选字段演示响应
type FormexampleStructSingleSelectResp struct {
	// 配置信息
	Theme      string `json:"theme" runner:"name:主题" widget:"type:input"`
	Language   string `json:"language" runner:"name:语言" widget:"type:input"`
	Difficulty string `json:"difficulty" runner:"name:难度" widget:"type:input"`
	// 处理结果
	Message string `json:"message" runner:"name:处理结果" widget:"type:input;mode:text_area"`
}

// FormexampleStructSingleSelect Struct内单选字段演示处理函数
func FormexampleStructSingleSelect(ctx *runner.Context, req *FormexampleStructSingleSelectReq, resp response.Response) error {
	// 验证配置信息
	if req.Config.Theme == "" || req.Config.Language == "" || req.Config.Difficulty == "" {
		return resp.Form(&FormexampleStructSingleSelectResp{
			Message: "请完善配置信息",
		}).Build()
	}

	return resp.Form(&FormexampleStructSingleSelectResp{
		Theme:      req.Config.Theme,
		Language:   req.Config.Language,
		Difficulty: req.Config.Difficulty,
		Message:    "配置保存成功！",
	}).Build()
}

// FormexampleStructSingleSelectOption Struct内单选字段演示配置
var FormexampleStructSingleSelectOption = &runner.FormFunctionOptions{
	BaseConfig: runner.BaseConfig{
		EnglishName:  "formexample_struct_single_select",
		ChineseName:  "Struct内单选字段演示",
		ApiDesc:      "Struct内单选字段的配置数据演示，支持主题、语言、难度选择",
		Tags:         []string{"配置数据", "Struct内单选", "静态信息"},
		Request:      &FormexampleStructSingleSelectReq{},
		Response:     &FormexampleStructSingleSelectResp{},
		CreateTables: []interface{}{&FormexampleConfig{}},
		Group:        FormexampleGroup,
	},

	// 【框架说明】OnApiCreated 在API创建时初始化数据库数据
	// 触发时机：API首次创建时    用途：初始化配置数据和商品数据
	OnApiCreated: func(ctx *runner.Context, req *usercall.OnApiCreatedReq) error {
		db := ctx.MustGetOrInitDB()

		// 初始化联想产品数据
		lenovoProducts := []FormexampleProduct{
			{Name: "联想ThinkPad X1 Carbon", Price: 12999.00, Stock: 50, Category: "电子产品", Description: "商务笔记本电脑，轻薄便携，性能强劲", Status: "上架"},
			{Name: "联想拯救者Y7000P", Price: 8999.00, Stock: 30, Category: "电子产品", Description: "游戏笔记本电脑，RTX显卡，高刷新率屏幕", Status: "上架"},
			{Name: "联想小新Air 14", Price: 4999.00, Stock: 80, Category: "电子产品", Description: "轻薄本，适合办公学习，性价比高", Status: "上架"},
			{Name: "联想ThinkPad E15", Price: 5999.00, Stock: 60, Category: "电子产品", Description: "商务本，15.6英寸大屏，接口丰富", Status: "上架"},
			{Name: "联想拯救者R7000", Price: 6999.00, Stock: 40, Category: "电子产品", Description: "游戏本，AMD处理器，独立显卡", Status: "上架"},
			{Name: "联想小新Pro 16", Price: 6999.00, Stock: 35, Category: "电子产品", Description: "创作本，16英寸2.5K屏幕，适合设计", Status: "上架"},
			{Name: "联想ThinkBook 14", Price: 4599.00, Stock: 70, Category: "电子产品", Description: "商务本，14英寸，轻薄便携", Status: "上架"},
			{Name: "联想拯救者Y9000P", Price: 11999.00, Stock: 25, Category: "电子产品", Description: "高端游戏本，RTX3070显卡，2K屏幕", Status: "上架"},
			{Name: "联想小新Air 15", Price: 5299.00, Stock: 45, Category: "电子产品", Description: "大屏轻薄本，15.6英寸，数字小键盘", Status: "上架"},
			{Name: "联想ThinkPad T14", Price: 8999.00, Stock: 20, Category: "电子产品", Description: "专业商务本，军工级品质，稳定可靠", Status: "上架"},
		}

		// 初始化其他品牌产品数据
		otherProducts := []FormexampleProduct{
			{Name: "苹果MacBook Pro 14", Price: 14999.00, Stock: 15, Category: "电子产品", Description: "苹果笔记本电脑，M2芯片，专业创作", Status: "上架"},
			{Name: "华为MateBook X Pro", Price: 9999.00, Stock: 25, Category: "电子产品", Description: "华为旗舰笔记本，3K触控屏，轻薄设计", Status: "上架"},
			{Name: "戴尔XPS 13", Price: 8999.00, Stock: 30, Category: "电子产品", Description: "戴尔超极本，13.4英寸，4K屏幕", Status: "上架"},
			{Name: "华硕ROG幻16", Price: 12999.00, Stock: 20, Category: "电子产品", Description: "华硕游戏本，RTX显卡，高刷新率", Status: "上架"},
			{Name: "小米笔记本Pro 15", Price: 5999.00, Stock: 40, Category: "电子产品", Description: "小米笔记本，3.5K屏幕，性价比高", Status: "上架"},
		}

		allProducts := append(lenovoProducts, otherProducts...)

		for _, product := range allProducts {
			var existing FormexampleProduct
			if err := db.Where("name = ?", product.Name).First(&existing).Error; err != nil {
				if err := db.Create(&product).Error; err != nil {
					ctx.Logger.Errorf("创建商品数据失败: %v", err)
				}
			}
		}

		// 初始化主题配置
		themes := []FormexampleConfig{
			{Type: "theme", Value: "dark", Label: "深色主题", Description: "适合夜间使用的深色界面"},
			{Type: "theme", Value: "light", Label: "浅色主题", Description: "适合日间使用的浅色界面"},
			{Type: "theme", Value: "auto", Label: "自动主题", Description: "根据系统设置自动切换"},
		}

		// 初始化语言配置
		languages := []FormexampleConfig{
			{Type: "language", Value: "zh-CN", Label: "简体中文", Description: "中国大陆地区使用的简体中文"},
			{Type: "language", Value: "en-US", Label: "English", Description: "American English"},
			{Type: "language", Value: "ja-JP", Label: "日本語", Description: "日本语"},
		}

		// 初始化难度配置
		difficulties := []FormexampleConfig{
			{Type: "difficulty", Value: "easy", Label: "简单", Description: "适合初学者的简单模式"},
			{Type: "difficulty", Value: "medium", Label: "中等", Description: "适合有一定基础的中等模式"},
			{Type: "difficulty", Value: "hard", Label: "困难", Description: "适合高级用户的困难模式"},
		}

		allConfigs := append(append(themes, languages...), difficulties...)

		for _, config := range allConfigs {
			var existing FormexampleConfig
			if err := db.Where("type = ? AND value = ?", config.Type, config.Value).First(&existing).Error; err != nil {
				if err := db.Create(&config).Error; err != nil {
					ctx.Logger.Errorf("创建配置数据失败: %v", err)
				}
			}
		}

		return nil
	},

	// 【框架说明】OnInputFuzzyMap 为请求结构体字段提供模糊搜索数据
	// 触发时机：用户输入时    数据去向：挂载到对应的请求字段
	OnInputFuzzyMap: map[string]runner.OnInputFuzzy{
		"theme": func(ctx *runner.Context, req *usercall.OnInputFuzzyReq) (*usercall.OnInputFuzzyResp, error) {
			// 【当前场景】theme是Struct内单选字段，只返回静态信息，不做聚合计算
			// 【目标字段】为 FormexampleStructSingleSelectReq.Config.Theme 提供主题选择数据
			var configs []FormexampleConfig
			db := ctx.MustGetOrInitDB()

			if req.IsByFiledValues() {
				// 多值查询：使用 IN 查询，这里必须用 db = db.Where
				db = db.Where("value in ?", req.GetFiledValues())
			} else if req.IsByFiledValue() {
				// 单值查询：使用等值查询，性能最优
				db = db.Where("value = ?", req.GetFiledValue()).Limit(1)
			} else {
				// 模糊查询：关键字搜索
				db = db.Where("type = ? AND (label LIKE ? OR value LIKE ?)", "theme", "%"+req.Keyword()+"%", "%"+req.Keyword()+"%").
					Limit(20)
			}
			db.Find(&configs)

			items := make([]*usercall.InputFuzzyItem, 0)
			for _, c := range configs {
				items = append(items, &usercall.InputFuzzyItem{
					Value: c.Value,
					Label: fmt.Sprintf("%s - %s", c.Label, c.Description),
					DisplayInfo: map[string]interface{}{
						"主题名称": c.Label,
						"主题值":  c.Value,
						"描述":   c.Description,
					},
				})
			}

			return &usercall.OnInputFuzzyResp{
				Statistics: map[string]interface{}{
					// ✅ 单选场景：只返回有用的静态信息
					"主题特色": "科幻风格界面",
					"兼容性":  "支持所有设备",
					"推荐指数": "★★★★★",
				},
				Values: items,
			}, nil
		},

		"language": func(ctx *runner.Context, req *usercall.OnInputFuzzyReq) (*usercall.OnInputFuzzyResp, error) {
			// 【当前场景】language是Struct内单选字段，只返回静态信息，不做聚合计算
			// 【目标字段】为 FormexampleStructSingleSelectReq.Config.Language 提供语言选择数据
			var configs []FormexampleConfig
			db := ctx.MustGetOrInitDB()

			if req.IsByFiledValues() {
				// 多值查询：使用 IN 查询，这里必须用 db = db.Where
				db = db.Where("value in ?", req.GetFiledValues())
			} else if req.IsByFiledValue() {
				// 单值查询：使用等值查询，性能最优
				db = db.Where("value = ?", req.GetFiledValue()).Limit(1)
			} else {
				// 模糊查询：关键字搜索
				db = db.Where("type = ? AND (label LIKE ? OR value LIKE ?)", "language", "%"+req.Keyword()+"%", "%"+req.Keyword()+"%").
					Limit(20)
			}
			db.Find(&configs)

			items := make([]*usercall.InputFuzzyItem, 0)
			for _, c := range configs {
				items = append(items, &usercall.InputFuzzyItem{
					Value: c.Value,
					Label: fmt.Sprintf("%s - %s", c.Label, c.Description),
					DisplayInfo: map[string]interface{}{
						"语言名称": c.Label,
						"语言值":  c.Value,
						"描述":   c.Description,
					},
				})
			}

			return &usercall.OnInputFuzzyResp{
				Statistics: map[string]interface{}{
					// ✅ 语言相关信息
					"语言包大小": "15MB",
					"支持语音":  "是",
					"更新频率":  "每月更新",
				},
				Values: items,
			}, nil
		},

		"difficulty": func(ctx *runner.Context, req *usercall.OnInputFuzzyReq) (*usercall.OnInputFuzzyResp, error) {
			// 【当前场景】difficulty是Struct内单选字段，只返回静态信息，不做聚合计算
			// 【目标字段】为 FormexampleStructSingleSelectReq.Config.Difficulty 提供难度选择数据
			var configs []FormexampleConfig
			db := ctx.MustGetOrInitDB()

			if req.IsByFiledValues() {
				// 多值查询：使用 IN 查询，这里必须用 db = db.Where
				db = db.Where("value in ?", req.GetFiledValues())
			} else if req.IsByFiledValue() {
				// 单值查询：使用等值查询，性能最优
				db = db.Where("value = ?", req.GetFiledValue()).Limit(1)
			} else {
				// 模糊查询：关键字搜索
				db = db.Where("type = ? AND (label LIKE ? OR value LIKE ?)", "difficulty", "%"+req.Keyword()+"%", "%"+req.Keyword()+"%").
					Limit(20)
			}
			db.Find(&configs)

			items := make([]*usercall.InputFuzzyItem, 0)
			for _, c := range configs {
				items = append(items, &usercall.InputFuzzyItem{
					Value: c.Value,
					Label: fmt.Sprintf("%s - %s", c.Label, c.Description),
					DisplayInfo: map[string]interface{}{
						"难度名称": c.Label,
						"难度值":  c.Value,
						"描述":   c.Description,
					},
				})
			}

			return &usercall.OnInputFuzzyResp{
				Statistics: map[string]interface{}{
					// ✅ 难度相关信息
					"推荐人群": "根据难度选择",
					"学习时间": "1-3个月",
					"通过率":  "85%",
				},
				Values: items,
			}, nil
		},
	},
}

// ================ 演示函数5：Struct内多选字段（配置数据） ================

// FormexampleStructMultiSelectReq Struct内多选字段演示请求
type FormexampleStructMultiSelectReq struct {
	// 用户偏好配置（Form组件，包含多个多选字段）
	UserProfile FormexampleStructMultiSelectProfile `json:"user_profile" runner:"name:用户偏好" widget:"type:form" validate:"required"`
	// 备注
	Remarks string `json:"remarks" runner:"name:备注" widget:"type:input;mode:text_area"`
}

// FormexampleStructMultiSelectProfile 用户偏好配置结构体
type FormexampleStructMultiSelectProfile struct {
	Relationship        []string `json:"relationship" runner:"name:关系类型" widget:"type:multiselect" validate:"required,min=1"`
	Preferences         []string `json:"preferences" runner:"name:偏好设置" widget:"type:multiselect" validate:"required,min=1"`
	RecommendedProducts []int    `json:"recommended_products" runner:"name:推荐商品" widget:"type:multiselect"`
}

// FormexampleStructMultiSelectResp Struct内多选字段演示响应
type FormexampleStructMultiSelectResp struct {
	// 配置信息
	Relationship        []string `json:"relationship" runner:"name:关系类型" widget:"type:list"`
	Preferences         []string `json:"preferences" runner:"name:偏好设置" widget:"type:list"`
	RecommendedProducts []int    `json:"recommended_products" runner:"name:推荐商品" widget:"type:list"`
	// 处理结果
	Message string `json:"message" runner:"name:处理结果" widget:"type:input;mode:text_area"`
}

// FormexampleStructMultiSelect Struct内多选字段演示处理函数
func FormexampleStructMultiSelect(ctx *runner.Context, req *FormexampleStructMultiSelectReq, resp response.Response) error {
	// 验证配置信息
	if len(req.UserProfile.Relationship) == 0 || len(req.UserProfile.Preferences) == 0 {
		return resp.Form(&FormexampleStructMultiSelectResp{
			Message: "请完善用户偏好配置",
		}).Build()
	}

	return resp.Form(&FormexampleStructMultiSelectResp{
		Relationship:        req.UserProfile.Relationship,
		Preferences:         req.UserProfile.Preferences,
		RecommendedProducts: req.UserProfile.RecommendedProducts,
		Message:             "用户偏好配置保存成功！",
	}).Build()
}

// FormexampleStructMultiSelectOption Struct内多选字段演示配置
var FormexampleStructMultiSelectOption = &runner.FormFunctionOptions{
	BaseConfig: runner.BaseConfig{
		EnglishName:  "formexample_struct_multi_select",
		ChineseName:  "Struct内多选字段演示",
		ApiDesc:      "Struct内多选字段的配置数据演示，支持关系类型、偏好设置、推荐商品多选",
		Tags:         []string{"配置数据", "Struct内多选", "聚合计算"},
		Request:      &FormexampleStructMultiSelectReq{},
		Response:     &FormexampleStructMultiSelectResp{},
		CreateTables: []interface{}{&FormexampleConfig{}, &FormexampleProduct{}},
		Group:        FormexampleGroup,
	},

	// 【框架说明】OnApiCreated 在API创建时初始化数据库数据
	// 触发时机：API首次创建时    用途：初始化配置数据
	OnApiCreated: func(ctx *runner.Context, req *usercall.OnApiCreatedReq) error {
		db := ctx.MustGetOrInitDB()

		// 初始化关系类型配置
		relationships := []FormexampleConfig{
			{Type: "relationship", Value: "family", Label: "家庭", Description: "家庭成员关系"},
			{Type: "relationship", Value: "friend", Label: "朋友", Description: "朋友关系"},
			{Type: "relationship", Value: "colleague", Label: "同事", Description: "工作同事关系"},
			{Type: "relationship", Value: "partner", Label: "伴侣", Description: "恋爱伴侣关系"},
		}

		// 初始化偏好设置配置
		preferences := []FormexampleConfig{
			{Type: "preference", Value: "music", Label: "音乐", Description: "喜欢音乐相关活动"},
			{Type: "preference", Value: "sports", Label: "运动", Description: "喜欢体育运动"},
			{Type: "preference", Value: "reading", Label: "阅读", Description: "喜欢阅读书籍"},
			{Type: "preference", Value: "travel", Label: "旅行", Description: "喜欢旅行探索"},
			{Type: "preference", Value: "cooking", Label: "烹饪", Description: "喜欢烹饪美食"},
		}

		allConfigs := append(relationships, preferences...)

		for _, config := range allConfigs {
			var existing FormexampleConfig
			if err := db.Where("type = ? AND value = ?", config.Type, config.Value).First(&existing).Error; err != nil {
				if err := db.Create(&config).Error; err != nil {
					ctx.Logger.Errorf("创建配置数据失败: %v", err)
				}
			}
		}

		return nil
	},

	// 【框架说明】OnInputFuzzyMap 为请求结构体字段提供模糊搜索数据
	// 触发时机：用户输入时    数据去向：挂载到对应的请求字段
	OnInputFuzzyMap: map[string]runner.OnInputFuzzy{
		"relationship": func(ctx *runner.Context, req *usercall.OnInputFuzzyReq) (*usercall.OnInputFuzzyResp, error) {
			// 【当前场景】relationship是Struct内多选字段，支持聚合计算
			// 【目标字段】为 FormexampleStructMultiSelectReq.UserProfile.Relationship 提供关系类型多选数据
			var configs []FormexampleConfig
			db := ctx.MustGetOrInitDB()

			if req.IsByFiledValues() {
				// 多值查询：使用 IN 查询，这里必须用 db = db.Where
				db = db.Where("value in ?", req.GetFiledValues())
			} else if req.IsByFiledValue() {
				// 单值查询：使用等值查询，性能最优
				db = db.Where("value = ?", req.GetFiledValue()).Limit(1)
			} else {
				// 模糊查询：关键字搜索
				db = db.Where("type = ? AND (label LIKE ? OR value LIKE ?)", "relationship", "%"+req.Keyword()+"%", "%"+req.Keyword()+"%").
					Limit(20)
			}
			db.Find(&configs)

			items := make([]*usercall.InputFuzzyItem, 0)
			for _, c := range configs {
				items = append(items, &usercall.InputFuzzyItem{
					Value: c.Value,
					Label: fmt.Sprintf("%s - %s", c.Label, c.Description),
					DisplayInfo: map[string]interface{}{
						"关系名称": c.Label,
						"关系值":  c.Value,
						"描述":   c.Description,
					},
				})
			}

			return &usercall.OnInputFuzzyResp{
				Statistics: map[string]interface{}{
					// ✅ 多选场景：支持聚合计算
					"选择数量": "count(关系类型)",
					"推荐活动": "根据关系推荐相应活动",
					"优惠政策": "多选享更多优惠",
				},
				Values: items,
			}, nil
		},

		"preferences": func(ctx *runner.Context, req *usercall.OnInputFuzzyReq) (*usercall.OnInputFuzzyResp, error) {
			// 【当前场景】preferences是Struct内多选字段，支持聚合计算
			// 【目标字段】为 FormexampleStructMultiSelectReq.UserProfile.Preferences 提供偏好设置多选数据
			var configs []FormexampleConfig
			db := ctx.MustGetOrInitDB()

			if req.IsByFiledValues() {
				// 多值查询：使用 IN 查询，这里必须用 db = db.Where
				db = db.Where("value in ?", req.GetFiledValues())
			} else if req.IsByFiledValue() {
				// 单值查询：使用等值查询，性能最优
				db = db.Where("value = ?", req.GetFiledValue()).Limit(1)
			} else {
				// 模糊查询：关键字搜索
				db = db.Where("type = ? AND (label LIKE ? OR value LIKE ?)", "preference", "%"+req.Keyword()+"%", "%"+req.Keyword()+"%").
					Limit(20)
			}
			db.Find(&configs)

			items := make([]*usercall.InputFuzzyItem, 0)
			for _, c := range configs {
				items = append(items, &usercall.InputFuzzyItem{
					Value: c.Value,
					Label: fmt.Sprintf("%s - %s", c.Label, c.Description),
					DisplayInfo: map[string]interface{}{
						"偏好名称": c.Label,
						"偏好值":  c.Value,
						"描述":   c.Description,
					},
				})
			}

			return &usercall.OnInputFuzzyResp{
				Statistics: map[string]interface{}{
					// ✅ 多选场景：支持聚合计算
					"选择数量": "count(偏好设置)",
					"推荐内容": "根据偏好推荐相关内容",
					"个性化":  "多选提升个性化体验",
				},
				Values: items,
			}, nil
		},

		"recommended_products": func(ctx *runner.Context, req *usercall.OnInputFuzzyReq) (*usercall.OnInputFuzzyResp, error) {
			// 【当前场景】recommended_products是Struct内多选字段，支持聚合计算
			// 【目标字段】为 FormexampleStructMultiSelectReq.UserProfile.RecommendedProducts 提供推荐商品多选数据
			var products []FormexampleProduct
			db := ctx.MustGetOrInitDB()

			if req.IsByFiledValues() {
				// 多值查询：使用 IN 查询，这里必须用 db = db.Where
				db = db.Where("id in ?", req.GetFiledValues())
			} else if req.IsByFiledValue() {
				// 单值查询：使用等值查询，性能最优
				db = db.Where("id = ?", req.GetFiledValue()).Limit(1)
			} else {
				// 模糊查询：关键字搜索
				db = db.Where("name LIKE ? OR category LIKE ?", "%"+req.Keyword()+"%", "%"+req.Keyword()+"%").
					Where("status = ?", "上架").
					Where("stock > ?", 0).
					Limit(20)
			}
			db.Find(&products)

			items := make([]*usercall.InputFuzzyItem, 0)
			for _, p := range products {
				items = append(items, &usercall.InputFuzzyItem{
					Value: p.ID,
					Label: fmt.Sprintf("%s - ¥%.2f (库存:%d)", p.Name, p.Price, p.Stock),
					DisplayInfo: map[string]interface{}{
						"商品名称": p.Name,
						"价格":   p.Price,
						"库存":   p.Stock,
						"分类":   p.Category,
					},
				})
			}

			return &usercall.OnInputFuzzyResp{
				Statistics: map[string]interface{}{
					// ✅ 多选场景：支持聚合计算
					"推荐商品数": "count(价格)",
					"总价值":   "sum(价格)",
					"平均价格":  "avg(价格)",
					"价格区间":  "min(价格) - max(价格)",

					// ✅ 静态信息
					"推荐理由": "基于用户画像智能推荐",
				},
				Values: items,
			}, nil
		},
	},
}

// ================ 演示函数6：List内多选字段聚合计算 ================

// FormexampleListMultiSelectReq List内多选字段聚合演示请求
type FormexampleListMultiSelectReq struct {
	// 商品多选列表（List组件，每行可以选择多个商品）
	ProductMultiSelectItems []FormexampleProductMultiSelect `json:"product_multi_select_items" runner:"name:商品多选清单" widget:"type:list" validate:"required,min=1"`
	// 备注信息
	Remarks string `json:"remarks" runner:"name:备注" widget:"type:input;mode:text_area"`
}

// FormexampleProductMultiSelect 商品多选结构体
type FormexampleProductMultiSelect struct {
	ProductIDs []int `json:"product_ids" runner:"name:商品选择" widget:"type:multiselect" validate:"required,min=1"`
	Quantity   int   `json:"quantity" runner:"name:数量" widget:"type:number;min:1" data:"example:1;default_value:1" validate:"required,min=1"`
}

// FormexampleListMultiSelectResp List内多选字段聚合演示响应
type FormexampleListMultiSelectResp struct {
	// 计算结果 - 放在第一位，用户第一时间看到
	TotalAmount    float64 `json:"total_amount" runner:"name:商品总额" widget:"type:number;precision:2"`
	DiscountAmount float64 `json:"discount_amount" runner:"name:折扣金额" widget:"type:number;precision:2"`
	FinalAmount    float64 `json:"final_amount" runner:"name:实付金额" widget:"type:number;precision:2"`
	ProductCount   int     `json:"product_count" runner:"name:商品种类" widget:"type:number"`
	TotalQuantity  int     `json:"total_quantity" runner:"name:商品总数" widget:"type:number"`
	// 商品清单
	ProductList []FormexampleCartItem `json:"product_list" runner:"name:商品清单" widget:"type:list"`
	// 处理结果
	Message string `json:"message" runner:"name:处理结果" widget:"type:input;mode:text_area"`
}

// FormexampleListMultiSelect List内多选字段聚合演示处理函数
func FormexampleListMultiSelect(ctx *runner.Context, req *FormexampleListMultiSelectReq, resp response.Response) error {
	db := ctx.MustGetOrInitDB()

	// 验证商品多选清单
	if len(req.ProductMultiSelectItems) == 0 {
		return resp.Form(&FormexampleListMultiSelectResp{
			Message: "请选择商品",
		}).Build()
	}

	// 获取商品信息并验证
	var totalAmount float64
	productList := make([]FormexampleCartItem, 0)

	for _, pms := range req.ProductMultiSelectItems {
		// 验证商品选择
		if len(pms.ProductIDs) == 0 {
			return resp.Form(&FormexampleListMultiSelectResp{
				Message: "每行至少选择一个商品",
			}).Build()
		}

		// 获取商品信息
		var products []FormexampleProduct
		if err := db.Where("id IN ?", pms.ProductIDs).Find(&products).Error; err != nil {
			return resp.Form(&FormexampleListMultiSelectResp{
				Message: "查询商品失败",
			}).Build()
		}

		if len(products) != len(pms.ProductIDs) {
			return resp.Form(&FormexampleListMultiSelectResp{
				Message: "部分商品不存在",
			}).Build()
		}

		// 构建商品清单
		for _, product := range products {
			// 检查库存
			if product.Stock < pms.Quantity {
				return resp.Form(&FormexampleListMultiSelectResp{
					Message: fmt.Sprintf("商品 %s 库存不足，需要 %d，库存 %d", product.Name, pms.Quantity, product.Stock),
				}).Build()
			}

			// 计算小计
			itemTotal := product.Price * float64(pms.Quantity)
			item := FormexampleCartItem{
				ProductID:   product.ID,
				ProductName: product.Name,
				Price:       product.Price,
				Quantity:    pms.Quantity,
				TotalPrice:  itemTotal,
			}
			productList = append(productList, item)
			totalAmount += itemTotal
		}
	}

	// 计算会员折扣（9折）
	discountAmount := totalAmount * 0.1
	finalAmount := totalAmount - discountAmount

	// 计算统计信息
	productCount := len(productList)
	totalQuantity := 0
	for _, item := range productList {
		totalQuantity += item.Quantity
	}

	return resp.Form(&FormexampleListMultiSelectResp{
		ProductList:    productList,
		TotalAmount:    totalAmount,
		DiscountAmount: discountAmount,
		FinalAmount:    finalAmount,
		ProductCount:   productCount,
		TotalQuantity:  totalQuantity,
		Message:        "处理成功！",
	}).Build()
}

// FormexampleListMultiSelectOption List内多选字段聚合演示配置
var FormexampleListMultiSelectOption = &runner.FormFunctionOptions{
	BaseConfig: runner.BaseConfig{
		EnglishName:  "formexample_list_multi_select",
		ChineseName:  "List内多选字段聚合演示",
		ApiDesc:      "List组件内多选字段的聚合计算演示，支持每行多选商品、数量输入、实时价格计算",
		Tags:         []string{"聚合计算", "List组件", "多选字段"},
		Request:      &FormexampleListMultiSelectReq{},
		Response:     &FormexampleListMultiSelectResp{},
		CreateTables: []interface{}{&FormexampleProduct{}, &FormexampleConfig{}},
		Group:        FormexampleGroup,
	},

	// 【框架说明】OnApiCreated 在API创建时初始化数据库数据
	// 触发时机：API首次创建时    用途：初始化商品数据
	OnApiCreated: func(ctx *runner.Context, req *usercall.OnApiCreatedReq) error {
		db := ctx.MustGetOrInitDB()

		// 初始化联想产品数据
		lenovoProducts := []FormexampleProduct{
			{Name: "联想ThinkPad X1 Carbon", Price: 12999.00, Stock: 50, Category: "电子产品", Description: "商务笔记本电脑，轻薄便携，性能强劲", Status: "上架"},
			{Name: "联想拯救者Y7000P", Price: 8999.00, Stock: 30, Category: "电子产品", Description: "游戏笔记本电脑，RTX显卡，高刷新率屏幕", Status: "上架"},
			{Name: "联想小新Air 14", Price: 4999.00, Stock: 80, Category: "电子产品", Description: "轻薄本，适合办公学习，性价比高", Status: "上架"},
			{Name: "联想ThinkPad E15", Price: 5999.00, Stock: 60, Category: "电子产品", Description: "商务本，15.6英寸大屏，接口丰富", Status: "上架"},
			{Name: "联想拯救者R7000", Price: 6999.00, Stock: 40, Category: "电子产品", Description: "游戏本，AMD处理器，独立显卡", Status: "上架"},
			{Name: "联想小新Pro 16", Price: 6999.00, Stock: 35, Category: "电子产品", Description: "创作本，16英寸2.5K屏幕，适合设计", Status: "上架"},
			{Name: "联想ThinkBook 14", Price: 4599.00, Stock: 70, Category: "电子产品", Description: "商务本，14英寸，轻薄便携", Status: "上架"},
			{Name: "联想拯救者Y9000P", Price: 11999.00, Stock: 25, Category: "电子产品", Description: "高端游戏本，RTX3070显卡，2K屏幕", Status: "上架"},
			{Name: "联想小新Air 15", Price: 5299.00, Stock: 45, Category: "电子产品", Description: "大屏轻薄本，15.6英寸，数字小键盘", Status: "上架"},
			{Name: "联想ThinkPad T14", Price: 8999.00, Stock: 20, Category: "电子产品", Description: "专业商务本，军工级品质，稳定可靠", Status: "上架"},
		}

		// 初始化其他品牌产品数据
		otherProducts := []FormexampleProduct{
			{Name: "苹果MacBook Pro 14", Price: 14999.00, Stock: 15, Category: "电子产品", Description: "苹果笔记本电脑，M2芯片，专业创作", Status: "上架"},
			{Name: "华为MateBook X Pro", Price: 9999.00, Stock: 25, Category: "电子产品", Description: "华为旗舰笔记本，3K触控屏，轻薄设计", Status: "上架"},
			{Name: "戴尔XPS 13", Price: 8999.00, Stock: 30, Category: "电子产品", Description: "戴尔超极本，13.4英寸，4K屏幕", Status: "上架"},
			{Name: "华硕ROG幻16", Price: 12999.00, Stock: 20, Category: "电子产品", Description: "华硕游戏本，RTX显卡，高刷新率", Status: "上架"},
			{Name: "小米笔记本Pro 15", Price: 5999.00, Stock: 40, Category: "电子产品", Description: "小米笔记本，3.5K屏幕，性价比高", Status: "上架"},
		}

		allProducts := append(lenovoProducts, otherProducts...)

		for _, product := range allProducts {
			var existing FormexampleProduct
			if err := db.Where("name = ?", product.Name).First(&existing).Error; err != nil {
				if err := db.Create(&product).Error; err != nil {
					ctx.Logger.Errorf("创建商品数据失败: %v", err)
				}
			}
		}

		return nil
	},

	// 【框架说明】OnInputFuzzyMap 为请求结构体字段提供模糊搜索数据
	// 触发时机：用户输入时    数据去向：挂载到对应的请求字段
	OnInputFuzzyMap: map[string]runner.OnInputFuzzy{
		"product_ids": func(ctx *runner.Context, req *usercall.OnInputFuzzyReq) (*usercall.OnInputFuzzyResp, error) {
			// 【当前场景】product_ids是List内多选字段，支持聚合计算
			// 【目标字段】为 FormexampleListMultiSelectReq.ProductMultiSelectItems[].ProductIDs 提供商品多选数据
			var products []FormexampleProduct
			db := ctx.MustGetOrInitDB()

			if req.IsByFiledValues() {
				// 多值查询：使用 IN 查询，这里必须用 db = db.Where
				db = db.Where("id in ?", req.GetFiledValues())
			} else if req.IsByFiledValue() {
				// 单值查询：使用等值查询，性能最优
				db = db.Where("id = ?", req.GetFiledValue()).Limit(1)
			} else {
				// 模糊查询：关键字搜索
				db = db.Where("name LIKE ? OR category LIKE ?", "%"+req.Keyword()+"%", "%"+req.Keyword()+"%").
					Where("status = ?", "上架").
					Where("stock > ?", 0).
					Limit(20)
			}
			db.Find(&products)

			items := make([]*usercall.InputFuzzyItem, 0)
			for _, p := range products {
				items = append(items, &usercall.InputFuzzyItem{
					Value: p.ID,
					Label: fmt.Sprintf("%s - ¥%.2f (库存:%d)", p.Name, p.Price, p.Stock),
					DisplayInfo: map[string]interface{}{
						"商品名称": p.Name,
						"价格":   p.Price,
						"库存":   p.Stock,
						"分类":   p.Category,
					},
				})
			}

			return &usercall.OnInputFuzzyResp{
				Statistics: map[string]interface{}{
					// ✅ List内多选场景：支持聚合计算
					"选中商品数":  "count(价格)",         // 选了几个商品
					"选中商品总价": "sum(价格,*quantity)", // 总价格
					"最低单价":   "min(价格)",           // 选中商品中最便宜的
					"平均单价":   "avg(价格)",           // 选中商品平均价格
					"商品总数":   "sum(quantity)",     // 商品总数量

					// ✅ 有用的静态信息
					"会员折扣": "9折优惠",
					"配送说明": "满99元包邮",
				},
				Values: items,
			}, nil
		},
	},
}

// ================ API注册 ================
func init() {
	// 注册所有演示函数
	runner.Post(RouterGroup+"/formexample_list_single_select", FormexampleListSingleSelect, FormexampleListSingleSelectOption)
	runner.Post(RouterGroup+"/formexample_multi_select", FormexampleMultiSelect, FormexampleMultiSelectOption)
	runner.Post(RouterGroup+"/formexample_single_select", FormexampleSingleSelect, FormexampleSingleSelectOption)
	runner.Post(RouterGroup+"/formexample_struct_single_select", FormexampleStructSingleSelect, FormexampleStructSingleSelectOption)
	runner.Post(RouterGroup+"/formexample_struct_multi_select", FormexampleStructMultiSelect, FormexampleStructMultiSelectOption)
	runner.Post(RouterGroup+"/formexample_list_multi_select", FormexampleListMultiSelect, FormexampleListMultiSelectOption)
}

```
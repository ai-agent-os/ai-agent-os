# è¡¨å•å€¼æå–é€»è¾‘åˆ†ææŠ¥å‘Š

## ä¸€ã€é—®é¢˜ç°è±¡

ç”¨æˆ·åé¦ˆï¼šæäº¤ form ç±»å‹å­—æ®µæ—¶ï¼Œæäº¤çš„æ•°æ®ä¸ºç©º `{}`ã€‚

ç¤ºä¾‹æ•°æ®ç»“æ„ï¼š
```json
{
  "business_info": {  // form ç±»å‹å­—æ®µ
    "industry": "äº’è”ç½‘",
    "scale": "1-50äºº",
    "description": "...",
    "keywords": ["AI", "å¤§æ•°æ®"],
    "products": [  // table ç±»å‹å­—æ®µï¼ˆåµŒå¥—åœ¨ form ä¸­ï¼‰
      {
        "product_name": "äº§å“1",
        "category": "è½¯ä»¶äº§å“",
        "features": ["é«˜æ€§èƒ½", "æ˜“ç”¨æ€§"]
      }
    ]
  }
}
```

## äºŒã€å½“å‰å®ç°åˆ†æ

### 2.1 ç°æœ‰çš„å€¼æå–å®ç°

ç³»ç»Ÿä¸­æœ‰**ä¸‰ä¸ª**åœ°æ–¹å®ç°äº†å€¼æå–é€»è¾‘ï¼š

#### å®ç° 1ï¼š`useFormDataStore().getSubmitData()` âœ… æ­£ç¡®
**ä½ç½®**ï¼š`web/src/core/stores-v2/formData.ts`

```typescript
function getSubmitData(fields: FieldConfig[], basePath: string = ''): Record<string, any> {
  const result: Record<string, any> = {}
  
  fields.forEach(field => {
    const fieldPath = basePath ? `${basePath}.${field.code}` : field.code
    
    // ğŸ”¥ ä½¿ç”¨æå–å™¨æ³¨å†Œè¡¨æå–å­—æ®µå€¼ï¼ˆé€’å½’ï¼‰
    const extractedValue = extractorRegistry.extractField(field, fieldPath, (path: string) => {
      return data.get(path)
    })
    
    if (extractedValue !== undefined) {
      result[field.code] = extractedValue
    } else if (field.widget?.type === 'form') {
      result[field.code] = {}
    } else if (field.widget?.type === 'table') {
      result[field.code] = []
    }
  })
  
  return result
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… ä½¿ç”¨ `FieldExtractorRegistry` è¿›è¡Œé€’å½’æå–
- âœ… éµå¾ª**ç­–ç•¥æ¨¡å¼**å’Œ**ä¾èµ–å€’ç½®åŸåˆ™**
- âœ… æ”¯æŒä»»æ„åµŒå¥—ç»“æ„ï¼ˆform åµŒå¥— tableï¼Œtable åµŒå¥— form ç­‰ï¼‰
- âœ… å…·å¤‡è‰¯å¥½çš„æ‰©å±•æ€§

#### å®ç° 2ï¼š`FormStateManager.getSubmitData()` âœ… æ­£ç¡®
**ä½ç½®**ï¼š`web/src/architecture/infrastructure/stateManager/FormStateManager.ts`

```typescript
getSubmitData(fields: any[]): Record<string, any> {
  return this.formStore.getSubmitData(fields)
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… å§”æ‰˜ç»™ `useFormDataStore().getSubmitData()`
- âœ… éµå¾ª**ä¾èµ–å€’ç½®åŸåˆ™**
- âœ… æ­£ç¡®çš„å®ç°

#### å®ç° 3ï¼š`FormDomainService.getSubmitData()` âŒ é”™è¯¯
**ä½ç½®**ï¼š`web/src/architecture/domain/services/FormDomainService.ts`

```typescript
getSubmitData(fields: FieldConfig[]): Record<string, any> {
  const state = this.stateManager.getState()
  const result: Record<string, any> = {}
  
  fields.forEach(field => {
    const value = state.data.get(field.code)
    if (value) {
      result[field.code] = value.raw  // âŒ ç›´æ¥è¿”å› rawï¼Œæ²¡æœ‰é€’å½’æå–
    }
  })
  
  return result
}
```

**é—®é¢˜**ï¼š
- âŒ **æ²¡æœ‰ä½¿ç”¨ `FieldExtractorRegistry`**ï¼Œåªæ˜¯ç®€å•åœ°å– `value.raw`
- âŒ å¯¹äº form/table ç±»å‹å­—æ®µï¼Œ`value.raw` æ˜¯ä¸€ä¸ªå¯¹è±¡/æ•°ç»„ï¼Œä½†**æ²¡æœ‰é€’å½’æå–å­å­—æ®µçš„å€¼**
- âŒ è¿å**å¼€é—­åŸåˆ™**ï¼šæ— æ³•æ‰©å±•æ–°çš„å­—æ®µç±»å‹
- âŒ è¿å**å•ä¸€èŒè´£åŸåˆ™**ï¼šDomain Service ä¸åº”è¯¥çŸ¥é“å¦‚ä½•æå–å€¼
- âŒ è¿å**ä¾èµ–å€’ç½®åŸåˆ™**ï¼šDomain Service åº”è¯¥å§”æ‰˜ç»™ StateManagerï¼Œè€Œä¸æ˜¯è‡ªå·±å®ç°

### 2.2 è°ƒç”¨é“¾è·¯

å½“å‰çš„è°ƒç”¨é“¾è·¯ï¼š

```
FormView.vue (submitForm)
  â†“
FormApplicationService.submitForm()
  â†“
FormApplicationService.getSubmitData(fields)  // ç§æœ‰æ–¹æ³•
  â†“
FormDomainService.getSubmitData(fields)  âŒ è°ƒç”¨äº†é”™è¯¯çš„å®ç°
  â†“
ç›´æ¥ä» stateManager.getState().data ä¸­å– value.raw
```

**åº”è¯¥çš„è°ƒç”¨é“¾è·¯**ï¼š

```
FormView.vue (submitForm)
  â†“
FormApplicationService.submitForm()
  â†“
FormApplicationService.getSubmitData(fields)
  â†“
FormDomainService.getSubmitData(fields)
  â†“
FormStateManager.getSubmitData(fields)  âœ… å§”æ‰˜ç»™ StateManager
  â†“
useFormDataStore().getSubmitData(fields)  âœ… ä½¿ç”¨ FieldExtractorRegistry
  â†“
FieldExtractorRegistry.extractField()  âœ… é€’å½’æå–
```

## ä¸‰ã€æ¶æ„è®¾è®¡é—®é¢˜

### 3.1 è¿åä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰

**é—®é¢˜**ï¼š`FormDomainService.getSubmitData()` ç›´æ¥å®ç°äº†å€¼æå–é€»è¾‘ï¼Œæ²¡æœ‰å§”æ‰˜ç»™ `StateManager`ã€‚

**åº”è¯¥**ï¼šDomain Service åº”è¯¥ä¾èµ–æŠ½è±¡ï¼ˆIStateManagerï¼‰ï¼Œè€Œä¸æ˜¯è‡ªå·±å®ç°æå–é€»è¾‘ã€‚

```typescript
// âŒ é”™è¯¯ï¼šDomain Service è‡ªå·±å®ç°æå–é€»è¾‘
getSubmitData(fields: FieldConfig[]): Record<string, any> {
  const state = this.stateManager.getState()
  const result: Record<string, any> = {}
  fields.forEach(field => {
    const value = state.data.get(field.code)
    if (value) {
      result[field.code] = value.raw  // è‡ªå·±å®ç°
    }
  })
  return result
}

// âœ… æ­£ç¡®ï¼šDomain Service å§”æ‰˜ç»™ StateManager
getSubmitData(fields: FieldConfig[]): Record<string, any> {
  const stateManager = this.stateManager as any
  if (stateManager && typeof stateManager.getSubmitData === 'function') {
    return stateManager.getSubmitData(fields)  // å§”æ‰˜ç»™ StateManager
  }
  return {}
}
```

### 3.2 è¿åå¼€é—­åŸåˆ™ï¼ˆOCPï¼‰

**é—®é¢˜**ï¼šå½“å‰å®ç°æ— æ³•æ‰©å±•æ–°çš„å­—æ®µç±»å‹ï¼Œå¦‚æœæ–°å¢å­—æ®µç±»å‹ï¼Œéœ€è¦ä¿®æ”¹ `FormDomainService.getSubmitData()` çš„ä»£ç ã€‚

**åº”è¯¥**ï¼šä½¿ç”¨ç­–ç•¥æ¨¡å¼ï¼ˆFieldExtractorRegistryï¼‰ï¼Œæ–°å¢å­—æ®µç±»å‹æ—¶åªéœ€æ³¨å†Œæ–°çš„æå–å™¨ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç ã€‚

```typescript
// âŒ é”™è¯¯ï¼šæ–°å¢å­—æ®µç±»å‹éœ€è¦ä¿®æ”¹è¿™é‡Œçš„ä»£ç 
getSubmitData(fields: FieldConfig[]): Record<string, any> {
  fields.forEach(field => {
    if (field.widget?.type === 'form') {
      // å¤„ç† form
    } else if (field.widget?.type === 'table') {
      // å¤„ç† table
    } else if (field.widget?.type === 'multiselect') {
      // å¤„ç† multiselect
    } else if (field.widget?.type === 'newtype') {  // æ–°å¢ç±»å‹
      // éœ€è¦ä¿®æ”¹è¿™é‡Œï¼è¿å OCP
    }
  })
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ç­–ç•¥æ¨¡å¼
extractorRegistry.registerExtractor('newtype', new NewTypeExtractor())  // æ‰©å±•æ—¶åªéœ€æ³¨å†Œ
const extractedValue = extractorRegistry.extractField(field, fieldPath, getValue)
```

### 3.3 è¿åå•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼‰

**é—®é¢˜**ï¼š`FormDomainService` ä¸åº”è¯¥çŸ¥é“å¦‚ä½•æå–å€¼ï¼Œå®ƒçš„èŒè´£åº”è¯¥æ˜¯ç®¡ç†è¡¨å•çš„ä¸šåŠ¡é€»è¾‘ï¼ˆåˆå§‹åŒ–ã€éªŒè¯ã€æäº¤ç­‰ï¼‰ï¼Œè€Œä¸æ˜¯çŸ¥é“å¦‚ä½•æå–ä¸åŒç±»å‹å­—æ®µçš„å€¼ã€‚

**åº”è¯¥**ï¼šå€¼æå–é€»è¾‘åº”è¯¥ç”±ä¸“é—¨çš„æå–å™¨ï¼ˆFieldExtractorï¼‰è´Ÿè´£ï¼ŒDomain Service åªéœ€è¦å§”æ‰˜ã€‚

### 3.4 æ‰©å±•æ€§é—®é¢˜

**é—®é¢˜**ï¼šå½“å‰å®ç°æ— æ³•æ”¯æŒä»»æ„æ•°æ®ç»“æ„çš„æå–ï¼Œåªèƒ½å¤„ç†ç®€å•çš„ä¸€çº§å­—æ®µã€‚å¯¹äºåµŒå¥—ç»“æ„ï¼ˆform åµŒå¥— tableï¼Œtable åµŒå¥— form ç­‰ï¼‰ï¼Œæ— æ³•æ­£ç¡®æå–ã€‚

**åº”è¯¥**ï¼šä½¿ç”¨é€’å½’æå–ï¼Œæ”¯æŒä»»æ„æ·±åº¦çš„åµŒå¥—ç»“æ„ã€‚

## å››ã€è§£å†³æ–¹æ¡ˆ

### 4.1 ä¿®å¤ FormDomainService.getSubmitData()

å°† `FormDomainService.getSubmitData()` ä¿®æ”¹ä¸ºå§”æ‰˜ç»™ `FormStateManager.getSubmitData()`ï¼š

```typescript
// ä¿®æ”¹å‰
getSubmitData(fields: FieldConfig[]): Record<string, any> {
  const state = this.stateManager.getState()
  const result: Record<string, any> = {}
  
  fields.forEach(field => {
    const value = state.data.get(field.code)
    if (value) {
      result[field.code] = value.raw
    }
  })
  
  return result
}

// ä¿®æ”¹å
getSubmitData(fields: FieldConfig[]): Record<string, any> {
  const stateManager = this.stateManager as any
  if (stateManager && typeof stateManager.getSubmitData === 'function') {
    return stateManager.getSubmitData(fields)
  }
  return {}
}
```

### 4.2 ç¡®ä¿ FormStateManager æ­£ç¡®å®ç°

`FormStateManager.getSubmitData()` å·²ç»æ­£ç¡®å®ç°ï¼Œæ— éœ€ä¿®æ”¹ï¼š

```typescript
getSubmitData(fields: any[]): Record<string, any> {
  return this.formStore.getSubmitData(fields)
}
```

### 4.3 ç¡®ä¿ useFormDataStore æ­£ç¡®å®ç°

`useFormDataStore().getSubmitData()` å·²ç»æ­£ç¡®å®ç°ï¼Œæ— éœ€ä¿®æ”¹ã€‚

## äº”ã€æ¶æ„ä¼˜åŠ¿åˆ†æ

### 5.1 ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰âœ…

**ç°çŠ¶**ï¼šä¿®å¤åï¼Œå®Œå…¨éµå¾ª DIPã€‚

```
FormDomainService (é«˜å±‚æ¨¡å—)
  â†“ ä¾èµ–æŠ½è±¡
IStateManager (æŠ½è±¡æ¥å£)
  â†‘ å®ç°
FormStateManager (ä½å±‚æ¨¡å—)
```

- âœ… é«˜å±‚æ¨¡å—ï¼ˆFormDomainServiceï¼‰ä¾èµ–æŠ½è±¡ï¼ˆIStateManagerï¼‰
- âœ… ä½å±‚æ¨¡å—ï¼ˆFormStateManagerï¼‰å®ç°æŠ½è±¡
- âœ… é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—çš„å…·ä½“å®ç°

### 5.2 å¼€é—­åŸåˆ™ï¼ˆOCPï¼‰âœ…

**ç°çŠ¶**ï¼šä¿®å¤åï¼Œå®Œå…¨éµå¾ª OCPã€‚

- âœ… å¯¹æ‰©å±•å¼€æ”¾ï¼šæ–°å¢å­—æ®µç±»å‹åªéœ€æ³¨å†Œæ–°çš„æå–å™¨
- âœ… å¯¹ä¿®æ”¹å°é—­ï¼šæ–°å¢å­—æ®µç±»å‹ä¸éœ€è¦ä¿®æ”¹ç°æœ‰ä»£ç 

```typescript
// æ‰©å±•æ–°çš„å­—æ®µç±»å‹ï¼ˆåœ¨ FieldExtractorRegistry æ„é€ å‡½æ•°ä¸­ï¼‰
extractorRegistry.registerExtractor('custom_widget', new CustomWidgetExtractor())
```

### 5.3 å•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼‰âœ…

**ç°çŠ¶**ï¼šä¿®å¤åï¼Œå®Œå…¨éµå¾ª SRPã€‚

- âœ… `FormDomainService`ï¼šè´Ÿè´£è¡¨å•ä¸šåŠ¡é€»è¾‘ï¼ˆåˆå§‹åŒ–ã€éªŒè¯ã€æäº¤ç­‰ï¼‰
- âœ… `FormStateManager`ï¼šè´Ÿè´£çŠ¶æ€ç®¡ç†
- âœ… `useFormDataStore`ï¼šè´Ÿè´£æ•°æ®å­˜å‚¨
- âœ… `FieldExtractorRegistry`ï¼šè´Ÿè´£å€¼æå–ç­–ç•¥ç®¡ç†
- âœ… å„ç§ `FieldExtractor`ï¼šè´Ÿè´£ç‰¹å®šç±»å‹å­—æ®µçš„å€¼æå–

### 5.4 æ‰©å±•æ€§ âœ…

**ç°çŠ¶**ï¼šä¿®å¤åï¼Œå…·å¤‡æå¼ºçš„æ‰©å±•æ€§ã€‚

#### æ”¯æŒä»»æ„æ•°æ®ç»“æ„çš„æå–

- âœ… æ”¯æŒç®€å•å­—æ®µï¼ˆtext, select, number ç­‰ï¼‰
- âœ… æ”¯æŒå¤æ‚å­—æ®µï¼ˆform, table, multiselect ç­‰ï¼‰
- âœ… æ”¯æŒä»»æ„åµŒå¥—ï¼ˆform åµŒå¥— tableï¼Œtable åµŒå¥— form ç­‰ï¼‰
- âœ… æ”¯æŒä»»æ„æ·±åº¦çš„åµŒå¥—

ç¤ºä¾‹ï¼š
```typescript
// ä¸‰å±‚åµŒå¥—ï¼šform -> table -> form
{
  "business_info": {  // form
    "products": [  // table
      {
        "product_name": "äº§å“1",
        "specs": {  // form
          "cpu": "Intel i7",
          "memory": "16GB"
        }
      }
    ]
  }
}
```

#### æ”¯æŒä»»æ„ç»„ä»¶çš„æ¸²æŸ“

- âœ… ä½¿ç”¨ `WidgetComponentFactory` æ³¨å†Œç»„ä»¶
- âœ… ä½¿ç”¨ `FieldExtractorRegistry` æ³¨å†Œæå–å™¨
- âœ… æ–°å¢ç»„ä»¶æ—¶ï¼Œåªéœ€ï¼š
  1. åˆ›å»º Vue ç»„ä»¶
  2. åœ¨ `WidgetComponentFactory` ä¸­æ³¨å†Œ
  3. å¦‚æœéœ€è¦ç‰¹æ®Šæå–é€»è¾‘ï¼Œåˆ›å»ºå¹¶æ³¨å†Œ `FieldExtractor`

ç¤ºä¾‹ï¼š
```typescript
// 1. åˆ›å»ºç»„ä»¶
// CustomWidget.vue

// 2. æ³¨å†Œç»„ä»¶
widgetFactory.register('custom_widget', CustomWidget)

// 3. æ³¨å†Œæå–å™¨ï¼ˆå¦‚æœéœ€è¦ç‰¹æ®Šæå–é€»è¾‘ï¼‰
extractorRegistry.registerExtractor('custom_widget', new CustomWidgetExtractor())
```

## å…­ã€æ€»ç»“

### 6.1 é—®é¢˜æ ¹æº

`FormDomainService.getSubmitData()` æ²¡æœ‰ä½¿ç”¨ `FieldExtractorRegistry`ï¼Œå¯¼è‡´ï¼š
- âŒ form ç±»å‹å­—æ®µæ— æ³•æ­£ç¡®æå–å€¼
- âŒ è¿åä¾èµ–å€’ç½®åŸåˆ™
- âŒ è¿åå¼€é—­åŸåˆ™
- âŒ è¿åå•ä¸€èŒè´£åŸåˆ™
- âŒ ç¼ºä¹æ‰©å±•æ€§

### 6.2 è§£å†³æ–¹æ¡ˆ

ä¿®æ”¹ `FormDomainService.getSubmitData()` ä¸ºå§”æ‰˜ç»™ `FormStateManager.getSubmitData()`ï¼Œç¡®ä¿ä½¿ç”¨ `FieldExtractorRegistry` è¿›è¡Œé€’å½’æå–ã€‚

### 6.3 æ¶æ„ä¼˜åŠ¿

ä¿®å¤åï¼Œç³»ç»Ÿå®Œå…¨éµå¾ª SOLID åŸåˆ™ï¼š
- âœ… ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰
- âœ… å¼€é—­åŸåˆ™ï¼ˆOCPï¼‰
- âœ… å•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼‰
- âœ… æ”¯æŒä»»æ„æ•°æ®ç»“æ„çš„æå–
- âœ… æ”¯æŒä»»æ„ç»„ä»¶çš„æ¸²æŸ“
- âœ… å…·å¤‡æå¼ºçš„æ‰©å±•æ€§

### 6.4 ä¸‹ä¸€æ­¥

1. ä¿®å¤ `FormDomainService.getSubmitData()` å®ç°
2. æ·»åŠ æ—¥å¿—éªŒè¯ä¿®å¤æ•ˆæœ
3. æµ‹è¯• form ç±»å‹å­—æ®µæäº¤
4. æ¸…ç†è°ƒè¯•æ—¥å¿—


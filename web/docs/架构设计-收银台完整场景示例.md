# æ”¶é“¶å°å®Œæ•´åœºæ™¯ç¤ºä¾‹

## åœºæ™¯æè¿°

æ”¶é“¶å°æ˜¯ä¸€ä¸ªå…¸å‹çš„å¤æ‚åœºæ™¯ï¼Œæ¶‰åŠä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

1. **ä¼šå‘˜å¡é€‰æ‹©**ï¼šé€‰æ‹©ä¸åŒçš„ä¼šå‘˜å¡ï¼Œå•†å“ä»·æ ¼ä¸åŒ
2. **å•†å“æ¸…å•**ï¼šList ç»„ä»¶ï¼Œæ¯è¡ŒåŒ…å«å•†å“é€‰æ‹©å’Œæ•°é‡
3. **èšåˆè®¡ç®—**ï¼šå®æ—¶è®¡ç®—å•†å“æ€»ä»·ã€ä¼šå‘˜æŠ˜æ‰£ã€å®ä»˜é‡‘é¢
4. **åµŒå¥—ç»“æ„**ï¼šList å†…çš„ Selectï¼ŒSelect éœ€è¦è®¿é—®çˆ¶è¡¨å•çš„ä¼šå‘˜å¡ä¿¡æ¯

---

## æ•°æ®ç»“æ„

### åç«¯è¯·æ±‚ç»“æ„ï¼ˆGoï¼‰

```go
// æ”¶é“¶å°è¯·æ±‚
type CashierReq struct {
    MemberCardID int                `json:"member_card_id" runner:"name:ä¼šå‘˜å¡" widget:"type:select" validate:"required"`
    Products     []CashierProduct   `json:"products" runner:"name:å•†å“æ¸…å•" widget:"type:list" validate:"required,min=1"`
    Remarks      string             `json:"remarks" runner:"name:å¤‡æ³¨" widget:"type:input;mode:text_area"`
}

// å•†å“ç»“æ„
type CashierProduct struct {
    ProductID int `json:"product_id" runner:"name:å•†å“" widget:"type:select" validate:"required"`
    Quantity  int `json:"quantity" runner:"name:æ•°é‡" widget:"type:number;min:1" data:"default_value:1" validate:"required,min=1"`
}
```

### å‰ç«¯æ•°æ®ç»“æ„ï¼ˆTypeScriptï¼‰

```typescript
// FormDataManager ä¸­çš„æ•°æ®ç»“æ„
{
  member_card_id: {
    raw: 1,
    display: "ä¼šå‘˜å¡1",
    meta: {
      displayInfo: { 
        card_name: "ä¼šå‘˜å¡1", 
        discount: 0.9 
      },
      dataType: "int"
    }
  },
  products: {
    raw: [
      {
        product_id: 101,
        quantity: 2
      },
      {
        product_id: 102,
        quantity: 3
      }
    ],
    display: "2æ¡è®°å½•",
    meta: {
      dataType: "[]struct"
    }
  }
}
```

---

## å®ç°æµç¨‹

### 1. ç”¨æˆ·é€‰æ‹©ä¼šå‘˜å¡

```typescript
// MemberCardSelect Widget
const MemberCardSelect: IWidget = {
  type: 'select',
  
  render(props: WidgetRenderProps) {
    const { field, value, onChange, formManager } = props
    
    const handleOpenDialog = async () => {
      // ğŸ”¥ è·å–å½“å‰è¡¨å•çŠ¶æ€ï¼ˆæ­¤æ—¶ products å¯èƒ½ä¸ºç©ºï¼‰
      const request = formManager.prepareSubmitData()
      // { member_card_id: null, products: [] }
      
      // è°ƒç”¨å›è°ƒ
      const result = await callbackManager.executeSelectFuzzy(
        field,
        '',
        formManager
      )
      
      // æ˜¾ç¤ºä¼šå‘˜å¡é€‰é¡¹
      options.value = result.values
      // [
      //   { value: 1, label: "ä¼šå‘˜å¡1 - 9æŠ˜", displayInfo: { card_name: "ä¼šå‘˜å¡1", discount: 0.9 } },
      //   { value: 2, label: "ä¼šå‘˜å¡2 - 8æŠ˜", displayInfo: { card_name: "ä¼šå‘˜å¡2", discount: 0.8 } }
      // ]
    }
    
    const handleSelect = (option: SelectOption) => {
      // æ›´æ–°ä¼šå‘˜å¡å­—æ®µ
      onChange({
        raw: option.value,
        display: option.label,
        meta: {
          displayInfo: option.displayInfo,
          dataType: field.data.type
        }
      })
      
      // ğŸ”¥ ä¼šå‘˜å¡å˜åŒ–åï¼Œå¯èƒ½éœ€è¦æ¸…ç©ºå•†å“æ¸…å•ï¼ˆæ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼‰
      // formManager.setValue('products', [])
    }
    
    return h(ElInput, {
      modelValue: value?.display || '',
      readonly: true,
      placeholder: 'è¯·é€‰æ‹©ä¼šå‘˜å¡',
      onClick: handleOpenDialog
    })
  }
}
```

### 2. ç”¨æˆ·æ·»åŠ å•†å“ï¼ˆList å†…çš„ Selectï¼‰

```typescript
// ListWidget æ¸²æŸ“
const ListWidget: IWidget = {
  type: 'list',
  
  render(props: WidgetRenderProps) {
    const { field, value, onChange, formManager, allFields, currentFieldPath } = props
    
    const listData = ref((value?.raw as any[]) || [])
    const rowManagers = new Map<number, ReactiveFormDataManager>()
    const statistics = ref<Record<string, any>>({})
    
    // ğŸ”¥ ç›‘å¬æ‰€æœ‰è¡Œæ•°æ®å˜åŒ–ï¼Œè‡ªåŠ¨é‡æ–°è®¡ç®—ç»Ÿè®¡
    watch(
      () => getAllRowsData(),
      () => updateStatistics(),
      { deep: true }
    )
    
    const renderColumns = (subFields: FieldConfig[]) => {
      return subFields.map(subField =>
        h(ElTableColumn, {
          label: subField.name,
          prop: subField.code
        }, {
          default: ({ row, $index }) => {
            // ğŸ”¥ è·å–æˆ–åˆ›å»ºè¡Œçš„ FormDataManager
            const rowManager = getOrCreateRowManager($index, row, subFields)
            
            // æ¸²æŸ“å­å­—æ®µçš„ Widget
            return widgetFactory.create(subField, {
              field: subField,
              value: rowManager.getValue(subField.code),
              onChange: (newValue: FieldValue) => {
                rowManager.setValue(subField.code, newValue)
                syncRowToList(row, rowManager)
              },
              
              // ========== ğŸ”¥ æ ¸å¿ƒï¼šä¼ é€’å…¨å±€è®¿é—®èƒ½åŠ› ==========
              allFields: allFields,  // æ•´ä¸ªå‡½æ•°çš„å­—æ®µç»“æ„
              currentFieldPath: `${currentFieldPath}.products[${$index}].${subField.code}`,
              
              // è¡Œçº§åˆ«çš„æ•°æ®ç®¡ç†å™¨
              formManager: rowManager,
              getFieldValue: (code) => rowManager.getValue(code),
              updateField: (code, value) => rowManager.setValue(code, value),
              
              // ğŸ”¥ çˆ¶è¡¨å•è®¿é—®ï¼ˆè®© product_id å¯ä»¥è®¿é—® member_card_idï¼‰
              parentFormManager: formManager,
              getParentFieldValue: (code) => formManager.getValue(code)
            })
          }
        })
      )
    }
    
    const getOrCreateRowManager = (index: number, row: any, subFields: FieldConfig[]) => {
      if (!rowManagers.has(index)) {
        const rowManager = new ReactiveFormDataManager()
        
        // åˆå§‹åŒ–å­—æ®µé…ç½®
        for (const subField of subFields) {
          rowManager.registerField(subField)
        }
        
        // åˆå§‹åŒ–è¡Œæ•°æ®
        for (const [key, value] of Object.entries(row)) {
          rowManager.setValue(key, value, true)
        }
        
        rowManagers.set(index, rowManager)
      }
      
      return rowManagers.get(index)!
    }
    
    const getAllRowsData = () => {
      const allData: any[] = []
      
      for (const [index, rowManager] of rowManagers) {
        const row: Record<string, any> = {}
        
        for (const [code, fieldValue] of rowManager.store) {
          // ğŸ”¥ åŸºç¡€å€¼
          row[code] = fieldValue.raw
          
          // ğŸ”¥ displayInfo ä¸­çš„å€¼ï¼ˆå¦‚ä»·æ ¼ï¼‰
          if (fieldValue.meta?.displayInfo) {
            for (const [key, value] of Object.entries(fieldValue.meta.displayInfo)) {
              row[key] = value
            }
          }
        }
        
        allData.push(row)
      }
      
      return allData
    }
    
    const updateStatistics = () => {
      // ğŸ”¥ ä»å›è°ƒå“åº”ä¸­è·å–çš„èšåˆè¡¨è¾¾å¼é…ç½®
      const config = this.statisticsConfig || {}
      // {
      //   "å•†å“åŸä»·(å…ƒ)": "sum(ä»·æ ¼,*quantity)",
      //   "ä¼šå‘˜ä»·æ ¼(å…ƒ)": "sum(ä»·æ ¼,*quantity,*0.9)",
      // }
      
      const result: Record<string, any> = {}
      
      for (const [label, expression] of Object.entries(config)) {
        result[label] = parser.evaluate(expression, getAllRowsData())
      }
      
      statistics.value = result
    }
    
    return h('div', [
      // è¡¨æ ¼
      h(ElTable, { data: listData.value }, {
        default: () => renderColumns(field.sub_fields || [])
      }),
      
      // ğŸ”¥ ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤º
      h('div', { class: 'list-statistics' },
        Object.entries(statistics.value).map(([label, value]) =>
          h('div', { class: 'stat-item' }, [
            h('span', { class: 'stat-label' }, label + ':'),
            h('span', { class: 'stat-value' }, value)
          ])
        )
      )
    ])
  }
}
```

### 3. å•†å“ Select çš„å›è°ƒï¼ˆè®¿é—®çˆ¶è¡¨å•çš„ä¼šå‘˜å¡ï¼‰

```typescript
// ProductSelect Widget (List å†…çš„ Select)
const ProductSelect: IWidget = {
  type: 'select',
  
  render(props: WidgetRenderProps) {
    const {
      field,
      value,
      onChange,
      formManager,           // ğŸ”¥ è¡Œçº§åˆ«çš„ FormDataManager
      parentFormManager,     // ğŸ”¥ çˆ¶è¡¨å•çš„ FormDataManager
      allFields,
      currentFieldPath
    } = props
    
    const handleOpenDialog = async () => {
      // ğŸ”¥ æ ¸å¿ƒï¼šè·å–å®Œæ•´çš„è¡¨å•çŠ¶æ€ï¼ˆåŒ…æ‹¬çˆ¶è¡¨å•çš„ä¼šå‘˜å¡ï¼‰
      const parentData = parentFormManager ? parentFormManager.prepareSubmitData() : {}
      const rowData = formManager.getAllRawValues()
      
      console.log('å•†å“é€‰æ‹©å›è°ƒä¸Šä¸‹æ–‡:', {
        member_card_id: parentData.member_card_id,  // ğŸ”¥ æ¥è‡ªçˆ¶è¡¨å•
        quantity: rowData.quantity,                  // ğŸ”¥ æ¥è‡ªå½“å‰è¡Œ
        currentFieldPath: currentFieldPath           // products[0].product_id
      })
      
      // è°ƒç”¨å›è°ƒï¼Œä¼ é€’çˆ¶è¡¨å•çš„ FormDataManager
      // CallbackManager ä¼šè‡ªåŠ¨æå– parentFormManager.prepareSubmitData()
      const result = await callbackManager.executeSelectFuzzy(
        field,
        '',
        parentFormManager || formManager
      )
      
      // åç«¯æ ¹æ® member_card_id è¿”å›ä¸åŒçš„å•†å“ä»·æ ¼
      options.value = result.values
      // [
      //   {
      //     value: 101,
      //     label: "å•†å“A - Â¥4.5",  // ä¼šå‘˜ä»·ï¼ˆåŸä»·5.0 * 0.9ï¼‰
      //     displayInfo: {
      //       å•†å“åç§°: "å•†å“A",
      //       ä»·æ ¼: 4.5,        // ğŸ”¥ ä¼šå‘˜ä»·
      //       åŸä»·: 5.0,
      //       åº“å­˜: 100
      //     }
      //   }
      // ]
      
      // ğŸ”¥ ä¿å­˜èšåˆè¡¨è¾¾å¼é…ç½®åˆ° ListWidget
      if (result.statistics) {
        // é€šçŸ¥ ListWidget ä¿å­˜ç»Ÿè®¡é…ç½®
        // ListWidget ä¼šåœ¨ watch ä¸­è‡ªåŠ¨è®¡ç®—
        saveStatisticsConfig(result.statistics)
      }
    }
    
    const handleSelect = (option: SelectOption) => {
      // æ›´æ–°å½“å‰å­—æ®µå€¼
      onChange({
        raw: option.value,
        display: option.label,
        meta: {
          displayInfo: option.displayInfo,  // ğŸ”¥ åŒ…å«ä»·æ ¼ç­‰ä¿¡æ¯
          dataType: field.data.type,
          fromCallback: true
        }
      })
      
      // ğŸ”¥ ListWidget çš„ watch ä¼šè‡ªåŠ¨è§¦å‘ç»Ÿè®¡é‡æ–°è®¡ç®—
    }
    
    return h(ElInput, {
      modelValue: value?.display || '',
      readonly: true,
      placeholder: 'è¯·é€‰æ‹©å•†å“',
      onClick: handleOpenDialog
    })
  }
}
```

### 4. åç«¯å›è°ƒå®ç°ï¼ˆæ ¹æ®ä¼šå‘˜å¡è¿”å›ä¸åŒä»·æ ¼ï¼‰

```go
// OnSelectFuzzy å›è°ƒå®ç°
func ProductOnSelectFuzzy(ctx *runner.Context, req *usercall.OnInputFuzzyReq) (*usercall.OnInputFuzzyResp, error) {
    db := ctx.MustGetOrInitDB()
    
    // ğŸ”¥ æ ¸å¿ƒï¼šä» request ä¸­è·å–ä¼šå‘˜å¡ä¿¡æ¯
    memberCardID := req.Request["member_card_id"]
    
    ctx.Logger.Infof("å•†å“é€‰æ‹©å›è°ƒï¼Œä¼šå‘˜å¡ID: %v", memberCardID)
    
    // æŸ¥è¯¢å•†å“
    var products []Product
    db.Where("status = ?", "ä¸Šæ¶").Limit(20).Find(&products)
    
    // ğŸ”¥ æ ¹æ®ä¼šå‘˜å¡è®¡ç®—ä»·æ ¼
    var discount float64 = 1.0  // é»˜è®¤åŸä»·
    
    if memberCardID == 1 {
        discount = 0.9  // ä¼šå‘˜å¡1ï¼š9æŠ˜
    } else if memberCardID == 2 {
        discount = 0.8  // ä¼šå‘˜å¡2ï¼š8æŠ˜
    }
    
    // æ„å»ºè¿”å›ç»“æœ
    items := make([]*usercall.InputFuzzyItem, 0)
    for _, p := range products {
        memberPrice := p.Price * discount
        
        items = append(items, &usercall.InputFuzzyItem{
            Value: p.ID,
            Label: fmt.Sprintf("%s - Â¥%.2f", p.Name, memberPrice),
            DisplayInfo: map[string]interface{}{
                "å•†å“åç§°": p.Name,
                "ä»·æ ¼":   memberPrice,  // ğŸ”¥ ä¼šå‘˜ä»·
                "åŸä»·":   p.Price,      // åŸä»·
                "åº“å­˜":   p.Stock,
                "åˆ†ç±»":   p.Category,
            },
        })
    }
    
    return &usercall.OnInputFuzzyResp{
        Values: items,
        Statistics: map[string]interface{}{
            // ğŸ”¥ èšåˆè¡¨è¾¾å¼é…ç½®
            "å•†å“åŸä»·(å…ƒ)": "sum(åŸä»·,*quantity)",
            "ä¼šå‘˜ä»·æ ¼(å…ƒ)": "sum(ä»·æ ¼,*quantity)",
            "ä¼˜æƒ é‡‘é¢(å…ƒ)": "sum(åŸä»·,*quantity) - sum(ä»·æ ¼,*quantity)",
            "å•†å“ç§ç±»":    "count(ä»·æ ¼)",
            "å•†å“æ€»æ•°":    "sum(quantity)",
        },
    }, nil
}
```

---

## æ•°æ®æµå®Œæ•´ç¤ºæ„å›¾

```
1. ç”¨æˆ·é€‰æ‹©ä¼šå‘˜å¡1
   â†“
   FormDataManager: { member_card_id: 1 }

2. ç”¨æˆ·æ·»åŠ å•†å“ï¼Œç‚¹å‡»ç¬¬ä¸€è¡Œçš„å•†å“é€‰æ‹©æ¡†
   â†“
   SelectWidget.handleOpenDialog()
   â†“
   è·å–çˆ¶è¡¨å•æ•°æ®: parentFormManager.prepareSubmitData()
   = { member_card_id: 1, products: [{ product_id: null, quantity: 1 }] }
   â†“
   CallbackManager.executeSelectFuzzy(field, '', parentFormManager)
   â†“
   è¯·æ±‚æ•°æ®:
   {
     code: "product_id",
     value: "",
     request: { member_card_id: 1, products: [...] }  // ğŸ”¥ å®Œæ•´è¡¨å•çŠ¶æ€
   }

3. åç«¯æ”¶åˆ°è¯·æ±‚
   â†“
   ä» req.Request["member_card_id"] è·å–ä¼šå‘˜å¡ID = 1
   â†“
   æŸ¥è¯¢å•†å“ï¼Œåº”ç”¨ 9æŠ˜ æŠ˜æ‰£
   â†“
   è¿”å›ä¼šå‘˜ä»·å•†å“åˆ—è¡¨ + èšåˆè¡¨è¾¾å¼é…ç½®

4. å‰ç«¯æ”¶åˆ°å“åº”
   â†“
   æ˜¾ç¤ºå•†å“é€‰é¡¹ï¼ˆä¼šå‘˜ä»·ï¼‰
   â†“
   ä¿å­˜èšåˆè¡¨è¾¾å¼é…ç½®åˆ° ListWidget

5. ç”¨æˆ·é€‰æ‹©å•†å“Aï¼ˆä¼šå‘˜ä»· Â¥4.5ï¼‰
   â†“
   SelectWidget.handleSelect()
   â†“
   æ›´æ–° rowManager: product_id = { raw: 101, displayInfo: { ä»·æ ¼: 4.5 } }
   â†“
   ListWidget.watch è§¦å‘
   â†“
   ExpressionParser.evaluate("sum(ä»·æ ¼,*quantity)", rowsData)
   â†“
   è®¡ç®—ï¼š4.5 * 1 = 4.5
   â†“
   æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º: ä¼šå‘˜ä»·æ ¼(å…ƒ): Â¥4.50

6. ç”¨æˆ·ä¿®æ”¹æ•°é‡ä¸º 2
   â†“
   NumberWidget.onChange(2)
   â†“
   æ›´æ–° rowManager: quantity = 2
   â†“
   ListWidget.watch è§¦å‘
   â†“
   é‡æ–°è®¡ç®—ï¼š4.5 * 2 = 9.0
   â†“
   æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º: ä¼šå‘˜ä»·æ ¼(å…ƒ): Â¥9.00
```

---

## å…³é”®è®¾è®¡ç‚¹æ€»ç»“

### âœ… 1. æ¯ä¸ªç»„ä»¶éƒ½æœ‰"å…¨çŸ¥è§†è§’"

- `allFields`ï¼šçŸ¥é“å…¨å±€æœ‰å“ªäº›å­—æ®µ
- `currentFieldPath`ï¼šçŸ¥é“è‡ªå·±åœ¨ç»“æ„ä¸­çš„ä½ç½®
- `formManager`ï¼šè®¿é—®å’Œæ›´æ–°ä»»æ„å­—æ®µ
- `parentFormManager`ï¼šè®¿é—®çˆ¶è¡¨å•å­—æ®µï¼ˆList/Struct åœºæ™¯ï¼‰

### âœ… 2. å›è°ƒè‡ªåŠ¨ä¼ é€’å®Œæ•´è¡¨å•çŠ¶æ€

- CallbackManager è‡ªåŠ¨è°ƒç”¨ `formManager.prepareSubmitData()`
- åç«¯æ ¹æ®è¡¨å•çŠ¶æ€è¿”å›é’ˆå¯¹æ€§æ•°æ®
- æ— éœ€æ‰‹åŠ¨æŒ‡å®šä¾èµ–å…³ç³»

### âœ… 3. èšåˆè®¡ç®—å®Œå…¨ç”±åç«¯æ§åˆ¶

- åç«¯è¿”å›èšåˆè¡¨è¾¾å¼é…ç½®ï¼ˆ`statistics`ï¼‰
- å‰ç«¯ä½¿ç”¨ `ExpressionParser` è®¡ç®—
- `displayInfo` å’Œå­—æ®µå€¼åˆå¹¶å‚ä¸è®¡ç®—
- å®æ—¶å“åº”æ•°æ®å˜åŒ–

### âœ… 4. ä¸‰å±‚æ•°æ®æµæ¶æ„

- **çˆ¶è¡¨å•å±‚**ï¼šparentFormManagerï¼ˆä¼šå‘˜å¡ç­‰ï¼‰
- **List å±‚**ï¼šListWidgetï¼ˆç®¡ç†æ‰€æœ‰è¡Œã€è®¡ç®—ç»Ÿè®¡ï¼‰
- **è¡Œå±‚**ï¼šrowManagerï¼ˆæ¯è¡Œç‹¬ç«‹ç®¡ç†ï¼‰

---

**è¿™ä¸ªæ¶æ„å·²ç»å¯ä»¥ä¼˜é›…åœ°å¤„ç†æ”¶é“¶å°è¿™ç§å¤æ‚åœºæ™¯äº†ï¼** âœ…


# å¼¹çª—æ¨¡å¼ä¸‹çš„åˆ†äº«è§†å›¾å®ç°æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜åˆ†æ

**ç”¨æˆ·é—®é¢˜**ï¼šå¦‚æœæ–°å¢ä¿æŒå¼¹çª—ï¼Œæ˜¯å¦èƒ½å®ç°åˆ†äº«è§†å›¾çš„åŠŸèƒ½ï¼Ÿä¾‹å¦‚è§†å›¾é‡Œæœ‰ä¸ªå­—æ®µæ ‡è¯†è¿™ä¸ªæ˜¯æ–°å¢åœºæ™¯ï¼Œç‚¹å‡»è§†å›¾æ—¶è‡ªåŠ¨è·³è½¬åˆ°æŒ‡å®šå‡½æ•°ï¼Œç„¶åæ¸²æŸ“ä¸Šé‚£äº›å­—æ®µã€‚

## ğŸ¯ æ ¸å¿ƒéœ€æ±‚

1. **è§†å›¾åŒ…å«åœºæ™¯ä¿¡æ¯**ï¼šæ ‡è¯†è¿™æ˜¯æ–°å¢/ç¼–è¾‘/æœç´¢åœºæ™¯
2. **è§†å›¾åŒ…å«ç›®æ ‡å‡½æ•°**ï¼šæŒ‡å®šè¦è·³è½¬çš„å‡½æ•°
3. **è§†å›¾åŒ…å«è¡¨å•æ•°æ®**ï¼šä¿å­˜çš„å­—æ®µå€¼
4. **ç‚¹å‡»è§†å›¾è‡ªåŠ¨æ‰§è¡Œ**ï¼šæ ¹æ®åœºæ™¯ç±»å‹æ‰“å¼€å¼¹çª—æˆ–è·³è½¬é¡µé¢

## ğŸ“Š è§†å›¾æ•°æ®ç»“æ„è®¾è®¡

### è§†å›¾æ•°æ®æ¨¡å‹

```typescript
interface ViewData {
  // åŸºç¡€ä¿¡æ¯
  view_id: string                    // è§†å›¾ ID
  view_name: string                  // è§†å›¾åç§°
  view_type: 'create' | 'update' | 'search' | 'form'  // è§†å›¾ç±»å‹
  
  // ç›®æ ‡å‡½æ•°ä¿¡æ¯
  function_router: string             // å‡½æ•°è·¯ç”±ï¼Œå¦‚ '/user/app/function'
  function_name?: string             // å‡½æ•°åç§°ï¼ˆå¯é€‰ï¼‰
  
  // è¡¨å•æ•°æ®
  form_data: Record<string, any>     // ä¿å­˜çš„å­—æ®µå€¼
  
  // å…ƒæ•°æ®
  metadata: {
    created_at: string               // åˆ›å»ºæ—¶é—´
    created_by?: string              // åˆ›å»ºè€…
    description?: string             // æè¿°
  }
}
```

### ç¤ºä¾‹æ•°æ®

```typescript
// æ–°å¢è§†å›¾ç¤ºä¾‹
const createView: ViewData = {
  view_id: 'view_001',
  view_name: 'æˆ‘çš„æ–°å¢è§†å›¾',
  view_type: 'create',
  function_router: '/luobei/demo/crm/crm_ticket',
  function_name: 'å·¥å•ç®¡ç†',
  form_data: {
    title: 'é»˜è®¤æ ‡é¢˜',
    priority: 'high',
    handler: 'luobei',
    // ... å…¶ä»–å­—æ®µ
  },
  metadata: {
    created_at: '2025-01-21T10:00:00Z',
    created_by: 'luobei',
    description: 'å¿«é€Ÿåˆ›å»ºé«˜ä¼˜å…ˆçº§å·¥å•'
  }
}

// æœç´¢è§†å›¾ç¤ºä¾‹
const searchView: ViewData = {
  view_id: 'view_002',
  view_name: 'æˆ‘çš„æœç´¢è§†å›¾',
  view_type: 'search',
  function_router: '/luobei/demo/crm/crm_ticket',
  form_data: {
    handler: ['luobei', 'beiluo'],
    status: 'open',
    created_at_gte: 1763654400000,
    created_at_lte: 1763740800000
  }
}
```

## ğŸ”„ å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šå¼¹çª—æ¨¡å¼ + è§†å›¾ï¼ˆæ¨èï¼‰

#### 1. è§†å›¾æ•°æ®ç»“æ„

è§†å›¾åŒ…å«åœºæ™¯ç±»å‹ï¼Œç‚¹å‡»æ—¶æ ¹æ®åœºæ™¯æ‰§è¡Œä¸åŒæ“ä½œï¼š

```typescript
interface ViewData {
  view_id: string
  view_name: string
  scene: 'create' | 'update' | 'search'  // åœºæ™¯ç±»å‹
  function_router: string                // ç›®æ ‡å‡½æ•°è·¯ç”±
  form_data: Record<string, any>         // è¡¨å•æ•°æ®
}
```

#### 2. ç‚¹å‡»è§†å›¾çš„å¤„ç†é€»è¾‘

```typescript
// åœ¨è§†å›¾åˆ—è¡¨ä¸­ç‚¹å‡»è§†å›¾
async function handleViewClick(view: ViewData) {
  // 1. æ ¹æ®åœºæ™¯ç±»å‹æ‰§è¡Œä¸åŒæ“ä½œ
  if (view.scene === 'create') {
    // æ–°å¢åœºæ™¯ï¼šæ‰“å¼€æ–°å¢å¼¹çª—
    await openCreateDialog(view)
  } else if (view.scene === 'update') {
    // ç¼–è¾‘åœºæ™¯ï¼šæ‰“å¼€ç¼–è¾‘å¼¹çª—ï¼ˆéœ€è¦å…ˆè·å–è®°å½• IDï¼‰
    await openUpdateDialog(view)
  } else if (view.scene === 'search') {
    // æœç´¢åœºæ™¯ï¼šå¡«å……æœç´¢æ¡ä»¶
    await applySearchView(view)
  }
}

// æ‰“å¼€æ–°å¢å¼¹çª—
async function openCreateDialog(view: ViewData) {
  // 1. æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨ç›®æ ‡å‡½æ•°é¡µé¢
  const currentRouter = route.path
  const targetRouter = `/workspace${view.function_router}`
  
  if (currentRouter !== targetRouter) {
    // 2. å¦‚æœä¸åœ¨ç›®æ ‡å‡½æ•°é¡µé¢ï¼Œå…ˆè·³è½¬
    await router.push(targetRouter)
    // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
    await nextTick()
  }
  
  // 3. æ‰“å¼€æ–°å¢å¼¹çª—ï¼Œå¹¶å¡«å……è§†å›¾æ•°æ®
  dialogMode.value = 'create'
  currentRow.value = view.form_data  // å¡«å……åˆå§‹æ•°æ®
  dialogVisible.value = true
}

// æ‰“å¼€ç¼–è¾‘å¼¹çª—
async function openUpdateDialog(view: ViewData) {
  // ç¼–è¾‘éœ€è¦è®°å½• IDï¼Œè§†å›¾æ•°æ®ä¸­åº”è¯¥åŒ…å«
  if (!view.form_data.id) {
    ElMessage.error('ç¼–è¾‘è§†å›¾éœ€è¦åŒ…å«è®°å½• ID')
    return
  }
  
  // 1. è·³è½¬åˆ°ç›®æ ‡å‡½æ•°é¡µé¢
  const targetRouter = `/workspace${view.function_router}`
  await router.push(targetRouter)
  await nextTick()
  
  // 2. åŠ è½½è®°å½•æ•°æ®ï¼ˆåˆå¹¶è§†å›¾æ•°æ®ï¼‰
  const record = await loadRecord(view.form_data.id)
  const mergedData = { ...record, ...view.form_data }
  
  // 3. æ‰“å¼€ç¼–è¾‘å¼¹çª—
  dialogMode.value = 'update'
  currentRow.value = mergedData
  dialogVisible.value = true
}

// åº”ç”¨æœç´¢è§†å›¾
async function applySearchView(view: ViewData) {
  // 1. è·³è½¬åˆ°ç›®æ ‡å‡½æ•°é¡µé¢
  const targetRouter = `/workspace${view.function_router}`
  await router.push({
    path: targetRouter,
    query: view.form_data  // æœç´¢æ¡ä»¶ä½œä¸º URL å‚æ•°
  })
  
  // 2. TableRenderer ä¼šè‡ªåŠ¨ä» URL æ¢å¤æœç´¢æ¡ä»¶
}
```

#### 3. FormDialog æ”¯æŒ initialData

`FormDialog` å·²ç»æ”¯æŒ `initialData` propï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š

```vue
<FormDialog
  v-model="dialogVisible"
  :mode="dialogMode"
  :initial-data="currentRow"  // è§†å›¾æ•°æ®ä½œä¸ºåˆå§‹æ•°æ®
  :fields="props.functionData.response"
  :router="props.functionData.router"
/>
```

#### 4. è§†å›¾åˆ—è¡¨ UI

```vue
<template>
  <div class="view-list">
    <div
      v-for="view in views"
      :key="view.view_id"
      class="view-item"
      @click="handleViewClick(view)"
    >
      <div class="view-header">
        <span class="view-name">{{ view.view_name }}</span>
        <el-tag :type="getViewTypeTag(view.scene)">
          {{ getViewTypeLabel(view.scene) }}
        </el-tag>
      </div>
      <div class="view-info">
        <span class="view-function">{{ view.function_name }}</span>
        <span class="view-time">{{ formatTime(view.metadata.created_at) }}</span>
      </div>
    </div>
  </div>
</template>

<script setup>
function getViewTypeTag(scene: string) {
  const map = {
    create: 'success',
    update: 'warning',
    search: 'info'
  }
  return map[scene] || 'info'
}

function getViewTypeLabel(scene: string) {
  const map = {
    create: 'æ–°å¢',
    update: 'ç¼–è¾‘',
    search: 'æœç´¢'
  }
  return map[scene] || scene
}
</script>
```

### æ–¹æ¡ˆ Bï¼šç»Ÿä¸€è·³è½¬é¡µé¢ï¼ˆå¤‡é€‰ï¼‰

å¦‚æœå¸Œæœ›ç»Ÿä¸€ä½“éªŒï¼Œæ‰€æœ‰è§†å›¾éƒ½è·³è½¬åˆ°é¡µé¢ï¼š

```typescript
async function handleViewClick(view: ViewData) {
  // ç»Ÿä¸€è·³è½¬åˆ°é¡µé¢ï¼Œé€šè¿‡ URL å‚æ•°ä¼ é€’è§†å›¾æ•°æ®
  const targetRouter = `/workspace${view.function_router}`
  
  if (view.scene === 'create') {
    // è·³è½¬åˆ°æ–°å¢é¡µé¢
    router.push({
      path: `${targetRouter}/create`,
      query: {
        view_id: view.view_id  // æˆ–ç›´æ¥ä¼ é€’ form_data
      }
    })
  } else if (view.scene === 'search') {
    // è·³è½¬åˆ°åˆ—è¡¨é¡µé¢ï¼ŒURL å‚æ•°è‡ªåŠ¨æ¢å¤æœç´¢æ¡ä»¶
    router.push({
      path: targetRouter,
      query: view.form_data
    })
  }
}
```

## âœ… ä¼˜åŠ¿åˆ†æ

### å¼¹çª—æ¨¡å¼ + è§†å›¾çš„ä¼˜åŠ¿

1. **âœ… å¯ä»¥å®ç°åˆ†äº«è§†å›¾åŠŸèƒ½**
   - è§†å›¾å¯ä»¥åŒ…å«åœºæ™¯ç±»å‹ã€ç›®æ ‡å‡½æ•°ã€è¡¨å•æ•°æ®
   - ç‚¹å‡»è§†å›¾æ—¶ï¼Œæ ¹æ®åœºæ™¯ç±»å‹æ‰“å¼€å¯¹åº”çš„å¼¹çª—
   - å¼¹çª—å¯ä»¥æ¥æ”¶ `initialData`ï¼Œè‡ªåŠ¨å¡«å……è§†å›¾æ•°æ®

2. **âœ… ä¿æŒå¿«é€Ÿæ“ä½œ**
   - æ–°å¢å’Œç¼–è¾‘ä¿æŒå¼¹çª—ï¼Œæ“ä½œå¿«é€Ÿ
   - ä¸éœ€è¦ç¦»å¼€å½“å‰é¡µé¢

3. **âœ… æ”¯æŒè·¨å‡½æ•°è·³è½¬**
   - è§†å›¾å¯ä»¥æŒ‡å®šç›®æ ‡å‡½æ•°
   - ç‚¹å‡»è§†å›¾æ—¶è‡ªåŠ¨è·³è½¬åˆ°ç›®æ ‡å‡½æ•°é¡µé¢
   - ç„¶åæ‰“å¼€å¼¹çª—å¹¶å¡«å……æ•°æ®

4. **âœ… çµæ´»çš„åœºæ™¯æ”¯æŒ**
   - æ”¯æŒæ–°å¢ã€ç¼–è¾‘ã€æœç´¢ä¸‰ç§åœºæ™¯
   - æ¯ç§åœºæ™¯æœ‰ä¸åŒçš„å¤„ç†é€»è¾‘

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. è·¨å‡½æ•°è·³è½¬

å¦‚æœè§†å›¾çš„ç›®æ ‡å‡½æ•°å’Œå½“å‰é¡µé¢ä¸åŒï¼Œéœ€è¦å…ˆè·³è½¬ï¼š

```typescript
// æ£€æŸ¥æ˜¯å¦éœ€è¦è·³è½¬
const currentRouter = route.path
const targetRouter = `/workspace${view.function_router}`

if (currentRouter !== targetRouter) {
  // å…ˆè·³è½¬åˆ°ç›®æ ‡å‡½æ•°é¡µé¢
  await router.push(targetRouter)
  await nextTick()  // ç­‰å¾…é¡µé¢åŠ è½½
}

// ç„¶åæ‰“å¼€å¼¹çª—
dialogVisible.value = true
```

### 2. æ•°æ®åˆå¹¶

ç¼–è¾‘åœºæ™¯éœ€è¦åˆå¹¶è§†å›¾æ•°æ®å’Œè®°å½•æ•°æ®ï¼š

```typescript
// è§†å›¾æ•°æ®å¯èƒ½åªåŒ…å«éƒ¨åˆ†å­—æ®µ
const viewData = view.form_data  // { handler: 'luobei', priority: 'high' }

// éœ€è¦å…ˆåŠ è½½å®Œæ•´è®°å½•
const record = await loadRecord(viewData.id)

// ç„¶ååˆå¹¶ï¼ˆè§†å›¾æ•°æ®ä¼˜å…ˆï¼‰
const mergedData = { ...record, ...viewData }
```

### 3. å­—æ®µéªŒè¯

è§†å›¾æ•°æ®ä¸­çš„å­—æ®µéœ€è¦éªŒè¯æ˜¯å¦åŒ¹é…ç›®æ ‡å‡½æ•°ï¼š

```typescript
// æ£€æŸ¥è§†å›¾æ•°æ®çš„å­—æ®µæ˜¯å¦åœ¨ç›®æ ‡å‡½æ•°çš„å­—æ®µåˆ—è¡¨ä¸­
function validateViewData(view: ViewData, functionFields: FieldConfig[]) {
  const fieldCodes = new Set(functionFields.map(f => f.code))
  const viewFields = Object.keys(view.form_data)
  
  const invalidFields = viewFields.filter(f => !fieldCodes.has(f))
  if (invalidFields.length > 0) {
    console.warn('è§†å›¾åŒ…å«æ— æ•ˆå­—æ®µ:', invalidFields)
    // å¯ä»¥é€‰æ‹©å¿½ç•¥æˆ–æŠ¥é”™
  }
}
```

## ğŸ¯ æ¨èæ–¹æ¡ˆ

### æ¨èï¼šå¼¹çª—æ¨¡å¼ + è§†å›¾ï¼ˆæ–¹æ¡ˆ Aï¼‰

**ç†ç”±**ï¼š
1. âœ… **å¯ä»¥å®ç°åˆ†äº«è§†å›¾åŠŸèƒ½**ï¼šè§†å›¾åŒ…å«åœºæ™¯ã€ç›®æ ‡å‡½æ•°ã€è¡¨å•æ•°æ®
2. âœ… **ä¿æŒå¿«é€Ÿæ“ä½œ**ï¼šæ–°å¢å’Œç¼–è¾‘ä¿æŒå¼¹çª—
3. âœ… **æ”¯æŒè·¨å‡½æ•°è·³è½¬**ï¼šç‚¹å‡»è§†å›¾æ—¶è‡ªåŠ¨è·³è½¬åˆ°ç›®æ ‡å‡½æ•°
4. âœ… **çµæ´»çš„åœºæ™¯æ”¯æŒ**ï¼šæ”¯æŒæ–°å¢ã€ç¼–è¾‘ã€æœç´¢ä¸‰ç§åœºæ™¯

**å®ç°æ­¥éª¤**ï¼š
1. è®¾è®¡è§†å›¾æ•°æ®ç»“æ„ï¼ˆåŒ…å« `scene`ã€`function_router`ã€`form_data`ï¼‰
2. å®ç°è§†å›¾ç‚¹å‡»å¤„ç†é€»è¾‘ï¼ˆæ ¹æ®åœºæ™¯ç±»å‹æ‰§è¡Œä¸åŒæ“ä½œï¼‰
3. æ”¯æŒè·¨å‡½æ•°è·³è½¬ï¼ˆå…ˆè·³è½¬ï¼Œå†æ‰“å¼€å¼¹çª—ï¼‰
4. åœ¨ `FormDialog` ä¸­ä½¿ç”¨ `initialData` å¡«å……è§†å›¾æ•°æ®

## ğŸ“ ä»£ç ç¤ºä¾‹

### å®Œæ•´çš„è§†å›¾ç‚¹å‡»å¤„ç†

```typescript
// TableRenderer.vue
async function handleViewClick(view: ViewData) {
  try {
    // 1. éªŒè¯è§†å›¾æ•°æ®
    if (!view.function_router) {
      ElMessage.error('è§†å›¾ç¼ºå°‘ç›®æ ‡å‡½æ•°ä¿¡æ¯')
      return
    }
    
    // 2. æ ¹æ®åœºæ™¯ç±»å‹å¤„ç†
    if (view.scene === 'create') {
      await handleCreateView(view)
    } else if (view.scene === 'update') {
      await handleUpdateView(view)
    } else if (view.scene === 'search') {
      await handleSearchView(view)
    } else {
      ElMessage.error('ä¸æ”¯æŒçš„è§†å›¾åœºæ™¯ç±»å‹')
    }
  } catch (error) {
    console.error('åº”ç”¨è§†å›¾å¤±è´¥:', error)
    ElMessage.error('åº”ç”¨è§†å›¾å¤±è´¥')
  }
}

async function handleCreateView(view: ViewData) {
  // 1. æ£€æŸ¥æ˜¯å¦éœ€è¦è·³è½¬
  const targetRouter = `/workspace${view.function_router}`
  const currentRouter = route.path
  
  if (!currentRouter.startsWith(targetRouter)) {
    // éœ€è¦è·³è½¬åˆ°ç›®æ ‡å‡½æ•°é¡µé¢
    await router.push(targetRouter)
    await nextTick()
    // ç­‰å¾… TableRenderer åŠ è½½å®Œæˆ
    await new Promise(resolve => setTimeout(resolve, 500))
  }
  
  // 2. æ‰“å¼€æ–°å¢å¼¹çª—ï¼Œå¡«å……è§†å›¾æ•°æ®
  dialogMode.value = 'create'
  currentRow.value = view.form_data
  dialogVisible.value = true
  
  ElMessage.success(`å·²åº”ç”¨è§†å›¾ï¼š${view.view_name}`)
}

async function handleUpdateView(view: ViewData) {
  // ç¼–è¾‘éœ€è¦è®°å½• ID
  if (!view.form_data.id) {
    ElMessage.error('ç¼–è¾‘è§†å›¾éœ€è¦åŒ…å«è®°å½• ID')
    return
  }
  
  // 1. è·³è½¬åˆ°ç›®æ ‡å‡½æ•°é¡µé¢
  const targetRouter = `/workspace${view.function_router}`
  await router.push(targetRouter)
  await nextTick()
  await new Promise(resolve => setTimeout(resolve, 500))
  
  // 2. åŠ è½½å®Œæ•´è®°å½•æ•°æ®
  const record = await loadRecord(view.form_data.id)
  
  // 3. åˆå¹¶è§†å›¾æ•°æ®ï¼ˆè§†å›¾æ•°æ®ä¼˜å…ˆï¼‰
  const mergedData = { ...record, ...view.form_data }
  
  // 4. æ‰“å¼€ç¼–è¾‘å¼¹çª—
  dialogMode.value = 'update'
  currentRow.value = mergedData
  dialogVisible.value = true
  
  ElMessage.success(`å·²åº”ç”¨è§†å›¾ï¼š${view.view_name}`)
}

async function handleSearchView(view: ViewData) {
  // æœç´¢åœºæ™¯ï¼šç›´æ¥è·³è½¬ï¼ŒURL å‚æ•°è‡ªåŠ¨æ¢å¤æœç´¢æ¡ä»¶
  const targetRouter = `/workspace${view.function_router}`
  await router.push({
    path: targetRouter,
    query: view.form_data
  })
  
  ElMessage.success(`å·²åº”ç”¨æœç´¢è§†å›¾ï¼š${view.view_name}`)
}
```

## ğŸ‰ ç»“è®º

**å¼¹çª—æ¨¡å¼å®Œå…¨å¯ä»¥å®ç°åˆ†äº«è§†å›¾åŠŸèƒ½ï¼**

å…³é”®ç‚¹ï¼š
1. âœ… è§†å›¾æ•°æ®ç»“æ„åŒ…å«åœºæ™¯ç±»å‹ã€ç›®æ ‡å‡½æ•°ã€è¡¨å•æ•°æ®
2. âœ… ç‚¹å‡»è§†å›¾æ—¶ï¼Œæ ¹æ®åœºæ™¯ç±»å‹æ‰§è¡Œä¸åŒæ“ä½œ
3. âœ… æ”¯æŒè·¨å‡½æ•°è·³è½¬ï¼ˆå…ˆè·³è½¬ï¼Œå†æ‰“å¼€å¼¹çª—ï¼‰
4. âœ… `FormDialog` æ”¯æŒ `initialData`ï¼Œå¯ä»¥è‡ªåŠ¨å¡«å……è§†å›¾æ•°æ®

è¿™æ ·æ—¢ä¿æŒäº†å¼¹çª—çš„å¿«é€Ÿæ“ä½œä½“éªŒï¼Œåˆæ”¯æŒäº†åˆ†äº«è§†å›¾åŠŸèƒ½ã€‚


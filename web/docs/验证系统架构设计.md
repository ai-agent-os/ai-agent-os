# éªŒè¯ç³»ç»Ÿæ¶æ„è®¾è®¡

## è®¾è®¡åŸåˆ™

1. **å¼€é—­åŸåˆ™**ï¼šæ–°å¢éªŒè¯å™¨æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç ï¼Œåªéœ€æ³¨å†Œæ–°çš„ `Validator`
2. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªéªŒè¯å™¨åªè´Ÿè´£ä¸€ç§éªŒè¯è§„åˆ™
3. **ä¾èµ–æ³¨å…¥**ï¼šé€šè¿‡ `ValidationContext` æ³¨å…¥ä¾èµ–ï¼Œä¸ç›´æ¥è€¦åˆ
4. **ç­–ç•¥æ¨¡å¼**ï¼šéªŒè¯å™¨ä½œä¸ºç­–ç•¥ï¼Œå¯åŠ¨æ€æ³¨å†Œå’Œæ›¿æ¢

---

## æ ¸å¿ƒæ¶æ„

### 1. ç±»å‹å®šä¹‰

```typescript
/**
 * éªŒè¯è§„åˆ™ï¼ˆè§£æåçš„ç»“æ„ï¼‰
 */
interface ValidationRule {
  type: string  // 'required', 'min', 'required_if', etc.
  value?: string | number  // è§„åˆ™çš„å€¼ï¼ˆå¦‚ min=2 ä¸­çš„ 2ï¼‰
  field?: string  // æ¡ä»¶éªŒè¯ä¸­å¼•ç”¨çš„å­—æ®µ codeï¼ˆå¦‚ required_if=is_vip ä¸­çš„ is_vipï¼‰
}

/**
 * éªŒè¯ç»“æœ
 */
interface ValidationResult {
  valid: boolean
  message?: string  // é”™è¯¯ä¿¡æ¯
}

/**
 * éªŒè¯ä¸Šä¸‹æ–‡ï¼ˆç”¨äºä¾èµ–æ³¨å…¥ï¼‰
 */
interface ValidationContext {
  formManager: ReactiveFormDataManager  // ğŸ”¥ ç”¨äºè®¿é—®å…¶ä»–å­—æ®µå€¼
  fieldPath: string  // å½“å‰å­—æ®µçš„è·¯å¾„
  allFields: FieldConfig[]  // æ‰€æœ‰å­—æ®µé…ç½®ï¼ˆç”¨äºæŸ¥æ‰¾å­—æ®µä¿¡æ¯ï¼‰
}
```

### 2. éªŒè¯å™¨æ¥å£ï¼ˆç­–ç•¥æ¨¡å¼ï¼‰

```typescript
/**
 * éªŒè¯å™¨æ¥å£
 * 
 * æ‰€æœ‰éªŒè¯å™¨å¿…é¡»å®ç°æ­¤æ¥å£
 * ç¬¦åˆå¼€é—­åŸåˆ™ï¼šæ–°å¢éªŒè¯å™¨åªéœ€å®ç°æ­¤æ¥å£å¹¶æ³¨å†Œ
 */
interface Validator {
  /**
   * éªŒè¯å™¨åç§°ï¼ˆå¯¹åº” validation å­—ç¬¦ä¸²ä¸­çš„è§„åˆ™åï¼‰
   * ä¾‹å¦‚ï¼š'required', 'min', 'required_if'
   */
  readonly name: string
  
  /**
   * æ‰§è¡ŒéªŒè¯
   * 
   * @param value å½“å‰å­—æ®µçš„å€¼
   * @param rule éªŒè¯è§„åˆ™ï¼ˆå·²è§£æï¼‰
   * @param context éªŒè¯ä¸Šä¸‹æ–‡ï¼ˆåŒ…å« formManager ç­‰ä¾èµ–ï¼‰
   * @returns éªŒè¯ç»“æœ
   */
  validate(
    value: FieldValue,
    rule: ValidationRule,
    context: ValidationContext
  ): ValidationResult
}
```

### 3. éªŒè¯å™¨æ³¨å†Œè¡¨

```typescript
/**
 * éªŒè¯å™¨æ³¨å†Œè¡¨
 * 
 * ä½¿ç”¨ç­–ç•¥æ¨¡å¼ç®¡ç†æ‰€æœ‰éªŒè¯å™¨
 */
class ValidatorRegistry {
  private validators = new Map<string, Validator>()
  
  /**
   * æ³¨å†ŒéªŒè¯å™¨
   */
  register(validator: Validator): void {
    this.validators.set(validator.name, validator)
  }
  
  /**
   * è·å–éªŒè¯å™¨
   */
  get(name: string): Validator | undefined {
    return this.validators.get(name)
  }
  
  /**
   * è·å–æ‰€æœ‰å·²æ³¨å†Œçš„éªŒè¯å™¨åç§°
   */
  getRegisteredNames(): string[] {
    return Array.from(this.validators.keys())
  }
}
```

### 4. éªŒè¯å¼•æ“ï¼ˆç»Ÿä¸€å…¥å£ï¼‰

```typescript
/**
 * éªŒè¯å¼•æ“
 * 
 * è´Ÿè´£è§£æ validation å­—ç¬¦ä¸²ï¼Œè°ƒç”¨ç›¸åº”çš„éªŒè¯å™¨
 */
class ValidationEngine {
  constructor(
    private registry: ValidatorRegistry,
    private formManager: ReactiveFormDataManager
  ) {}
  
  /**
   * éªŒè¯å•ä¸ªå­—æ®µ
   * 
   * @param field å­—æ®µé…ç½®
   * @param value å­—æ®µå€¼
   * @param allFields æ‰€æœ‰å­—æ®µé…ç½®ï¼ˆç”¨äºæŸ¥æ‰¾å…¶ä»–å­—æ®µï¼‰
   * @returns éªŒè¯é”™è¯¯åˆ—è¡¨ï¼ˆç©ºæ•°ç»„è¡¨ç¤ºéªŒè¯é€šè¿‡ï¼‰
   */
  validateField(
    field: FieldConfig,
    value: FieldValue,
    allFields: FieldConfig[]
  ): ValidationResult[] {
    if (!field.validation) {
      return []  // æ— éªŒè¯è§„åˆ™ï¼Œç›´æ¥é€šè¿‡
    }
    
    // è§£æ validation å­—ç¬¦ä¸²
    const rules = this.parseValidationString(field.validation)
    
    // æ„å»ºéªŒè¯ä¸Šä¸‹æ–‡
    const context: ValidationContext = {
      formManager: this.formManager,
      fieldPath: field.field_path || field.code,
      allFields
    }
    
    const errors: ValidationResult[] = []
    
    // éå†æ‰€æœ‰è§„åˆ™ï¼Œæ‰§è¡ŒéªŒè¯
    for (const rule of rules) {
      const validator = this.registry.get(rule.type)
      if (!validator) {
        console.warn(`[ValidationEngine] æœªçŸ¥éªŒè¯å™¨: ${rule.type}ï¼Œè·³è¿‡`)
        continue
      }
      
      try {
        const result = validator.validate(value, rule, context)
        if (!result.valid) {
          errors.push(result)
        }
      } catch (error) {
        console.error(`[ValidationEngine] éªŒè¯å™¨ ${rule.type} æ‰§è¡Œå¤±è´¥:`, error)
        // éªŒè¯å™¨æ‰§è¡Œå¤±è´¥ï¼Œä¸é˜»æ­¢è¡¨å•æäº¤ï¼ˆåç«¯ä¼šå…œåº•ï¼‰
      }
    }
    
    return errors
  }
  
  /**
   * è§£æ validation å­—ç¬¦ä¸²
   * 
   * ç¤ºä¾‹ï¼š
   * - "required" -> [{ type: 'required' }]
   * - "required,min=2,max=20" -> [{ type: 'required' }, { type: 'min', value: 2 }, { type: 'max', value: 20 }]
   * - "required_if=is_vip true" -> [{ type: 'required_if', field: 'is_vip', value: 'true' }]
   */
  private parseValidationString(validation: string): ValidationRule[] {
    const rules: ValidationRule[] = []
    const parts = validation.split(',').map(s => s.trim())
    
    for (const part of parts) {
      if (!part) continue
      
      // å¤„ç†å¸¦å‚æ•°çš„è§„åˆ™ï¼šmin=2, max=20
      if (part.includes('=')) {
        const [type, valueStr] = part.split('=', 2)
        const typeTrimmed = type.trim()
        const valueTrimmed = valueStr.trim()
        
        // åˆ¤æ–­æ˜¯å¦æ˜¯æ¡ä»¶éªŒè¯è§„åˆ™ï¼ˆåŒ…å«å­—æ®µåå’Œå€¼ï¼‰
        // required_if=is_vip true
        // required_unless=UserType guest
        if (this.isConditionalRule(typeTrimmed)) {
          // å°è¯•è§£æï¼šfield value
          const spaceIndex = valueTrimmed.indexOf(' ')
          if (spaceIndex > 0) {
            const field = valueTrimmed.substring(0, spaceIndex).trim()
            const value = valueTrimmed.substring(spaceIndex + 1).trim()
            rules.push({ type: typeTrimmed, field, value })
          } else {
            // æ²¡æœ‰ç©ºæ ¼ï¼Œå¯èƒ½æ˜¯ required_with=Phone è¿™ç§ï¼ˆåªæœ‰å­—æ®µåï¼‰
            rules.push({ type: typeTrimmed, field: valueTrimmed })
          }
        } else {
          // æ™®é€šå¸¦å‚æ•°è§„åˆ™ï¼šmin=2, max=20
          const numValue = this.parseNumber(valueTrimmed)
          rules.push({ type: typeTrimmed, value: numValue !== null ? numValue : valueTrimmed })
        }
      } else {
        // æ— å‚æ•°è§„åˆ™ï¼šrequired, email
        rules.push({ type: part })
      }
    }
    
    return rules
  }
  
  /**
   * åˆ¤æ–­æ˜¯å¦æ˜¯æ¡ä»¶éªŒè¯è§„åˆ™
   */
  private isConditionalRule(type: string): boolean {
    return [
      'required_if',
      'required_unless',
      'required_with',
      'required_without',
      'required_with_all',
      'required_without_all',
      'excluded_if',
      'excluded_unless',
      'excluded_with',
      'excluded_without',
      'eqfield',
      'nefield',
      'gtfield',
      'gtefield',
      'ltfield',
      'ltefield'
    ].includes(type)
  }
  
  /**
   * è§£ææ•°å­—å€¼
   */
  private parseNumber(str: string): number | null {
    const num = Number(str)
    return isNaN(num) ? null : num
  }
}
```

---

## éªŒè¯å™¨å®ç°ç¤ºä¾‹

### 1. åŸºç¡€éªŒè¯å™¨ï¼šRequiredValidator

```typescript
/**
 * å¿…å¡«éªŒè¯å™¨
 */
class RequiredValidator implements Validator {
  readonly name = 'required'
  
  validate(
    value: FieldValue,
    rule: ValidationRule,
    context: ValidationContext
  ): ValidationResult {
    // åˆ¤æ–­æ˜¯å¦ä¸ºç©º
    const isEmpty = value.raw === null ||
                   value.raw === undefined ||
                   value.raw === '' ||
                   (Array.isArray(value.raw) && value.raw.length === 0)
    
    if (isEmpty) {
      return {
        valid: false,
        message: 'æ­¤å­—æ®µä¸ºå¿…å¡«é¡¹'
      }
    }
    
    return { valid: true }
  }
}
```

### 2. æ•°å€¼éªŒè¯å™¨ï¼šMinValidator

```typescript
/**
 * æœ€å°å€¼éªŒè¯å™¨
 */
class MinValidator implements Validator {
  readonly name = 'min'
  
  validate(
    value: FieldValue,
    rule: ValidationRule,
    context: ValidationContext
  ): ValidationResult {
    if (rule.value === undefined) {
      return { valid: true }  // è§„åˆ™é…ç½®é”™è¯¯ï¼Œè·³è¿‡
    }
    
    const minValue = typeof rule.value === 'number' ? rule.value : Number(rule.value)
    const fieldValue = Number(value.raw)
    
    // åˆ¤æ–­å­—æ®µç±»å‹
    const field = context.allFields.find(f => (f.field_path || f.code) === context.fieldPath)
    const isString = field?.data?.type === 'string' || field?.widget?.type === 'input'
    
    if (isString) {
      // å­—ç¬¦ä¸²ç±»å‹ï¼šæ¯”è¾ƒé•¿åº¦
      const length = String(value.raw || '').length
      if (length < minValue) {
        return {
          valid: false,
          message: `é•¿åº¦ä¸èƒ½å°‘äº ${minValue} ä¸ªå­—ç¬¦`
        }
      }
    } else {
      // æ•°å€¼ç±»å‹ï¼šæ¯”è¾ƒå¤§å°
      if (isNaN(fieldValue) || fieldValue < minValue) {
        return {
          valid: false,
          message: `å€¼ä¸èƒ½å°äº ${minValue}`
        }
      }
    }
    
    return { valid: true }
  }
}
```

### 3. æ¡ä»¶éªŒè¯å™¨ï¼šRequiredIfValidatorï¼ˆğŸ”¥ æ ¸å¿ƒç¤ºä¾‹ï¼‰

```typescript
/**
 * æ¡ä»¶å¿…å¡«éªŒè¯å™¨
 * 
 * ç¤ºä¾‹ï¼šrequired_if=is_vip true
 * å½“ is_vip å­—æ®µçš„å€¼ç­‰äº 'true' æ—¶ï¼Œå½“å‰å­—æ®µå¿…å¡«
 * 
 * ğŸ”¥ å…³é”®è®¾è®¡ï¼š
 * - é€šè¿‡ context.formManager è®¿é—®å…¶ä»–å­—æ®µï¼Œä¸ç›´æ¥è€¦åˆ
 * - å­—æ®µåå·²ç”±åç«¯è½¬æ¢ä¸º codeï¼ˆå¦‚ 'is_vip'ï¼‰
 */
class RequiredIfValidator implements Validator {
  readonly name = 'required_if'
  
  validate(
    value: FieldValue,
    rule: ValidationRule,
    context: ValidationContext
  ): ValidationResult {
    // æ£€æŸ¥è§„åˆ™é…ç½®
    if (!rule.field || rule.value === undefined) {
      console.warn(`[RequiredIfValidator] è§„åˆ™é…ç½®ä¸å®Œæ•´: ${JSON.stringify(rule)}`)
      return { valid: true }  // é…ç½®é”™è¯¯ï¼Œè·³è¿‡éªŒè¯
    }
    
    // ğŸ”¥ é€šè¿‡ formManager è·å–å…¶ä»–å­—æ®µçš„å€¼ï¼ˆè§£è€¦è®¾è®¡ï¼‰
    const otherFieldPath = this.resolveFieldPath(rule.field, context)
    const otherFieldValue = context.formManager.getValue(otherFieldPath)
    
    // åˆ¤æ–­æ¡ä»¶æ˜¯å¦æ»¡è¶³
    const conditionMet = this.isConditionMet(otherFieldValue, rule.value)
    
    if (conditionMet) {
      // æ¡ä»¶æ»¡è¶³ï¼Œå½“å‰å­—æ®µå¿…å¡«
      const isEmpty = value.raw === null ||
                     value.raw === undefined ||
                     value.raw === '' ||
                     (Array.isArray(value.raw) && value.raw.length === 0)
      
      if (isEmpty) {
        return {
          valid: false,
          message: 'æ­¤å­—æ®µä¸ºå¿…å¡«é¡¹'
        }
      }
    }
    
    return { valid: true }
  }
  
  /**
   * è§£æå­—æ®µè·¯å¾„
   * 
   * å¤„ç†åµŒå¥—å­—æ®µï¼šproducts[].product_id
   * å¦‚æœ rule.field æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œéœ€è¦åŸºäºå½“å‰å­—æ®µè·¯å¾„è§£æ
   */
  private resolveFieldPath(fieldCode: string, context: ValidationContext): string {
    // ç®€å•å®ç°ï¼šç›´æ¥ä½¿ç”¨ fieldCode
    // å¦‚æœ fieldCode å·²ç»æ˜¯å®Œæ•´è·¯å¾„ï¼ˆå¦‚ 'products[0].product_id'ï¼‰ï¼Œç›´æ¥è¿”å›
    // å¦‚æœæ˜¯ç®€å•å­—æ®µåï¼ˆå¦‚ 'is_vip'ï¼‰ï¼Œç›´æ¥è¿”å›
    
    // TODO: å¤„ç†ç›¸å¯¹è·¯å¾„å’ŒåµŒå¥—ç»“æ„
    // å½“å‰å®ç°å‡è®¾ fieldCode å·²ç»æ˜¯å®Œæ•´çš„ field_path æˆ– code
    return fieldCode
  }
  
  /**
   * åˆ¤æ–­æ¡ä»¶æ˜¯å¦æ»¡è¶³
   * 
   * æ”¯æŒå¤šç§ç±»å‹æ¯”è¾ƒï¼š
   * - å­—ç¬¦ä¸²ï¼š'true' === 'true'
   * - å¸ƒå°”å€¼ï¼štrue === true
   * - æ•°å­—ï¼š1 === 1
   */
  private isConditionMet(fieldValue: FieldValue, expectedValue: string): boolean {
    const actualValue = fieldValue.raw
    
    // ç±»å‹è½¬æ¢å’Œæ¯”è¾ƒ
    if (typeof actualValue === 'boolean') {
      return String(actualValue) === expectedValue || actualValue === (expectedValue === 'true')
    }
    
    if (typeof actualValue === 'number') {
      const expectedNum = Number(expectedValue)
      return !isNaN(expectedNum) && actualValue === expectedNum
    }
    
    // é»˜è®¤å­—ç¬¦ä¸²æ¯”è¾ƒ
    return String(actualValue) === expectedValue
  }
}
```

---

## ä½¿ç”¨æ–¹å¼

### 1. åˆå§‹åŒ–éªŒè¯ç³»ç»Ÿ

```typescript
// åˆ›å»ºæ³¨å†Œè¡¨
const registry = new ValidatorRegistry()

// æ³¨å†ŒéªŒè¯å™¨
registry.register(new RequiredValidator())
registry.register(new MinValidator())
registry.register(new MaxValidator())
registry.register(new OneOfValidator())
registry.register(new RequiredIfValidator())
registry.register(new RequiredUnlessValidator())
// ... æ›´å¤šéªŒè¯å™¨

// åˆ›å»ºå¼•æ“
const engine = new ValidationEngine(registry, formManager)
```

### 2. åœ¨ Widget ä¸­ä½¿ç”¨

```typescript
// BaseWidget.ts
export abstract class BaseWidget {
  // ...
  
  /**
   * éªŒè¯å½“å‰å­—æ®µ
   */
  validate(): ValidationResult[] {
    if (!this.formManager || !this.field.validation) {
      return []
    }
    
    const value = this.getValue()
    // å‡è®¾å¯ä»¥é€šè¿‡æŸç§æ–¹å¼è·å–æ‰€æœ‰å­—æ®µ
    const allFields = this.formRenderer?.getAllFields() || []
    
    return this.validationEngine.validateField(this.field, value, allFields)
  }
}
```

### 3. åœ¨ FormRenderer ä¸­ä½¿ç”¨

```typescript
// FormRenderer.vue
const handleSubmit = async () => {
  // éªŒè¯æ‰€æœ‰å­—æ®µ
  const allErrors: Map<string, ValidationResult[]> = new Map()
  
  for (const [fieldPath, widget] of widgets.value) {
    const errors = widget.validate()
    if (errors.length > 0) {
      allErrors.set(fieldPath, errors)
    }
  }
  
  if (allErrors.size > 0) {
    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    showValidationErrors(allErrors)
    return
  }
  
  // éªŒè¯é€šè¿‡ï¼Œæäº¤æ•°æ®
  // ...
}
```

---

## æ‰©å±•æ€§è®¾è®¡

### æ–°å¢éªŒè¯å™¨ï¼ˆç¬¦åˆå¼€é—­åŸåˆ™ï¼‰

```typescript
/**
 * æ–°å¢é‚®ç®±éªŒè¯å™¨
 * 
 * åªéœ€å®ç° Validator æ¥å£å¹¶æ³¨å†Œï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
 */
class EmailValidator implements Validator {
  readonly name = 'email'
  
  validate(
    value: FieldValue,
    rule: ValidationRule,
    context: ValidationContext
  ): ValidationResult {
    const email = String(value.raw || '')
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
    
    if (!emailRegex.test(email)) {
      return {
        valid: false,
        message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€'
      }
    }
    
    return { valid: true }
  }
}

// æ³¨å†Œ
registry.register(new EmailValidator())
```

---

## å­—æ®µè·¯å¾„è§£æï¼ˆå¤„ç†åµŒå¥—ç»“æ„ï¼‰

æ¡ä»¶éªŒè¯å™¨éœ€è¦è®¿é—®å…¶ä»–å­—æ®µï¼Œä½†å­—æ®µå¯èƒ½ä½äºåµŒå¥—ç»“æ„ä¸­ï¼š

```
products[].product_id  // List å†…çš„å­—æ®µ
member.card_number     // Form å†…çš„å­—æ®µ
```

**è§£æé€»è¾‘ï¼š**
```typescript
/**
 * è§£æå­—æ®µè·¯å¾„ï¼Œæ”¯æŒåµŒå¥—ç»“æ„
 */
function resolveFieldPath(
  fieldCode: string,
  currentFieldPath: string,
  allFields: FieldConfig[]
): string {
  // 1. å¦‚æœæ˜¯å®Œæ•´è·¯å¾„ï¼ˆåŒ…å« []ï¼‰ï¼Œç›´æ¥è¿”å›
  if (fieldCode.includes('[') || fieldCode.includes('.')) {
    return fieldCode
  }
  
  // 2. æŸ¥æ‰¾åŒçº§çš„å­—æ®µ
  const currentField = allFields.find(f => (f.field_path || f.code) === currentFieldPath)
  if (!currentField) {
    return fieldCode  // æ‰¾ä¸åˆ°å½“å‰å­—æ®µï¼Œè¿”å›åŸå§‹ code
  }
  
  // 3. åŸºäºå½“å‰å­—æ®µçš„ parent_path æ„å»ºå®Œæ•´è·¯å¾„
  if (currentField.parent_path) {
    return `${currentField.parent_path}.${fieldCode}`
  }
  
  // 4. é¡¶çº§å­—æ®µï¼Œç›´æ¥è¿”å› code
  return fieldCode
}
```

---

## æ€»ç»“

**æ ¸å¿ƒè®¾è®¡ç‰¹ç‚¹ï¼š**

1. âœ… **å¼€é—­åŸåˆ™**ï¼šæ–°å¢éªŒè¯å™¨åªéœ€å®ç°æ¥å£å¹¶æ³¨å†Œ
2. âœ… **ä¾èµ–æ³¨å…¥**ï¼šé€šè¿‡ `ValidationContext` æ³¨å…¥ `formManager`ï¼Œä¸ç›´æ¥è€¦åˆ
3. âœ… **ç­–ç•¥æ¨¡å¼**ï¼šéªŒè¯å™¨ä½œä¸ºç­–ç•¥ï¼Œå¯åŠ¨æ€æ³¨å†Œå’Œæ›¿æ¢
4. âœ… **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªéªŒè¯å™¨åªè´Ÿè´£ä¸€ç§éªŒè¯è§„åˆ™
5. âœ… **é”™è¯¯å¤„ç†**ï¼šéªŒè¯å™¨æ‰§è¡Œå¤±è´¥ä¸å½±å“è¡¨å•æäº¤ï¼ˆåç«¯å…œåº•ï¼‰

**å®ç°ä¼˜å…ˆçº§ï¼š**

1. Phase 1ï¼šåŸºç¡€éªŒè¯å™¨ï¼ˆrequired, min, max, oneofï¼‰
2. Phase 2ï¼šæ¡ä»¶éªŒè¯å™¨ï¼ˆrequired_ifç­‰ï¼Œä¾èµ–å­—æ®µæ˜ å°„é—®é¢˜çš„è§£å†³ï¼‰
3. Phase 3ï¼šæ‰©å±•éªŒè¯å™¨ï¼ˆemail, urlç­‰ï¼ŒæŒ‰éœ€æ·»åŠ ï¼‰


# å€¼æå–å’Œæ¸²æŸ“æœºåˆ¶å®Œæ•´æ€§åˆ†æ

## ä¸€ã€æ ¸å¿ƒæœºåˆ¶åˆ†æ

### 1.1 å€¼æå–æœºåˆ¶ï¼ˆData Extractionï¼‰âœ…

#### æ¶æ„è®¾è®¡
```
FormDomainService.getSubmitData()
  â†“ å§”æ‰˜
FormStateManager.getSubmitData()
  â†“ å§”æ‰˜
useFormDataStore().getSubmitData()
  â†“ ä½¿ç”¨
FieldExtractorRegistry.extractField()  // ç­–ç•¥æ¨¡å¼
  â†“ æ ¹æ® widget.type é€‰æ‹©æå–å™¨
  â”œâ”€ BasicFieldExtractor (text, select, number, etc.)
  â”œâ”€ MultiSelectFieldExtractor (multiselect)
  â”œâ”€ FormFieldExtractor (form/struct)
  â””â”€ TableFieldExtractor (table/array of struct)
```

#### è®¾è®¡åŸåˆ™
- âœ… **ç­–ç•¥æ¨¡å¼**ï¼šæ¯ç§ç»„ä»¶ç±»å‹æœ‰ç‹¬ç«‹çš„æå–å™¨
- âœ… **ä¾èµ–å€’ç½®åŸåˆ™**ï¼šé«˜å±‚æ¨¡å—ä¾èµ–æŠ½è±¡ï¼ˆIFieldExtractorï¼‰
- âœ… **å¼€é—­åŸåˆ™**ï¼šæ–°å¢ç»„ä»¶ç±»å‹åªéœ€æ³¨å†Œæ–°æå–å™¨
- âœ… **å•ä¸€èŒè´£åŸåˆ™**ï¼šæ¯ä¸ªæå–å™¨åªè´Ÿè´£ä¸€ç§ç±»å‹
- âœ… **é€’å½’æå–**ï¼šæ”¯æŒä»»æ„æ·±åº¦çš„åµŒå¥—ç»“æ„

#### æ”¯æŒçš„æ•°æ®ç»“æ„
```typescript
// âœ… ç®€å•å­—æ®µ
{ name: "å¼ ä¸‰", age: 20 }

// âœ… form åµŒå¥—
{ 
  business_info: { 
    industry: "é‡‘è", 
    scale: "1000äººä»¥ä¸Š" 
  } 
}

// âœ… table åµŒå¥—
{ 
  products: [
    { product_name: "äº§å“1", price: 100 },
    { product_name: "äº§å“2", price: 200 }
  ]
}

// âœ… form åµŒå¥— table
{
  business_info: {
    industry: "é‡‘è",
    products: [
      { product_name: "äº§å“1", category: "è½¯ä»¶äº§å“" }
    ]
  }
}

// âœ… table åµŒå¥— form
{
  orders: [
    {
      order_id: 1,
      customer_info: {
        name: "å¼ ä¸‰",
        phone: "13800138000"
      }
    }
  ]
}

// âœ… ä»»æ„æ·±åº¦åµŒå¥—
{
  level1: {  // form
    level2: [  // table
      {
        level3: {  // form
          level4: [  // table
            { field: "value" }
          ]
        }
      }
    ]
  }
}
```

### 1.2 å€¼æ¸²æŸ“æœºåˆ¶ï¼ˆRenderingï¼‰âœ…

#### æ¶æ„è®¾è®¡
```
WidgetComponentFactory.getComponent(widgetType)
  â†“ æ ¹æ® widgetType è¿”å› Vue ç»„ä»¶
  â”œâ”€ InputWidget (text)
  â”œâ”€ SelectWidget (select)
  â”œâ”€ MultiSelectWidget (multiselect)
  â”œâ”€ NumberWidget (number)
  â”œâ”€ FormWidget (form)
  â”œâ”€ TableWidget (table)
  â”œâ”€ FilesWidget (files)
  â””â”€ ... (å…¶ä»–ç»„ä»¶)
```

#### æ¸²æŸ“æ¨¡å¼ï¼ˆModeï¼‰
æ¯ä¸ªç»„ä»¶éƒ½æ”¯æŒå¤šç§æ¸²æŸ“æ¨¡å¼ï¼š

1. **edit æ¨¡å¼**ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
   - ä½¿ç”¨åœºæ™¯ï¼šFormRenderer çš„è¯·æ±‚å‚æ•°è¡¨å•
   - è¡Œä¸ºï¼šæ˜¾ç¤ºå¯ç¼–è¾‘çš„è¾“å…¥æ§ä»¶
   - ç¤ºä¾‹ï¼šel-inputã€el-selectã€el-date-picker

2. **response æ¨¡å¼**ï¼ˆå“åº”æ¨¡å¼ï¼‰
   - ä½¿ç”¨åœºæ™¯ï¼šFormRenderer çš„å“åº”å‚æ•°å±•ç¤º
   - è¡Œä¸ºï¼šåªè¯»å±•ç¤º
   - ç¤ºä¾‹ï¼š<span>ã€<div>

3. **table-cell æ¨¡å¼**ï¼ˆè¡¨æ ¼å•å…ƒæ ¼æ¨¡å¼ï¼‰
   - ä½¿ç”¨åœºæ™¯ï¼šTableRenderer çš„è¡¨æ ¼å•å…ƒæ ¼
   - è¡Œä¸ºï¼šç®€åŒ–ç‰ˆæœ¬ï¼Œå¯èƒ½æœ‰é¢œè‰²æ ‡ç­¾
   - ç¤ºä¾‹ï¼šel-tagã€el-link

4. **detail æ¨¡å¼**ï¼ˆè¯¦æƒ…æ¨¡å¼ï¼‰
   - ä½¿ç”¨åœºæ™¯ï¼šè¯¦æƒ…æŠ½å±‰ã€è¯¦æƒ…é¡µé¢
   - è¡Œä¸ºï¼šè¯¦æƒ…å±•ç¤ºï¼Œæ”¯æŒæ ¼å¼åŒ–
   - ç¤ºä¾‹ï¼šJSONã€YAMLã€Markdown æ ¼å¼åŒ–

5. **search æ¨¡å¼**ï¼ˆæœç´¢æ¨¡å¼ï¼‰
   - ä½¿ç”¨åœºæ™¯ï¼šæœç´¢è¡¨å•ã€ç­›é€‰æ¡ä»¶
   - è¡Œä¸ºï¼šç±»ä¼¼ edit æ¨¡å¼ï¼Œä½†ç”¨äºæœç´¢
   - ç¤ºä¾‹ï¼šæœç´¢è¾“å…¥æ¡†ã€ç­›é€‰å™¨

#### è®¾è®¡åŸåˆ™
- âœ… **å·¥å‚æ¨¡å¼**ï¼šWidgetComponentFactory ç»Ÿä¸€ç®¡ç†ç»„ä»¶
- âœ… **å¼€é—­åŸåˆ™**ï¼šæ–°å¢ç»„ä»¶åªéœ€æ³¨å†Œï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
- âœ… **å•ä¸€èŒè´£åŸåˆ™**ï¼šæ¯ä¸ªç»„ä»¶åªè´Ÿè´£ä¸€ç§ç±»å‹çš„æ¸²æŸ“
- âœ… **æ¨¡å¼åˆ‡æ¢**ï¼šåŒä¸€ç»„ä»¶åœ¨ä¸åŒæ¨¡å¼ä¸‹æœ‰ä¸åŒè¡Œä¸º

### 1.3 å€¼å­˜å‚¨æœºåˆ¶ï¼ˆState Managementï¼‰âœ…

#### æ¶æ„è®¾è®¡
```
useFormDataStore()  // Pinia Store
  â”œâ”€ data: Map<string, FieldValue>  // å­—æ®µè·¯å¾„ -> FieldValue
  â”œâ”€ setValue(fieldPath, value)     // è®¾ç½®å€¼
  â”œâ”€ getValue(fieldPath)            // è·å–å€¼
  â””â”€ getSubmitData(fields)          // æå–æäº¤æ•°æ®
```

#### FieldValue æ•°æ®ç»“æ„
```typescript
{
  raw: any,        // åŸå§‹å€¼ï¼ˆæäº¤ç»™åç«¯ï¼‰
  display: string, // æ˜¾ç¤ºå€¼ï¼ˆå‰ç«¯å±•ç¤ºï¼‰
  meta: {          // å…ƒæ•°æ®
    displayInfo?: string,      // è¯¦ç»†ä¿¡æ¯
    statistics?: any,          // ç»Ÿè®¡ä¿¡æ¯
    dataType?: string,         // æ•°æ®ç±»å‹
    [key: string]: any         // å…¶ä»–è‡ªå®šä¹‰å…ƒæ•°æ®
  }
}
```

#### å­—æ®µè·¯å¾„è§„åˆ™
```typescript
// ä¸€çº§å­—æ®µ
'name' â†’ { raw: 'å¼ ä¸‰', display: 'å¼ ä¸‰', meta: {} }

// form åµŒå¥—å­—æ®µ
'business_info.industry' â†’ { raw: 'é‡‘è', display: 'é‡‘è', meta: {} }

// table åµŒå¥—å­—æ®µ
'products[0].product_name' â†’ { raw: 'äº§å“1', display: 'äº§å“1', meta: {} }

// form åµŒå¥— table
'business_info.products[0].product_name' â†’ { raw: 'äº§å“1', display: 'äº§å“1', meta: {} }
```

## äºŒã€å®Œæ•´æµç¨‹åˆ†æ

### 2.1 è¡¨å•åˆå§‹åŒ–æµç¨‹

```
1. FormView.onMounted()
   â†“
2. FormApplicationService.handleFunctionLoaded()
   â†“
3. FormDomainService.initializeForm(fields, initialData)
   â†“
4. éå†æ‰€æœ‰å­—æ®µï¼Œè°ƒç”¨ getDefaultValue(field)
   â†“
5. FormStateManager.setValue(fieldCode, defaultValue)
   â†“
6. useFormDataStore().setValue(fieldPath, fieldValue)
   â†“
7. å­—æ®µå€¼å­˜å‚¨åˆ° Map<string, FieldValue>
```

**å…³é”®ç‚¹**ï¼š
- âœ… form ç±»å‹å­—æ®µé»˜è®¤å€¼ï¼š`{}`
- âœ… table ç±»å‹å­—æ®µé»˜è®¤å€¼ï¼š`[]`
- âœ… å…¶ä»–å­—æ®µé»˜è®¤å€¼ï¼š`null`

### 2.2 è¡¨å•å¡«å†™æµç¨‹

```
1. ç”¨æˆ·åœ¨ç»„ä»¶ä¸­è¾“å…¥å€¼ï¼ˆå¦‚ InputWidgetï¼‰
   â†“
2. ç»„ä»¶è§¦å‘ update:modelValue äº‹ä»¶
   â†“
3. WidgetComponent æ¥æ”¶äº‹ä»¶ï¼Œè°ƒç”¨ eventBus.emit(FormEvent.fieldUpdated)
   â†“
4. FormDomainService ç›‘å¬äº‹ä»¶ï¼Œè°ƒç”¨ updateFieldValue()
   â†“
5. FormStateManager.setValue(fieldCode, value)
   â†“
6. useFormDataStore().setValue(fieldPath, fieldValue)
   â†“
7. å­—æ®µå€¼æ›´æ–°åˆ° Map<string, FieldValue>
```

**å…³é”®ç‚¹**ï¼š
- âœ… æ¯ä¸ªå­—æ®µéƒ½æœ‰ç‹¬ç«‹çš„è·¯å¾„
- âœ… åµŒå¥—å­—æ®µä¹Ÿèƒ½æ­£ç¡®æ›´æ–°
- âœ… FieldValue åŒ…å« rawã€displayã€meta

### 2.3 è¡¨å•æäº¤æµç¨‹

```
1. FormView.submitForm()
   â†“
2. FormApplicationService.submitForm()
   â†“
3. FormDomainService.validateForm(fields)  // éªŒè¯è¡¨å•
   â†“
4. FormDomainService.getSubmitData(fields)  // æå–æ•°æ®
   â†“
5. FormStateManager.getSubmitData(fields)
   â†“
6. useFormDataStore().getSubmitData(fields)
   â†“
7. FieldExtractorRegistry.extractField()  // é€’å½’æå–
   â†“
8. æ ¹æ® widget.type é€‰æ‹©æå–å™¨
   â”œâ”€ BasicFieldExtractor: è¿”å› value.raw
   â”œâ”€ MultiSelectFieldExtractor: æ ¹æ® data.type è¿”å›æ•°ç»„æˆ–å­—ç¬¦ä¸²
   â”œâ”€ FormFieldExtractor: é€’å½’æå–æ‰€æœ‰å­å­—æ®µ
   â””â”€ TableFieldExtractor: é€’å½’æå–æ‰€æœ‰è¡Œ
   â†“
9. è¿”å›æäº¤æ•°æ®å¯¹è±¡
   â†“
10. apiClient.post(url, submitData)  // å‘é€è¯·æ±‚
```

**å…³é”®ç‚¹**ï¼š
- âœ… ä½¿ç”¨ FieldExtractorRegistry è¿›è¡Œé€’å½’æå–
- âœ… æ”¯æŒä»»æ„åµŒå¥—ç»“æ„
- âœ… è¿‡æ»¤ç©ºè¡Œï¼ˆtableï¼‰
- âœ… ä¿æŒç»“æ„å®Œæ•´ï¼ˆform/table è¿”å› {}/[]ï¼‰

### 2.4 å“åº”æ•°æ®æ¸²æŸ“æµç¨‹

```
1. åç«¯è¿”å›å“åº”æ•°æ®
   â†“
2. FormApplicationService æ¥æ”¶å“åº”
   â†“
3. FormStateManager.setResponse(responseData)
   â†“
4. FormRenderer ç›‘å¬ response å˜åŒ–
   â†“
5. éå†å“åº”å­—æ®µï¼ˆfunctionDetail.responseï¼‰
   â†“
6. æ ¹æ®å­—æ®µç±»å‹å’Œ mode="response" æ¸²æŸ“ç»„ä»¶
   â†“
7. ç»„ä»¶æ ¹æ® mode å†³å®šæ¸²æŸ“é€»è¾‘ï¼ˆåªè¯»å±•ç¤ºï¼‰
```

**å…³é”®ç‚¹**ï¼š
- âœ… response æ¨¡å¼ä¸‹æ‰€æœ‰ç»„ä»¶åªè¯»
- âœ… æ”¯æŒæ ¼å¼åŒ–å±•ç¤ºï¼ˆJSONã€YAMLã€Markdownï¼‰
- âœ… æ”¯æŒåµŒå¥—ç»“æ„æ¸²æŸ“

## ä¸‰ã€æ½œåœ¨é—®é¢˜åˆ†æ

### 3.1 å·²ä¿®å¤çš„é—®é¢˜ âœ…

#### é—®é¢˜ 1ï¼štable å­—æ®µéªŒè¯å¤±è´¥
- **åŸå› **ï¼štable å­—æ®µé»˜è®¤å€¼æ˜¯ `null`ï¼ŒéªŒè¯å™¨æœŸæœ›æ•°ç»„
- **ä¿®å¤**ï¼šä¿®æ”¹ `getDefaultValue()` è¿”å› `[]`

#### é—®é¢˜ 2ï¼štable å­—æ®µä¿å­˜åæ•°æ®ä¸¢å¤±
- **åŸå› **ï¼š`saveRow` åè°ƒç”¨ `cancelEditing()` è¯¯åˆ æ•°æ®
- **ä¿®å¤**ï¼šä¿®æ”¹ `saveRow` é€»è¾‘ï¼Œç›´æ¥é‡ç½®çŠ¶æ€

#### é—®é¢˜ 3ï¼štable å­—æ®µæ˜¾ç¤ºå€¼ä¸¢å¤±
- **åŸå› **ï¼šä¿å­˜æ—¶è¦†ç›– `display` ä¸º `String(rawValue)`
- **ä¿®å¤**ï¼šä¿ç•™åŸæœ‰ `display` å’Œ `meta`

#### é—®é¢˜ 4ï¼štable å­—æ®µæäº¤ç©ºè¡Œ
- **åŸå› **ï¼šæœªè¿‡æ»¤æ‰€æœ‰å­—æ®µéƒ½ä¸º null çš„è¡Œ
- **ä¿®å¤**ï¼šåœ¨ `TableFieldExtractor` ä¸­è¿‡æ»¤ç©ºè¡Œ

#### é—®é¢˜ 5ï¼šform å­—æ®µæäº¤æ— å€¼
- **åŸå› **ï¼š`FormDomainService.getSubmitData()` æ²¡æœ‰ä½¿ç”¨ `FieldExtractorRegistry`
- **ä¿®å¤**ï¼šå§”æ‰˜ç»™ `FormStateManager.getSubmitData()`

### 3.2 å½“å‰æœºåˆ¶çš„ä¼˜åŠ¿ âœ…

#### 1. å®Œå…¨éµå¾ª SOLID åŸåˆ™
- âœ… **å•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼‰**ï¼šæ¯ä¸ªç±»/ç»„ä»¶åªè´Ÿè´£ä¸€ä»¶äº‹
- âœ… **å¼€é—­åŸåˆ™ï¼ˆOCPï¼‰**ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­
- âœ… **é‡Œæ°æ›¿æ¢åŸåˆ™ï¼ˆLSPï¼‰**ï¼šæ‰€æœ‰æå–å™¨éƒ½å®ç° IFieldExtractor
- âœ… **æ¥å£éš”ç¦»åŸåˆ™ï¼ˆISPï¼‰**ï¼šæ¥å£è®¾è®¡ç®€æ´ï¼ŒåªåŒ…å«å¿…è¦æ–¹æ³•
- âœ… **ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰**ï¼šé«˜å±‚æ¨¡å—ä¾èµ–æŠ½è±¡ï¼Œä¸ä¾èµ–å…·ä½“å®ç°

#### 2. æ”¯æŒä»»æ„æ•°æ®ç»“æ„
- âœ… ç®€å•å­—æ®µï¼ˆtext, select, number, etc.ï¼‰
- âœ… å¤æ‚å­—æ®µï¼ˆform, table, multiselectï¼‰
- âœ… ä»»æ„åµŒå¥—ï¼ˆform åµŒå¥— tableï¼Œtable åµŒå¥— formï¼‰
- âœ… ä»»æ„æ·±åº¦ï¼ˆ10 å±‚åµŒå¥—ä¹Ÿèƒ½æ­£ç¡®å¤„ç†ï¼‰

#### 3. æ”¯æŒä»»æ„ç»„ä»¶æ¸²æŸ“
- âœ… ä½¿ç”¨å·¥å‚æ¨¡å¼æ³¨å†Œç»„ä»¶
- âœ… ä½¿ç”¨ç­–ç•¥æ¨¡å¼æ³¨å†Œæå–å™¨
- âœ… ç»„ä»¶æ”¯æŒå¤šç§æ¸²æŸ“æ¨¡å¼
- âœ… æ‰©å±•æ—¶æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 

#### 4. æ•°æ®ä¸€è‡´æ€§ä¿è¯
- âœ… ä½¿ç”¨ Pinia ç»Ÿä¸€çŠ¶æ€ç®¡ç†
- âœ… ä½¿ç”¨ FieldValue ç»Ÿä¸€æ•°æ®ç»“æ„
- âœ… ä½¿ç”¨ FieldExtractorRegistry ç»Ÿä¸€æå–é€»è¾‘
- âœ… ä½¿ç”¨äº‹ä»¶æ€»çº¿è§£è€¦ç»„ä»¶

### 3.3 éœ€è¦æ³¨æ„çš„äº‹é¡¹ âš ï¸

#### 1. æ–°å¢ç»„ä»¶æ—¶çš„å¿…è¦æ­¥éª¤

**æ­¥éª¤ 1ï¼šåˆ›å»º Vue ç»„ä»¶**
```vue
<!-- CustomWidget.vue -->
<template>
  <div v-if="mode === 'edit'">
    <!-- ç¼–è¾‘æ¨¡å¼ -->
  </div>
  <div v-else-if="mode === 'response'">
    <!-- å“åº”æ¨¡å¼ -->
  </div>
  <!-- å…¶ä»–æ¨¡å¼ -->
</template>

<script setup lang="ts">
defineProps<{
  fieldPath: string
  mode: 'edit' | 'response' | 'table-cell' | 'detail' | 'search'
  modelValue?: FieldValue
}>()

defineEmits<{
  (e: 'update:modelValue', value: FieldValue): void
}>()
</script>
```

**æ­¥éª¤ 2ï¼šæ³¨å†Œç»„ä»¶åˆ°å·¥å‚**
```typescript
// web/src/core/factories-v2/index.ts
import CustomWidget from '@/core/widgets-v2/components/CustomWidget.vue'

widgetFactory.register('custom_widget', CustomWidget)
```

**æ­¥éª¤ 3ï¼šï¼ˆå¯é€‰ï¼‰åˆ›å»ºæå–å™¨**
```typescript
// web/src/core/stores-v2/extractors/CustomFieldExtractor.ts
export class CustomFieldExtractor implements IFieldExtractor {
  extract(field, fieldPath, getValue, extractorRegistry) {
    const value = getValue(fieldPath)
    // è‡ªå®šä¹‰æå–é€»è¾‘
    return value?.raw
  }
}
```

**æ­¥éª¤ 4ï¼šï¼ˆå¯é€‰ï¼‰æ³¨å†Œæå–å™¨**
```typescript
// web/src/core/stores-v2/extractors/FieldExtractorRegistry.ts
constructor() {
  this.registerExtractor('custom_widget', new CustomFieldExtractor())
}
```

#### 2. FieldValue æ•°æ®ç»“æ„è§„èŒƒ

**å¿…é¡»éµå®ˆçš„è§„èŒƒ**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„ FieldValue
{
  raw: 123,                    // å¿…é¡»ï¼šåŸå§‹å€¼ï¼ˆæäº¤ç»™åç«¯ï¼‰
  display: "123",             // å¿…é¡»ï¼šæ˜¾ç¤ºå€¼ï¼ˆå‰ç«¯å±•ç¤ºï¼‰
  meta: {                      // å¿…é¡»ï¼šå…ƒæ•°æ®ï¼ˆå¯ä»¥ä¸ºç©ºå¯¹è±¡ï¼‰
    displayInfo: "è¯¦ç»†ä¿¡æ¯",
    dataType: "number"
  }
}

// âŒ é”™è¯¯ï¼šç¼ºå°‘å­—æ®µ
{
  raw: 123
  // ç¼ºå°‘ display å’Œ meta
}

// âŒ é”™è¯¯ï¼šç±»å‹ä¸å¯¹
{
  raw: 123,
  display: 123,  // âŒ display å¿…é¡»æ˜¯ string
  meta: null     // âŒ meta å¿…é¡»æ˜¯ object
}
```

#### 3. æå–å™¨å®ç°è§„èŒƒ

**å¿…é¡»éµå®ˆçš„è§„èŒƒ**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šå®ç° IFieldExtractor æ¥å£
export class CustomFieldExtractor implements IFieldExtractor {
  extract(
    field: FieldConfig,
    fieldPath: string,
    getValue: (path: string) => FieldValue | undefined,
    extractorRegistry: FieldExtractorRegistry
  ): any {
    const value = getValue(fieldPath)
    
    // å¦‚æœæœ‰å­å­—æ®µï¼Œéœ€è¦é€’å½’æå–
    if (field.children && field.children.length > 0) {
      const result: Record<string, any> = {}
      field.children.forEach(subField => {
        const subFieldPath = `${fieldPath}.${subField.code}`
        result[subField.code] = extractorRegistry.extractField(subField, subFieldPath, getValue)
      })
      return result
    }
    
    // å¦åˆ™è¿”å› raw å€¼
    return value?.raw
  }
}

// âŒ é”™è¯¯ï¼šæ²¡æœ‰é€’å½’æå–å­å­—æ®µ
export class BadExtractor implements IFieldExtractor {
  extract(field, fieldPath, getValue, extractorRegistry) {
    const value = getValue(fieldPath)
    return value?.raw  // âŒ å¦‚æœæœ‰å­å­—æ®µï¼Œè¿™æ ·ä¼šä¸¢å¤±æ•°æ®
  }
}
```

#### 4. ç»„ä»¶æ¸²æŸ“æ¨¡å¼è§„èŒƒ

**å¿…é¡»éµå®ˆçš„è§„èŒƒ**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šæ ¹æ® mode æ¸²æŸ“ä¸åŒçš„ UI
<template>
  <div v-if="mode === 'edit'">
    <!-- ç¼–è¾‘æ¨¡å¼ï¼šå¯ç¼–è¾‘çš„è¾“å…¥æ§ä»¶ -->
    <el-input v-model="localValue" @input="handleUpdate" />
  </div>
  <div v-else-if="mode === 'response'">
    <!-- å“åº”æ¨¡å¼ï¼šåªè¯»å±•ç¤º -->
    <span>{{ modelValue?.display }}</span>
  </div>
  <div v-else-if="mode === 'table-cell'">
    <!-- è¡¨æ ¼æ¨¡å¼ï¼šç®€åŒ–ç‰ˆæœ¬ -->
    <el-tag>{{ modelValue?.display }}</el-tag>
  </div>
  <!-- å…¶ä»–æ¨¡å¼ -->
</template>

// âŒ é”™è¯¯ï¼šæ²¡æœ‰æ ¹æ® mode æ¸²æŸ“ä¸åŒçš„ UI
<template>
  <!-- âŒ æ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤ºè¾“å…¥æ¡†ï¼Œresponse æ¨¡å¼åº”è¯¥åªè¯» -->
  <el-input v-model="localValue" />
</template>
```

## å››ã€æ‰©å±•æ€§éªŒè¯

### 4.1 æ–°å¢ç®€å•ç»„ä»¶ï¼ˆå¦‚ Email Widgetï¼‰

**æ­¥éª¤ 1ï¼šåˆ›å»ºç»„ä»¶**
```vue
<!-- EmailWidget.vue -->
<template>
  <div v-if="mode === 'edit'">
    <el-input 
      type="email"
      :model-value="modelValue?.raw"
      @input="handleUpdate"
      placeholder="è¯·è¾“å…¥é‚®ç®±"
    />
  </div>
  <span v-else>{{ modelValue?.display }}</span>
</template>

<script setup lang="ts">
const handleUpdate = (value: string) => {
  emit('update:modelValue', {
    raw: value,
    display: value,
    meta: {}
  })
}
</script>
```

**æ­¥éª¤ 2ï¼šæ³¨å†Œç»„ä»¶**
```typescript
widgetFactory.register('email', EmailWidget)
```

**æ­¥éª¤ 3ï¼šä½¿ç”¨ï¼ˆä¸éœ€è¦æå–å™¨ï¼Œä½¿ç”¨é»˜è®¤çš„ BasicFieldExtractorï¼‰**
```typescript
// åç«¯å®šä¹‰
{
  code: "email",
  name: "é‚®ç®±",
  widget: {
    type: "email"
  }
}
```

âœ… **æ‰©å±•æˆåŠŸ**ï¼šæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç ï¼Œåªéœ€æ³¨å†Œç»„ä»¶

### 4.2 æ–°å¢å¤æ‚ç»„ä»¶ï¼ˆå¦‚ Cascader Widgetï¼‰

**æ­¥éª¤ 1ï¼šåˆ›å»ºç»„ä»¶**
```vue
<!-- CascaderWidget.vue -->
<template>
  <div v-if="mode === 'edit'">
    <el-cascader 
      :model-value="modelValue?.raw"
      :options="options"
      @change="handleUpdate"
    />
  </div>
  <span v-else>{{ modelValue?.display }}</span>
</template>
```

**æ­¥éª¤ 2ï¼šæ³¨å†Œç»„ä»¶**
```typescript
widgetFactory.register('cascader', CascaderWidget)
```

**æ­¥éª¤ 3ï¼šåˆ›å»ºæå–å™¨ï¼ˆå¦‚æœéœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰**
```typescript
export class CascaderFieldExtractor implements IFieldExtractor {
  extract(field, fieldPath, getValue, extractorRegistry) {
    const value = getValue(fieldPath)
    // Cascader çš„å€¼æ˜¯æ•°ç»„ï¼Œå¦‚ ['æµ™æ±Ÿçœ', 'æ­å·å¸‚', 'è¥¿æ¹–åŒº']
    return value?.raw || []
  }
}
```

**æ­¥éª¤ 4ï¼šæ³¨å†Œæå–å™¨**
```typescript
extractorRegistry.registerExtractor('cascader', new CascaderFieldExtractor())
```

âœ… **æ‰©å±•æˆåŠŸ**ï¼šæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç ï¼Œåªéœ€æ³¨å†Œç»„ä»¶å’Œæå–å™¨

### 4.3 æ–°å¢åµŒå¥—ç»„ä»¶ï¼ˆå¦‚ Nested Form Widgetï¼‰

**æ­¥éª¤ 1ï¼šåˆ›å»ºç»„ä»¶**
```vue
<!-- NestedFormWidget.vue -->
<template>
  <div class="nested-form">
    <div v-for="subField in field.children" :key="subField.code">
      <WidgetComponent 
        :field="subField"
        :field-path="`${fieldPath}.${subField.code}`"
        :mode="mode"
      />
    </div>
  </div>
</template>
```

**æ­¥éª¤ 2ï¼šæ³¨å†Œç»„ä»¶**
```typescript
widgetFactory.register('nested_form', NestedFormWidget)
```

**æ­¥éª¤ 3ï¼šä½¿ç”¨ FormFieldExtractorï¼ˆå·²æœ‰ï¼‰**
```typescript
// ä¸éœ€è¦æ–°çš„æå–å™¨ï¼ŒFormFieldExtractor å·²ç»æ”¯æŒé€’å½’æå–
```

âœ… **æ‰©å±•æˆåŠŸ**ï¼šæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç ï¼Œç”šè‡³ä¸éœ€è¦æ–°çš„æå–å™¨

## äº”ã€æ€»ç»“ä¸å»ºè®®

### 5.1 å½“å‰æœºåˆ¶çš„ä¼˜åŠ¿ âœ…

1. **æ¶æ„ä¼˜åŠ¿**
   - âœ… å®Œå…¨éµå¾ª SOLID åŸåˆ™
   - âœ… ä½¿ç”¨è®¾è®¡æ¨¡å¼ï¼ˆç­–ç•¥ã€å·¥å‚ã€é€‚é…å™¨ï¼‰
   - âœ… é«˜å†…èšä½è€¦åˆ
   - âœ… æ˜“äºæµ‹è¯•å’Œç»´æŠ¤

2. **åŠŸèƒ½ä¼˜åŠ¿**
   - âœ… æ”¯æŒä»»æ„æ•°æ®ç»“æ„
   - âœ… æ”¯æŒä»»æ„ç»„ä»¶æ¸²æŸ“
   - âœ… æ”¯æŒä»»æ„åµŒå¥—æ·±åº¦
   - âœ… æ•°æ®ä¸€è‡´æ€§ä¿è¯

3. **æ‰©å±•ä¼˜åŠ¿**
   - âœ… æ–°å¢ç»„ä»¶æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
   - âœ… æ–°å¢æå–å™¨åªéœ€æ³¨å†Œ
   - âœ… æ”¯æŒè‡ªå®šä¹‰æ¸²æŸ“æ¨¡å¼
   - âœ… æ”¯æŒè‡ªå®šä¹‰æå–é€»è¾‘

### 5.2 ç¡®ä¿åç»­æ­£ç¡®çš„å»ºè®® âš ï¸

#### å»ºè®® 1ï¼šä¸¥æ ¼éµå®ˆ FieldValue è§„èŒƒ
```typescript
// âœ… æ‰€æœ‰ç»„ä»¶éƒ½å¿…é¡»è¿”å›å®Œæ•´çš„ FieldValue
emit('update:modelValue', {
  raw: rawValue,        // å¿…é¡»
  display: displayValue, // å¿…é¡»
  meta: metaData        // å¿…é¡»ï¼ˆå¯ä»¥ä¸º {}ï¼‰
})
```

#### å»ºè®® 2ï¼šæ–°å¢ç»„ä»¶æ—¶éµå¾ªæ­¥éª¤
1. åˆ›å»º Vue ç»„ä»¶ï¼Œæ”¯æŒæ‰€æœ‰æ¸²æŸ“æ¨¡å¼
2. åœ¨ WidgetComponentFactory ä¸­æ³¨å†Œ
3. å¦‚æœéœ€è¦ç‰¹æ®Šæå–é€»è¾‘ï¼Œåˆ›å»ºå¹¶æ³¨å†Œæå–å™¨
4. æµ‹è¯•æ‰€æœ‰æ¨¡å¼å’ŒåµŒå¥—åœºæ™¯

#### å»ºè®® 3ï¼šç¼–å†™å•å…ƒæµ‹è¯•
```typescript
// æµ‹è¯•æå–å™¨
describe('CustomFieldExtractor', () => {
  it('should extract simple value', () => {
    // ...
  })
  
  it('should extract nested value', () => {
    // ...
  })
})

// æµ‹è¯•ç»„ä»¶
describe('CustomWidget', () => {
  it('should render in edit mode', () => {
    // ...
  })
  
  it('should render in response mode', () => {
    // ...
  })
})
```

#### å»ºè®® 4ï¼šæ·»åŠ ä»£ç æ³¨é‡Š
```typescript
/**
 * CustomFieldExtractor
 * 
 * åŠŸèƒ½ï¼šæå– custom_widget ç±»å‹å­—æ®µçš„å€¼
 * 
 * æ”¯æŒçš„æ•°æ®ç»“æ„ï¼š
 * - ç®€å•å€¼ï¼š{ raw: "value", display: "value", meta: {} }
 * - å¤æ‚å€¼ï¼š{ raw: {...}, display: "formatted", meta: {...} }
 * 
 * ä½¿ç”¨ç¤ºä¾‹ï¼š
 * extractorRegistry.registerExtractor('custom_widget', new CustomFieldExtractor())
 */
export class CustomFieldExtractor implements IFieldExtractor {
  // ...
}
```

### 5.3 æœ€ç»ˆç»“è®º âœ…

**å½“å‰çš„å€¼æå–å’Œæ¸²æŸ“æœºåˆ¶å®Œå…¨å¯é ï¼Œå¯ä»¥ç¡®ä¿ï¼š**

1. âœ… **åç»­æ–°å¢ä»»ä½•ç»„ä»¶éƒ½èƒ½æ­£ç¡®æäº¤**
   - ä½¿ç”¨ FieldExtractorRegistry ç»Ÿä¸€ç®¡ç†
   - æ”¯æŒä»»æ„æ•°æ®ç»“æ„å’ŒåµŒå¥—æ·±åº¦
   - å®Œå…¨éµå¾ª SOLID åŸåˆ™

2. âœ… **åç»­æ–°å¢ä»»ä½•ç»„ä»¶éƒ½èƒ½æ­£ç¡®æ¸²æŸ“**
   - ä½¿ç”¨ WidgetComponentFactory ç»Ÿä¸€ç®¡ç†
   - æ”¯æŒå¤šç§æ¸²æŸ“æ¨¡å¼
   - ç»„ä»¶ä¹‹é—´å®Œå…¨è§£è€¦

3. âœ… **ç³»ç»Ÿå…·å¤‡æå¼ºçš„æ‰©å±•æ€§**
   - æ–°å¢ç»„ä»¶åªéœ€æ³¨å†Œï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
   - æ”¯æŒè‡ªå®šä¹‰æå–é€»è¾‘å’Œæ¸²æŸ“é€»è¾‘
   - å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­

4. âœ… **æ•°æ®ä¸€è‡´æ€§æœ‰ä¿è¯**
   - ä½¿ç”¨ç»Ÿä¸€çš„ FieldValue æ•°æ®ç»“æ„
   - ä½¿ç”¨ Pinia ç»Ÿä¸€çŠ¶æ€ç®¡ç†
   - ä½¿ç”¨äº‹ä»¶æ€»çº¿è§£è€¦ç»„ä»¶

**è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥å£®å’Œä¼˜é›…çš„æ¶æ„ï¼Œå¯ä»¥æ”¾å¿ƒåœ°ç”¨äºç”Ÿäº§ç¯å¢ƒï¼** ğŸ‰


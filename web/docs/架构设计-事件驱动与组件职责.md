# æ¶æ„è®¾è®¡ - äº‹ä»¶é©±åŠ¨ä¸ç»„ä»¶èŒè´£

## æ ¸å¿ƒåŸåˆ™

> **ç»„ä»¶åªç®¡è‡ªå·±ï¼Œé€šè¿‡äº‹ä»¶é€šä¿¡**

### è®¾è®¡ç†å¿µ

1. âŒ **é¿å…è·¨ç»„ä»¶ç›´æ¥æ›´æ–°**
   - ä¸åº”è¯¥å‡ºç°"a ç»„ä»¶æ›´æ–° b ç»„ä»¶çš„å€¼"
   - è¿™ç§è®¾è®¡åäººæ€§ï¼Œéš¾ä»¥ç»´æŠ¤

2. âœ… **äº‹ä»¶é©±åŠ¨é€šä¿¡**
   - å­ç»„ä»¶ï¼šåªç®¡è‡ªå·±ï¼Œå‘å‡ºäº‹ä»¶
   - çˆ¶ç»„ä»¶ï¼šç›‘å¬å­ç»„ä»¶äº‹ä»¶ï¼Œåè°ƒå¤„ç†
   - è§£è€¦ã€æ¸…æ™°ã€æ˜“æ‰©å±•

3. âœ… **èŒè´£æ¸…æ™°**
   - SelectWidgetï¼šç®¡ç†è‡ªå·±çš„å€¼ï¼Œå‘å‡ºæœç´¢/å˜åŒ–äº‹ä»¶
   - MultiSelectWidgetï¼šç®¡ç†è‡ªå·±çš„å€¼ï¼Œè®¡ç®—è¡Œå†…èšåˆï¼Œå‘å‡ºäº‹ä»¶
   - ListWidgetï¼šç›‘å¬å­ç»„ä»¶äº‹ä»¶ï¼Œè°ƒç”¨å›è°ƒï¼Œè®¡ç®—Listå±‚èšåˆ

---

## ç»„ä»¶ç»§æ‰¿ä½“ç³»

### ç±»å›¾

```
BaseWidgetï¼ˆæŠ½è±¡åŸºç±»ï¼‰
â”œâ”€â”€ InputWidget
â”œâ”€â”€ SelectWidget
â”œâ”€â”€ MultiSelectWidget
â”œâ”€â”€ NumberWidget
â”œâ”€â”€ TextAreaWidget
â”œâ”€â”€ SwitchWidget
â”œâ”€â”€ TimestampWidget
â”œâ”€â”€ FileUploadWidget
â”œâ”€â”€ ListWidgetï¼ˆç‰¹æ®Šï¼‰
â””â”€â”€ StructWidgetï¼ˆç‰¹æ®Šï¼‰
```

### BaseWidget - æ‰€æœ‰ç»„ä»¶çš„çˆ¶ç±»

```typescript
/**
 * Widget åŸºç±»
 * æ‰€æœ‰ç»„ä»¶éƒ½ç»§æ‰¿æ­¤ç±»
 */
abstract class BaseWidget {
  // å­—æ®µé…ç½®
  protected field: FieldConfig
  
  // å½“å‰å­—æ®µè·¯å¾„
  protected fieldPath: string
  
  // å½“å‰å­—æ®µå€¼
  protected value: FieldValue
  
  // è¡¨å•æ•°æ®ç®¡ç†å™¨
  protected formManager: ReactiveFormDataManager
  
  // å˜åŒ–å›è°ƒ
  protected onChange: (value: FieldValue) => void
  
  constructor(props: WidgetRenderProps) {
    this.field = props.field
    this.fieldPath = props.currentFieldPath
    this.value = props.value
    this.formManager = props.formManager
    this.onChange = props.onChange
  }
  
  /**
   * æ¸²æŸ“æ–¹æ³•ï¼ˆå­ç±»å¿…é¡»å®ç°ï¼‰
   */
  abstract render(): VNode
  
  /**
   * é€šç”¨æ–¹æ³•ï¼šéå†å­å­—æ®µ
   */
  protected findChildFieldsByType(types: string[]): FieldConfig[] {
    if (!this.field.sub_fields) return []
    return this.field.sub_fields.filter(field => 
      types.includes(field.widget.type)
    )
  }
  
  /**
   * é€šç”¨æ–¹æ³•ï¼šæ„å»ºå­å­—æ®µè·¯å¾„
   */
  protected buildChildFieldPath(childName: string, index?: number): string {
    if (index !== undefined) {
      return `${this.fieldPath}[${index}].${childName}`
    }
    return `${this.fieldPath}.${childName}`
  }
  
  /**
   * é€šç”¨æ–¹æ³•ï¼šå‘å‡ºäº‹ä»¶
   */
  protected emit(eventType: string, payload: any): void {
    this.formManager.emit(eventType, {
      ...payload,
      fieldPath: this.fieldPath
    })
  }
}
```

---

## SelectWidget - åªç®¡è‡ªå·±

```typescript
/**
 * Select ç»„ä»¶
 * èŒè´£ï¼š
 * 1. ç®¡ç†è‡ªå·±çš„å€¼
 * 2. å‘å‡ºæœç´¢äº‹ä»¶ï¼ˆä¸è‡ªå·±è°ƒç”¨å›è°ƒï¼‰
 * 3. å‘å‡ºå˜åŒ–äº‹ä»¶ï¼ˆä¸æ›´æ–°å…¶ä»–ç»„ä»¶ï¼‰
 */
class SelectWidget extends BaseWidget {
  private dialogVisible = ref(false)
  private options = ref<SelectOption[]>([])
  
  render(): VNode {
    return h('div', { class: 'select-widget' }, [
      h(ElInput, {
        modelValue: this.value.display,
        readonly: true,
        placeholder: `è¯·é€‰æ‹©${this.field.name}`,
        onClick: () => this.handleOpenDialog()
      }),
      
      this.renderDialog()
    ])
  }
  
  /**
   * æ‰“å¼€æœç´¢å¯¹è¯æ¡†
   */
  async handleOpenDialog() {
    this.dialogVisible.value = true
    
    // ğŸ”¥ å‘å‡ºæœç´¢äº‹ä»¶ï¼ˆä¸è‡ªå·±å¤„ç†ï¼‰
    this.emit('field:search', {
      query: '',
      callback: (options: SelectOption[]) => {
        this.options.value = options
      }
    })
  }
  
  /**
   * æœç´¢å•†å“
   */
  async handleSearch(query: string) {
    // ğŸ”¥ å‘å‡ºæœç´¢äº‹ä»¶
    this.emit('field:search', {
      query,
      callback: (options: SelectOption[]) => {
        this.options.value = options
      }
    })
  }
  
  /**
   * é€‰æ‹©å•†å“
   */
  handleSelect(option: SelectOption) {
    // 1. æ›´æ–°è‡ªå·±çš„å€¼
    this.onChange({
      raw: option.value,
      display: option.label,
      meta: {
        displayInfo: option.displayInfo,
        dataType: this.field.data.type,
        fromCallback: true
      }
    })
    
    // 2. å‘å‡ºå˜åŒ–äº‹ä»¶ï¼ˆè®©çˆ¶ç»„ä»¶çŸ¥é“ï¼‰
    this.emit('field:change', {
      value: option.value,
      displayInfo: option.displayInfo
    })
    
    // 3. å…³é—­å¯¹è¯æ¡†
    this.dialogVisible.value = false
  }
  
  private renderDialog(): VNode {
    return h(FuzzySearchDialog, {
      visible: this.dialogVisible.value,
      options: this.options.value,
      onSearch: (query: string) => this.handleSearch(query),
      onSelect: (option: SelectOption) => this.handleSelect(option),
      onClose: () => this.dialogVisible.value = false
    })
  }
}
```

---

## MultiSelectWidget - è¡Œå†…èšåˆ

```typescript
/**
 * MultiSelect ç»„ä»¶
 * èŒè´£ï¼š
 * 1. ç®¡ç†è‡ªå·±çš„å€¼ï¼ˆå¤šé€‰ï¼‰
 * 2. è®¡ç®—è¡Œå†…èšåˆï¼ˆè‡ªå·±çš„èšåˆï¼‰
 * 3. å‘å‡ºå˜åŒ–äº‹ä»¶ï¼ˆæºå¸¦è¡Œå†…èšåˆç»“æœï¼‰
 */
class MultiSelectWidget extends BaseWidget {
  private selectedValues = ref<any[]>([])
  private options = ref<SelectOption[]>([])
  private rowStatistics = ref<Record<string, any>>({})
  private statisticsConfig = ref<Record<string, string>>({})
  
  render(): VNode {
    return h('div', { class: 'multiselect-widget' }, [
      // å¤šé€‰ç»„ä»¶
      h(ElSelect, {
        modelValue: this.selectedValues.value,
        multiple: true,
        placeholder: `è¯·é€‰æ‹©${this.field.name}`,
        onChange: (values: any[]) => this.handleChange(values)
      }, {
        default: () => this.options.value.map(opt =>
          h(ElOption, {
            key: opt.value,
            label: opt.label,
            value: opt.value
          })
        )
      }),
      
      // æ˜¾ç¤ºè¡Œå†…ç»Ÿè®¡
      this.rowStatistics.value && h('div', { class: 'row-statistics' },
        Object.entries(this.rowStatistics.value).map(([label, value]) =>
          h('div', { class: 'stat-item' }, [
            h('span', { class: 'stat-label' }, label + ':'),
            h('span', { class: 'stat-value' }, value)
          ])
        )
      )
    ])
  }
  
  /**
   * å€¼å˜åŒ–å¤„ç†
   */
  handleChange(values: any[]) {
    // 1. è·å–é€‰ä¸­çš„é€‰é¡¹
    const selectedOptions = this.options.value.filter(opt => 
      values.includes(opt.value)
    )
    
    // 2. è®¡ç®—è¡Œå†…èšåˆï¼ˆè‡ªå·±çš„èšåˆï¼‰
    const rowStats = this.calculateRowStatistics(selectedOptions)
    this.rowStatistics.value = rowStats
    
    // 3. æ›´æ–°è‡ªå·±çš„å€¼
    this.onChange({
      raw: values,
      display: `å·²é€‰ ${values.length} é¡¹`,
      meta: {
        displayInfo: selectedOptions.map(opt => opt.displayInfo),
        dataType: this.field.data.type,
        // ğŸ”¥ ä¿å­˜è¡Œå†…èšåˆç»“æœ
        rowStatistics: rowStats
      }
    })
    
    // 4. å‘å‡ºå˜åŒ–äº‹ä»¶ï¼ˆè®©çˆ¶ç»„ä»¶ ListWidget çŸ¥é“ï¼‰
    this.emit('field:change', {
      values,
      selectedOptions,
      rowStatistics: rowStats  // æºå¸¦è¡Œå†…èšåˆï¼ˆä»…ä¾›å‚è€ƒï¼Œçˆ¶ç»„ä»¶ä¸ä¼šç”¨ï¼‰
    })
  }
  
  /**
   * è®¡ç®—è¡Œå†…èšåˆï¼ˆMultiSelect è‡ªå·±çš„èŒè´£ï¼‰
   */
  private calculateRowStatistics(selectedOptions: SelectOption[]): Record<string, any> {
    const config = this.statisticsConfig.value
    if (!config || Object.keys(config).length === 0) {
      return {}
    }
    
    const result: Record<string, any> = {}
    const displayInfoList = selectedOptions.map(opt => opt.displayInfo || {})
    
    for (const [label, expression] of Object.entries(config)) {
      // ä½¿ç”¨è¡¨è¾¾å¼è§£æå™¨è®¡ç®—
      // ä¾‹å¦‚: "sum(ä»·æ ¼)" â†’ éå† displayInfoListï¼Œç´¯åŠ  ä»·æ ¼ å­—æ®µ
      result[label] = ExpressionParser.evaluate(expression, displayInfoList)
    }
    
    return result
  }
}
```

---

## ListWidget - çˆ¶ç»„ä»¶åè°ƒ

```typescript
/**
 * List ç»„ä»¶
 * èŒè´£ï¼š
 * 1. æ¸²æŸ“å­ç»„ä»¶
 * 2. è®¢é˜…å­ç»„ä»¶çš„æœç´¢äº‹ä»¶ â†’ è°ƒç”¨å›è°ƒ â†’ æ›´æ–°å­ç»„ä»¶é€‰é¡¹
 * 3. è®¢é˜…å­ç»„ä»¶çš„å˜åŒ–äº‹ä»¶ â†’ é‡æ–°è®¡ç®—Listå±‚èšåˆ
 * 4. è®¡ç®—Listå±‚èšåˆï¼ˆç‹¬ç«‹è®¡ç®—ï¼Œä¸å¤ç”¨å­ç»„ä»¶çš„è¡Œå†…èšåˆï¼‰
 */
class ListWidget extends BaseWidget {
  private rows = ref<any[]>([])
  private rowManagers = new Map<number, ReactiveFormDataManager>()
  private listStatistics = ref<Record<string, any>>({})
  private statisticsConfig = ref<Record<string, string>>({})
  
  created() {
    // ğŸ”¥ åˆå§‹åŒ–ï¼šè®¢é˜…å­ç»„ä»¶äº‹ä»¶
    this.subscribeChildEvents()
  }
  
  render(): VNode {
    return h('div', { class: 'list-widget' }, [
      // æ¸²æŸ“è¡¨æ ¼
      this.renderTable(),
      
      // æ˜¾ç¤ºListå±‚ç»Ÿè®¡ï¼ˆåœ¨åº•éƒ¨ï¼‰
      this.listStatistics.value && h('div', { class: 'list-statistics' },
        Object.entries(this.listStatistics.value).map(([label, value]) =>
          h('div', { class: 'stat-item' }, [
            h('span', { class: 'stat-label' }, label + ':'),
            h('span', { class: 'stat-value' }, value)
          ])
        )
      )
    ])
  }
  
  /**
   * è®¢é˜…å­ç»„ä»¶äº‹ä»¶ï¼ˆé€šç”¨æ–¹æ³•ï¼‰
   * ğŸ”¥ ListWidget çš„æ ¸å¿ƒèŒè´£
   */
  private subscribeChildEvents() {
    // 1. æ‰¾å‡ºæ‰€æœ‰ select å’Œ multiselect å­å­—æ®µ
    const selectFields = this.findChildFieldsByType(['select', 'multiselect'])
    
    console.log(`[ListWidget] å‘ç° ${selectFields.length} ä¸ª select/multiselect å­—æ®µ`)
    
    // 2. éå†ï¼Œè®¢é˜…å®ƒä»¬çš„äº‹ä»¶
    selectFields.forEach(field => {
      // è®¢é˜…æœç´¢äº‹ä»¶
      if (field.callbacks?.includes('OnSelectFuzzy')) {
        this.subscribeSearchEvent(field)
      }
      
      // è®¢é˜…å˜åŒ–äº‹ä»¶ï¼ˆç”¨äºèšåˆï¼‰
      this.subscribeChangeEvent(field)
    })
  }
  
  /**
   * è®¢é˜…æœç´¢äº‹ä»¶
   * å½“å­ç»„ä»¶æœç´¢æ—¶ï¼ŒListWidget è´Ÿè´£è°ƒç”¨å›è°ƒ
   */
  private subscribeSearchEvent(field: FieldConfig) {
    // ğŸ”¥ ç›‘å¬æ‰€æœ‰è¡Œçš„è¯¥å­—æ®µçš„æœç´¢äº‹ä»¶
    const eventPattern = `field:search:${this.fieldPath}[].${field.code}`
    
    console.log(`[ListWidget] è®¢é˜…æœç´¢äº‹ä»¶: ${eventPattern}`)
    
    this.formManager.on(eventPattern, async (event: any) => {
      console.log(`[ListWidget] æ”¶åˆ°å­ç»„ä»¶æœç´¢äº‹ä»¶:`, event)
      // event = {
      //   fieldPath: 'products[2].product_id',  // å…·ä½“æ˜¯ç¬¬å‡ è¡Œ
      //   query: 'è‹¹æœ',
      //   callback: (options) => { ... }
      // }
      
      // 1. æ”¶é›†ä¸Šä¸‹æ–‡
      const listData = this.formManager.getFieldValue(this.fieldPath)
      const parentData = this.formManager.getAllValues()
      
      // 2. è°ƒç”¨å›è°ƒ
      try {
        const result = await this.callOnSelectFuzzy({
          field: field,
          fieldPath: event.fieldPath,
          query: event.query,
          context: {
            listData,
            parentData
          }
        })
        
        // 3. æ›´æ–°å­ç»„ä»¶é€‰é¡¹
        event.callback(result.options)
        
        // 4. ä¿å­˜èšåˆé…ç½®ï¼ˆå¦‚æœå›è°ƒè¿”å›äº†ï¼‰
        if (result.statistics) {
          this.statisticsConfig.value = result.statistics
        }
      } catch (error) {
        console.error(`[ListWidget] å›è°ƒå¤±è´¥:`, error)
        event.callback([])
      }
    })
  }
  
  /**
   * è®¢é˜…å˜åŒ–äº‹ä»¶
   * å½“å­ç»„ä»¶å€¼å˜åŒ–æ—¶ï¼Œé‡æ–°è®¡ç®—Listå±‚èšåˆ
   */
  private subscribeChangeEvent(field: FieldConfig) {
    // ğŸ”¥ ç›‘å¬æ‰€æœ‰è¡Œçš„è¯¥å­—æ®µçš„å˜åŒ–äº‹ä»¶
    const eventPattern = `field:change:${this.fieldPath}[].${field.code}`
    
    console.log(`[ListWidget] è®¢é˜…å˜åŒ–äº‹ä»¶: ${eventPattern}`)
    
    this.formManager.on(eventPattern, (event: any) => {
      console.log(`[ListWidget] æ”¶åˆ°å­ç»„ä»¶å˜åŒ–äº‹ä»¶:`, event)
      
      // ğŸ”¥ é‡æ–°è®¡ç®—èšåˆ
      this.recalculateStatistics()
    })
  }
  
  /**
   * é‡æ–°è®¡ç®—èšåˆï¼ˆListWidget çš„æ ¸å¿ƒèŒè´£ï¼‰
   * ğŸ”¥ æ³¨æ„ï¼šä¸å¤ç”¨å­ç»„ä»¶çš„ rowStatisticsï¼Œè‡ªå·±éå†è®¡ç®—
   */
  private recalculateStatistics() {
    const config = this.statisticsConfig.value
    if (!config || Object.keys(config).length === 0) {
      return
    }
    
    console.log(`[ListWidget] é‡æ–°è®¡ç®—èšåˆç»Ÿè®¡`)
    
    // 1. è·å–æ‰€æœ‰è¡Œçš„æ•°æ®
    const allRows = this.getAllRowsData()
    
    // 2. éå†èšåˆé…ç½®ï¼Œè®¡ç®—æ¯ä¸ªç»Ÿè®¡é¡¹
    const result: Record<string, any> = {}
    
    for (const [label, expression] of Object.entries(config)) {
      // ğŸ”¥ ä½¿ç”¨è¡¨è¾¾å¼è§£æå™¨è®¡ç®—
      // æ³¨æ„ï¼šè¿™é‡Œæ˜¯éå† allRows è®¡ç®—ï¼Œä¸æ˜¯å¤ç”¨ rowStatistics
      result[label] = ExpressionParser.evaluate(expression, allRows)
    }
    
    // 3. æ›´æ–°Listå±‚ç»Ÿè®¡
    this.listStatistics.value = result
    
    console.log(`[ListWidget] èšåˆç»Ÿè®¡ç»“æœ:`, result)
    
    // 4. å‘å‡ºListèšåˆå®Œæˆäº‹ä»¶ï¼ˆå¦‚æœçˆ¶ç»„ä»¶è¿˜éœ€è¦ï¼‰
    this.emit('list:statistics:updated', {
      statistics: result
    })
  }
  
  /**
   * è·å–æ‰€æœ‰è¡Œçš„æ•°æ®
   * åŒ…æ‹¬ï¼šå­—æ®µå€¼ + displayInfoï¼ˆä½†ä¸å¤ç”¨ rowStatisticsï¼‰
   */
  private getAllRowsData(): any[] {
    const allData: any[] = []
    
    for (const [index, rowManager] of this.rowManagers) {
      const row: Record<string, any> = {}
      
      // éå†è¯¥è¡Œçš„æ‰€æœ‰å­—æ®µ
      for (const [code, fieldValue] of rowManager.store) {
        // åŸå§‹å€¼
        row[code] = fieldValue.raw
        
        // ğŸ”¥ åˆå¹¶ displayInfoï¼ˆç”¨äºèšåˆè®¡ç®—ï¼‰
        if (fieldValue.meta?.displayInfo) {
          if (Array.isArray(fieldValue.meta.displayInfo)) {
            // MultiSelectï¼šdisplayInfo æ˜¯æ•°ç»„
            // è¿™é‡Œéœ€è¦ç‰¹æ®Šå¤„ç†ï¼šéå†æ•°ç»„ä¸­çš„æ¯ä¸ªå¯¹è±¡ï¼Œåˆå¹¶åˆ° row
            // æˆ–è€…ä¿ç•™ä¸ºæ•°ç»„ï¼Œåœ¨è¡¨è¾¾å¼è§£æå™¨ä¸­å¤„ç†
            row[`${code}_displayInfo`] = fieldValue.meta.displayInfo
          } else {
            // Selectï¼šdisplayInfo æ˜¯å¯¹è±¡
            Object.assign(row, fieldValue.meta.displayInfo)
          }
        }
        
        // âŒ ä¸å¤ç”¨ rowStatistics
        // åŸå› ï¼šListWidget éœ€è¦ç‹¬ç«‹è®¡ç®—ï¼Œä¿æŒå„è‡ªç‹¬ç«‹
      }
      
      allData.push(row)
    }
    
    return allData
  }
  
  private renderTable(): VNode {
    // æ¸²æŸ“è¡¨æ ¼çš„ä»£ç ...
  }
}
```

---

## äº‹ä»¶ç³»ç»Ÿ

### FormDataManager äº‹ä»¶æ”¯æŒ

```typescript
class ReactiveFormDataManager {
  private eventBus = new EventEmitter()
  
  /**
   * å‘å‡ºäº‹ä»¶
   */
  emit(eventType: string, payload: any): void {
    // å‘å‡ºå®Œæ•´äº‹ä»¶
    this.eventBus.emit(eventType, payload)
    
    // ğŸ”¥ åŒæ—¶å‘å‡ºæ¨¡ç³ŠåŒ¹é…äº‹ä»¶
    if (payload.fieldPath) {
      const pattern = this.convertToPattern(payload.fieldPath)
      this.eventBus.emit(`${eventType}:${pattern}`, payload)
    }
    
    console.log(`[FormDataManager] å‘å‡ºäº‹ä»¶: ${eventType}`, payload)
  }
  
  /**
   * ç›‘å¬äº‹ä»¶
   */
  on(eventPattern: string, handler: Function): () => void {
    this.eventBus.on(eventPattern, handler)
    
    console.log(`[FormDataManager] ç›‘å¬äº‹ä»¶: ${eventPattern}`)
    
    // è¿”å›å–æ¶ˆç›‘å¬å‡½æ•°
    return () => {
      this.eventBus.off(eventPattern, handler)
      console.log(`[FormDataManager] å–æ¶ˆç›‘å¬: ${eventPattern}`)
    }
  }
  
  /**
   * è½¬æ¢è·¯å¾„ä¸ºæ¨¡å¼
   * "products[2].product_id" â†’ "products[].product_id"
   */
  private convertToPattern(fieldPath: string): string {
    return fieldPath.replace(/\[\d+\]/g, '[]')
  }
}
```

### äº‹ä»¶ç±»å‹å®šä¹‰

```typescript
/**
 * äº‹ä»¶ç±»å‹
 */
type FormEvent = 
  | 'field:search'              // å­—æ®µæœç´¢äº‹ä»¶
  | 'field:change'              // å­—æ®µå˜åŒ–äº‹ä»¶
  | 'field:validate'            // å­—æ®µéªŒè¯äº‹ä»¶
  | 'field:focus'               // å­—æ®µèšç„¦äº‹ä»¶
  | 'field:blur'                // å­—æ®µå¤±ç„¦äº‹ä»¶
  | 'list:statistics:updated'   // Listèšåˆæ›´æ–°äº‹ä»¶
  | 'form:submit'               // è¡¨å•æäº¤äº‹ä»¶
  | 'form:reset'                // è¡¨å•é‡ç½®äº‹ä»¶

/**
 * äº‹ä»¶ Payload
 */
interface EventPayload {
  fieldPath: string             // å­—æ®µè·¯å¾„ï¼ˆç”± BaseWidget.emit è‡ªåŠ¨æ·»åŠ ï¼‰
  [key: string]: any            // å…¶ä»–æ•°æ®
}

/**
 * æœç´¢äº‹ä»¶ Payload
 */
interface SearchEventPayload extends EventPayload {
  query: string                 // æœç´¢å…³é”®è¯
  callback: (options: SelectOption[]) => void  // å›è°ƒå‡½æ•°
}

/**
 * å˜åŒ–äº‹ä»¶ Payload
 */
interface ChangeEventPayload extends EventPayload {
  value: any                    // æ–°å€¼
  displayInfo?: any             // display_info
  rowStatistics?: any           // è¡Œå†…ç»Ÿè®¡ï¼ˆä»…ä¾›å‚è€ƒï¼‰
}
```

---

## field_path çš„çœŸæ­£ä½œç”¨

### ä¸æ˜¯ç”¨äºè·¨ç»„ä»¶æ›´æ–°

```typescript
// âŒ é”™è¯¯ç†è§£ï¼ša ç»„ä»¶é€šè¿‡ field_path æ›´æ–° b ç»„ä»¶
class SelectWidget {
  handleChange(value: any) {
    this.formManager.updateField('other_field_path', value)  // âŒ ä¸åº”è¯¥è¿™æ ·
  }
}
```

### æ˜¯ç”¨äºäº‹ä»¶æ ‡è¯†

```typescript
// âœ… æ­£ç¡®ç†è§£ï¼šfield_path ç”¨äºäº‹ä»¶çš„å”¯ä¸€æ ‡è¯†ç¬¦

// 1. å‘å‡ºäº‹ä»¶æ—¶æºå¸¦ field_path
class SelectWidget {
  handleChange(value: any) {
    // æ›´æ–°è‡ªå·±
    this.onChange(value)
    
    // å‘å‡ºäº‹ä»¶ï¼ˆæºå¸¦ field_pathï¼‰
    this.emit('field:change', { value })
    // å®é™…å‘å‡ºçš„äº‹ä»¶ï¼š
    // - 'field:change:products[0].product_id'  ï¼ˆç²¾ç¡®è·¯å¾„ï¼‰
    // - 'field:change:products[].product_id'   ï¼ˆæ¨¡ç³Šè·¯å¾„ï¼‰
  }
}

// 2. çˆ¶ç»„ä»¶ç›‘å¬æ—¶ä½¿ç”¨ field_path æ¨¡å¼
class ListWidget {
  subscribeChildEvents() {
    // ç›‘å¬æ‰€æœ‰è¡Œçš„ product_id å˜åŒ–
    this.formManager.on('field:change:products[].product_id', (event) => {
      console.log('å“ªä¸€è¡Œ?', event.fieldPath)  // 'products[0].product_id'
      // å¯ä»¥åŒºåˆ†æ˜¯å“ªä¸€è¡Œè§¦å‘çš„
    })
    
    // ä¹Ÿå¯ä»¥ç›‘å¬ç‰¹å®šè¡Œ
    this.formManager.on('field:change:products[0].product_id', (event) => {
      console.log('ç¬¬0è¡Œçš„product_idå˜åŒ–äº†')
    })
  }
}
```

---

## æ‰©å±•æ€§

### æ–°å¢ç»„ä»¶ç±»å‹

```typescript
// å‡è®¾æ–°å¢äº† DateRangePicker ç»„ä»¶

class DateRangeWidget extends BaseWidget {
  render(): VNode {
    return h(ElDatePicker, {
      type: 'daterange',
      modelValue: this.value.raw,
      onChange: (dates: [Date, Date]) => this.handleChange(dates)
    })
  }
  
  handleChange(dates: [Date, Date]) {
    // 1. æ›´æ–°è‡ªå·±
    this.onChange({
      raw: dates,
      display: this.formatDateRange(dates),
      meta: { dataType: 'timestamp' }
    })
    
    // 2. å‘å‡ºå˜åŒ–äº‹ä»¶
    this.emit('field:change', { dates })
    
    // 3. å¯èƒ½éœ€è¦éªŒè¯æ—¥æœŸèŒƒå›´
    this.emit('field:validate', { dates })
  }
}
```

### ListWidget è®¢é˜…æ–°ç»„ä»¶äº‹ä»¶

```typescript
class ListWidget extends BaseWidget {
  private subscribeChildEvents() {
    // ç°æœ‰é€»è¾‘ï¼šè®¢é˜… select/multiselect
    const selectFields = this.findChildFieldsByType(['select', 'multiselect'])
    selectFields.forEach(field => {
      this.subscribeSearchEvent(field)
      this.subscribeChangeEvent(field)
    })
    
    // ğŸ†• æ–°å¢ï¼šè®¢é˜… daterange çš„éªŒè¯äº‹ä»¶
    const dateFields = this.findChildFieldsByType(['daterange'])
    dateFields.forEach(field => {
      this.subscribeDateValidateEvent(field)
    })
  }
  
  // ğŸ†• æ–°å¢æ–¹æ³•
  private subscribeDateValidateEvent(field: FieldConfig) {
    const eventPattern = `field:validate:${this.fieldPath}[].${field.code}`
    
    this.formManager.on(eventPattern, (event: any) => {
      console.log('[ListWidget] æ”¶åˆ°æ—¥æœŸéªŒè¯äº‹ä»¶:', event)
      
      // éªŒè¯é€»è¾‘ï¼šæ£€æŸ¥æ—¥æœŸèŒƒå›´æ˜¯å¦åˆç†
      const [start, end] = event.dates
      if (start > end) {
        // æ˜¾ç¤ºé”™è¯¯
      }
    })
  }
}
```

---

## èŒè´£æ€»ç»“

| ç»„ä»¶ | èŒè´£ | ä¸è¯¥åšçš„ | å‘å‡ºçš„äº‹ä»¶ |
|------|------|---------|-----------|
| **SelectWidget** | ç®¡ç†è‡ªå·±çš„å€¼<br>å‘å‡ºæœç´¢/å˜åŒ–äº‹ä»¶ | âŒ è°ƒç”¨å›è°ƒ<br>âŒ æ›´æ–°å…¶ä»–ç»„ä»¶ | `field:search`<br>`field:change` |
| **MultiSelectWidget** | ç®¡ç†è‡ªå·±çš„å€¼<br>è®¡ç®—è¡Œå†…èšåˆ<br>å‘å‡ºå˜åŒ–äº‹ä»¶ | âŒ è°ƒç”¨å›è°ƒ<br>âŒ æ›´æ–°å…¶ä»–ç»„ä»¶ | `field:change` |
| **ListWidget** | ç›‘å¬å­ç»„ä»¶äº‹ä»¶<br>è°ƒç”¨å›è°ƒ<br>è®¡ç®—Listå±‚èšåˆ | âŒ ä¸å…³å¿ƒå­ç»„ä»¶å†…éƒ¨å®ç° | `list:statistics:updated` |
| **FormDataManager** | å­˜å‚¨æ•°æ®<br>äº‹ä»¶æ€»çº¿<br>å“åº”å¼æ›´æ–° | âŒ ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ | - |

---

## æ•°æ®æµç¤ºä¾‹ï¼šæ”¶é“¶å°åœºæ™¯

```typescript
// åœºæ™¯ï¼šç”¨æˆ·åœ¨ç¬¬ 2 è¡Œé€‰æ‹©å•†å“

// 1. ç”¨æˆ·ç‚¹å‡» SelectWidget
SelectWidget (products[2].product_id) {
  handleOpenDialog() {
    // å‘å‡ºæœç´¢äº‹ä»¶
    this.emit('field:search', {
      query: '',
      callback: (options) => { this.options = options }
    })
  }
}

// 2. ListWidget æ”¶åˆ°äº‹ä»¶
ListWidget (products[]) {
  // è®¢é˜…çš„äº‹ä»¶è¢«è§¦å‘
  this.formManager.on('field:search:products[].product_id', (event) => {
    console.log('æ”¶åˆ°æœç´¢äº‹ä»¶:', event.fieldPath)  // 'products[2].product_id'
    
    // æ”¶é›†ä¸Šä¸‹æ–‡
    const listData = this.formManager.getFieldValue('products[]')
    const memberCard = this.formManager.getFieldValue('member_card_id')
    
    // è°ƒç”¨å›è°ƒ
    const result = await callOnSelectFuzzy({
      field: field,
      query: event.query,
      context: { listData, memberCard }
    })
    
    // æ›´æ–°å­ç»„ä»¶é€‰é¡¹
    event.callback(result.options)
    
    // ä¿å­˜èšåˆé…ç½®
    this.statisticsConfig = result.statistics
  })
}

// 3. SelectWidget æ”¶åˆ°é€‰é¡¹
SelectWidget (products[2].product_id) {
  // å›è°ƒè¢«è°ƒç”¨
  callback(options) {
    this.options = options  // æ›´æ–°é€‰é¡¹åˆ—è¡¨
  }
}

// 4. ç”¨æˆ·é€‰æ‹©å•†å“
SelectWidget (products[2].product_id) {
  handleSelect(option) {
    // æ›´æ–°è‡ªå·±
    this.onChange({ raw: option.value, display: option.label, ... })
    
    // å‘å‡ºå˜åŒ–äº‹ä»¶
    this.emit('field:change', {
      value: option.value,
      displayInfo: option.displayInfo
    })
  }
}

// 5. ListWidget æ”¶åˆ°å˜åŒ–äº‹ä»¶
ListWidget (products[]) {
  // è®¢é˜…çš„äº‹ä»¶è¢«è§¦å‘
  this.formManager.on('field:change:products[].product_id', (event) => {
    console.log('æ”¶åˆ°å˜åŒ–äº‹ä»¶:', event.fieldPath)  // 'products[2].product_id'
    
    // é‡æ–°è®¡ç®—èšåˆ
    this.recalculateStatistics()
  })
}

// 6. èšåˆè®¡ç®—
ListWidget (products[]) {
  recalculateStatistics() {
    const allRows = this.getAllRowsData()
    // [
    //   { product_id: 101, quantity: 2, ä»·æ ¼: 5.0 },
    //   { product_id: 102, quantity: 3, ä»·æ ¼: 8.0 },
    //   { product_id: 103, quantity: 1, ä»·æ ¼: 3.0 }  // åˆšé€‰çš„
    // ]
    
    const statistics = {}
    for (const [label, expr] of Object.entries(this.statisticsConfig)) {
      statistics[label] = ExpressionParser.evaluate(expr, allRows)
    }
    
    this.listStatistics = statistics
    // { å•†å“æ€»ä»·: 37.0, å•†å“æ€»æ•°: 6, ... }
  }
}
```

---

## æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿

âœ… **å°è£…æ€§** - ListWidget çš„èšåˆé€»è¾‘åœ¨å†…éƒ¨ï¼Œä¿®æ”¹èšåˆåªæ”¹ä¸€ä¸ªç±»  
âœ… **ç‹¬ç«‹æ€§** - å­ç»„ä»¶ç®—è‡ªå·±çš„ï¼Œçˆ¶ç»„ä»¶ç®—è‡ªå·±çš„ï¼Œäº’ä¸å½±å“  
âœ… **æ‰©å±•æ€§** - æ–°å¢äº‹ä»¶åªéœ€åœ¨ ListWidget æ–°å¢è®¢é˜…ï¼Œä¸å½±å“å…¶ä»–ç»„ä»¶  
âœ… **é€šç”¨æ€§** - `findChildFieldsByType` ç­‰æ–¹æ³•å¯å¤ç”¨  
âœ… **æ¸…æ™°æ€§** - ä¸å­˜åœ¨ a æ›´æ–° b çš„åœºæ™¯ï¼Œç¬¦åˆç›´è§‰  
âœ… **è§£è€¦** - å­ç»„ä»¶ä¸çŸ¥é“çˆ¶ç»„ä»¶çš„å­˜åœ¨ï¼Œçˆ¶ç»„ä»¶é€šè¿‡äº‹ä»¶äº†è§£å­ç»„ä»¶  

### è®¾è®¡åŸåˆ™

1. **å•å‘æ•°æ®æµ** - çˆ¶ â†’ å­ï¼ˆpropsï¼‰ï¼Œå­ â†’ çˆ¶ï¼ˆäº‹ä»¶ï¼‰
2. **èŒè´£æ¸…æ™°** - æ¯ä¸ªç»„ä»¶åªåšè‡ªå·±è¯¥åšçš„äº‹
3. **äº‹ä»¶é©±åŠ¨** - ç»„ä»¶é—´é€šè¿‡äº‹ä»¶é€šä¿¡ï¼Œä¸ç›´æ¥å¼•ç”¨
4. **ç‹¬ç«‹è®¡ç®—** - å„è‡ªè®¡ç®—å„è‡ªçš„èšåˆï¼Œä¸å¤ç”¨
5. **æ˜“äºæ‰©å±•** - æ–°å¢åŠŸèƒ½åªéœ€æ–°å¢è®¢é˜…ï¼Œä¸ä¿®æ”¹ç°æœ‰ä»£ç 

**è¿™ä¸ªæ¶æ„æ¸…æ™°ã€è§£è€¦ã€æ˜“æ‰©å±•ï¼Œå®Œç¾ç¬¦åˆ SOLID åŸåˆ™ï¼** ğŸ‰


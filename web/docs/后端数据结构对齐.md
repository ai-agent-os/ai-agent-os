# åç«¯æ•°æ®ç»“æ„å¯¹é½è¯´æ˜

## æ ¸å¿ƒåŸåˆ™

> **å‰ç«¯ FieldConfig å¿…é¡»ä¸åç«¯ Field ç»“æ„ 100% å¯¹åº”**
> 
> **ä¸è¦åœ¨å‰ç«¯æ·»åŠ åç«¯æ²¡æœ‰çš„å­—æ®µ**

---

## 1. åç«¯ Field ç»“æ„ï¼ˆGoï¼‰

```go
// sdk/agent-app/widget/field.go
type Field struct {
    Code            string     `json:"code"`             // å­—æ®µä»£ç 
    Desc            string     `json:"desc"`             // å­—æ®µæè¿°
    Name            string     `json:"name"`             // å­—æ®µåç§°
    Search          string     `json:"search"`           // æœç´¢é…ç½®
    Data            *FieldData `json:"data"`             // æ•°æ®ç±»å‹
    Widget          struct {
        Type   string      `json:"type"`               // Widget ç±»å‹
        Config interface{} `json:"config"`             // Widget é…ç½®
    } `json:"widget"`
    Callbacks       []string `json:"callbacks"`         // å›è°ƒåˆ—è¡¨
    TablePermission string   `json:"table_permission"`  // è¡¨æ ¼æƒé™
    Validation      string   `json:"validation"`        // éªŒè¯è§„åˆ™ï¼ˆå®Œå…¨ç…§æ¬ validator/v10ï¼‰
}

// FieldData
type FieldData struct {
    Type    string `json:"type"`      // string, int, bool, []string, []int, timestamp, float, files, struct, []struct
    Format  string `json:"format"`    // csv, markdown, json, yaml, html
    Example string `json:"example"`   // ç¤ºä¾‹æ•°æ®ï¼Œä¾‹å¦‚: "10", "ç´§æ€¥"
}
```

---

## 2. å‰ç«¯ FieldConfigï¼ˆTypeScriptï¼‰

```typescript
/**
 * å­—æ®µé…ç½®ï¼ˆä¸åç«¯ Field å®Œå…¨å¯¹åº”ï¼‰
 */
interface FieldConfig {
  // åŸºç¡€ä¿¡æ¯
  code: string
  name: string
  desc?: string
  search?: string
  
  // æ•°æ®ç±»å‹
  data: {
    type: string      // string, int, bool, []string, []int, []float, timestamp, float, files, struct, []struct
    format?: string   // csv, markdown, json, yaml, html
    example?: string  // ç¤ºä¾‹æ•°æ®
  }
  
  // Widget é…ç½®
  widget: {
    type: string      // input, text, text_area, select, switch, timestamp, user, ID, number, float, files, checkbox, radio
    config?: any      // æ¯ä¸ª Widget ç±»å‹æœ‰è‡ªå·±çš„é…ç½®
  }
  
  // å›è°ƒ
  callbacks?: string[]  // ["OnSelectFuzzy", "OnInputValidate"]
  
  // è¡¨æ ¼æƒé™
  table_permission?: '' | 'read' | 'update' | 'create'
  
  // éªŒè¯è§„åˆ™
  validation?: string   // "required,min=5,max=100,oneof=A B C,required_if=type urgent"
}
```

---

## 3. Widget ç±»å‹ä¸é…ç½®

### 3.1 åç«¯æ”¯æŒçš„ Widget ç±»å‹

```go
// sdk/agent-app/widget/widget.go
const (
    TypeInput     = "input"
    TypeText      = "text"
    TypeTextArea  = "text_area"
    TypeSelect    = "select"
    TypeSwitch    = "switch"
    TypeTimestamp = "timestamp"
    TypeUser      = "user"
    TypeID        = "ID"
    TypeNumber    = "number"
    TypeFloat     = "float"
    TypeFiles     = "files"
    TypeCheckbox  = "checkbox"
    TypeRadio     = "radio"
)
```

### 3.2 Input Widget Config

```go
// åç«¯
type Input struct {
    Placeholder string `json:"placeholder"`
    Password    bool   `json:"password"`
    Prepend     string `json:"prepend"`
    Append      string `json:"append"`
    Default     string `json:"default"`
}
```

```typescript
// å‰ç«¯
interface InputConfig {
  placeholder?: string
  password?: boolean
  prepend?: string
  append?: string
  default?: string
}
```

### 3.3 Select Widget Config

```go
// åç«¯
type Select struct {
    Options     []string `json:"options"`
    Placeholder string   `json:"placeholder"`
    Default     string   `json:"default"`
}
```

```typescript
// å‰ç«¯
interface SelectConfig {
  options?: string[]    // é™æ€é€‰é¡¹åˆ—è¡¨
  placeholder?: string
  default?: string
}
```

---

## 4. æ•°æ®ç±»å‹å¯¹åº”å…³ç³»

| åç«¯ Go ç±»å‹ | å‰ç«¯ TypeScript ç±»å‹ | è¯´æ˜ |
|-------------|---------------------|-----|
| `string` | `string` | å­—ç¬¦ä¸² |
| `int` | `number` | æ•´æ•° |
| `bool` | `boolean` | å¸ƒå°”å€¼ |
| `float` | `number` | æµ®ç‚¹æ•° |
| `[]string` | `string[]` | å­—ç¬¦ä¸²æ•°ç»„ |
| `[]int` | `number[]` | æ•´æ•°æ•°ç»„ |
| `[]float` | `number[]` | æµ®ç‚¹æ•°ç»„ |
| `timestamp` | `string` æˆ– `number` | æ—¶é—´æˆ³ |
| `files` | `File[]` | æ–‡ä»¶åˆ—è¡¨ |
| `struct` | `object` | ç»“æ„ä½“ |
| `[]struct` | `object[]` | ç»“æ„ä½“æ•°ç»„ï¼ˆListï¼‰ |

---

## 5. æ¡ä»¶æ¸²æŸ“çš„å¤„ç†

### 5.1 åç«¯çš„æ–¹å¼

åç«¯æŠŠæ¡ä»¶ç›´æ¥å†™åœ¨ `validation` å­—ç¬¦ä¸²ä¸­ï¼š

```go
validation: "required_if=type urgent"     // å½“ type=urgent æ—¶å¿…å¡«
validation: "excluded_if=type software"   // å½“ type=software æ—¶éšè—
```

### 5.2 å‰ç«¯çš„å¤„ç†

**å‰ç«¯ä¸åº”è¯¥åœ¨ FieldConfig ä¸­æ·»åŠ  `conditions` å­—æ®µï¼**

```typescript
// âŒ é”™è¯¯ï¼šæ·»åŠ åç«¯æ²¡æœ‰çš„å­—æ®µ
interface FieldConfig {
  conditions?: {
    visible?: { ... }
    required?: { ... }
  }
}

// âœ… æ­£ç¡®ï¼šä» validation å­—ç¬¦ä¸²ä¸­è§£æ
function parseConditionsFromValidation(validation: string) {
  // è§£æ required_if, excluded_if ç­‰
  const requiredIfMatch = validation.match(/required_if=(\w+)\s+(.+?)(?:,|$)/)
  const excludedIfMatch = validation.match(/excluded_if=(\w+)\s+(.+?)(?:,|$)/)
  
  return {
    requiredIf: requiredIfMatch ? { field: requiredIfMatch[1], values: requiredIfMatch[2].split(/\s+/) } : null,
    excludedIf: excludedIfMatch ? { field: excludedIfMatch[1], values: excludedIfMatch[2].split(/\s+/) } : null
  }
}
```

---

## 6. å­—æ®µè”åŠ¨çš„å¤„ç†

### 6.1 å‰ç«¯ä¸åº”è¯¥æ·»åŠ  linkage å­—æ®µ

```typescript
// âŒ é”™è¯¯ï¼šæ·»åŠ åç«¯æ²¡æœ‰çš„å­—æ®µ
interface FieldConfig {
  linkage?: {
    watch?: string[]
    onChange?: LinkageAction[]
  }
}

// âœ… æ­£ç¡®ï¼šåœ¨ FormDataManager ä¸­ä½¿ç”¨ watch æœºåˆ¶
formManager.watch('province', (newVal, oldVal) => {
  if (newVal?.raw !== oldVal?.raw) {
    // çœä»½å˜åŒ–ï¼Œæ¸…ç©ºåŸå¸‚
    formManager.setValue('city', null)
    formManager.setValue('district', null)
  }
})
```

---

## 7. æäº¤æ•°æ®æ ¼å¼

### 7.1 å‰ç«¯å†…éƒ¨å­˜å‚¨

```typescript
// FormDataManager å†…éƒ¨å­˜å‚¨ï¼ˆFieldValue æ ¼å¼ï¼‰
{
  name: {
    raw: "å¼ ä¸‰",
    display: "å¼ ä¸‰",
    meta: { dataType: "string" }
  },
  department: {
    raw: 1,
    display: "æŠ€æœ¯éƒ¨",
    meta: {
      dataType: "int",
      displayInfo: { id: 1, name: "æŠ€æœ¯éƒ¨", manager: "æå››" }
    }
  }
}
```

### 7.2 æäº¤ç»™åç«¯

```typescript
// prepareSubmitData() è‡ªåŠ¨æå– raw å€¼
{
  "name": "å¼ ä¸‰",
  "department": 1
}
```

åç«¯æ¥æ”¶åˆ°çš„å°±æ˜¯ç®€å•çš„ `map[string]interface{}`ï¼Œå®Œå…¨ç¬¦åˆé¢„æœŸï¼âœ…

---

## 8. å›è°ƒæ•°æ®æ ¼å¼

### 8.1 OnSelectFuzzy å›è°ƒè¯·æ±‚

```typescript
// å‰ç«¯å‘é€
{
  "search_value": "å¼ ",
  "context": {
    "department": 1,      // ğŸ”¥ è‡ªåŠ¨ä¼ é€’å®Œæ•´çš„è¡¨å•æ•°æ®
    "role": "å¼€å‘"
  }
}
```

### 8.2 OnSelectFuzzy å›è°ƒå“åº”

```go
// åç«¯è¿”å›
{
  "values": [
    {
      "value": 1,
      "label": "å¼ ä¸‰",
      "display_info": {
        "id": 1,
        "name": "å¼ ä¸‰",
        "department": "æŠ€æœ¯éƒ¨",
        "role": "å¼€å‘"
      }
    }
  ],
  "statistics": {
    "æ€»äººæ•°": "count(*)",
    "å¹³å‡å·¥èµ„": "avg(salary)"
  }
}
```

```typescript
// å‰ç«¯å¤„ç†
formManager.setValue('user', {
  raw: 1,                    // value
  display: "å¼ ä¸‰",           // label
  meta: {
    dataType: "int",
    displayInfo: {           // ğŸ”¥ ä¿å­˜ display_infoï¼Œç”¨äº tooltip ç­‰
      id: 1,
      name: "å¼ ä¸‰",
      department: "æŠ€æœ¯éƒ¨",
      role: "å¼€å‘"
    },
    fromCallback: true
  }
})
```

---

## 9. æ ¸å¿ƒè¦ç‚¹æ€»ç»“

### âœ… åº”è¯¥åšçš„

1. **FieldConfig ä¸åç«¯ Field å®Œå…¨å¯¹åº”** - å­—æ®µåã€ç±»å‹éƒ½ä¸€è‡´
2. **Widget Config ä¸åç«¯å¯¹åº”** - æ¯ä¸ª Widget æœ‰è‡ªå·±çš„é…ç½®ç»“æ„
3. **ä» validation è§£ææ¡ä»¶** - ä¸æ·»åŠ é¢å¤–çš„ conditions å­—æ®µ
4. **ä½¿ç”¨ watch æœºåˆ¶å¤„ç†è”åŠ¨** - ä¸æ·»åŠ é¢å¤–çš„ linkage å­—æ®µ
5. **FieldValue å‰ç«¯å†…éƒ¨ä½¿ç”¨** - æäº¤æ—¶è‡ªåŠ¨è½¬æ¢ä¸ºç®€å•æ ¼å¼
6. **å›è°ƒè‡ªåŠ¨ä¼ é€’å®Œæ•´ä¸Šä¸‹æ–‡** - `getAllRawValues()` è‡ªåŠ¨è·å–

### âŒ ä¸åº”è¯¥åšçš„

1. **ä¸è¦åœ¨ FieldConfig ä¸­æ·»åŠ  `conditions`** - åç«¯æ²¡æœ‰è¿™ä¸ªå­—æ®µ
2. **ä¸è¦åœ¨ FieldConfig ä¸­æ·»åŠ  `linkage`** - åç«¯æ²¡æœ‰è¿™ä¸ªå­—æ®µ
3. **ä¸è¦ä¿®æ”¹åç«¯è¿”å›çš„ JSON ç»“æ„** - ä¿æŒåŸæ ·
4. **ä¸è¦åœ¨æäº¤æ•°æ®ä¸­åŒ…å« `display` æˆ– `meta`** - åªæäº¤ `raw` å€¼

---

## 10. å®ç°æ£€æŸ¥æ¸…å•

åœ¨å®ç°å‰ç«¯æ—¶ï¼Œç¡®ä¿ï¼š

- [ ] FieldConfig æ¥å£ä¸åç«¯ Field å®Œå…¨å¯¹åº”
- [ ] Widget Config æ¥å£ä¸åç«¯å¯¹åº”
- [ ] æ•°æ®ç±»å‹æ˜ å°„æ­£ç¡®
- [ ] ä» validation å­—ç¬¦ä¸²è§£ææ¡ä»¶æ¸²æŸ“
- [ ] ä½¿ç”¨ FormDataManager.watch å¤„ç†å­—æ®µè”åŠ¨
- [ ] prepareSubmitData() åªæå– raw å€¼
- [ ] å›è°ƒè¯·æ±‚è‡ªåŠ¨ä¼ é€’å®Œæ•´ä¸Šä¸‹æ–‡ï¼ˆgetAllRawValuesï¼‰
- [ ] å›è°ƒå“åº”ä¿å­˜ displayInfo åˆ° meta
- [ ] el-form ç»‘å®š Proxy å¯¹è±¡
- [ ] Widget ä½¿ç”¨ :value å’Œ @changeï¼Œä¸ç”¨ v-model

---

**å®Œå…¨å¯¹é½åç«¯ï¼Œç®€å•æ¸…æ™°ï¼** âœ…


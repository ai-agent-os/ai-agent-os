# å­—æ®µè·¯å¾„å¢å¼ºå™¨ï¼ˆFieldPathEnhancerï¼‰

## æ ¸å¿ƒé—®é¢˜

### ä¸ºä»€ä¹ˆéœ€è¦å­—æ®µè·¯å¾„ï¼Ÿ

åœ¨å¤æ‚çš„è¡¨å•ç³»ç»Ÿä¸­ï¼Œå­—æ®µä¹‹é—´å­˜åœ¨å¤§é‡çš„è”åŠ¨å…³ç³»ï¼š

```typescript
// é—®é¢˜ 1ï¼šå¦‚ä½•å”¯ä¸€æ ‡è¯†åµŒå¥—å­—æ®µï¼Ÿ
{
  products: [
    { product_id: 101, quantity: 2 },  // è¿™ä¸ª product_id
    { product_id: 102, quantity: 3 }   // å’Œè¿™ä¸ª product_id å¦‚ä½•åŒºåˆ†ï¼Ÿ
  ]
}

// é—®é¢˜ 2ï¼šå¦‚ä½•é…ç½®å­—æ®µè”åŠ¨ï¼Ÿ
// "å½“çœä»½å˜åŒ–æ—¶ï¼Œæ¸…ç©ºåŸå¸‚å’ŒåŒºå¿"
// éœ€è¦æ˜ç¡®çŸ¥é“è¿™ä¸‰ä¸ªå­—æ®µçš„å”¯ä¸€æ ‡è¯†

// é—®é¢˜ 3ï¼šå¦‚ä½•ç›‘å¬ç‰¹å®šå­—æ®µçš„å˜åŒ–ï¼Ÿ
// ç›‘å¬ç¬¬ 0 è¡Œçš„ product_id å˜åŒ–ï¼Ÿè¿˜æ˜¯æ‰€æœ‰è¡Œçš„ï¼Ÿ

// é—®é¢˜ 4ï¼šè°ƒè¯•å’Œæ—¥å¿—å¦‚ä½•æ¸…æ™°ï¼Ÿ
console.log('å­—æ®µå˜åŒ–:', fieldCode)  // âŒ ä¸çŸ¥é“æ˜¯å“ªä¸ªå­—æ®µ
console.log('å­—æ®µå˜åŒ–:', fieldPath)  // âœ… "products[0].product_id"
```

### è§£å†³æ–¹æ¡ˆ

**ä¸ºæ¯ä¸ªå­—æ®µç”Ÿæˆå”¯ä¸€çš„ `field_path`**

```typescript
// é¡¶å±‚å­—æ®µ
"member_card_id"

// List å­—æ®µ
"products[]"

// List å†…å­—æ®µ
"products[].product_id"
"products[].quantity"

// Struct å†…å­—æ®µ
"user_profile.name"
"user_profile.email"

// List å†… Struct
"orders[].customer.name"
```

---

## è®¾è®¡æ–¹æ¡ˆ

### æ–¹æ¡ˆé€‰æ‹©ï¼šå‰ç«¯è‡ªåŠ¨å¢å¼º

**ä¸ºä»€ä¹ˆä¸è®©åç«¯è¿”å›ï¼Ÿ**
- åç«¯æ¡†æ¶æ”¹åŠ¨æˆæœ¬é«˜
- å‰ç«¯éœ€è¦çš„ä¿¡æ¯ä¸ä¸€å®šæ˜¯åç«¯éœ€è¦çš„
- å‰ç«¯å¯ä»¥æ ¹æ®éœ€è¦çµæ´»æ‰©å±•

**å‰ç«¯è‡ªåŠ¨å¢å¼ºçš„ä¼˜åŠ¿ï¼š**
- âœ… åç«¯æ— éœ€æ”¹åŠ¨
- âœ… å‰ç«¯å®Œå…¨æ§åˆ¶
- âœ… çµæ´»æ‰©å±•
- âœ… ç»Ÿä¸€å¤„ç†

---

## å®ç°æ–¹æ¡ˆ

### 1. å­—æ®µè·¯å¾„å¢å¼ºå™¨

```typescript
/**
 * å­—æ®µè·¯å¾„å¢å¼ºå™¨
 * åœ¨è·å–å‡½æ•°è¯¦æƒ…åï¼Œè‡ªåŠ¨ä¸ºæ¯ä¸ªå­—æ®µæ·»åŠ  field_pathã€parent_pathã€depth ç­‰ä¿¡æ¯
 */
class FieldPathEnhancer {
  /**
   * å¢å¼ºå‡½æ•°è¯¦æƒ…
   * @param functionDetail åç«¯è¿”å›çš„å‡½æ•°è¯¦æƒ…
   * @returns å¢å¼ºåçš„å‡½æ•°è¯¦æƒ…
   */
  enhance(functionDetail: FunctionDetail): FunctionDetail {
    console.log('[FieldPathEnhancer] å¼€å§‹å¢å¼ºå­—æ®µé…ç½®')
    
    const enhanced = { ...functionDetail }
    
    // å¢å¼ºè¯·æ±‚å­—æ®µ
    if (enhanced.request) {
      enhanced.request = this.enhanceFields(
        enhanced.request,
        '',      // parentPath
        0        // depth
      )
    }
    
    // å¢å¼ºå“åº”å­—æ®µ
    if (enhanced.response) {
      enhanced.response = this.enhanceFields(
        enhanced.response,
        '',
        0
      )
    }
    
    console.log('[FieldPathEnhancer] å¢å¼ºå®Œæˆ')
    return enhanced
  }
  
  /**
   * å¢å¼ºå­—æ®µåˆ—è¡¨
   * @param fields å­—æ®µåˆ—è¡¨
   * @param parentPath çˆ¶å­—æ®µè·¯å¾„
   * @param depth å½“å‰æ·±åº¦
   * @returns å¢å¼ºåçš„å­—æ®µåˆ—è¡¨
   */
  private enhanceFields(
    fields: FieldConfig[],
    parentPath: string,
    depth: number
  ): FieldConfig[] {
    return fields.map((field, index) => 
      this.enhanceField(field, parentPath, depth, index)
    )
  }
  
  /**
   * å¢å¼ºå•ä¸ªå­—æ®µ
   * @param field åŸå§‹å­—æ®µ
   * @param parentPath çˆ¶å­—æ®µè·¯å¾„
   * @param depth å½“å‰æ·±åº¦
   * @param indexInParent åœ¨çˆ¶å­—æ®µä¸­çš„ç´¢å¼•
   * @returns å¢å¼ºåçš„å­—æ®µ
   */
  private enhanceField(
    field: FieldConfig,
    parentPath: string,
    depth: number,
    indexInParent: number
  ): FieldConfig {
    // ğŸ”¥ ç”Ÿæˆ field_path
    const fieldPath = this.buildFieldPath(field, parentPath)
    
    // ğŸ”¥ å¢å¼ºå­—æ®µé…ç½®
    const enhancedField: FieldConfig = {
      ...field,
      
      // æ–°å¢å­—æ®µ
      field_path: fieldPath,
      parent_path: parentPath || undefined,
      depth: depth,
      index_in_parent: indexInParent,
      
      // è§£æ meta ä¿¡æ¯
      meta: {
        ...field.meta,
        required: this.isRequired(field.validation),
        readonly: this.isReadonly(field),
        disabled: this.isDisabled(field),
        searchable: !!field.search,
        sortable: this.isSortable(field),
        placeholder: this.getPlaceholder(field)
      }
    }
    
    // ğŸ”¥ é€’å½’å¤„ç†å­å­—æ®µ
    if (field.sub_fields && field.sub_fields.length > 0) {
      enhancedField.sub_fields = this.enhanceFields(
        field.sub_fields,
        fieldPath,        // å½“å‰å­—æ®µè·¯å¾„ä½œä¸ºå­å­—æ®µçš„ parentPath
        depth + 1         // æ·±åº¦ +1
      )
    }
    
    console.log(
      `[FieldPathEnhancer] ${field.code} â†’ ${fieldPath} ` +
      `(depth: ${depth}, parent: ${parentPath || 'root'})`
    )
    
    return enhancedField
  }
  
  /**
   * æ„å»ºå­—æ®µè·¯å¾„
   * @param field å­—æ®µ
   * @param parentPath çˆ¶å­—æ®µè·¯å¾„
   * @returns å­—æ®µè·¯å¾„
   */
  private buildFieldPath(field: FieldConfig, parentPath: string): string {
    const isListType = this.isListType(field)
    
    if (!parentPath) {
      // é¡¶å±‚å­—æ®µ
      return isListType ? `${field.code}[]` : field.code
    }
    
    // æ‹¼æ¥è·¯å¾„
    const separator = parentPath.endsWith('[]') ? '.' : '.'
    const fieldCode = isListType ? `${field.code}[]` : field.code
    
    return `${parentPath}${separator}${fieldCode}`
  }
  
  /**
   * åˆ¤æ–­æ˜¯å¦æ˜¯ List ç±»å‹
   */
  private isListType(field: FieldConfig): boolean {
    return field.data.type.startsWith('[]') || 
           field.widget.type === 'list'
  }
  
  /**
   * åˆ¤æ–­æ˜¯å¦å¿…å¡«
   */
  private isRequired(validation?: string): boolean {
    if (!validation) return false
    
    // ä» validation å­—ç¬¦ä¸²è§£æ
    // "required,min=5" â†’ true
    // "min=5,max=10" â†’ false
    return /\brequired\b/.test(validation)
  }
  
  /**
   * åˆ¤æ–­æ˜¯å¦åªè¯»
   */
  private isReadonly(field: FieldConfig): boolean {
    return field.table_permission === 'read'
  }
  
  /**
   * åˆ¤æ–­æ˜¯å¦ç¦ç”¨
   */
  private isDisabled(field: FieldConfig): boolean {
    // å¯ä»¥æ ¹æ®ä¸šåŠ¡è§„åˆ™åˆ¤æ–­
    // ä¾‹å¦‚ï¼šæŸäº›çŠ¶æ€ä¸‹ç¦ç”¨æŸäº›å­—æ®µ
    return false
  }
  
  /**
   * åˆ¤æ–­æ˜¯å¦å¯æ’åº
   */
  private isSortable(field: FieldConfig): boolean {
    // åŸºç¡€ç±»å‹å¯æ’åº
    const sortableTypes = ['string', 'int', 'float', 'timestamp', 'bool']
    return sortableTypes.includes(field.data.type)
  }
  
  /**
   * è·å– placeholder
   */
  private getPlaceholder(field: FieldConfig): string {
    // æ ¹æ®ç»„ä»¶ç±»å‹ç”Ÿæˆé»˜è®¤ placeholder
    const widgetType = field.widget.type
    
    switch (widgetType) {
      case 'input':
      case 'text':
        return `è¯·è¾“å…¥${field.name}`
      case 'select':
      case 'multiselect':
        return `è¯·é€‰æ‹©${field.name}`
      case 'timestamp':
        return `è¯·é€‰æ‹©${field.name}`
      case 'number':
      case 'float':
        return `è¯·è¾“å…¥${field.name}`
      default:
        return ''
    }
  }
}

// å•ä¾‹
export const fieldPathEnhancer = new FieldPathEnhancer()
```

---

## å­—æ®µè·¯å¾„æ ¼å¼è§„èŒƒ

### è·¯å¾„æ ¼å¼

| åœºæ™¯ | æ ¼å¼ | ç¤ºä¾‹ |
|-----|------|------|
| é¡¶å±‚å­—æ®µ | `field_code` | `member_card_id` |
| é¡¶å±‚ List | `list_code[]` | `products[]` |
| List å†…å­—æ®µ | `list_code[].field_code` | `products[].product_id` |
| é¡¶å±‚ Struct | `struct_code` | `user_profile` |
| Struct å†…å­—æ®µ | `struct_code.field_code` | `user_profile.name` |
| List å†… Struct | `list_code[].struct_code` | `orders[].customer` |
| List å†… Struct å†…å­—æ®µ | `list_code[].struct_code.field_code` | `orders[].customer.name` |
| å¤šå±‚åµŒå¥— | `list_code[].struct_code.list_code[].field_code` | `dept[].teams[].members[].name` |

### è·¯å¾„å®ä¾‹åŒ–ï¼ˆè¿è¡Œæ—¶ï¼‰

```typescript
// æ¨¡æ¿è·¯å¾„ï¼ˆé…ç½®ä¸­çš„è·¯å¾„ï¼‰
"products[].product_id"

// å®ä¾‹åŒ–è·¯å¾„ï¼ˆè¿è¡Œæ—¶çš„è·¯å¾„ï¼‰
"products[0].product_id"  // ç¬¬ 0 è¡Œ
"products[1].product_id"  // ç¬¬ 1 è¡Œ
"products[2].product_id"  // ç¬¬ 2 è¡Œ

// å®ä¾‹åŒ–æ–¹æ³•
function instantiatePath(templatePath: string, index: number): string {
  return templatePath.replace('[]', `[${index}]`)
}
```

---

## åœ¨ API ä¸­ä½¿ç”¨

### API å°è£…

```typescript
/**
 * è·å–å‡½æ•°è¯¦æƒ…ï¼ˆå¢å¼ºç‰ˆï¼‰
 */
export async function getFunctionDetail(
  namespace: string,
  appName: string,
  functionCode: string
): Promise<FunctionDetail> {
  const url = `/api/v1/function/${namespace}/${appName}/${functionCode}`
  
  console.log('[API] è·å–å‡½æ•°è¯¦æƒ…:', url)
  
  try {
    // 1. è°ƒç”¨åç«¯ API
    const response = await get<FunctionDetail>(url)
    
    console.log('[API] åç«¯è¿”å›:', {
      template_type: response.template_type,
      method: response.method,
      request_fields: response.request?.length || 0,
      response_fields: response.response?.length || 0
    })
    
    // ğŸ”¥ 2. å¢å¼ºå­—æ®µé…ç½®
    const enhancedResponse = fieldPathEnhancer.enhance(response)
    
    console.log('[API] å¢å¼ºå®Œæˆ:', {
      request_fields: enhancedResponse.request?.map(f => f.field_path),
      response_fields: enhancedResponse.response?.map(f => f.field_path)
    })
    
    return enhancedResponse
    
  } catch (error) {
    console.error('[API] è·å–å‡½æ•°è¯¦æƒ…å¤±è´¥:', error)
    throw error
  }
}
```

---

## å¢å¼ºå‰åå¯¹æ¯”

### ç¤ºä¾‹ï¼šæ”¶é“¶å°åœºæ™¯

#### å¢å¼ºå‰ï¼ˆåç«¯è¿”å›ï¼‰

```json
{
  "template_type": "form",
  "method": "POST",
  "router": "/api/cashier",
  "request": [
    {
      "code": "member_card_id",
      "name": "ä¼šå‘˜å¡",
      "data": { "type": "int" },
      "widget": { "type": "select" },
      "callbacks": ["OnSelectFuzzy"],
      "validation": "required"
    },
    {
      "code": "products",
      "name": "å•†å“æ¸…å•",
      "data": { "type": "[]struct" },
      "widget": { "type": "list" },
      "validation": "required,min=1",
      "sub_fields": [
        {
          "code": "product_id",
          "name": "å•†å“",
          "data": { "type": "int" },
          "widget": { "type": "select" },
          "callbacks": ["OnSelectFuzzy"],
          "validation": "required"
        },
        {
          "code": "quantity",
          "name": "æ•°é‡",
          "data": { "type": "int" },
          "widget": { "type": "number" },
          "validation": "required,min=1"
        }
      ]
    },
    {
      "code": "remarks",
      "name": "å¤‡æ³¨",
      "data": { "type": "string" },
      "widget": { "type": "text_area" }
    }
  ]
}
```

#### å¢å¼ºåï¼ˆå‰ç«¯å¤„ç†ï¼‰

```json
{
  "template_type": "form",
  "method": "POST",
  "router": "/api/cashier",
  "request": [
    {
      "code": "member_card_id",
      "name": "ä¼šå‘˜å¡",
      "field_path": "member_card_id",          // ğŸ”¥ æ–°å¢
      "parent_path": undefined,                // ğŸ”¥ æ–°å¢
      "depth": 0,                              // ğŸ”¥ æ–°å¢
      "index_in_parent": 0,                    // ğŸ”¥ æ–°å¢
      "data": { "type": "int" },
      "widget": { "type": "select" },
      "callbacks": ["OnSelectFuzzy"],
      "validation": "required",
      "meta": {                                // ğŸ”¥ æ–°å¢
        "required": true,
        "readonly": false,
        "disabled": false,
        "searchable": false,
        "sortable": true,
        "placeholder": "è¯·é€‰æ‹©ä¼šå‘˜å¡"
      }
    },
    {
      "code": "products",
      "name": "å•†å“æ¸…å•",
      "field_path": "products[]",              // ğŸ”¥ æ–°å¢ï¼ˆList ç±»å‹ï¼Œåç¼€ []ï¼‰
      "parent_path": undefined,                // ğŸ”¥ æ–°å¢
      "depth": 0,                              // ğŸ”¥ æ–°å¢
      "index_in_parent": 1,                    // ğŸ”¥ æ–°å¢
      "data": { "type": "[]struct" },
      "widget": { "type": "list" },
      "validation": "required,min=1",
      "meta": {                                // ğŸ”¥ æ–°å¢
        "required": true,
        "readonly": false,
        "disabled": false
      },
      "sub_fields": [
        {
          "code": "product_id",
          "name": "å•†å“",
          "field_path": "products[].product_id", // ğŸ”¥ æ–°å¢ï¼ˆåµŒå¥—è·¯å¾„ï¼‰
          "parent_path": "products[]",           // ğŸ”¥ æ–°å¢ï¼ˆçˆ¶è·¯å¾„ï¼‰
          "depth": 1,                            // ğŸ”¥ æ–°å¢ï¼ˆæ·±åº¦ 1ï¼‰
          "index_in_parent": 0,                  // ğŸ”¥ æ–°å¢
          "data": { "type": "int" },
          "widget": { "type": "select" },
          "callbacks": ["OnSelectFuzzy"],
          "validation": "required",
          "meta": {                              // ğŸ”¥ æ–°å¢
            "required": true,
            "readonly": false,
            "disabled": false,
            "searchable": false,
            "sortable": true,
            "placeholder": "è¯·é€‰æ‹©å•†å“"
          }
        },
        {
          "code": "quantity",
          "name": "æ•°é‡",
          "field_path": "products[].quantity",   // ğŸ”¥ æ–°å¢
          "parent_path": "products[]",           // ğŸ”¥ æ–°å¢
          "depth": 1,                            // ğŸ”¥ æ–°å¢
          "index_in_parent": 1,                  // ğŸ”¥ æ–°å¢
          "data": { "type": "int" },
          "widget": { "type": "number" },
          "validation": "required,min=1",
          "meta": {                              // ğŸ”¥ æ–°å¢
            "required": true,
            "readonly": false,
            "disabled": false,
            "searchable": false,
            "sortable": true,
            "placeholder": "è¯·è¾“å…¥æ•°é‡"
          }
        }
      ]
    },
    {
      "code": "remarks",
      "name": "å¤‡æ³¨",
      "field_path": "remarks",                 // ğŸ”¥ æ–°å¢
      "parent_path": undefined,                // ğŸ”¥ æ–°å¢
      "depth": 0,                              // ğŸ”¥ æ–°å¢
      "index_in_parent": 2,                    // ğŸ”¥ æ–°å¢
      "data": { "type": "string" },
      "widget": { "type": "text_area" },
      "meta": {                                // ğŸ”¥ æ–°å¢
        "required": false,
        "readonly": false,
        "disabled": false,
        "searchable": false,
        "sortable": false,
        "placeholder": "è¯·è¾“å…¥å¤‡æ³¨"
      }
    }
  ]
}
```

---

## ä½¿ç”¨åœºæ™¯

### 1. FormDataManager ä½¿ç”¨ field_path

```typescript
class ReactiveFormDataManager {
  // ğŸ”¥ ä½¿ç”¨ field_path ä½œä¸º key
  private store = reactive(new Map<string, FieldValue>())
  
  /**
   * æ³¨å†Œå­—æ®µ
   */
  registerField(field: FieldConfig) {
    const fieldPath = field.field_path || field.code
    
    if (!this.store.has(fieldPath)) {
      // åˆå§‹åŒ–å­—æ®µå€¼
      this.store.set(fieldPath, {
        raw: field.data.example || this.getDefaultValue(field),
        display: '',
        meta: {
          dataType: field.data.type
        }
      })
      
      console.log(`[FormDataManager] æ³¨å†Œå­—æ®µ: ${fieldPath}`)
    }
  }
  
  /**
   * è·å–å€¼
   */
  getValue(fieldPath: string): FieldValue | undefined {
    return this.store.get(fieldPath)
  }
  
  /**
   * è®¾ç½®å€¼
   */
  setValue(fieldPath: string, value: any, silent = false) {
    const oldValue = this.store.get(fieldPath)
    const newValue = this.normalizeValue(value)
    
    this.store.set(fieldPath, newValue)
    
    if (!silent) {
      this.notifyWatchers(fieldPath, newValue, oldValue)
    }
    
    console.log(`[FormDataManager] è®¾ç½®å€¼: ${fieldPath}`, {
      old: oldValue?.raw,
      new: newValue.raw
    })
  }
  
  /**
   * ç›‘å¬å­—æ®µå˜åŒ–
   */
  watch(fieldPath: string, callback: WatchCallback): () => void {
    // æ”¯æŒé€šé…ç¬¦
    // watch("products[].product_id", ...) ç›‘å¬æ‰€æœ‰è¡Œçš„ product_id
    // watch("products[0].product_id", ...) åªç›‘å¬ç¬¬0è¡Œçš„ product_id
    
    console.log(`[FormDataManager] ç›‘å¬å­—æ®µ: ${fieldPath}`)
    
    // è¿”å›å–æ¶ˆç›‘å¬å‡½æ•°
    return () => {
      console.log(`[FormDataManager] å–æ¶ˆç›‘å¬: ${fieldPath}`)
    }
  }
}
```

### 2. å­—æ®µè”åŠ¨ä½¿ç”¨ field_path

```typescript
/**
 * å­—æ®µè”åŠ¨å¼•æ“
 */
class LinkageEngine {
  /**
   * è®¾ç½®å­—æ®µè”åŠ¨
   * @param fields æ‰€æœ‰å­—æ®µé…ç½®
   * @param formManager è¡¨å•æ•°æ®ç®¡ç†å™¨
   */
  setup(fields: FieldConfig[], formManager: ReactiveFormDataManager) {
    // éå†æ‰€æœ‰å­—æ®µï¼Œè®¾ç½®è”åŠ¨
    this.processFields(fields, formManager)
  }
  
  /**
   * å¤„ç†å­—æ®µåˆ—è¡¨
   */
  private processFields(fields: FieldConfig[], formManager: ReactiveFormDataManager) {
    for (const field of fields) {
      // å¤„ç†å½“å‰å­—æ®µ
      this.processField(field, formManager)
      
      // é€’å½’å¤„ç†å­å­—æ®µ
      if (field.sub_fields) {
        this.processFields(field.sub_fields, formManager)
      }
    }
  }
  
  /**
   * å¤„ç†å•ä¸ªå­—æ®µ
   */
  private processField(field: FieldConfig, formManager: ReactiveFormDataManager) {
    const linkage = this.getLinkageConfig(field)
    if (!linkage) return
    
    console.log(`[LinkageEngine] è®¾ç½®è”åŠ¨: ${field.field_path}`, linkage)
    
    // ğŸ”¥ ç›‘å¬é…ç½®ä¸­çš„å­—æ®µ
    for (const watchPath of linkage.watch || []) {
      formManager.watch(watchPath, (newVal, oldVal) => {
        console.log(`[LinkageEngine] ${field.field_path} æ£€æµ‹åˆ° ${watchPath} å˜åŒ–`)
        
        // æ‰§è¡Œé…ç½®çš„æ“ä½œ
        this.executeActions(field, linkage.actions, formManager)
      })
    }
  }
  
  /**
   * è·å–è”åŠ¨é…ç½®
   * å¯ä»¥ä»å­—æ®µçš„ linkage å±æ€§è·å–ï¼Œæˆ–ä»å…¨å±€é…ç½®è·å–
   */
  private getLinkageConfig(field: FieldConfig): LinkageConfig | null {
    // ä»å­—æ®µè‡ªèº«è·å–ï¼ˆå¦‚æœåç«¯è¿”å›äº† linkageï¼‰
    if (field.linkage) {
      return field.linkage
    }
    
    // ä»å…¨å±€é…ç½®è·å–ï¼ˆå‰ç«¯é…ç½®ï¼‰
    const globalConfig = this.getGlobalLinkageConfig()
    return globalConfig[field.field_path] || null
  }
  
  /**
   * æ‰§è¡Œè”åŠ¨æ“ä½œ
   */
  private executeActions(
    field: FieldConfig,
    actions: LinkageActions | undefined,
    formManager: ReactiveFormDataManager
  ) {
    if (!actions) return
    
    // æ¸…ç©ºå­—æ®µ
    if (actions.clear) {
      for (const clearPath of actions.clear) {
        console.log(`[LinkageEngine] æ¸…ç©ºå­—æ®µ: ${clearPath}`)
        formManager.setValue(clearPath, null)
      }
    }
    
    // æ›´æ–°å­—æ®µ
    if (actions.update) {
      for (const [updatePath, expression] of Object.entries(actions.update)) {
        console.log(`[LinkageEngine] æ›´æ–°å­—æ®µ: ${updatePath} = ${expression}`)
        // è®¡ç®—è¡¨è¾¾å¼ï¼Œæ›´æ–°å­—æ®µå€¼
        const value = this.evaluateExpression(expression, formManager)
        formManager.setValue(updatePath, value)
      }
    }
    
    // é‡æ–°åŠ è½½æ•°æ®
    if (actions.reload) {
      console.log(`[LinkageEngine] é‡æ–°åŠ è½½æ•°æ®: ${field.field_path}`)
      // è§¦å‘å­—æ®µçš„ reload é€»è¾‘
    }
    
    // ç¦ç”¨/å¯ç”¨å­—æ®µ
    if (actions.disable) {
      console.log(`[LinkageEngine] ç¦ç”¨å­—æ®µ:`, actions.disable)
    }
    if (actions.enable) {
      console.log(`[LinkageEngine] å¯ç”¨å­—æ®µ:`, actions.enable)
    }
    
    // æ˜¾ç¤º/éšè—å­—æ®µ
    if (actions.show) {
      console.log(`[LinkageEngine] æ˜¾ç¤ºå­—æ®µ:`, actions.show)
    }
    if (actions.hide) {
      console.log(`[LinkageEngine] éšè—å­—æ®µ:`, actions.hide)
    }
  }
  
  /**
   * å…¨å±€è”åŠ¨é…ç½®ï¼ˆå‰ç«¯é…ç½®ï¼‰
   */
  private getGlobalLinkageConfig(): Record<string, LinkageConfig> {
    return {
      // çœå¸‚åŒºçº§è”
      'city': {
        watch: ['province'],
        actions: {
          clear: ['city', 'district'],
          reload: true
        }
      },
      'district': {
        watch: ['city'],
        actions: {
          clear: ['district'],
          reload: true
        }
      },
      
      // List å†…å­—æ®µç›‘å¬çˆ¶è¡¨å•å­—æ®µ
      'products[].product_id': {
        watch: ['member_card_id'],
        actions: {
          reload: true  // ä¼šå‘˜å¡å˜åŒ–æ—¶ï¼Œé‡æ–°åŠ è½½å•†å“åˆ—è¡¨
        }
      }
    }
  }
}
```

### 3. ListWidget ç”Ÿæˆå®ä¾‹åŒ–è·¯å¾„

```typescript
class ListWidget extends BaseWidget {
  private renderColumns(subFields: FieldConfig[]): VNode[] {
    return subFields.map(subField =>
      h(ElTableColumn, {
        label: subField.name,
        prop: subField.code
      }, {
        default: ({ row, $index }: any) => {
          const rowManager = this.getOrCreateRowManager($index, row)
          
          // ğŸ”¥ ç”Ÿæˆå½“å‰è¡Œçš„å®ä¾‹åŒ– field_path
          const instanceFieldPath = this.instantiatePath(subField.field_path, $index)
          // "products[].product_id" â†’ "products[0].product_id"
          
          console.log(`[ListWidget] æ¸²æŸ“å­—æ®µ: ${instanceFieldPath}`)
          
          const WidgetClass = widgetFactory.getWidgetClass(subField.widget.type)
          const widget = new WidgetClass({
            field: subField,
            value: rowManager.getValue(subField.code),
            onChange: (newValue: FieldValue) => {
              rowManager.setValue(subField.code, newValue)
              this.syncRowToList(row, rowManager)
            },
            
            // ğŸ”¥ ä¼ é€’å®ä¾‹åŒ–çš„ field_path
            currentFieldPath: instanceFieldPath,
            
            formManager: rowManager,
            parentFormManager: this.props.formManager
          })
          
          return widget.render()
        }
      })
    )
  }
  
  /**
   * å®ä¾‹åŒ–è·¯å¾„
   * "products[].product_id" + index=0 â†’ "products[0].product_id"
   */
  private instantiatePath(templatePath: string, index: number): string {
    return templatePath.replace('[]', `[${index}]`)
  }
}
```

---

## è°ƒè¯•å’Œæ—¥å¿—

### æ¸…æ™°çš„æ—¥å¿—è¾“å‡º

```typescript
// âŒ ä¸æ¸…æ™°çš„æ—¥å¿—
console.log('å­—æ®µå˜åŒ–:', 'product_id', 101)
// è¾“å‡ºï¼šå­—æ®µå˜åŒ–: product_id 101
// é—®é¢˜ï¼šä¸çŸ¥é“æ˜¯å“ªä¸€è¡Œçš„ product_id

// âœ… æ¸…æ™°çš„æ—¥å¿—
console.log(`[${field.field_path}] å€¼å˜åŒ–:`, 101)
// è¾“å‡ºï¼š[products[0].product_id] å€¼å˜åŒ–: 101
// æ¸…æ™°ï¼šçŸ¥é“æ˜¯ç¬¬ 0 è¡Œçš„ product_id

console.log(`[${field.field_path}] è§¦å‘å›è°ƒ:`, 'OnSelectFuzzy')
// è¾“å‡ºï¼š[products[1].product_id] è§¦å‘å›è°ƒ: OnSelectFuzzy

console.log(`[${field.field_path}] èšåˆè®¡ç®—:`, { æ€»ä»·: 100 })
// è¾“å‡ºï¼š[products[]] èšåˆè®¡ç®—: { æ€»ä»·: 100 }
```

---

## æ‰©å±•çš„ FieldConfig ç±»å‹

```typescript
/**
 * å­—æ®µé…ç½®ï¼ˆå¢å¼ºç‰ˆï¼‰
 */
interface FieldConfig {
  // ========== åç«¯è¿”å›çš„å­—æ®µ ==========
  code: string
  name: string
  desc?: string
  data: {
    type: string
    format?: string
    example?: string
  }
  widget: {
    type: string
    config?: any
  }
  callbacks?: string[]
  table_permission?: '' | 'read' | 'update' | 'create'
  validation?: string
  search?: string
  sub_fields?: FieldConfig[]
  
  // ========== ğŸ”¥ å‰ç«¯è‡ªåŠ¨æ·»åŠ çš„å­—æ®µ ==========
  
  /**
   * å­—æ®µè·¯å¾„ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
   * ä¾‹å¦‚ï¼š
   * - "member_card_id"ï¼ˆé¡¶å±‚ï¼‰
   * - "products[]"ï¼ˆListï¼‰
   * - "products[].product_id"ï¼ˆList å†…ï¼‰
   * - "user_profile.name"ï¼ˆStruct å†…ï¼‰
   */
  field_path?: string
  
  /**
   * çˆ¶å­—æ®µè·¯å¾„
   * ä¾‹å¦‚ï¼š
   * - undefinedï¼ˆé¡¶å±‚å­—æ®µï¼‰
   * - "products[]"ï¼ˆList å†…å­—æ®µçš„ parentï¼‰
   * - "user_profile"ï¼ˆStruct å†…å­—æ®µçš„ parentï¼‰
   */
  parent_path?: string
  
  /**
   * åµŒå¥—æ·±åº¦
   * 0 = é¡¶å±‚
   * 1 = List/Struct å†…
   * 2 = List å†… Struct
   */
  depth?: number
  
  /**
   * åœ¨çˆ¶å­—æ®µä¸­çš„ç´¢å¼•
   */
  index_in_parent?: number
  
  /**
   * å…ƒæ•°æ®ï¼ˆå‰ç«¯è§£æåçš„ï¼‰
   */
  meta?: {
    required?: boolean       // æ˜¯å¦å¿…å¡«ï¼ˆä» validation è§£æï¼‰
    readonly?: boolean       // æ˜¯å¦åªè¯»ï¼ˆä» table_permission è§£æï¼‰
    disabled?: boolean       // æ˜¯å¦ç¦ç”¨
    searchable?: boolean     // æ˜¯å¦å¯æœç´¢ï¼ˆä» search è§£æï¼‰
    sortable?: boolean       // æ˜¯å¦å¯æ’åºï¼ˆæ ¹æ®ç±»å‹åˆ¤æ–­ï¼‰
    placeholder?: string     // æç¤ºä¿¡æ¯ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
    help_text?: string       // å¸®åŠ©æ–‡æœ¬
  }
}
```

---

## æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿

| ç‰¹æ€§ | è¯´æ˜ | ä¼˜åŠ¿ |
|-----|------|------|
| **å”¯ä¸€æ ‡è¯†** | æ¯ä¸ªå­—æ®µæœ‰å”¯ä¸€çš„ field_path | âœ… é¿å…æ··æ·† |
| **åµŒå¥—æ”¯æŒ** | æ”¯æŒä»»æ„æ·±åº¦çš„åµŒå¥— | âœ… çµæ´»å¼ºå¤§ |
| **è‡ªåŠ¨å¢å¼º** | å‰ç«¯è‡ªåŠ¨å¤„ç†ï¼Œåç«¯æ— éœ€æ”¹åŠ¨ | âœ… ä½æˆæœ¬ |
| **ç»Ÿä¸€å¤„ç†** | FieldPathEnhancer ç»Ÿä¸€å¢å¼º | âœ… ä»£ç é›†ä¸­ |
| **è°ƒè¯•æ–¹ä¾¿** | æ¸…æ™°çš„è·¯å¾„å’Œæ—¥å¿— | âœ… æ˜“äºæ’æŸ¥ |
| **å­—æ®µè”åŠ¨** | åŸºäº field_path é…ç½®è”åŠ¨ | âœ… å£°æ˜å¼ |
| **ç±»å‹å®‰å…¨** | TypeScript ç±»å‹å®Œæ•´ | âœ… å¼€å‘ä½“éªŒå¥½ |

### å®ç°æµç¨‹

```
1. åç«¯è¿”å›åŸå§‹å­—æ®µé…ç½®
   â†“
2. fieldPathEnhancer.enhance()  // ğŸ”¥ è‡ªåŠ¨å¢å¼º
   â†“
3. ä¸ºæ¯ä¸ªå­—æ®µæ·»åŠ ï¼š
   - field_pathï¼ˆå”¯ä¸€è·¯å¾„ï¼‰
   - parent_pathï¼ˆçˆ¶è·¯å¾„ï¼‰
   - depthï¼ˆæ·±åº¦ï¼‰
   - metaï¼ˆå…ƒæ•°æ®ï¼‰
   â†“
4. FormDataManager ä½¿ç”¨ field_path ç®¡ç†æ•°æ®
   â†“
5. LinkageEngine ä½¿ç”¨ field_path å¤„ç†è”åŠ¨
   â†“
6. Widget ä½¿ç”¨ field_path è°ƒè¯•å’Œæ—¥å¿—
   â†“
7. å®Œç¾æ”¯æŒå­—æ®µè”åŠ¨ã€è°ƒè¯•ã€æ—¥å¿—
```

### ä½¿ç”¨å»ºè®®

1. **å¿…é¡»ä½¿ç”¨** - åœ¨ getFunctionDetail ä¸­è°ƒç”¨ enhance()
2. **ç»Ÿä¸€ç®¡ç†** - æ‰€æœ‰å­—æ®µæ“ä½œéƒ½ä½¿ç”¨ field_path
3. **å®ä¾‹åŒ–è·¯å¾„** - ListWidget ä¸­ç”Ÿæˆå®ä¾‹åŒ–è·¯å¾„
4. **æ¸…æ™°æ—¥å¿—** - æ‰€æœ‰æ—¥å¿—éƒ½åŒ…å« field_path
5. **ç±»å‹å®‰å…¨** - ä½¿ç”¨ TypeScript ç±»å‹å®šä¹‰

**è¿™ä¸ªè®¾è®¡æ—¢ä¸éœ€è¦åç«¯æ”¹åŠ¨ï¼Œåˆèƒ½è·å¾—æ‰€æœ‰ field_path çš„å¥½å¤„ï¼** ğŸ‰


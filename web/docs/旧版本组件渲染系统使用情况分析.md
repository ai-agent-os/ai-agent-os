# æ—§ç‰ˆæœ¬ç»„ä»¶æ¸²æŸ“ç³»ç»Ÿä½¿ç”¨æƒ…å†µåˆ†æ

## ğŸ“Š åˆ†ææ—¶é—´
2025-01-21

## ğŸ¯ åˆ†æç›®æ ‡
ç¡®è®¤æ—§ç‰ˆæœ¬çš„ç»„ä»¶æ¸²æŸ“ç³»ç»Ÿï¼ˆ`web/src/core/widgets/`ï¼‰æ˜¯å¦å·²ç»å®Œå…¨æ— ç”¨äº†ï¼Œæ˜¯å¦å¯ä»¥å®‰å…¨åˆ é™¤ã€‚

## âœ… å·²è¿ç§»åˆ° widgets-v2 çš„åœºæ™¯

### 1. TableRendererï¼ˆè¡¨æ ¼æ¸²æŸ“å™¨ï¼‰
- **æ–‡ä»¶**ï¼š`web/src/components/TableRenderer.vue`
- **çŠ¶æ€**ï¼šâœ… **å·²å®Œå…¨è¿ç§»**
- **è¯æ®**ï¼š
  - ä½¿ç”¨ `widgetComponentFactory` (æ¥è‡ª `factories-v2`)
  - ä½¿ç”¨ `h()` æ¸²æŸ“ v2 ç»„ä»¶
  - ä¸å†ä½¿ç”¨ `WidgetBuilder` æˆ– `WidgetFactory`
  - `renderTableCell()` å’Œ `renderDetailField()` éƒ½ä½¿ç”¨ v2 ç»„ä»¶

### 2. SearchInputï¼ˆæœç´¢è¾“å…¥ï¼‰
- **æ–‡ä»¶**ï¼š`web/src/components/SearchInput.vue`
- **çŠ¶æ€**ï¼šâœ… **å·²å®Œå…¨è¿ç§»**
- **è¯æ®**ï¼š
  - ä½¿ç”¨ `widgetComponentFactory` (æ¥è‡ª `factories-v2`)
  - `inputConfig` computed æ ¹æ® v2 æ€è·¯ç”Ÿæˆé…ç½®
  - ä¸å†ä½¿ç”¨ `WidgetBuilder.createTemporary()` æˆ– `renderSearchInput()`

### 3. FormRendererï¼ˆè¡¨å•æ¸²æŸ“å™¨ï¼‰
- **æ–‡ä»¶**ï¼š`web/src/core/renderers-v2/FormRenderer.vue`
- **çŠ¶æ€**ï¼šâœ… **å®Œå…¨ä½¿ç”¨ v2**
- **è¯æ®**ï¼š
  - ä½¿ç”¨ `widgetComponentFactory` (æ¥è‡ª `factories-v2`)
  - ä½¿ç”¨ `widgets-v2/components/*.vue` ç»„ä»¶
  - ä¸å†ä½¿ç”¨æ—§ç‰ˆæœ¬ widgets/

## âš ï¸ ä»åœ¨ä½¿ç”¨æ—§ç‰ˆæœ¬ widgets/ çš„åœºæ™¯

### 1. æ—§ç‰ˆæœ¬ Widget å†…éƒ¨é€’å½’ä½¿ç”¨

#### 1.1 TableWidget.ts
- **æ–‡ä»¶**ï¼š`web/src/core/widgets/TableWidget.ts`
- **ä½¿ç”¨æ–¹å¼**ï¼š
  - å†…éƒ¨ä½¿ç”¨ `WidgetBuilder.create()` åˆ›å»ºå­ Widget
  - å†…éƒ¨ä½¿ç”¨ `WidgetBuilder.createTemporary()` åˆ›å»ºä¸´æ—¶ Widget
  - å†…éƒ¨ä½¿ç”¨ `widgetFactory.getWidgetClass()` è·å– Widget ç±»
- **çŠ¶æ€**ï¼šâš ï¸ **ä»åœ¨ä½¿ç”¨**
- **é—®é¢˜**ï¼šå¦‚æœ `TableWidget` æœ¬èº«ä¸å†è¢«ä½¿ç”¨ï¼Œè¿™äº›å†…éƒ¨è°ƒç”¨ä¹Ÿä¸ä¼šè¢«æ‰§è¡Œ

#### 1.2 FormWidget.ts
- **æ–‡ä»¶**ï¼š`web/src/core/widgets/FormWidget.ts`
- **ä½¿ç”¨æ–¹å¼**ï¼š
  - å†…éƒ¨ä½¿ç”¨ `WidgetBuilder.create()` åˆ›å»ºå­ Widget
  - å†…éƒ¨ä½¿ç”¨ `WidgetBuilder.createTemporary()` åˆ›å»ºä¸´æ—¶ Widget
  - å†…éƒ¨ä½¿ç”¨ `ResponseFormWidget` æ¸²æŸ“è¯¦æƒ…
- **çŠ¶æ€**ï¼šâš ï¸ **ä»åœ¨ä½¿ç”¨**
- **é—®é¢˜**ï¼šå¦‚æœ `FormWidget` æœ¬èº«ä¸å†è¢«ä½¿ç”¨ï¼Œè¿™äº›å†…éƒ¨è°ƒç”¨ä¹Ÿä¸ä¼šè¢«æ‰§è¡Œ

#### 1.3 ResponseTableWidget.ts
- **æ–‡ä»¶**ï¼š`web/src/core/widgets/ResponseTableWidget.ts`
- **ä½¿ç”¨æ–¹å¼**ï¼š
  - å†…éƒ¨ä½¿ç”¨ `WidgetBuilder.createTemporary()` åˆ›å»ºä¸´æ—¶ Widget
  - å†…éƒ¨ä½¿ç”¨ `ResponseFormWidget` æ¸²æŸ“è¯¦æƒ…
- **çŠ¶æ€**ï¼šâš ï¸ **ä»åœ¨ä½¿ç”¨**
- **é—®é¢˜**ï¼šå¦‚æœ `ResponseTableWidget` æœ¬èº«ä¸å†è¢«ä½¿ç”¨ï¼Œè¿™äº›å†…éƒ¨è°ƒç”¨ä¹Ÿä¸ä¼šè¢«æ‰§è¡Œ

#### 1.4 ResponseFormWidget.ts
- **æ–‡ä»¶**ï¼š`web/src/core/widgets/ResponseFormWidget.ts`
- **ä½¿ç”¨æ–¹å¼**ï¼š
  - å†…éƒ¨ä½¿ç”¨ `WidgetBuilder.create()` åˆ›å»ºå­ Widget
  - å†…éƒ¨ä½¿ç”¨ `widgetFactory.getResponseWidgetClass()` è·å– Response Widget
- **çŠ¶æ€**ï¼šâš ï¸ **ä»åœ¨ä½¿ç”¨**
- **é—®é¢˜**ï¼šå¦‚æœ `ResponseFormWidget` æœ¬èº«ä¸å†è¢«ä½¿ç”¨ï¼Œè¿™äº›å†…éƒ¨è°ƒç”¨ä¹Ÿä¸ä¼šè¢«æ‰§è¡Œ

### 2. å·¥å…·å‡½æ•°

#### 2.1 field.ts
- **æ–‡ä»¶**ï¼š`web/src/utils/field.ts`
- **ä½¿ç”¨æ–¹å¼**ï¼š
  - ä½¿ç”¨ `widgetFactory.getWidgetClass()` è·å– Widget ç±»
  - è°ƒç”¨ Widget çš„é™æ€æ–¹æ³• `loadFromRawData()`
- **çŠ¶æ€**ï¼šâš ï¸ **ä»åœ¨ä½¿ç”¨**
- **ç”¨é€”**ï¼š`convertToFieldValue()` å‡½æ•°ï¼Œç”¨äºå°†åŸå§‹å€¼è½¬æ¢ä¸º `FieldValue` æ ¼å¼
- **å½±å“**ï¼šè¿™ä¸ªå‡½æ•°å¯èƒ½è¢«å¤šä¸ªåœ°æ–¹ä½¿ç”¨ï¼Œéœ€è¦æ£€æŸ¥

### 3. ç±»å‹å®šä¹‰

#### 3.1 widget.ts
- **æ–‡ä»¶**ï¼š`web/src/core/types/widget.ts`
- **ä½¿ç”¨æ–¹å¼**ï¼š
  - å¯¼å…¥ `BaseWidget` ç±»å‹ç”¨äºç±»å‹å®šä¹‰
- **çŠ¶æ€**ï¼šâš ï¸ **ä»åœ¨ä½¿ç”¨**
- **å½±å“**ï¼šå¦‚æœåˆ é™¤ `BaseWidget`ï¼Œéœ€è¦æ›´æ–°ç±»å‹å®šä¹‰

## ğŸ” å…³é”®é—®é¢˜ï¼šæ—§ç‰ˆæœ¬ Widget æ˜¯å¦è¿˜åœ¨è¢«ä½¿ç”¨ï¼Ÿ

### æ£€æŸ¥ç‚¹ 1ï¼šFormRenderer æ˜¯å¦ä½¿ç”¨æ—§ç‰ˆæœ¬ Widgetï¼Ÿ

**ç»“è®º**ï¼šâœ… **FormRenderer å·²å®Œå…¨ä½¿ç”¨ v2**

- `FormRenderer.vue` ä½¿ç”¨ `widgetComponentFactory.getRequestComponent()`
- ä½¿ç”¨ `widgets-v2/components/*.vue` ç»„ä»¶
- ä¸å†ä½¿ç”¨æ—§ç‰ˆæœ¬çš„ `TableWidget` æˆ– `FormWidget`

### æ£€æŸ¥ç‚¹ 2ï¼šResponse Widget æ˜¯å¦è¿˜åœ¨è¢«ä½¿ç”¨ï¼Ÿ

**ç»“è®º**ï¼šâœ… **å·²ä¸å†ä½¿ç”¨**

- `FormRenderer` å·²ç»ä½¿ç”¨ v2 ç»„ä»¶çš„ `mode="response"`
- ä½¿ç”¨ `widgetComponentFactory.getResponseComponent()` è·å–å“åº”ç»„ä»¶
- æ‰€æœ‰ v2 ç»„ä»¶éƒ½æ”¯æŒ `mode="response"`ï¼ˆå¦‚ `FormWidget.vue`ã€`TableWidget.vue`ï¼‰
- **æ—§ç‰ˆæœ¬çš„ `ResponseTableWidget` å’Œ `ResponseFormWidget` å·²ä¸å†è¢«ä½¿ç”¨**
- å®ƒä»¬åªåœ¨æ—§ç‰ˆæœ¬çš„ `TableWidget.ts` å’Œ `FormWidget.ts` å†…éƒ¨è¢«ä½¿ç”¨ï¼Œä½†è¿™äº›æ—§ç‰ˆæœ¬ Widget æœ¬èº«ä¹Ÿä¸å†è¢«ä½¿ç”¨

### æ£€æŸ¥ç‚¹ 3ï¼šfield.ts çš„ä½¿ç”¨æƒ…å†µ

**ç»“è®º**ï¼šâš ï¸ **ä»åœ¨ä½¿ç”¨ï¼Œä½†å¯èƒ½å¯ä»¥è¿ç§»**

- `convertToFieldValue()` å‡½æ•°ä½¿ç”¨ `widgetFactory.getWidgetClass()`
- è¿™ä¸ªå‡½æ•°å¯èƒ½è¢«å¤šä¸ªåœ°æ–¹è°ƒç”¨
- **éœ€è¦æ£€æŸ¥**ï¼šæ˜¯å¦å¯ä»¥æ”¹ä¸ºä½¿ç”¨ v2 ç»„ä»¶çš„æ–¹å¼ï¼Ÿ

## ğŸ“‹ æ€»ç»“

### âœ… å¯ä»¥ç¡®è®¤å·²æ— ç”¨çš„éƒ¨åˆ†

1. **TableRenderer** - å·²å®Œå…¨è¿ç§»åˆ° v2
2. **SearchInput** - å·²å®Œå…¨è¿ç§»åˆ° v2
3. **FormRenderer** - å·²å®Œå…¨è¿ç§»åˆ° v2

### âœ… å·²ç¡®è®¤ä¸å†ä½¿ç”¨çš„éƒ¨åˆ†

1. **ResponseTableWidget** å’Œ **ResponseFormWidget**
   - âœ… **å·²ä¸å†ä½¿ç”¨**
   - `FormRenderer` å·²ä½¿ç”¨ v2 ç»„ä»¶çš„ `mode="response"`
   - åªåœ¨æ—§ç‰ˆæœ¬ Widget å†…éƒ¨è¢«ä½¿ç”¨ï¼Œä½†è¿™äº›æ—§ç‰ˆæœ¬ Widget æœ¬èº«ä¹Ÿä¸å†è¢«ä½¿ç”¨

2. **æ—§ç‰ˆæœ¬çš„ TableWidget å’Œ FormWidget**
   - âœ… **å·²ä¸å†ä½¿ç”¨**
   - `FormRenderer` å·²ä½¿ç”¨ v2 çš„ `FormWidget.vue` å’Œ `TableWidget.vue`
   - åªåœ¨ `WidgetFactory` ä¸­æ³¨å†Œï¼Œä½† `FormRenderer` ä¸å†ä½¿ç”¨ `WidgetFactory`

### âš ï¸ éœ€è¦è¿›ä¸€æ­¥ç¡®è®¤çš„éƒ¨åˆ†

1. **field.ts ä¸­çš„ `convertToFieldValue()`**
   - ä»åœ¨ä½¿ç”¨ï¼ˆè¢« `TableRenderer.vue`ã€`SearchInput.vue` ä½¿ç”¨ï¼‰
   - ä½†è¿™ä¸¤ä¸ªç»„ä»¶å·²ç»è¿ç§»åˆ° v2ï¼Œå¯èƒ½å¯ä»¥æ”¹ä¸ºä½¿ç”¨ v2 ç»„ä»¶çš„æ–¹å¼
   - **éœ€è¦æ£€æŸ¥**ï¼šæ˜¯å¦å¯ä»¥æ”¹ä¸ºä½¿ç”¨ v2 ç»„ä»¶çš„æ–¹å¼ï¼Ÿ

## ğŸ¯ å·²å®Œæˆçš„æ›´æ–°

### 1. âœ… æ›´æ–° `convertToFieldValue` å‡½æ•°

**æ›´æ–°å†…å®¹**ï¼š
- ç§»é™¤äº†å¯¹æ—§ç‰ˆæœ¬ `widgetFactory` çš„ä¾èµ–
- ç›´æ¥æ ¹æ® `widget.type` è¿›è¡Œè½¬æ¢ï¼Œä¸ä¾èµ– Widget ç±»
- ä¿æŒä¸ v2 ç»„ä»¶å…¼å®¹çš„æ•°æ®æ ¼å¼
- æ”¯æŒæ—¶é—´æˆ³ã€æ•°ç»„ã€å¸ƒå°”ã€æ•°å­—ã€å¯¹è±¡ç­‰ç±»å‹çš„è½¬æ¢

**æ–‡ä»¶**ï¼š`web/src/utils/field.ts`

### 2. âœ… æ›´æ–°ç±»å‹å®šä¹‰

**æ›´æ–°å†…å®¹**ï¼š
- ç§»é™¤äº†å¯¹ `BaseWidget` çš„å¯¼å…¥å’Œä¾èµ–
- `FormRendererContext.registerWidget` å‚æ•°æ”¹ä¸º `any`ï¼ˆv2 ç³»ç»Ÿä¸­å·²ä¸å†ä½¿ç”¨ï¼‰
- `MarkRawWidget` æ”¹ä¸ºç‹¬ç«‹ç±»å‹ï¼Œä¸å†ç»§æ‰¿ `BaseWidget`

**æ–‡ä»¶**ï¼š`web/src/core/types/widget.ts`

### 3. ğŸ¯ ä¸‹ä¸€æ­¥ï¼šåˆ é™¤æ—§ç‰ˆæœ¬ä»£ç 

**å¯ä»¥åˆ é™¤çš„æ–‡ä»¶/ç›®å½•**ï¼š
- âœ… `web/src/core/widgets/` ç›®å½•ï¼ˆæ•´ä¸ªç›®å½•ï¼‰
- âœ… `web/src/core/factories/WidgetBuilder.ts`
- âœ… `web/src/core/factories/WidgetFactory.ts`

**éœ€è¦æ›´æ–°çš„æ–‡ä»¶**ï¼š
- âš ï¸ `web/src/utils/field.ts` - æ›´æ–° `convertToFieldValue()` å®ç°ï¼Œç§»é™¤å¯¹ `widgetFactory` çš„ä¾èµ–
- âš ï¸ `web/src/core/types/widget.ts` - æ›´æ–°ç±»å‹å®šä¹‰ï¼Œç§»é™¤å¯¹ `BaseWidget` çš„ä¾èµ–
- âš ï¸ `web/src/core/README.md` - æ›´æ–°æ–‡æ¡£ï¼Œç§»é™¤å¯¹æ—§ç‰ˆæœ¬çš„å¼•ç”¨

## ğŸ“ ç»“è®º

### âœ… æ ¸å¿ƒç»“è®º

**æ—§ç‰ˆæœ¬çš„ç»„ä»¶æ¸²æŸ“ç³»ç»Ÿï¼ˆ`web/src/core/widgets/`ï¼‰å·²ç»åŸºæœ¬æ— ç”¨**ï¼Œæ‰€æœ‰æ ¸å¿ƒä½¿ç”¨åœºæ™¯ï¼ˆTableRendererã€SearchInputã€FormRendererï¼‰éƒ½å·²ç»è¿ç§»åˆ° v2ã€‚

### âœ… å·²ç¡®è®¤ä¸å†ä½¿ç”¨çš„éƒ¨åˆ†

1. **æ‰€æœ‰æ—§ç‰ˆæœ¬ Widget ç±»**ï¼ˆ`TableWidget.ts`ã€`FormWidget.ts`ã€`ResponseTableWidget.ts`ã€`ResponseFormWidget.ts` ç­‰ï¼‰
   - `FormRenderer` å·²ä½¿ç”¨ v2 çš„ `FormWidget.vue` å’Œ `TableWidget.vue`
   - æ—§ç‰ˆæœ¬ Widget åªåœ¨å†…éƒ¨é€’å½’è°ƒç”¨ï¼Œä½†è¿™äº› Widget æœ¬èº«ä¸å†è¢«ä½¿ç”¨

2. **WidgetBuilder å’Œ WidgetFactory**
   - `TableRenderer` å’Œ `SearchInput` å·²ä½¿ç”¨ `widgetComponentFactory` (v2)
   - `FormRenderer` å·²ä½¿ç”¨ `widgetComponentFactory` (v2)
   - æ—§ç‰ˆæœ¬çš„å·¥å‚ç±»ä¸å†è¢«ä½¿ç”¨

### âœ… å·²å¤„ç†çš„éƒ¨åˆ†

1. **`field.ts` ä¸­çš„ `convertToFieldValue()`**
   - âœ… **å·²æ›´æ–°**ï¼šç§»é™¤äº†å¯¹æ—§ç‰ˆæœ¬ `widgetFactory` çš„ä¾èµ–
   - ç°åœ¨ç›´æ¥æ ¹æ® `widget.type` è¿›è¡Œè½¬æ¢ï¼Œä¸ä¾èµ– Widget ç±»
   - ä¿æŒä¸ v2 ç»„ä»¶å…¼å®¹çš„æ•°æ®æ ¼å¼

2. **ç±»å‹å®šä¹‰**
   - âœ… **å·²æ›´æ–°**ï¼š`web/src/core/types/widget.ts` ç§»é™¤äº†å¯¹ `BaseWidget` çš„ä¾èµ–
   - `FormRendererContext.registerWidget` å‚æ•°æ”¹ä¸º `any`ï¼ˆv2 ç³»ç»Ÿä¸­å·²ä¸å†ä½¿ç”¨ï¼‰
   - `MarkRawWidget` æ”¹ä¸ºç‹¬ç«‹ç±»å‹ï¼Œä¸å†ç»§æ‰¿ `BaseWidget`

### ğŸ¯ æœ€ç»ˆå»ºè®®

**å¯ä»¥å®‰å…¨åˆ é™¤**ï¼š
- âœ… `web/src/core/widgets/` ç›®å½•ï¼ˆæ•´ä¸ªç›®å½•ï¼‰
- âœ… `web/src/core/factories/WidgetBuilder.ts`
- âœ… `web/src/core/factories/WidgetFactory.ts`

**éœ€è¦å…ˆæ›´æ–°**ï¼š
- âš ï¸ `web/src/utils/field.ts` - æ›´æ–° `convertToFieldValue()` å®ç°
- âš ï¸ `web/src/core/types/widget.ts` - æ›´æ–°ç±»å‹å®šä¹‰
- âš ï¸ `web/src/core/README.md` - æ›´æ–°æ–‡æ¡£

**å»ºè®®æ­¥éª¤**ï¼š
1. å…ˆæ›´æ–° `field.ts` å’Œç±»å‹å®šä¹‰ï¼Œç§»é™¤å¯¹æ—§ç‰ˆæœ¬çš„ä¾èµ–
2. ç„¶ååˆ é™¤æ—§ç‰ˆæœ¬çš„ç›®å½•å’Œæ–‡ä»¶
3. æœ€åæ›´æ–°æ–‡æ¡£


# 新增/编辑实现方式分析

## 📋 当前实现

### 现状
- **新增**：使用 `FormDialog` 弹窗
- **编辑**：使用 `FormDialog` 弹窗
- **搜索**：使用 `SearchInput` 组件（内联在表格上方）
- **正常 Form**：使用 `FormRenderer` 直接渲染（独立页面）

## 🎯 用户提出的问题

### 核心问题
1. **保存视图功能**：用户填写了 9/10 个字段，想保存这个状态，下次打开时只需要填最后一个字段
2. **视图集成**：弹窗可能难以和视图功能集成
3. **场景区分**：需要明确不同场景的使用方式

## 📊 场景分析

### 1. 新增场景（Table 的新增）

**当前实现**：弹窗（FormDialog）

**用户建议**：跳转到新页面，使用 FormRenderer

**优势**：
- ✅ 支持保存视图功能（可以保存部分填写的表单数据）
- ✅ 更好的 URL 状态管理（可以保存到 URL 参数）
- ✅ 更大的编辑空间（不受弹窗宽度限制）
- ✅ 可以支持浏览器前进/后退
- ✅ 更容易集成视图功能（视图可以是一个 URL 状态）

**劣势**：
- ❌ 需要离开当前列表页面
- ❌ 需要额外的路由配置
- ❌ 返回列表时需要刷新数据

**推荐方案**：✅ **跳转到新页面**

### 2. 编辑场景（Table 的编辑）

**当前实现**：弹窗（FormDialog）

**用户建议**：保持弹窗或跳转到新页面？

**分析**：
- 编辑通常是快速修改，不需要保存中间状态
- 编辑的数据已经存在，不需要"保存视图"功能
- 弹窗可以保持上下文（看到列表）

**推荐方案**：✅ **保持弹窗**（或提供两种选择）

### 3. 搜索场景（Table 的搜索）

**当前实现**：内联搜索表单（SearchInput）

**特点**：
- 搜索是高频操作，需要快速切换
- 搜索条件可以保存到 URL（已实现）
- 不需要"保存视图"功能

**推荐方案**：✅ **保持内联搜索**（当前实现已很好）

### 4. 正常 Form 场景（独立 Form 函数）

**当前实现**：直接使用 FormRenderer 渲染（独立页面）

**特点**：
- 这是独立的表单页面，不是 Table 的一部分
- 已经支持保存视图功能（可以通过 URL 参数）
- 不需要修改

**推荐方案**：✅ **保持现状**

## 🔄 保存视图功能分析

### 什么是"保存视图"？

**场景**：
- 用户填写了 9/10 个字段
- 想保存这个状态，下次打开时只需要填最后一个字段
- 或者，用户想创建一个"模板"，下次直接使用

### 保存视图的应用场景

| 场景 | 是否需要保存视图 | 说明 |
|------|----------------|------|
| **新增** | ✅ **需要** | 用户可能分多次填写，需要保存中间状态 |
| **编辑** | ❌ **不需要** | 数据已存在，编辑是快速修改 |
| **搜索** | ✅ **已实现** | 通过 URL 参数保存（已实现） |
| **正常 Form** | ✅ **可以支持** | 通过 URL 参数保存（可以扩展） |

### 保存视图的实现方式

#### 方案 1：URL 参数（当前搜索已实现）
```typescript
// 保存到 URL
router.push({
  path: '/workspace/user/app/function/create',
  query: {
    field1: 'value1',
    field2: 'value2',
    // ...
  }
})

// 从 URL 恢复
const formData = route.query
```

**优势**：
- ✅ 简单，无需额外存储
- ✅ 可以分享链接
- ✅ 支持浏览器前进/后退

**劣势**：
- ❌ URL 可能很长
- ❌ 刷新页面会丢失（除非保存到 localStorage）

#### 方案 2：localStorage（推荐）
```typescript
// 保存到 localStorage
localStorage.setItem('form_draft:function_id', JSON.stringify(formData))

// 从 localStorage 恢复
const draft = localStorage.getItem('form_draft:function_id')
if (draft) {
  formData = JSON.parse(draft)
}
```

**优势**：
- ✅ 持久化存储
- ✅ 不受 URL 长度限制
- ✅ 可以保存多个草稿

**劣势**：
- ❌ 需要清理机制（过期、手动删除）
- ❌ 不能分享链接

#### 方案 3：后端保存（未来扩展）
```typescript
// 保存到后端
await api.saveFormDraft({
  function_id: 'xxx',
  form_data: formData,
  name: '我的草稿'
})

// 从后端恢复
const drafts = await api.getFormDrafts('xxx')
```

**优势**：
- ✅ 跨设备同步
- ✅ 可以命名和管理多个草稿
- ✅ 可以分享给其他用户

**劣势**：
- ❌ 需要后端支持
- ❌ 实现复杂度高

## 🎨 推荐方案

### 方案 A：新增跳转页面，编辑保持弹窗（推荐）

```typescript
// 新增：跳转到新页面
router.push({
  path: '/workspace/user/app/function/create',
  query: {
    // 可选：从视图加载初始数据
    view_id: 'xxx'
  }
})

// 编辑：保持弹窗
<FormDialog
  v-model="editDialogVisible"
  :mode="'update'"
  :initial-data="currentRow"
/>
```

**优势**：
- ✅ 新增支持保存视图功能
- ✅ 编辑保持快速操作
- ✅ 实现简单，改动小

### 方案 B：新增和编辑都跳转页面

```typescript
// 新增：跳转到新页面
router.push('/workspace/user/app/function/create')

// 编辑：也跳转到新页面
router.push({
  path: '/workspace/user/app/function/edit',
  query: {
    id: currentRow.id
  }
})
```

**优势**：
- ✅ 统一体验
- ✅ 都支持保存视图功能
- ✅ 更大的编辑空间

**劣势**：
- ❌ 编辑需要离开列表页面
- ❌ 返回列表时需要刷新数据

### 方案 C：提供两种选择（灵活）

```typescript
// 用户可以选择：
// 1. 快速编辑（弹窗）
// 2. 详细编辑（跳转页面）
```

**优势**：
- ✅ 灵活性最高
- ✅ 满足不同用户需求

**劣势**：
- ❌ 实现复杂度高
- ❌ 可能让用户困惑

## 📝 视图功能集成分析

### 视图是什么？

**视图（View）**：保存的表单状态，可以：
- 命名（如"我的新增视图"）
- 保存部分字段的值
- 下次打开时自动填充

### 视图的应用场景

| 场景 | 视图类型 | 说明 |
|------|---------|------|
| **新增视图** | `create_view` | 保存新增时的表单状态 |
| **编辑视图** | `update_view` | 保存编辑时的表单状态（较少使用） |
| **搜索视图** | `search_view` | 保存搜索条件（已实现） |
| **Form 视图** | `form_view` | 保存 Form 函数的表单状态 |

### 视图与弹窗/页面的关系

#### 弹窗 + 视图
```typescript
// 问题：弹窗关闭后，状态丢失
// 解决方案：需要额外的状态管理
const viewData = await loadView('create_view_xxx')
openDialog(viewData)  // 打开弹窗时加载视图数据
```

**问题**：
- ❌ 弹窗关闭后，状态难以持久化
- ❌ 需要额外的状态管理机制
- ❌ 难以和 URL 集成

#### 页面 + 视图
```typescript
// 优势：页面状态可以保存到 URL
router.push({
  path: '/workspace/user/app/function/create',
  query: {
    view_id: 'xxx'  // 从视图加载
  }
})

// 或者
router.push({
  path: '/workspace/user/app/function/create',
  query: {
    // 直接传递视图数据
    field1: 'value1',
    field2: 'value2'
  }
})
```

**优势**：
- ✅ 状态可以保存到 URL
- ✅ 可以分享链接
- ✅ 支持浏览器前进/后退
- ✅ 更容易集成视图功能

## 🎯 最终推荐

### 推荐方案：新增跳转页面，编辑保持弹窗

#### 1. 新增场景
- **实现方式**：跳转到新页面 `/workspace/user/app/function/create`
- **使用组件**：`FormRenderer`
- **支持功能**：
  - ✅ 保存视图（localStorage + URL）
  - ✅ 从视图加载初始数据
  - ✅ 浏览器前进/后退
  - ✅ 更大的编辑空间

#### 2. 编辑场景
- **实现方式**：保持弹窗（FormDialog）
- **使用组件**：`FormDialog`（内部使用 FormRenderer）
- **支持功能**：
  - ✅ 快速编辑
  - ✅ 保持上下文（看到列表）
  - ✅ 不需要保存视图

#### 3. 搜索场景
- **实现方式**：保持内联搜索（SearchInput）
- **支持功能**：
  - ✅ URL 参数保存（已实现）
  - ✅ 快速切换搜索条件

#### 4. 正常 Form 场景
- **实现方式**：保持独立页面（FormRenderer）
- **支持功能**：
  - ✅ 可以扩展保存视图功能

## 🔧 实现步骤

### 第一步：新增跳转页面

1. 创建新增页面路由
```typescript
{
  path: '/workspace/:user/:app/:function/create',
  component: FormCreatePage
}
```

2. 创建 FormCreatePage 组件
```vue
<template>
  <div class="form-create-page">
    <div class="page-header">
      <el-button @click="handleBack" :icon="ArrowLeft">返回列表</el-button>
      <h2>新增数据</h2>
    </div>
    <div class="page-content">
      <FormRenderer
        :function-detail="functionDetail"
        :initial-data="initialData"
        @submit="handleSubmit"
      />
    </div>
  </div>
</template>
```

3. 修改 TableRenderer 的新增按钮
```typescript
// 从打开弹窗改为跳转页面
function handleCreate() {
  router.push({
    path: `/workspace/${user}/${app}/${function}/create`,
    query: {
      // 可选：从视图加载
      view_id: selectedViewId
    }
  })
}
```

### 第二步：保存视图功能

1. 实现 localStorage 保存
```typescript
// 保存草稿
function saveDraft(functionId: string, formData: Record<string, any>) {
  localStorage.setItem(
    `form_draft:${functionId}`,
    JSON.stringify({
      data: formData,
      timestamp: Date.now()
    })
  )
}

// 加载草稿
function loadDraft(functionId: string) {
  const draft = localStorage.getItem(`form_draft:${functionId}`)
  if (draft) {
    const { data, timestamp } = JSON.parse(draft)
    // 检查是否过期（7天）
    if (Date.now() - timestamp < 7 * 24 * 60 * 60 * 1000) {
      return data
    }
  }
  return null
}
```

2. 在 FormCreatePage 中集成
```typescript
onMounted(() => {
  // 从视图加载
  if (route.query.view_id) {
    loadView(route.query.view_id)
  }
  // 或从草稿加载
  else {
    const draft = loadDraft(functionId)
    if (draft) {
      formData = draft
    }
  }
})

// 自动保存草稿（防抖）
watch(formData, debounce((newData) => {
  saveDraft(functionId, newData)
}, 1000))
```

### 第三步：保持编辑弹窗

编辑场景保持使用 `FormDialog`，无需修改。

## 📊 对比总结

| 场景 | 当前实现 | 推荐实现 | 原因 |
|------|---------|---------|------|
| **新增** | 弹窗 | ✅ **跳转页面** | 支持保存视图，更好的用户体验 |
| **编辑** | 弹窗 | ✅ **保持弹窗** | 快速编辑，保持上下文 |
| **搜索** | 内联搜索 | ✅ **保持现状** | 已实现 URL 保存，体验良好 |
| **正常 Form** | 独立页面 | ✅ **保持现状** | 已经是独立页面，可以扩展视图功能 |

## 🎉 结论

**推荐采用"新增跳转页面，编辑保持弹窗"的方案**，这样既能支持保存视图功能，又能保持编辑的快速操作体验。


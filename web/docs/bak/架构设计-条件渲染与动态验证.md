# æ¶æ„è®¾è®¡ - æ¡ä»¶æ¸²æŸ“ä¸åŠ¨æ€éªŒè¯

## 1. æ—§ç‰ˆæœ¬åˆ†æ

### 1.1 æ—§ç‰ˆæœ¬çš„å®ç°

```typescript
// æ—§ç‰ˆæœ¬ï¼šæ¡ä»¶å†™åœ¨ validation å­—ç¬¦ä¸²ä¸­
{
  code: "å¤‡æ³¨",
  validation: "required_if=ç±»å‹ ç´§æ€¥"  // å½“"ç±»å‹"å­—æ®µç­‰äº"ç´§æ€¥"æ—¶å¿…å¡«
}

// æ”¯æŒçš„æ¡ä»¶ç±»å‹ï¼š
// - required_if=field value      å½“å­—æ®µç­‰äºå€¼æ—¶æ˜¾ç¤ºï¼ˆå¿…å¡«ï¼‰
// - required_unless=field value   å½“å­—æ®µä¸ç­‰äºå€¼æ—¶æ˜¾ç¤º
// - excluded_if=field value       å½“å­—æ®µç­‰äºå€¼æ—¶éšè—
// - excluded_unless=field value   å½“å­—æ®µä¸ç­‰äºå€¼æ—¶éšè—
```

### 1.2 æ—§ç‰ˆæœ¬çš„é—®é¢˜

1. **æ¡ä»¶å’ŒéªŒè¯æ··åœ¨ä¸€èµ·** - `validation` å­—æ®µæ—¢è¡¨ç¤ºéªŒè¯è§„åˆ™ï¼Œåˆè¡¨ç¤ºæ˜¾ç¤ºæ¡ä»¶
2. **åªæ”¯æŒç®€å•æ¡ä»¶** - åªèƒ½æ˜¯ `field == value`ï¼Œä¸æ”¯æŒ `>`, `<`, `in` ç­‰
3. **ä¸æ”¯æŒå¤šæ¡ä»¶** - ä¸èƒ½åŒæ—¶ä¾èµ–å¤šä¸ªå­—æ®µ
4. **ä¸æ”¯æŒæ¡ä»¶ç¦ç”¨** - åªæœ‰æ˜¾ç¤º/éšè—ï¼Œæ²¡æœ‰å¯ç”¨/ç¦ç”¨

---

## 2. æ–°ç‰ˆæœ¬è®¾è®¡

### 2.1 æ ¸å¿ƒç†å¿µ

> **æ¡ä»¶é€»è¾‘ç‹¬ç«‹äºéªŒè¯è§„åˆ™**
> 
> **æ”¯æŒå¤æ‚çš„æ¡ä»¶è¡¨è¾¾å¼**
> 
> **ä¸å“åº”å¼æ•°æ®ç®¡ç†å™¨æ·±åº¦é›†æˆ**

### 2.2 å­—æ®µé…ç½®ç»“æ„

```typescript
interface FieldConfig {
  code: string
  name: string
  widget: WidgetConfig
  
  // ========== éªŒè¯è§„åˆ™ï¼ˆçº¯ç²¹çš„éªŒè¯ï¼‰ ==========
  validation?: string  // ä¾‹å¦‚: "required,min=5,max=100"
  
  // ========== æ¡ä»¶æ¸²æŸ“ï¼ˆæ–°å¢ï¼‰ ==========
  conditions?: {
    // æ˜¾ç¤ºæ¡ä»¶
    visible?: FieldCondition
    
    // å¯ç”¨æ¡ä»¶
    enabled?: FieldCondition
    
    // å¿…å¡«æ¡ä»¶
    required?: FieldCondition
    
    // åªè¯»æ¡ä»¶
    readonly?: FieldCondition
  }
  
  // ========== å­—æ®µè”åŠ¨ï¼ˆä¹‹å‰å·²è®¾è®¡ï¼‰ ==========
  linkage?: {
    watch?: string[]
    onChange?: LinkageAction[]
  }
}
```

---

## 3. æ¡ä»¶è¡¨è¾¾å¼ç³»ç»Ÿ

### 3.1 æ¡ä»¶è¡¨è¾¾å¼å®šä¹‰

```typescript
/**
 * å­—æ®µæ¡ä»¶
 * æ”¯æŒç®€å•æ¡ä»¶å’Œå¤æ‚æ¡ä»¶
 */
type FieldCondition = SimpleCondition | ComplexCondition

/**
 * ç®€å•æ¡ä»¶
 */
interface SimpleCondition {
  // ä¾èµ–çš„å­—æ®µ
  field: string
  
  // æ“ä½œç¬¦
  operator: 'eq' | 'ne' | 'gt' | 'lt' | 'gte' | 'lte' | 'in' | 'not_in' | 'contains' | 'not_contains' | 'empty' | 'not_empty'
  
  // æ¯”è¾ƒå€¼
  value?: any
}

/**
 * å¤æ‚æ¡ä»¶ï¼ˆå¤šæ¡ä»¶ç»„åˆï¼‰
 */
interface ComplexCondition {
  // é€»è¾‘è¿ç®—ç¬¦
  logic: 'and' | 'or'
  
  // å­æ¡ä»¶
  conditions: FieldCondition[]
}

/**
 * è‡ªå®šä¹‰æ¡ä»¶ï¼ˆç»ˆæçµæ´»æ€§ï¼‰
 */
interface CustomCondition {
  // è‡ªå®šä¹‰å‡½æ•°
  handler: (formData: Record<string, any>) => boolean
}
```

### 3.2 æ¡ä»¶è¡¨è¾¾å¼ç¤ºä¾‹

```typescript
// ç¤ºä¾‹1ï¼šç®€å•æ¡ä»¶ - å½“"ç±»å‹"ç­‰äº"ç´§æ€¥"æ—¶å¿…å¡«
{
  code: "å¤‡æ³¨",
  conditions: {
    required: {
      field: "ç±»å‹",
      operator: "eq",
      value: "ç´§æ€¥"
    }
  }
}

// ç¤ºä¾‹2ï¼šç®€å•æ¡ä»¶ - å½“"å¹´é¾„"å¤§äºç­‰äº18æ—¶æ˜¾ç¤º
{
  code: "èº«ä»½è¯å·",
  conditions: {
    visible: {
      field: "å¹´é¾„",
      operator: "gte",
      value: 18
    }
  }
}

// ç¤ºä¾‹3ï¼šå¤æ‚æ¡ä»¶ - å½“"ç±»å‹"æ˜¯"ä¸ªäºº"ä¸”"å¹´é¾„">=18æ—¶æ˜¾ç¤º
{
  code: "èº«ä»½è¯å·",
  conditions: {
    visible: {
      logic: "and",
      conditions: [
        { field: "ç±»å‹", operator: "eq", value: "ä¸ªäºº" },
        { field: "å¹´é¾„", operator: "gte", value: 18 }
      ]
    }
  }
}

// ç¤ºä¾‹4ï¼šå¤æ‚æ¡ä»¶ - å½“"ä¼˜å…ˆçº§"æ˜¯"é«˜"æˆ–"ç´§æ€¥"æ—¶å¿…å¡«
{
  code: "å¤„ç†äºº",
  conditions: {
    required: {
      field: "ä¼˜å…ˆçº§",
      operator: "in",
      value: ["é«˜", "ç´§æ€¥"]
    }
  }
}

// ç¤ºä¾‹5ï¼šå­—æ®µä¸ºç©ºæ—¶éšè—
{
  code: "è¯¦ç»†è¯´æ˜",
  conditions: {
    visible: {
      field: "ç®€è¦è¯´æ˜",
      operator: "not_empty"
    }
  }
}

// ç¤ºä¾‹6ï¼šè‡ªå®šä¹‰æ¡ä»¶ - å½“"å¼€å§‹æ—¥æœŸ"æ—©äº"ç»“æŸæ—¥æœŸ"æ—¶å¯ç”¨
{
  code: "å¤©æ•°",
  conditions: {
    enabled: {
      handler: (formData) => {
        const start = formData.å¼€å§‹æ—¥æœŸ
        const end = formData.ç»“æŸæ—¥æœŸ
        return start && end && new Date(start) < new Date(end)
      }
    }
  }
}
```

---

## 4. æ¡ä»¶æ±‚å€¼å™¨

### 4.1 ConditionEvaluator å®ç°

```typescript
/**
 * æ¡ä»¶æ±‚å€¼å™¨
 * è´Ÿè´£è®¡ç®—æ¡ä»¶è¡¨è¾¾å¼çš„ç»“æœ
 */
class ConditionEvaluator {
  /**
   * è®¡ç®—æ¡ä»¶æ˜¯å¦æ»¡è¶³
   * @param condition æ¡ä»¶è¡¨è¾¾å¼
   * @param formData å®Œæ•´çš„è¡¨å•æ•°æ®
   * @returns æ¡ä»¶æ˜¯å¦æ»¡è¶³
   */
  evaluate(
    condition: FieldCondition | CustomCondition | undefined,
    formData: Record<string, any>
  ): boolean {
    // æ²¡æœ‰æ¡ä»¶ï¼Œé»˜è®¤ä¸º true
    if (!condition) return true
    
    // è‡ªå®šä¹‰æ¡ä»¶
    if ('handler' in condition) {
      return condition.handler(formData)
    }
    
    // å¤æ‚æ¡ä»¶
    if ('logic' in condition) {
      return this.evaluateComplexCondition(condition, formData)
    }
    
    // ç®€å•æ¡ä»¶
    return this.evaluateSimpleCondition(condition, formData)
  }
  
  /**
   * è®¡ç®—ç®€å•æ¡ä»¶
   */
  private evaluateSimpleCondition(
    condition: SimpleCondition,
    formData: Record<string, any>
  ): boolean {
    const actualValue = formData[condition.field]
    const targetValue = condition.value
    
    switch (condition.operator) {
      case 'eq':
        return this.normalizeValue(actualValue, targetValue)
        
      case 'ne':
        return !this.normalizeValue(actualValue, targetValue)
        
      case 'gt':
        return Number(actualValue) > Number(targetValue)
        
      case 'lt':
        return Number(actualValue) < Number(targetValue)
        
      case 'gte':
        return Number(actualValue) >= Number(targetValue)
        
      case 'lte':
        return Number(actualValue) <= Number(targetValue)
        
      case 'in':
        if (!Array.isArray(targetValue)) return false
        return targetValue.some(v => this.normalizeValue(actualValue, v))
        
      case 'not_in':
        if (!Array.isArray(targetValue)) return false
        return !targetValue.some(v => this.normalizeValue(actualValue, v))
        
      case 'contains':
        if (typeof actualValue !== 'string') return false
        return actualValue.includes(String(targetValue))
        
      case 'not_contains':
        if (typeof actualValue !== 'string') return false
        return !actualValue.includes(String(targetValue))
        
      case 'empty':
        return actualValue === null || actualValue === undefined || actualValue === ''
        
      case 'not_empty':
        return actualValue !== null && actualValue !== undefined && actualValue !== ''
        
      default:
        return false
    }
  }
  
  /**
   * è®¡ç®—å¤æ‚æ¡ä»¶
   */
  private evaluateComplexCondition(
    condition: ComplexCondition,
    formData: Record<string, any>
  ): boolean {
    const results = condition.conditions.map(c => this.evaluate(c, formData))
    
    if (condition.logic === 'and') {
      return results.every(r => r)
    } else {
      return results.some(r => r)
    }
  }
  
  /**
   * å€¼å½’ä¸€åŒ–æ¯”è¾ƒï¼ˆå¤„ç†ç±»å‹è½¬æ¢ï¼‰
   */
  private normalizeValue(actualValue: any, targetValue: any): boolean {
    // null/undefined æ¯”è¾ƒ
    if (actualValue === null || actualValue === undefined) {
      return targetValue === null || targetValue === undefined
    }
    if (targetValue === null || targetValue === undefined) {
      return false
    }
    
    // å¸ƒå°”å€¼æ¯”è¾ƒ
    if (typeof actualValue === 'boolean' || typeof targetValue === 'boolean') {
      return Boolean(actualValue) === Boolean(targetValue)
    }
    
    // æ•°å­—æ¯”è¾ƒ
    const actualNum = Number(actualValue)
    const targetNum = Number(targetValue)
    if (!isNaN(actualNum) && !isNaN(targetNum)) {
      return actualNum === targetNum
    }
    
    // å­—ç¬¦ä¸²æ¯”è¾ƒ
    return String(actualValue) === String(targetValue)
  }
}
```

---

## 5. é›†æˆåˆ° ReactiveFormDataManager

### 5.1 å¢å¼º FormDataManager

```typescript
class ReactiveFormDataManager {
  // ... ä¹‹å‰çš„ä»£ç  ...
  
  // æ¡ä»¶æ±‚å€¼å™¨
  private conditionEvaluator = new ConditionEvaluator()
  
  /**
   * è®¡ç®—å­—æ®µçš„å¯è§æ€§
   * @param field å­—æ®µé…ç½®
   * @returns æ˜¯å¦å¯è§
   */
  isFieldVisible(field: FieldConfig): boolean {
    return this.conditionEvaluator.evaluate(
      field.conditions?.visible,
      this.getAllRawValues()
    )
  }
  
  /**
   * è®¡ç®—å­—æ®µçš„å¯ç”¨çŠ¶æ€
   * @param field å­—æ®µé…ç½®
   * @returns æ˜¯å¦å¯ç”¨
   */
  isFieldEnabled(field: FieldConfig): boolean {
    return this.conditionEvaluator.evaluate(
      field.conditions?.enabled,
      this.getAllRawValues()
    )
  }
  
  /**
   * è®¡ç®—å­—æ®µæ˜¯å¦å¿…å¡«
   * @param field å­—æ®µé…ç½®
   * @returns æ˜¯å¦å¿…å¡«
   */
  isFieldRequired(field: FieldConfig): boolean {
    // 1. å…ˆçœ‹é™æ€éªŒè¯è§„åˆ™
    const hasStaticRequired = field.validation?.includes('required')
    
    // 2. å†çœ‹æ¡ä»¶å¿…å¡«
    const hasDynamicRequired = field.conditions?.required
      ? this.conditionEvaluator.evaluate(field.conditions.required, this.getAllRawValues())
      : false
    
    return hasStaticRequired || hasDynamicRequired
  }
  
  /**
   * è®¡ç®—å­—æ®µæ˜¯å¦åªè¯»
   * @param field å­—æ®µé…ç½®
   * @returns æ˜¯å¦åªè¯»
   */
  isFieldReadonly(field: FieldConfig): boolean {
    return this.conditionEvaluator.evaluate(
      field.conditions?.readonly,
      this.getAllRawValues()
    )
  }
  
  /**
   * è·å–æ‰€æœ‰å¯è§å­—æ®µ
   */
  getVisibleFields(fields: FieldConfig[]): FieldConfig[] {
    return fields.filter(field => this.isFieldVisible(field))
  }
  
  /**
   * è‡ªåŠ¨æ¸…ç©ºéšè—å­—æ®µçš„å€¼
   * ï¼ˆåœ¨å¯è§æ€§å˜åŒ–æ—¶è°ƒç”¨ï¼‰
   */
  clearHiddenFields(fields: FieldConfig[]): void {
    const updates: Record<string, any> = {}
    
    for (const field of fields) {
      if (!this.isFieldVisible(field)) {
        const currentValue = this.getRawValue(field.code)
        if (currentValue !== null && currentValue !== undefined) {
          updates[field.code] = null
          console.log(`ğŸ§¹ æ¸…ç©ºéšè—å­—æ®µ: ${field.code}`)
        }
      }
    }
    
    if (Object.keys(updates).length > 0) {
      this.batchUpdate(updates)
    }
  }
}
```

---

## 6. FormRenderer é›†æˆ

### 6.1 FormRenderer ä½¿ç”¨æ¡ä»¶æ¸²æŸ“

```vue
<template>
  <el-form ref="formRef" :model="formData" label-width="120px">
    <template v-for="field in fields" :key="field.code">
      <!-- ğŸ”¥ æ ¹æ®æ¡ä»¶æ§åˆ¶æ˜¾ç¤º -->
      <el-form-item
        v-if="fieldStates[field.code].visible"
        :prop="field.code"
        :required="fieldStates[field.code].required"
      >
        <template #label>
          <span>{{ field.name }}</span>
          <span v-if="fieldStates[field.code].required" class="required-mark">*</span>
        </template>
        
        <!-- æ¸²æŸ“ Widget -->
        <component
          :is="getWidgetComponent(field)"
          :field="field"
          :value="formManager.getValue(field.code)"
          :disabled="!fieldStates[field.code].enabled"
          :readonly="fieldStates[field.code].readonly"
          @change="handleFieldChange(field, $event)"
        />
      </el-form-item>
    </template>
  </el-form>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue'

// Props
const props = defineProps<{
  fields: FieldConfig[]
}>()

// è¡¨å•æ•°æ®ç®¡ç†å™¨
const formManager = new ReactiveFormDataManager()

// ğŸ”¥ å­—æ®µçŠ¶æ€ï¼ˆå“åº”å¼ï¼‰
const fieldStates = computed(() => {
  const states: Record<string, {
    visible: boolean
    enabled: boolean
    required: boolean
    readonly: boolean
  }> = {}
  
  for (const field of props.fields) {
    states[field.code] = {
      visible: formManager.isFieldVisible(field),
      enabled: formManager.isFieldEnabled(field),
      required: formManager.isFieldRequired(field),
      readonly: formManager.isFieldReadonly(field)
    }
  }
  
  return states
})

// ğŸ”¥ ç›‘å¬å¯è§æ€§å˜åŒ–ï¼Œè‡ªåŠ¨æ¸…ç©ºéšè—å­—æ®µ
watch(
  () => fieldStates.value,
  (newStates, oldStates) => {
    if (!oldStates) return
    
    // æ‰¾å‡ºä»æ˜¾ç¤ºå˜ä¸ºéšè—çš„å­—æ®µ
    for (const [code, state] of Object.entries(newStates)) {
      if (oldStates[code]?.visible && !state.visible) {
        formManager.setValue(code, null)
        console.log(`ğŸ§¹ æ¸…ç©ºéšè—å­—æ®µ: ${code}`)
      }
    }
  },
  { deep: true }
)
</script>
```

---

## 7. å®Œæ•´ç¤ºä¾‹

### 7.1 åœºæ™¯ï¼šå·¥å•è¡¨å•

```typescript
// å·¥å•è¡¨å•å­—æ®µé…ç½®
const ticketFields: FieldConfig[] = [
  {
    code: "å·¥å•ç±»å‹",
    name: "å·¥å•ç±»å‹",
    widget: { type: "select" },
    validation: "required",
    // æ— æ¡ä»¶ï¼Œå§‹ç»ˆæ˜¾ç¤º
  },
  {
    code: "ä¼˜å…ˆçº§",
    name: "ä¼˜å…ˆçº§",
    widget: { type: "select" },
    validation: "required"
  },
  {
    code: "ç´§æ€¥è”ç³»äºº",
    name: "ç´§æ€¥è”ç³»äºº",
    widget: { type: "input" },
    // ğŸ”¥ æ¡ä»¶å¿…å¡«ï¼šå½“ä¼˜å…ˆçº§æ˜¯"é«˜"æˆ–"ç´§æ€¥"æ—¶å¿…å¡«
    conditions: {
      required: {
        field: "ä¼˜å…ˆçº§",
        operator: "in",
        value: ["é«˜", "ç´§æ€¥"]
      }
    }
  },
  {
    code: "æ˜¯å¦éœ€è¦ä¸Šé—¨",
    name: "æ˜¯å¦éœ€è¦ä¸Šé—¨",
    widget: { type: "checkbox" },
    // ğŸ”¥ æ¡ä»¶æ˜¾ç¤ºï¼šå½“å·¥å•ç±»å‹æ˜¯"ç¡¬ä»¶æ•…éšœ"æ—¶æ‰æ˜¾ç¤º
    conditions: {
      visible: {
        field: "å·¥å•ç±»å‹",
        operator: "eq",
        value: "ç¡¬ä»¶æ•…éšœ"
      }
    }
  },
  {
    code: "ä¸Šé—¨åœ°å€",
    name: "ä¸Šé—¨åœ°å€",
    widget: { type: "input" },
    // ğŸ”¥ å¤æ‚æ¡ä»¶ï¼šå·¥å•ç±»å‹æ˜¯"ç¡¬ä»¶æ•…éšœ"ä¸”éœ€è¦ä¸Šé—¨æ—¶æ‰æ˜¾ç¤º
    conditions: {
      visible: {
        logic: "and",
        conditions: [
          { field: "å·¥å•ç±»å‹", operator: "eq", value: "ç¡¬ä»¶æ•…éšœ" },
          { field: "æ˜¯å¦éœ€è¦ä¸Šé—¨", operator: "eq", value: true }
        ]
      },
      required: {
        // æ˜¾ç¤ºæ—¶å¿…å¡«
        logic: "and",
        conditions: [
          { field: "å·¥å•ç±»å‹", operator: "eq", value: "ç¡¬ä»¶æ•…éšœ" },
          { field: "æ˜¯å¦éœ€è¦ä¸Šé—¨", operator: "eq", value: true }
        ]
      }
    }
  },
  {
    code: "é¢„ç®—",
    name: "é¢„ç®—",
    widget: { type: "number" },
    // ğŸ”¥ æ¡ä»¶å¯ç”¨ï¼šå½“å·¥å•ç±»å‹æ˜¯"é‡‡è´­"æ—¶æ‰èƒ½ç¼–è¾‘
    conditions: {
      visible: {
        field: "å·¥å•ç±»å‹",
        operator: "eq",
        value: "é‡‡è´­"
      }
    },
    validation: "required,min=0"
  },
  {
    code: "å¤‡æ³¨",
    name: "å¤‡æ³¨",
    widget: { type: "textarea" }
  }
]
```

### 7.2 åŠ¨æ€è¡Œä¸ºæ¼”ç¤º

```typescript
// ç”¨æˆ·æ“ä½œåºåˆ—

// 1. åˆå§‹çŠ¶æ€
formData = { å·¥å•ç±»å‹: null }
â†’ æ˜¾ç¤ºå­—æ®µ: [å·¥å•ç±»å‹, ä¼˜å…ˆçº§, å¤‡æ³¨]
â†’ éšè—å­—æ®µ: [ç´§æ€¥è”ç³»äºº, æ˜¯å¦éœ€è¦ä¸Šé—¨, ä¸Šé—¨åœ°å€, é¢„ç®—]

// 2. é€‰æ‹©å·¥å•ç±»å‹ = "ç¡¬ä»¶æ•…éšœ"
formData = { å·¥å•ç±»å‹: "ç¡¬ä»¶æ•…éšœ" }
â†’ æ˜¾ç¤ºå­—æ®µ: [å·¥å•ç±»å‹, ä¼˜å…ˆçº§, æ˜¯å¦éœ€è¦ä¸Šé—¨, å¤‡æ³¨]
â†’ éšè—å­—æ®µ: [ç´§æ€¥è”ç³»äºº, ä¸Šé—¨åœ°å€, é¢„ç®—]

// 3. å‹¾é€‰"æ˜¯å¦éœ€è¦ä¸Šé—¨" = true
formData = { å·¥å•ç±»å‹: "ç¡¬ä»¶æ•…éšœ", æ˜¯å¦éœ€è¦ä¸Šé—¨: true }
â†’ æ˜¾ç¤ºå­—æ®µ: [å·¥å•ç±»å‹, ä¼˜å…ˆçº§, æ˜¯å¦éœ€è¦ä¸Šé—¨, ä¸Šé—¨åœ°å€*, å¤‡æ³¨]
â†’ éšè—å­—æ®µ: [ç´§æ€¥è”ç³»äºº, é¢„ç®—]
â†’ å¿…å¡«å­—æ®µ: [ä¸Šé—¨åœ°å€] (æ¡ä»¶å¿…å¡«)

// 4. é€‰æ‹©ä¼˜å…ˆçº§ = "ç´§æ€¥"
formData = { å·¥å•ç±»å‹: "ç¡¬ä»¶æ•…éšœ", æ˜¯å¦éœ€è¦ä¸Šé—¨: true, ä¼˜å…ˆçº§: "ç´§æ€¥" }
â†’ æ˜¾ç¤ºå­—æ®µ: [å·¥å•ç±»å‹, ä¼˜å…ˆçº§, ç´§æ€¥è”ç³»äºº*, æ˜¯å¦éœ€è¦ä¸Šé—¨, ä¸Šé—¨åœ°å€*, å¤‡æ³¨]
â†’ å¿…å¡«å­—æ®µ: [å·¥å•ç±»å‹, ä¼˜å…ˆçº§, ç´§æ€¥è”ç³»äºº, ä¸Šé—¨åœ°å€]

// 5. åˆ‡æ¢å·¥å•ç±»å‹ = "é‡‡è´­"
formData = { å·¥å•ç±»å‹: "é‡‡è´­", æ˜¯å¦éœ€è¦ä¸Šé—¨: null, ä¸Šé—¨åœ°å€: null }
â†’ æ˜¾ç¤ºå­—æ®µ: [å·¥å•ç±»å‹, ä¼˜å…ˆçº§, é¢„ç®—*, å¤‡æ³¨]
â†’ è‡ªåŠ¨æ¸…ç©º: [æ˜¯å¦éœ€è¦ä¸Šé—¨, ä¸Šé—¨åœ°å€] (å› ä¸ºå·²éšè—)
```

---

## 8. å…¼å®¹æ—§ç‰ˆæœ¬é…ç½®

### 8.1 è‡ªåŠ¨è½¬æ¢å™¨

ä¸ºäº†å…¼å®¹æ—§ç‰ˆæœ¬çš„ `validation` å­—ç¬¦ä¸²é…ç½®ï¼Œæˆ‘ä»¬æä¾›ä¸€ä¸ªè‡ªåŠ¨è½¬æ¢å™¨ï¼š

```typescript
/**
 * æ—§ç‰ˆæœ¬é…ç½®è½¬æ¢å™¨
 * å°† validation ä¸­çš„æ¡ä»¶æå–åˆ° conditions ä¸­
 */
class LegacyConfigConverter {
  convert(field: FieldConfig): FieldConfig {
    if (!field.validation) return field
    
    const patterns = [
      { type: 'required_if', regex: /required_if=(\w+)\s+([^,]+)/ },
      { type: 'required_unless', regex: /required_unless=(\w+)\s+([^,]+)/ },
      { type: 'excluded_if', regex: /excluded_if=(\w+)\s+([^,]+)/ },
      { type: 'excluded_unless', regex: /excluded_unless=(\w+)\s+([^,]+)/ }
    ]
    
    for (const pattern of patterns) {
      const match = field.validation.match(pattern.regex)
      if (match) {
        const dependsOn = match[1]
        const value = match[2].trim()
        
        // åˆå§‹åŒ– conditions
        if (!field.conditions) field.conditions = {}
        
        switch (pattern.type) {
          case 'required_if':
            field.conditions.required = {
              field: dependsOn,
              operator: 'eq',
              value
            }
            field.conditions.visible = {
              field: dependsOn,
              operator: 'eq',
              value
            }
            break
            
          case 'required_unless':
            field.conditions.required = {
              field: dependsOn,
              operator: 'ne',
              value
            }
            field.conditions.visible = {
              field: dependsOn,
              operator: 'ne',
              value
            }
            break
            
          case 'excluded_if':
            field.conditions.visible = {
              field: dependsOn,
              operator: 'ne',
              value
            }
            break
            
          case 'excluded_unless':
            field.conditions.visible = {
              field: dependsOn,
              operator: 'eq',
              value
            }
            break
        }
        
        // ä» validation ä¸­ç§»é™¤æ¡ä»¶
        field.validation = field.validation.replace(match[0], '').replace(/^,|,$/g, '')
      }
    }
    
    return field
  }
}
```

---

## 9. æ€»ç»“

### 9.1 æ ¸å¿ƒèƒ½åŠ›

| åŠŸèƒ½ | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ |
|-----|-------|-------|
| **æ¡ä»¶æ˜¾ç¤º** | `required_if`, `excluded_if` | `conditions.visible` |
| **æ¡ä»¶å¿…å¡«** | `required_if` | `conditions.required` |
| **æ¡ä»¶å¯ç”¨** | âŒ | `conditions.enabled` |
| **æ¡ä»¶åªè¯»** | âŒ | `conditions.readonly` |
| **å¤æ‚æ¡ä»¶** | âŒ | æ”¯æŒ `and`/`or` é€»è¾‘ |
| **å¤šç§æ“ä½œç¬¦** | åªæ”¯æŒ `==` | æ”¯æŒ `>`, `<`, `in`, `contains` ç­‰ |
| **è‡ªå®šä¹‰æ¡ä»¶** | âŒ | æ”¯æŒè‡ªå®šä¹‰å‡½æ•° |
| **è‡ªåŠ¨æ¸…ç©ºéšè—å­—æ®µ** | âœ… | âœ… |
| **å“åº”å¼** | æ‰‹åŠ¨ watch | è‡ªåŠ¨å“åº” |

### 9.2 æ¶æ„ä¼˜åŠ¿

1. **åˆ†ç¦»å…³æ³¨ç‚¹**
   - æ¡ä»¶é€»è¾‘ä» validation ä¸­åˆ†ç¦»
   - æ›´æ¸…æ™°çš„é…ç½®ç»“æ„

2. **å¼ºå¤§çš„è¡¨è¾¾èƒ½åŠ›**
   - æ”¯æŒå¤æ‚æ¡ä»¶ç»„åˆ
   - æ”¯æŒå¤šç§æ“ä½œç¬¦
   - æ”¯æŒè‡ªå®šä¹‰å‡½æ•°

3. **å®Œå…¨å“åº”å¼**
   - åŸºäº computed
   - æ•°æ®å˜åŒ–è‡ªåŠ¨æ›´æ–°çŠ¶æ€

4. **æ˜“äºç»´æŠ¤**
   - é›†ä¸­å¼æ¡ä»¶æ±‚å€¼å™¨
   - ç»Ÿä¸€çš„åˆ¤æ–­é€»è¾‘

5. **å‘åå…¼å®¹**
   - æä¾›æ—§é…ç½®è½¬æ¢å™¨
   - å¹³æ»‘è¿ç§»

### 9.3 ä½¿ç”¨åœºæ™¯è¦†ç›–

âœ… ç®€å•æ¡ä»¶æ˜¾ç¤º/éšè—  
âœ… æ¡ä»¶å¿…å¡«  
âœ… æ¡ä»¶å¯ç”¨/ç¦ç”¨  
âœ… å¤šå­—æ®µè”åˆæ¡ä»¶  
âœ… å¤æ‚ä¸šåŠ¡é€»è¾‘  
âœ… è‡ªåŠ¨æ¸…ç©ºéšè—å­—æ®µ  
âœ… åŠ¨æ€éªŒè¯è§„åˆ™

---

## 10. ä¸å…¶ä»–æ¶æ„æ¨¡å—çš„é›†æˆ

### 10.1 ä¸å“åº”å¼æ•°æ®æµé›†æˆ

```typescript
// FormDataManager ç›‘å¬æ•°æ®å˜åŒ–ï¼Œè‡ªåŠ¨é‡æ–°è®¡ç®—å­—æ®µçŠ¶æ€
watch(
  () => formManager.getAllRawValues(),
  () => {
    // é‡æ–°è®¡ç®—æ‰€æœ‰å­—æ®µçš„å¯è§æ€§ã€å¯ç”¨çŠ¶æ€ç­‰
    updateFieldStates()
  },
  { deep: true }
)
```

### 10.2 ä¸ Widget æ¸²æŸ“é›†æˆ

```typescript
// Widget æ¥æ”¶å­—æ®µçŠ¶æ€
interface WidgetRenderProps {
  field: FieldConfig
  value: FieldValue
  
  // ğŸ”¥ å­—æ®µçŠ¶æ€
  disabled?: boolean  // ç”± conditions.enabled è®¡ç®—
  readonly?: boolean  // ç”± conditions.readonly è®¡ç®—
  required?: boolean  // ç”± conditions.required è®¡ç®—
  
  // ... å…¶ä»– props
}
```

### 10.3 ä¸å›è°ƒç³»ç»Ÿé›†æˆ

```typescript
// å›è°ƒæ—¶ä¼ é€’å®Œæ•´çš„å¯è§å­—æ®µæ•°æ®
const visibleFields = formManager.getVisibleFields(fields)
const context = formManager.getAllRawValues()

// åªæäº¤å¯è§å­—æ®µçš„æ•°æ®
const submitData = visibleFields.reduce((acc, field) => {
  acc[field.code] = context[field.code]
  return acc
}, {})
```

---

**è¿™ä¸ªè®¾è®¡æ˜¯å¦å®Œæ•´è§£å†³äº†æ¡ä»¶æ¸²æŸ“çš„éœ€æ±‚ï¼Ÿ** ğŸ¯


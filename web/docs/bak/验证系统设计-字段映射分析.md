# éªŒè¯ç³»ç»Ÿè®¾è®¡ - å­—æ®µæ˜ å°„åˆ†æ

## é—®é¢˜åˆ†æ

### æ ¸å¿ƒé—®é¢˜ï¼šGoå­—æ®µå vs JSONæ ‡ç­¾çš„æ˜ å°„

**åç«¯Goä»£ç ç¤ºä¾‹ï¼š**
```go
IsVip bool `json:"is_vip" validate:"required_if=CardType vip"`
```

**é—®é¢˜ï¼š**
1. Goç»“æ„ä½“å­—æ®µåï¼š`IsVip`ï¼ˆé©¼å³°å‘½åï¼‰
2. JSONæ ‡ç­¾ï¼š`is_vip`ï¼ˆä¸‹åˆ’çº¿å‘½åï¼‰
3. å‰ç«¯æ”¶åˆ°çš„ `code`ï¼š`is_vip`ï¼ˆæ¥è‡ªJSONæ ‡ç­¾ï¼‰
4. `validation` å­—æ®µå€¼ï¼š`required_if=CardType vip`
   - `CardType` æ˜¯Goå­—æ®µåï¼Œä¸æ˜¯JSONæ ‡ç­¾
   - å‰ç«¯æ— æ³•ç›´æ¥çŸ¥é“ `CardType` å¯¹åº”çš„ `code` æ˜¯ä»€ä¹ˆ

### éªŒè¯è§„åˆ™ä¸­çš„å­—æ®µå¼•ç”¨

æ¡ä»¶éªŒè¯è§„åˆ™ä¸­ä¼šå¼•ç”¨å…¶ä»–å­—æ®µï¼š

| è§„åˆ™ | æ ¼å¼ | ç¤ºä¾‹ | é—®é¢˜ |
|------|------|------|------|
| `required_if` | `required_if=Field value` | `required_if=IsVip true` | `IsVip` æ˜¯Goå­—æ®µå |
| `required_unless` | `required_unless=Field value` | `required_unless=UserType guest` | `UserType` æ˜¯Goå­—æ®µå |
| `required_with` | `required_with=Field` | `required_with=Phone` | `Phone` æ˜¯Goå­—æ®µå |
| `required_without` | `required_without=Field` | `required_without=Email` | `Email` æ˜¯Goå­—æ®µå |
| `eqfield` | `eqfield=Field` | `eqfield=ConfirmPassword` | `ConfirmPassword` æ˜¯Goå­—æ®µå |
| `gtfield` | `gtfield=Field` | `gtfield=StartDate` | `StartDate` æ˜¯Goå­—æ®µå |

---

## è§£å†³æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆAï¼šåç«¯é¢„å¤„ç†ï¼ˆâ­ æ¨èï¼‰

**æ€è·¯ï¼š** åç«¯åœ¨ç”Ÿæˆ `Field` æ—¶ï¼Œè‡ªåŠ¨å°† `validation` ä¸­çš„Goå­—æ®µåè½¬æ¢ä¸ºJSONæ ‡ç­¾ï¼ˆ`code`ï¼‰

**å®ç°ä½ç½®ï¼š** `sdk/agent-app/widget/decode.go` çš„ `ConvertTagsToField` å‡½æ•°

**å®ç°é€»è¾‘ï¼š**
```go
// éœ€è¦æ„å»ºä¸€ä¸ªæ˜ å°„è¡¨ï¼šFieldName -> JsonTag
fieldNameToJsonMap := make(map[string]string)
for _, tag := range allTags {
    fieldNameToJsonMap[tag.FieldName] = tag.Json
}

// è½¬æ¢ validation å­—ç¬¦ä¸²
convertedValidation := convertFieldNamesInValidation(tags.Validate, fieldNameToJsonMap)
// required_if=IsVip true -> required_if=is_vip true
```

**ä¼˜ç‚¹ï¼š**
- âœ… å‰ç«¯å®Œå…¨æ— éœ€å¤„ç†å­—æ®µæ˜ å°„
- âœ… èŒè´£åˆ†ç¦»ï¼šåç«¯è´Ÿè´£è½¬æ¢ï¼Œå‰ç«¯åªè´Ÿè´£éªŒè¯
- âœ… ä¸€æ¬¡æ€§è§£å†³ï¼Œåç»­æ— éœ€è€ƒè™‘
- âœ… ç¬¦åˆ"åç«¯å…œåº•"çš„è®¾è®¡åŸåˆ™

**ç¼ºç‚¹ï¼š**
- âŒ éœ€è¦ä¿®æ”¹åç«¯ä»£ç 
- âŒ éœ€è¦éå†æ‰€æœ‰å­—æ®µæ„å»ºæ˜ å°„è¡¨ï¼ˆæ€§èƒ½å½±å“å¾ˆå°ï¼‰

**æ¨èåº¦ï¼š** â­â­â­â­â­

---

### æ–¹æ¡ˆBï¼šå‰ç«¯è½¬æ¢ï¼ˆå½“å‰å¯è¡Œæ–¹æ¡ˆï¼‰

**æ€è·¯ï¼š** å‰ç«¯è§£æ `validation` æ—¶ï¼Œå°è¯•å°†å¯èƒ½çš„Goå­—æ®µåè½¬æ¢ä¸ºJSONæ ‡ç­¾

**å®ç°æ–¹å¼ï¼š**
1. éå†æ‰€æœ‰å­—æ®µï¼Œæ„å»º `code -> field` çš„æ˜ å°„
2. å°è¯•é€šè¿‡å‘½åçº¦å®šè½¬æ¢ï¼š
   - é©¼å³°è½¬ä¸‹åˆ’çº¿ï¼š`IsVip` -> `is_vip`
   - é¦–å­—æ¯å°å†™ï¼š`IsVip` -> `isVip`
3. å¦‚æœè½¬æ¢ååŒ¹é…åˆ°å­—æ®µï¼Œä½¿ç”¨è½¬æ¢åçš„ `code`

**ä¼˜ç‚¹ï¼š**
- âœ… ä¸éœ€è¦ä¿®æ”¹åç«¯
- âœ… å‰ç«¯å¯ä»¥ç«‹å³å®ç°

**ç¼ºç‚¹ï¼š**
- âŒ ä¸å¤Ÿå¯é ï¼ˆå‘½åçº¦å®šå¯èƒ½ä¸ä¸€è‡´ï¼‰
- âŒ å¢åŠ å‰ç«¯å¤æ‚åº¦
- âŒ å¯èƒ½å­˜åœ¨è½¬æ¢å¤±è´¥çš„æƒ…å†µ

**æ¨èåº¦ï¼š** â­â­â­ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

---

### æ–¹æ¡ˆCï¼šåç«¯è¿”å›æ˜ å°„å…³ç³»ï¼ˆæŠ˜ä¸­æ–¹æ¡ˆï¼‰

**æ€è·¯ï¼š** åç«¯åœ¨è¿”å›å­—æ®µä¿¡æ¯æ—¶ï¼Œé¢å¤–æä¾› `field_name`ï¼ˆGoå­—æ®µåï¼‰

**ä¿®æ”¹ `Field` ç»“æ„ï¼š**
```go
type Field struct {
    Code      string `json:"code"`        // JSONæ ‡ç­¾ï¼ˆç°æœ‰ï¼‰
    FieldName string `json:"field_name"`  // Goå­—æ®µåï¼ˆæ–°å¢ï¼‰
    // ... å…¶ä»–å­—æ®µ
}
```

**å‰ç«¯å¤„ç†ï¼š**
```typescript
interface FieldConfig {
  code: string
  field_name?: string  // Goå­—æ®µå
  // ...
}

// æ„å»ºæ˜ å°„è¡¨
const fieldNameToCodeMap = new Map<string, string>()
fields.forEach(field => {
  if (field.field_name && field.code) {
    fieldNameToCodeMap.set(field.field_name, field.code)
  }
})
```

**ä¼˜ç‚¹ï¼š**
- âœ… ä¿¡æ¯å®Œæ•´ï¼Œæ˜ å°„å‡†ç¡®
- âœ… å‰ç«¯å¯ä»¥çµæ´»å¤„ç†

**ç¼ºç‚¹ï¼š**
- âŒ éœ€è¦ä¿®æ”¹åç«¯æ•°æ®ç»“æ„ï¼ˆå¯èƒ½å½±å“å…¶ä»–è°ƒç”¨æ–¹ï¼‰
- âŒ å¢åŠ äº†æ•°æ®ä¼ è¾“é‡
- âŒ å‰ç«¯ä»ç„¶éœ€è¦åšè½¬æ¢é€»è¾‘

**æ¨èåº¦ï¼š** â­â­â­â­ï¼ˆå¦‚æœæ–¹æ¡ˆAä¸å¯è¡Œï¼‰

---

## å­—æ®µå‘½åçº¦å®šåˆ†æ

### Goå­—æ®µåå¸¸è§å‘½åè§„åˆ™

1. **é©¼å³°å‘½åï¼ˆPascalCaseï¼‰**ï¼š`IsVip`ã€`CardType`ã€`PhoneNumber`
2. **é¦–å­—æ¯å°å†™é©¼å³°ï¼ˆcamelCaseï¼‰**ï¼š`isVip`ã€`cardType`ï¼ˆä¸å¸¸è§ï¼Œä¸ç¬¦åˆGoè§„èŒƒï¼‰

### JSONæ ‡ç­¾å¸¸è§å‘½åè§„åˆ™

1. **ä¸‹åˆ’çº¿å‘½åï¼ˆsnake_caseï¼‰**ï¼š`is_vip`ã€`card_type`ã€`phone_number`ï¼ˆæœ€å¸¸è§ï¼‰
2. **é©¼å³°å‘½åï¼ˆcamelCaseï¼‰**ï¼š`isVip`ã€`cardType`ï¼ˆè¾ƒå°‘è§ï¼‰
3. **å…¨å°å†™**ï¼š`isvip`ã€`cardtype`ï¼ˆæå°‘è§ï¼‰

### è½¬æ¢è§„åˆ™æ¨æµ‹

å‡è®¾Goå­—æ®µåå’ŒJSONæ ‡ç­¾éµå¾ªå¸¸è§çº¦å®šï¼š
- Goï¼š`IsVip`ï¼ˆPascalCaseï¼‰
- JSONï¼š`is_vip`ï¼ˆsnake_caseï¼‰

è½¬æ¢é€»è¾‘ï¼ˆä¸å¯é ï¼Œä»…ä½œä¸ºä¸´æ—¶æ–¹æ¡ˆï¼‰ï¼š
```typescript
// PascalCase -> snake_case
function goFieldNameToJsonCode(fieldName: string): string {
  return fieldName
    .replace(/([A-Z])/g, '_$1')  // å¤§å†™å­—æ¯å‰åŠ ä¸‹åˆ’çº¿
    .toLowerCase()
    .replace(/^_/, '')            // ç§»é™¤å¼€å¤´çš„ä¸‹åˆ’çº¿
}

// ç¤ºä¾‹
goFieldNameToJsonCode('IsVip')      // -> 'is_vip'
goFieldNameToJsonCode('CardType')   // -> 'card_type'
goFieldNameToJsonCode('PhoneNumber') // -> 'phone_number'
```

**é—®é¢˜ï¼š**
- å¦‚æœå®é™…JSONæ ‡ç­¾æ˜¯ `isVip`ï¼ˆcamelCaseï¼‰ï¼Œè½¬æ¢ä¼šå¤±è´¥
- å¦‚æœå­—æ®µåæœ¬èº«åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œè½¬æ¢å¯èƒ½ä¸å‡†ç¡®

---

## æ¨èæ–¹æ¡ˆï¼šåç«¯é¢„å¤„ç†

### å®ç°æ­¥éª¤

1. **ä¿®æ”¹åç«¯ `ConvertTagsToField` å‡½æ•°**
   - æ¥æ”¶æ‰€æœ‰å­—æ®µçš„ `FieldTags` åˆ—è¡¨ï¼ˆç”¨äºæ„å»ºæ˜ å°„è¡¨ï¼‰
   - éå† `validation` å­—ç¬¦ä¸²ï¼Œè¯†åˆ«å­—æ®µå
   - å°†Goå­—æ®µåæ›¿æ¢ä¸ºJSONæ ‡ç­¾

2. **å‰ç«¯å®ç°éªŒè¯ç³»ç»Ÿ**
   - è§£æ `validation` å­—ç¬¦ä¸²ï¼ˆæ­¤æ—¶å­—æ®µåå·²ç»æ˜¯ `code`ï¼‰
   - å®ç°éªŒè¯å™¨ï¼ˆrequired, min, max, oneofç­‰ï¼‰
   - å®ç°æ¡ä»¶éªŒè¯å™¨ï¼ˆrequired_ifç­‰ï¼Œæ­¤æ—¶ç›´æ¥ä½¿ç”¨ `code` è®¿é—®å…¶ä»–å­—æ®µï¼‰

### éªŒè¯å™¨è§£æç¤ºä¾‹

**è¾“å…¥ï¼š** `validation="required,min=2,max=20,required_if=is_vip true"`

**è§£æåï¼š**
```typescript
{
  rules: [
    { type: 'required' },
    { type: 'min', value: 2 },
    { type: 'max', value: 20 },
    { type: 'required_if', field: 'is_vip', value: 'true' }
  ]
}
```

**éªŒè¯æ—¶ï¼š**
```typescript
// è®¿é—®å…¶ä»–å­—æ®µå€¼ï¼ˆé€šè¿‡ formManagerï¼‰
const otherFieldValue = formManager.getValue('is_vip')
if (otherFieldValue.raw === 'true') {
  // å½“å‰å­—æ®µå¿…å¡«
}
```

---

## å‰ç«¯éªŒè¯ç³»ç»Ÿæ¶æ„è®¾è®¡

### 1. éªŒè¯å™¨æ¥å£ï¼ˆç¬¦åˆå¼€é—­åŸåˆ™ï¼‰

```typescript
interface Validator {
  name: string
  validate(value: FieldValue, rule: ValidationRule, context: ValidationContext): ValidationResult
}

interface ValidationContext {
  formManager: ReactiveFormDataManager  // ç”¨äºè®¿é—®å…¶ä»–å­—æ®µ
  fieldPath: string  // å½“å‰å­—æ®µè·¯å¾„
  allFields: FieldConfig[]  // æ‰€æœ‰å­—æ®µé…ç½®ï¼ˆç”¨äºæŸ¥æ‰¾ï¼‰
}
```

### 2. éªŒè¯å™¨æ³¨å†Œè¡¨ï¼ˆç­–ç•¥æ¨¡å¼ï¼‰

```typescript
class ValidatorRegistry {
  private validators = new Map<string, Validator>()
  
  register(validator: Validator): void {
    this.validators.set(validator.name, validator)
  }
  
  get(name: string): Validator | undefined {
    return this.validators.get(name)
  }
}
```

### 3. æ¡ä»¶éªŒè¯å™¨å®ç°ï¼ˆè§£è€¦è®¾è®¡ï¼‰

```typescript
class RequiredIfValidator implements Validator {
  name = 'required_if'
  
  validate(
    value: FieldValue, 
    rule: ValidationRule, 
    context: ValidationContext
  ): ValidationResult {
    // ğŸ”¥ å…³é”®ï¼šé€šè¿‡ formManager è®¿é—®å…¶ä»–å­—æ®µï¼Œä¸ç›´æ¥è€¦åˆ
    const otherFieldValue = context.formManager.getValue(rule.field!)
    
    // åˆ¤æ–­æ¡ä»¶æ˜¯å¦æ»¡è¶³
    if (this.isConditionMet(otherFieldValue, rule.value)) {
      // æ¡ä»¶æ»¡è¶³ï¼Œå½“å‰å­—æ®µå¿…å¡«
      if (!value.raw || value.raw === '') {
        return { valid: false, message: 'æ­¤å­—æ®µä¸ºå¿…å¡«é¡¹' }
      }
    }
    
    return { valid: true }
  }
  
  private isConditionMet(fieldValue: FieldValue, expectedValue: string): boolean {
    // ç±»å‹è½¬æ¢å’Œæ¯”è¾ƒé€»è¾‘
    return String(fieldValue.raw) === expectedValue
  }
}
```

### 4. éªŒè¯å¼•æ“ï¼ˆç»Ÿä¸€å…¥å£ï¼‰

```typescript
class ValidationEngine {
  constructor(
    private registry: ValidatorRegistry,
    private formManager: ReactiveFormDataManager
  ) {}
  
  validateField(
    field: FieldConfig,
    value: FieldValue,
    allFields: FieldConfig[]
  ): ValidationResult[] {
    if (!field.validation) {
      return []  // æ— éªŒè¯è§„åˆ™
    }
    
    const rules = this.parseValidationString(field.validation)
    const context: ValidationContext = {
      formManager: this.formManager,
      fieldPath: field.field_path || field.code,
      allFields
    }
    
    const errors: ValidationResult[] = []
    
    for (const rule of rules) {
      const validator = this.registry.get(rule.type)
      if (!validator) {
        console.warn(`[ValidationEngine] æœªçŸ¥éªŒè¯å™¨: ${rule.type}`)
        continue
      }
      
      const result = validator.validate(value, rule, context)
      if (!result.valid) {
        errors.push(result)
      }
    }
    
    return errors
  }
  
  private parseValidationString(validation: string): ValidationRule[] {
    // è§£æ validation å­—ç¬¦ä¸²
    // ä¾‹å¦‚: "required,min=2,max=20,required_if=is_vip true"
    // è¿”å›: [
    //   { type: 'required' },
    //   { type: 'min', value: 2 },
    //   { type: 'max', value: 20 },
    //   { type: 'required_if', field: 'is_vip', value: 'true' }
    // ]
  }
}
```

---

## å®ç°ä¼˜å…ˆçº§

### Phase 1ï¼šåŸºç¡€éªŒè¯å™¨ï¼ˆä¸éœ€è¦å­—æ®µæ˜ å°„ï¼‰
- âœ… `required` - å¿…å¡«
- âœ… `min` / `max` - é•¿åº¦/å€¼é™åˆ¶
- âœ… `oneof` - æšä¸¾å€¼
- âœ… `email` - é‚®ç®±æ ¼å¼ï¼ˆå¦‚æœåç«¯è¿”å›å·²è½¬æ¢ï¼‰

### Phase 2ï¼šæ¡ä»¶éªŒè¯å™¨ï¼ˆéœ€è¦å­—æ®µæ˜ å°„ï¼‰
- âš ï¸ `required_if` - éœ€è¦è®¿é—®å…¶ä»–å­—æ®µ
- âš ï¸ `required_unless` - éœ€è¦è®¿é—®å…¶ä»–å­—æ®µ
- âš ï¸ `required_with` - éœ€è¦è®¿é—®å…¶ä»–å­—æ®µ
- âš ï¸ `required_without` - éœ€è¦è®¿é—®å…¶ä»–å­—æ®µ

### Phase 3ï¼šè·¨å­—æ®µéªŒè¯å™¨ï¼ˆéœ€è¦å­—æ®µæ˜ å°„ï¼‰
- âš ï¸ `eqfield` - å­—æ®µç›¸ç­‰
- âš ï¸ `gtfield` / `ltfield` - å­—æ®µæ¯”è¾ƒ

---

## å»ºè®®

1. **ä¼˜å…ˆæ¨åŠ¨åç«¯å®ç°æ–¹æ¡ˆA**ï¼ˆé¢„å¤„ç†validationå­—ç¬¦ä¸²ï¼‰
   - è”ç³»åç«¯å¼€å‘ï¼Œè¯´æ˜éœ€æ±‚å’Œå®ç°æ–¹æ¡ˆ
   - æä¾›å®ç°ç¤ºä¾‹ä»£ç 
   - ä¸€æ¬¡æ€§è§£å†³å­—æ®µæ˜ å°„é—®é¢˜

2. **å‰ç«¯å…ˆå®ç°Phase 1**ï¼ˆåŸºç¡€éªŒè¯å™¨ï¼‰
   - ä¸ä¾èµ–å­—æ®µæ˜ å°„
   - å¯ä»¥ç«‹å³æå‡ç”¨æˆ·ä½“éªŒ

3. **æ¡ä»¶éªŒè¯å™¨ä½¿ç”¨ä¸´æ—¶æ–¹æ¡ˆB**
   - å¦‚æœåç«¯æš‚æ—¶æ— æ³•ä¿®æ”¹ï¼Œä½¿ç”¨å‘½åçº¦å®šè½¬æ¢
   - æ·»åŠ è­¦å‘Šæ—¥å¿—ï¼Œæé†’å¯èƒ½çš„ä¸å‡†ç¡®æ€§
   - åç»­åˆ‡æ¢åˆ°æ–¹æ¡ˆA

---

## æ€»ç»“

**æ ¸å¿ƒé—®é¢˜ï¼š** Goå­—æ®µåå’ŒJSONæ ‡ç­¾çš„æ˜ å°„

**æœ€ä½³æ–¹æ¡ˆï¼š** åç«¯é¢„å¤„ç†ï¼Œå°†validationä¸­çš„Goå­—æ®µåè½¬æ¢ä¸ºJSONæ ‡ç­¾

**å‰ç«¯æ¶æ„ï¼š** ä½¿ç”¨ç­–ç•¥æ¨¡å¼ + ä¾èµ–æ³¨å…¥ï¼ˆformManagerï¼‰ï¼Œç¬¦åˆå¼€é—­åŸåˆ™ï¼Œæ˜“äºæ‰©å±•

**å®ç°ç­–ç•¥ï¼š** åˆ†é˜¶æ®µå®ç°ï¼Œå…ˆåŸºç¡€åæ¡ä»¶ï¼Œä¸´æ—¶æ–¹æ¡ˆä½œä¸ºè¿‡æ¸¡


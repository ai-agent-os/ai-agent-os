# æ¶æ„è®¾è®¡ - éªŒè¯ç³»ç»Ÿï¼ˆç®€åŒ–ç‰ˆï¼‰

## æ ¸å¿ƒåŸåˆ™

> **åç«¯éªŒè¯æ˜¯å…œåº•ï¼Œå‰ç«¯éªŒè¯æå‡ä½“éªŒ**
> 
> **å…ˆå®ç°æ ¸å¿ƒéªŒè¯ï¼ˆå¿…å¡« + æ¡ä»¶å±•ç¤ºï¼‰ï¼Œå¤Ÿç”¨å°±è¡Œ**
> 
> **æ¶æ„æ”¯æŒæ‰©å±•ï¼Œéœ€è¦æ—¶å†åŠ **

---

## å®ç°ä¼˜å…ˆçº§

### ğŸ”¥ Phase 1: æ ¸å¿ƒéªŒè¯ï¼ˆç«‹å³å®ç°ï¼‰
- `required` - å¿…å¡«
- `required_if` - æ¡ä»¶å¿…å¡«
- `excluded_if` - æ¡ä»¶æ’é™¤/éšè—
- `min` / `max` - é•¿åº¦/å€¼é™åˆ¶
- `oneof` - æšä¸¾å€¼

**è¿™ 5 ä¸ªéªŒè¯å™¨è¦†ç›– 90% åœºæ™¯ï¼**

### â­ Phase 2: å¸¸ç”¨éªŒè¯ï¼ˆæœ‰æ—¶é—´å†åšï¼‰
- `email` - é‚®ç®±æ ¼å¼
- `url` - URL æ ¼å¼
- `numeric` - æ•°å­—å­—ç¬¦ä¸²
- è·¨å­—æ®µéªŒè¯ï¼ˆ`eqfield`, `gtfield` ç­‰ï¼‰

### ğŸ’¡ Phase 3: æ‰©å±•éªŒè¯ï¼ˆæŒ‰éœ€æ·»åŠ ï¼‰
- Go validator/v10 çš„å…¶ä»– 60+ éªŒè¯å™¨
- éœ€è¦æ—¶ç®€å•æ³¨å†Œå³å¯

---

## 1. ç®€åŒ–çš„ ValidatorEngine

### 1.1 æ ¸å¿ƒå®ç°

```typescript
/**
 * éªŒè¯å¼•æ“ï¼ˆç®€åŒ–ç‰ˆï¼‰
 * åªå®ç°æ ¸å¿ƒéªŒè¯ï¼Œæ¶æ„æ”¯æŒæ‰©å±•
 */
class ValidatorEngine {
  // éªŒè¯å™¨æ³¨å†Œè¡¨
  private validators = new Map<string, ValidatorFunction>()
  
  constructor() {
    this.registerCoreValidators()
  }
  
  /**
   * éªŒè¯å­—æ®µ
   */
  validate(
    value: any,
    field: FieldConfig,
    formData: Record<string, any>
  ): ValidationResult {
    if (!field.validation) {
      return { valid: true }
    }
    
    // è§£æéªŒè¯è§„åˆ™
    const rules = this.parseValidationRules(field.validation)
    
    // æ‰§è¡ŒéªŒè¯
    const errors: ValidationError[] = []
    
    for (const rule of rules) {
      const validator = this.validators.get(rule.tag)
      
      if (!validator) {
        console.warn(`æœªçŸ¥çš„éªŒè¯è§„åˆ™: ${rule.tag}`)
        continue
      }
      
      const result = validator(value, rule.param, field, formData)
      
      if (!result.valid) {
        errors.push({
          field: field.code,
          tag: rule.tag,
          message: result.message || `${field.name}éªŒè¯å¤±è´¥`
        })
      }
    }
    
    return {
      valid: errors.length === 0,
      errors
    }
  }
  
  /**
   * è§£æéªŒè¯è§„åˆ™å­—ç¬¦ä¸²
   * ä¾‹å¦‚: "required,min=5,max=100,oneof=A B C"
   */
  private parseValidationRules(validation: string): ValidationRule[] {
    const rules: ValidationRule[] = []
    
    // ç®€å•æŒ‰é€—å·åˆ†å‰²ï¼ˆæš‚ä¸å¤„ç†å¤æ‚æƒ…å†µï¼‰
    const parts = validation.split(',').map(p => p.trim()).filter(p => p)
    
    for (const part of parts) {
      const index = part.indexOf('=')
      
      if (index === -1) {
        // æ— å‚æ•°ï¼Œå¦‚ required
        rules.push({ tag: part, param: undefined })
      } else {
        // æœ‰å‚æ•°ï¼Œå¦‚ min=5
        rules.push({
          tag: part.substring(0, index),
          param: part.substring(index + 1)
        })
      }
    }
    
    return rules
  }
  
  /**
   * æ³¨å†Œæ ¸å¿ƒéªŒè¯å™¨
   */
  private registerCoreValidators(): void {
    // ========== æ ¸å¿ƒéªŒè¯å™¨ ==========
    
    /**
     * required - å¿…å¡« ğŸ”¥
     */
    this.register('required', (value) => {
      const valid = value !== null && value !== undefined && value !== ''
      return {
        valid,
        message: valid ? undefined : 'æ­¤å­—æ®µä¸ºå¿…å¡«é¡¹'
      }
    })
    
    /**
     * min - æœ€å°é•¿åº¦/å€¼ ğŸ”¥
     */
    this.register('min', (value, param, field) => {
      if (!value && value !== 0) return { valid: true }
      
      const min = parseFloat(param || '0')
      const isNumber = ['int', 'float', 'number'].includes(field.data.type)
      
      if (isNumber) {
        const valid = Number(value) >= min
        return {
          valid,
          message: valid ? undefined : `ä¸èƒ½å°äº ${min}`
        }
      } else {
        const length = String(value).length
        const valid = length >= min
        return {
          valid,
          message: valid ? undefined : `æœ€å°‘ ${min} ä¸ªå­—ç¬¦`
        }
      }
    })
    
    /**
     * max - æœ€å¤§é•¿åº¦/å€¼ ğŸ”¥
     */
    this.register('max', (value, param, field) => {
      if (!value && value !== 0) return { valid: true }
      
      const max = parseFloat(param || '0')
      const isNumber = ['int', 'float', 'number'].includes(field.data.type)
      
      if (isNumber) {
        const valid = Number(value) <= max
        return {
          valid,
          message: valid ? undefined : `ä¸èƒ½å¤§äº ${max}`
        }
      } else {
        const length = String(value).length
        const valid = length <= max
        return {
          valid,
          message: valid ? undefined : `æœ€å¤š ${max} ä¸ªå­—ç¬¦`
        }
      }
    })
    
    /**
     * oneof - æšä¸¾å€¼ ğŸ”¥
     */
    this.register('oneof', (value, param) => {
      if (!value) return { valid: true }
      
      const options = param!.split(/\s+/).filter(o => o)
      const valid = options.includes(String(value))
      
      return {
        valid,
        message: valid ? undefined : `å¿…é¡»æ˜¯ä»¥ä¸‹å€¼ä¹‹ä¸€: ${options.join(', ')}`
      }
    })
    
    /**
     * required_if - æ¡ä»¶å¿…å¡« ğŸ”¥
     */
    this.register('required_if', (value, param, field, formData) => {
      // å‚æ•°æ ¼å¼: "å­—æ®µå å€¼"
      const parts = param!.split(/\s+/)
      const otherField = parts[0]
      const expectedValues = parts.slice(1)
      
      const otherValue = String(formData[otherField] || '')
      
      // æ£€æŸ¥æ¡ä»¶æ˜¯å¦æ»¡è¶³
      const conditionMet = expectedValues.some(expected => 
        String(expected) === otherValue
      )
      
      if (!conditionMet) {
        // æ¡ä»¶ä¸æ»¡è¶³ï¼Œä¸éœ€è¦éªŒè¯
        return { valid: true }
      }
      
      // æ¡ä»¶æ»¡è¶³ï¼Œæ£€æŸ¥æ˜¯å¦å¿…å¡«
      const valid = value !== null && value !== undefined && value !== ''
      return {
        valid,
        message: valid ? undefined : `å½“ ${otherField} ä¸º ${expectedValues.join(' æˆ– ')} æ—¶ï¼Œæ­¤å­—æ®µä¸ºå¿…å¡«é¡¹`
      }
    })
  }
  
  /**
   * æ³¨å†ŒéªŒè¯å™¨ï¼ˆæ”¯æŒæ‰©å±•ï¼‰
   */
  register(tag: string, validator: ValidatorFunction): void {
    this.validators.set(tag, validator)
  }
}

/**
 * éªŒè¯å‡½æ•°ç±»å‹
 */
type ValidatorFunction = (
  value: any,
  param: string | undefined,
  field: FieldConfig,
  formData: Record<string, any>
) => { valid: boolean; message?: string }

/**
 * éªŒè¯è§„åˆ™
 */
interface ValidationRule {
  tag: string
  param?: string
}

/**
 * éªŒè¯ç»“æœ
 */
interface ValidationResult {
  valid: boolean
  errors?: ValidationError[]
}

interface ValidationError {
  field: string
  tag: string
  message: string
}
```

---

## 2. æ¡ä»¶å±•ç¤ºï¼ˆexcluded_ifï¼‰

### 2.1 ä¸æ¡ä»¶æ¸²æŸ“ç³»ç»Ÿç»“åˆ

```typescript
/**
 * excluded_if ä¸»è¦ç”¨äºæ¡ä»¶æ¸²æŸ“ï¼Œä¸æ˜¯éªŒè¯
 * 
 * å»ºè®®ï¼š
 * - excluded_if æ”¾åœ¨ conditions.visible ä¸­å¤„ç†
 * - ä¸æ”¾åœ¨ validation ä¸­
 */

// âŒ ä¸æ¨èï¼ˆæ··åœ¨éªŒè¯ä¸­ï¼‰
{
  code: "ä¸Šé—¨åœ°å€",
  validation: "excluded_if=å·¥å•ç±»å‹ è½¯ä»¶"
}

// âœ… æ¨èï¼ˆæ”¾åœ¨æ¡ä»¶æ¸²æŸ“ä¸­ï¼‰
{
  code: "ä¸Šé—¨åœ°å€",
  conditions: {
    visible: {
      field: "å·¥å•ç±»å‹",
      operator: "ne",
      value: "è½¯ä»¶"
    }
  }
}
```

### 2.2 å¦‚æœä¸€å®šè¦åœ¨ validation ä¸­æ”¯æŒ

```typescript
/**
 * excluded_if - æ¡ä»¶æ’é™¤ï¼ˆè½¬ä¸ºæ¡ä»¶æ¸²æŸ“ï¼‰
 * 
 * è¿™ä¸ªéªŒè¯å™¨ä¸åšå®é™…éªŒè¯ï¼Œåªæ˜¯ä¸ºäº†å…¼å®¹æ—§é…ç½®
 * å®é™…å¤„ç†ç”±æ¡ä»¶æ¸²æŸ“ç³»ç»Ÿè´Ÿè´£
 */
this.register('excluded_if', (value, param, field, formData) => {
  // è¿™é‡Œä¸åšä»»ä½•éªŒè¯ï¼Œåªæ˜¯æ ‡è®°
  // å®é™…çš„æ˜¾ç¤º/éšè—ç”± ConditionEvaluator å¤„ç†
  return { valid: true }
})
```

---

## 3. é›†æˆåˆ° FormDataManager

```typescript
class ReactiveFormDataManager {
  private validatorEngine = new ValidatorEngine()
  
  /**
   * éªŒè¯å•ä¸ªå­—æ®µ
   */
  validateField(field: FieldConfig): ValidationResult {
    // åªéªŒè¯å¯è§å­—æ®µ
    if (!this.isFieldVisible(field)) {
      return { valid: true }
    }
    
    const value = this.getRawValue(field.code)
    const formData = this.getAllRawValues()
    
    return this.validatorEngine.validate(value, field, formData)
  }
  
  /**
   * éªŒè¯æ‰€æœ‰å­—æ®µ
   */
  validateAll(fields: FieldConfig[]): ValidationResult {
    const allErrors: ValidationError[] = []
    
    for (const field of fields) {
      // åªéªŒè¯å¯è§å­—æ®µ
      if (!this.isFieldVisible(field)) {
        continue
      }
      
      const result = this.validateField(field)
      
      if (!result.valid && result.errors) {
        allErrors.push(...result.errors)
      }
    }
    
    return {
      valid: allErrors.length === 0,
      errors: allErrors
    }
  }
}
```

---

## 4. FormRenderer ä½¿ç”¨

```vue
<template>
  <el-form ref="formRef" :model="formData" :rules="formRules">
    <el-form-item
      v-for="field in visibleFields"
      :key="field.code"
      :prop="field.code"
      :required="isFieldRequired(field)"
    >
      <!-- Widget -->
    </el-form-item>
  </el-form>
</template>

<script setup lang="ts">
// ç”Ÿæˆ Element Plus çš„éªŒè¯è§„åˆ™
const formRules = computed(() => {
  const rules: Record<string, any[]> = {}
  
  for (const field of props.fields) {
    rules[field.code] = [
      {
        validator: (rule: any, value: any, callback: any) => {
          const result = formManager.validateField(field)
          
          if (result.valid) {
            callback()
          } else {
            callback(new Error(result.errors?.[0]?.message || 'éªŒè¯å¤±è´¥'))
          }
        },
        trigger: ['blur', 'change']
      }
    ]
  }
  
  return rules
})

// æäº¤æ—¶éªŒè¯
const handleSubmit = async () => {
  // å‰ç«¯éªŒè¯
  const result = formManager.validateAll(props.fields)
  
  if (!result.valid) {
    ElMessage.error(result.errors?.[0]?.message || 'éªŒè¯å¤±è´¥')
    return
  }
  
  try {
    // æäº¤æ•°æ®
    await executeFunction(functionDetail.method, functionDetail.router, formManager.prepareSubmitData())
    ElMessage.success('æäº¤æˆåŠŸ')
  } catch (error: any) {
    // åç«¯éªŒè¯å¤±è´¥ï¼Œæ˜¾ç¤ºåç«¯è¿”å›çš„é”™è¯¯
    ElMessage.error(error.message || 'æäº¤å¤±è´¥')
  }
}
</script>
```

---

## 5. æ‰©å±•æ–°éªŒè¯å™¨ï¼ˆæŒ‰éœ€æ·»åŠ ï¼‰

### 5.1 æ·»åŠ  email éªŒè¯å™¨

```typescript
// éœ€è¦æ—¶ï¼Œç®€å•æ³¨å†Œå³å¯
validatorEngine.register('email', (value) => {
  if (!value) return { valid: true }
  
  const valid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(value))
  return {
    valid,
    message: valid ? undefined : 'å¿…é¡»æ˜¯æœ‰æ•ˆçš„é‚®ç®±åœ°å€'
  }
})
```

### 5.2 æ·»åŠ è·¨å­—æ®µéªŒè¯

```typescript
// ä¾‹å¦‚ï¼šå¯†ç ç¡®è®¤
validatorEngine.register('eqfield', (value, param, field, formData) => {
  if (!value) return { valid: true }
  
  const otherValue = formData[param!]
  const valid = value === otherValue
  
  return {
    valid,
    message: valid ? undefined : `å¿…é¡»ä¸ ${param} ç›¸åŒ`
  }
})
```

### 5.3 æ·»åŠ è‡ªå®šä¹‰éªŒè¯

```typescript
// ä¾‹å¦‚ï¼šæ‰‹æœºå·éªŒè¯
validatorEngine.register('mobile', (value) => {
  if (!value) return { valid: true }
  
  const valid = /^1[3-9]\d{9}$/.test(String(value))
  return {
    valid,
    message: valid ? undefined : 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·'
  }
})
```

---

## 6. æ€»ç»“

### 6.1 æ ¸å¿ƒéªŒè¯å™¨ï¼ˆPhase 1ï¼‰

| éªŒè¯å™¨ | ç”¨é€” | ä¼˜å…ˆçº§ |
|-------|-----|-------|
| `required` | å¿…å¡« | ğŸ”¥ æœ€é«˜ |
| `min` / `max` | é•¿åº¦/å€¼é™åˆ¶ | ğŸ”¥ æœ€é«˜ |
| `oneof` | æšä¸¾å€¼ | ğŸ”¥ æœ€é«˜ |
| `required_if` | æ¡ä»¶å¿…å¡« | ğŸ”¥ æœ€é«˜ |

**è¿™ 4 ä¸ªéªŒè¯å™¨è¶³å¤Ÿè¦†ç›– 90% çš„åœºæ™¯ï¼**

### 6.2 æ‰©å±•éªŒè¯å™¨ï¼ˆæŒ‰éœ€æ·»åŠ ï¼‰

| éªŒè¯å™¨ | ç”¨é€” | ä¼˜å…ˆçº§ |
|-------|-----|-------|
| `email` | é‚®ç®±æ ¼å¼ | â­ ä¸­ |
| `url` | URL æ ¼å¼ | â­ ä¸­ |
| `numeric` | æ•°å­—å­—ç¬¦ä¸² | â­ ä¸­ |
| `eqfield` | è·¨å­—æ®µç›¸ç­‰ | â­ ä¸­ |
| å…¶ä»– 60+ | Go validator/v10 | ğŸ’¡ ä½ |

### 6.3 è®¾è®¡ä¼˜åŠ¿

- âœ… **ç®€å•å¤Ÿç”¨** - æ ¸å¿ƒéªŒè¯å™¨è¦†ç›–å¤§éƒ¨åˆ†åœºæ™¯
- âœ… **åç«¯å…œåº•** - å‰ç«¯éªŒè¯å¤±è´¥ä¸å½±å“åç«¯éªŒè¯
- âœ… **æ˜“äºæ‰©å±•** - éœ€è¦æ—¶ï¼Œ`register` ä¸€ä¸‹å³å¯
- âœ… **ä¸è¿‡åº¦è®¾è®¡** - ä¸å®ç°ç”¨ä¸åˆ°çš„åŠŸèƒ½
- âœ… **å¿«é€Ÿä¸Šçº¿** - æ ¸å¿ƒéªŒè¯å™¨ 1-2 å¤©å³å¯å®Œæˆ

---

## 7. å¯¹é½ Go validator/v10 çš„ç­–ç•¥

### 7.1 æ¸è¿›å¼å¯¹é½

```
Phase 1: æ ¸å¿ƒ 5 ä¸ªéªŒè¯å™¨ âœ… ç«‹å³å®ç°
         â†“
Phase 2: å¸¸ç”¨ 10 ä¸ªéªŒè¯å™¨ â­ æœ‰éœ€è¦å†åš
         â†“
Phase 3: å®Œæ•´ 70+ éªŒè¯å™¨ ğŸ’¡ æŒ‰éœ€æ‰©å±•
```

### 7.2 éªŒè¯è§„åˆ™è§£æå…¼å®¹

```typescript
// å‰ç«¯æ”¯æŒçš„æ ¼å¼ä¸åç«¯å®Œå…¨ä¸€è‡´
validation: "required,min=5,max=100,oneof=A B C,required_if=type urgent"

// å³ä½¿å‰ç«¯æš‚æœªå®ç°æŸä¸ªéªŒè¯å™¨ï¼Œä¹Ÿä¸ä¼šæŠ¥é”™
// åªæ˜¯ä¼šæ‰“å° warningï¼Œä¸å½±å“å…¶ä»–éªŒè¯
validation: "required,isbn,email"  // isbn æš‚æœªå®ç°ï¼Œä½†ä¸å½±å“ required å’Œ email
```

### 7.3 é”™è¯¯æ¶ˆæ¯å¯¹é½

```typescript
// å‰ç«¯é”™è¯¯æ¶ˆæ¯å°½é‡ä¸åç«¯ä¸€è‡´
// ä½†ä¸å¼ºæ±‚å®Œå…¨ä¸€æ ·ï¼Œå› ä¸ºå‰ç«¯ä¸»è¦æ˜¯æå‡ä½“éªŒï¼Œåç«¯æ‰æ˜¯æœ€ç»ˆè£åˆ¤
```

---

**è¿™ä¸ªç®€åŒ–ç‰ˆè®¾è®¡ï¼Œå¤Ÿç”¨å—ï¼Ÿ** âœ…


# ç”¨æˆ·ä¿¡æ¯ç»Ÿä¸€è·å–æ–¹æ¡ˆåˆ†æ

## å½“å‰é—®é¢˜

åˆ·æ–°é¡µé¢æ—¶ï¼Œ`getUsersByUsernames` æ¥å£è¢«è°ƒç”¨äº† 3 æ¬¡ï¼š
1. **è¡¨æ ¼æ•°æ®ä¸­çš„ç”¨æˆ·**ï¼š`TableRenderer.batchLoadUserInfo()` - æŸ¥è¯¢è¡¨æ ¼ä¸­æ‰€æœ‰ user ç±»å‹å­—æ®µçš„ç”¨æˆ·ä¿¡æ¯
2. **å¤„ç†äººæœç´¢æ¡†**ï¼š`UserSearchInput.initSelectedUsers()` - æŸ¥è¯¢æœç´¢æ¡†ä¸­å·²é€‰ä¸­çš„ç”¨æˆ·ï¼ˆå¤„ç†äººï¼‰
3. **åˆ›å»ºäººæœç´¢æ¡†**ï¼š`UserSearchInput.initSelectedUsers()` - æŸ¥è¯¢æœç´¢æ¡†ä¸­å·²é€‰ä¸­çš„ç”¨æˆ·ï¼ˆåˆ›å»ºäººï¼‰

## é—®é¢˜åˆ†æ

### æ•°æ®æ¥æº
1. **è¡¨æ ¼æ•°æ®**ï¼šä» `tableData` ä¸­æ”¶é›†æ‰€æœ‰ user ç±»å‹å­—æ®µçš„å€¼
2. **æœç´¢è¡¨å•**ï¼šä» `searchForm` ä¸­æ”¶é›†æ‰€æœ‰ user ç±»å‹å­—æ®µçš„å€¼ï¼ˆå¯èƒ½æ˜¯æ•°ç»„æˆ–å­—ç¬¦ä¸²ï¼‰

### å¯èƒ½çš„é‡å¤
- è¡¨æ ¼ä¸­æ˜¾ç¤ºçš„å¤„ç†äºº/åˆ›å»ºäºº
- æœç´¢æ¡†ä¸­é€‰ä¸­çš„å¤„ç†äºº/åˆ›å»ºäºº
- è¿™ä¸¤ä¸ªå¯èƒ½æœ‰é‡å ï¼Œå¯¼è‡´é‡å¤æŸ¥è¯¢

## è§£å†³æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ1ï¼šæ‰©å±• TableRenderer çš„ batchLoadUserInfo

**å®ç°æ€è·¯**ï¼š
- åœ¨ `batchLoadUserInfo()` ä¸­ï¼Œä¸ä»…æ”¶é›†è¡¨æ ¼æ•°æ®ä¸­çš„ç”¨æˆ·ï¼Œè¿˜æ”¶é›†æœç´¢è¡¨å•ä¸­çš„ç”¨æˆ·
- ç»Ÿä¸€æŸ¥è¯¢åï¼Œå°†ç»“æœåˆ†å‘åˆ° `userInfoMap` å’Œé€šè¿‡äº‹ä»¶/å›è°ƒä¼ é€’ç»™ `UserSearchInput`

**ä¼˜ç‚¹**ï¼š
- å®ç°ç®€å•ï¼Œä¸éœ€è¦é¢å¤–çš„ store
- é€»è¾‘é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹

**ç¼ºç‚¹**ï¼š
- `UserSearchInput` éœ€è¦ç­‰å¾… `TableRenderer` æŸ¥è¯¢å®Œæˆï¼Œè€¦åˆåº¦é«˜
- å¦‚æœ `UserSearchInput` åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨ï¼ˆä¸åœ¨ TableRenderer ä¸­ï¼‰ï¼Œæ— æ³•å¤ç”¨
- éœ€è¦é¢å¤–çš„é€šä¿¡æœºåˆ¶ï¼ˆäº‹ä»¶/å›è°ƒï¼‰

**å¯è¡Œæ€§**ï¼šâ­â­â­ï¼ˆä¸­ç­‰ï¼‰

---

### æ–¹æ¡ˆ2ï¼šåˆ›å»ºå…¨å±€ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼ˆPinia Storeï¼‰â­æ¨è

**å®ç°æ€è·¯**ï¼š
- åˆ›å»ºä¸€ä¸ª `useUserInfoStore` Pinia store
- Store æä¾› `getUserInfo(username)` å’Œ `batchGetUserInfo(usernames)` æ–¹æ³•
- Store å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª `Map<string, UserInfo>` ç¼“å­˜
- æ‰€æœ‰ç»„ä»¶éƒ½ä» store ä¸­è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œæ‰è°ƒç”¨æ¥å£

**ä¼˜ç‚¹**ï¼š
- **è§£è€¦**ï¼š`UserSearchInput` ä¸éœ€è¦çŸ¥é“æ•°æ®æ¥æºï¼Œåªéœ€è¦ä» store è·å–
- **ç¼“å­˜**ï¼šé¿å…é‡å¤æŸ¥è¯¢ï¼Œå³ä½¿å¤šä¸ªç»„ä»¶éœ€è¦åŒä¸€ä¸ªç”¨æˆ·ï¼Œä¹ŸåªæŸ¥è¯¢ä¸€æ¬¡
- **å¯å¤ç”¨**ï¼šå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨ï¼Œä¸å±€é™äº TableRenderer
- **å®ç°ç®€å•**ï¼šå‚è€ƒ `auth.ts` store çš„æ¨¡å¼ï¼Œä»£ç é‡å°‘

**ç¼ºç‚¹**ï¼š
- éœ€è¦é¢å¤–çš„ store æ–‡ä»¶
- éœ€è¦ä¿®æ”¹ç°æœ‰ä»£ç ï¼Œè®©æ‰€æœ‰ç»„ä»¶éƒ½ä½¿ç”¨ store

**å®ç°æ­¥éª¤**ï¼š
1. åˆ›å»º `web/src/stores/userInfo.ts`
2. ä¿®æ”¹ `TableRenderer.batchLoadUserInfo()` ä½¿ç”¨ store
3. ä¿®æ”¹ `UserSearchInput.initSelectedUsers()` ä½¿ç”¨ store
4. åœ¨ `TableRenderer` åˆå§‹åŒ–æ—¶ï¼Œç»Ÿä¸€æ”¶é›†æ‰€æœ‰éœ€è¦çš„ç”¨æˆ·åï¼Œè°ƒç”¨ store çš„æ‰¹é‡æŸ¥è¯¢

**å¯è¡Œæ€§**ï¼šâ­â­â­â­â­ï¼ˆé«˜ï¼‰

---

### æ–¹æ¡ˆ3ï¼šé€šè¿‡ provide/inject åœ¨ TableRenderer ä¸­æä¾›ç”¨æˆ·ä¿¡æ¯

**å®ç°æ€è·¯**ï¼š
- `TableRenderer` é€šè¿‡ `provide` æä¾› `userInfoMap`
- `UserSearchInput` é€šè¿‡ `inject` è·å– `userInfoMap`
- å¦‚æœ `inject` åˆ° `userInfoMap`ï¼Œä¼˜å…ˆä½¿ç”¨ï¼›å¦åˆ™è‡ªå·±æŸ¥è¯¢

**ä¼˜ç‚¹**ï¼š
- ä¸éœ€è¦å…¨å±€ storeï¼Œä½œç”¨åŸŸæ¸…æ™°
- å®ç°ç›¸å¯¹ç®€å•

**ç¼ºç‚¹**ï¼š
- `UserSearchInput` éœ€è¦çŸ¥é“è‡ªå·±åœ¨ `TableRenderer` ä¸­ï¼Œè€¦åˆåº¦ä¸­ç­‰
- å¦‚æœ `UserSearchInput` åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨ï¼Œéœ€è¦ fallback é€»è¾‘
- éœ€è¦ä¿®æ”¹ `UserSearchInput` çš„ props æˆ–ä½¿ç”¨ inject

**å¯è¡Œæ€§**ï¼šâ­â­â­â­ï¼ˆè¾ƒé«˜ï¼‰

---

## æ¨èæ–¹æ¡ˆï¼šæ–¹æ¡ˆ2ï¼ˆå…¨å±€ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼‰

### å®ç°ç»†èŠ‚

#### 1. åˆ›å»º Store

```typescript
// web/src/stores/userInfo.ts
import { defineStore } from 'pinia'
import { ref } from 'vue'
import { getUsersByUsernames } from '@/api/user'
import type { UserInfo } from '@/types'

export const useUserInfoStore = defineStore('userInfo', () => {
  // ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼ˆusername -> UserInfoï¼‰
  const userInfoCache = ref<Map<string, UserInfo>>(new Map())
  
  // æ­£åœ¨æŸ¥è¯¢çš„ç”¨æˆ·åé›†åˆï¼ˆé¿å…é‡å¤æŸ¥è¯¢ï¼‰
  const loadingUsernames = ref<Set<string>>(new Set())
  
  /**
   * è·å–å•ä¸ªç”¨æˆ·ä¿¡æ¯
   * å¦‚æœç¼“å­˜ä¸­æœ‰ï¼Œç›´æ¥è¿”å›ï¼›å¦åˆ™æŸ¥è¯¢å¹¶ç¼“å­˜
   */
  async function getUserInfo(username: string): Promise<UserInfo | null> {
    if (!username) return null
    
    // å¦‚æœç¼“å­˜ä¸­æœ‰ï¼Œç›´æ¥è¿”å›
    if (userInfoCache.value.has(username)) {
      return userInfoCache.value.get(username)!
    }
    
    // å¦‚æœæ­£åœ¨æŸ¥è¯¢ï¼Œç­‰å¾…æŸ¥è¯¢å®Œæˆ
    if (loadingUsernames.value.has(username)) {
      // ç­‰å¾…æŸ¥è¯¢å®Œæˆï¼ˆç®€å•å®ç°ï¼šè½®è¯¢æ£€æŸ¥ï¼‰
      return new Promise((resolve) => {
        const checkInterval = setInterval(() => {
          if (userInfoCache.value.has(username)) {
            clearInterval(checkInterval)
            resolve(userInfoCache.value.get(username) || null)
          } else if (!loadingUsernames.value.has(username)) {
            clearInterval(checkInterval)
            resolve(null)
          }
        }, 50)
      })
    }
    
    // æ‰¹é‡æŸ¥è¯¢ï¼ˆå³ä½¿åªæœ‰ä¸€ä¸ªç”¨æˆ·ï¼Œä¹Ÿä½¿ç”¨æ‰¹é‡æ¥å£ï¼‰
    return batchGetUserInfo([username]).then(users => users[0] || null)
  }
  
  /**
   * æ‰¹é‡è·å–ç”¨æˆ·ä¿¡æ¯
   * åªæŸ¥è¯¢ç¼“å­˜ä¸­æ²¡æœ‰çš„ç”¨æˆ·
   */
  async function batchGetUserInfo(usernames: string[]): Promise<UserInfo[]> {
    if (!usernames || usernames.length === 0) return []
    
    // å»é‡
    const uniqueUsernames = [...new Set(usernames)].filter(u => u)
    if (uniqueUsernames.length === 0) return []
    
    // åˆ†ç¦»å·²ç¼“å­˜å’Œæœªç¼“å­˜çš„ç”¨æˆ·å
    const cachedUsers: UserInfo[] = []
    const uncachedUsernames: string[] = []
    
    uniqueUsernames.forEach(username => {
      if (userInfoCache.value.has(username)) {
        cachedUsers.push(userInfoCache.value.get(username)!)
      } else if (!loadingUsernames.value.has(username)) {
        uncachedUsernames.push(username)
      }
    })
    
    // å¦‚æœæ‰€æœ‰ç”¨æˆ·éƒ½å·²ç¼“å­˜ï¼Œç›´æ¥è¿”å›
    if (uncachedUsernames.length === 0) {
      return cachedUsers
    }
    
    // æ ‡è®°æ­£åœ¨æŸ¥è¯¢
    uncachedUsernames.forEach(username => loadingUsernames.value.add(username))
    
    try {
      // æ‰¹é‡æŸ¥è¯¢æœªç¼“å­˜çš„ç”¨æˆ·
      const response = await getUsersByUsernames(uncachedUsernames)
      const loadedUsers = response.users || []
      
      // æ›´æ–°ç¼“å­˜
      loadedUsers.forEach(user => {
        if (user.username) {
          userInfoCache.value.set(user.username, user)
        }
      })
      
      // ç§»é™¤æŸ¥è¯¢æ ‡è®°
      uncachedUsernames.forEach(username => loadingUsernames.value.delete(username))
      
      // è¿”å›æ‰€æœ‰ç”¨æˆ·ï¼ˆå·²ç¼“å­˜ + æ–°åŠ è½½çš„ï¼‰
      return uniqueUsernames.map(username => {
        return userInfoCache.value.get(username)!
      }).filter(Boolean)
    } catch (error) {
      // ç§»é™¤æŸ¥è¯¢æ ‡è®°
      uncachedUsernames.forEach(username => loadingUsernames.value.delete(username))
      console.error('[UserInfoStore] æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error)
      return cachedUsers
    }
  }
  
  /**
   * æ¸…é™¤ç¼“å­˜ï¼ˆå¯é€‰ï¼Œç”¨äºç™»å‡ºæ—¶æ¸…ç†ï¼‰
   */
  function clearCache(): void {
    userInfoCache.value.clear()
    loadingUsernames.value.clear()
  }
  
  return {
    userInfoCache,
    getUserInfo,
    batchGetUserInfo,
    clearCache
  }
})
```

#### 2. ä¿®æ”¹ TableRenderer

```typescript
// åœ¨ TableRenderer.vue ä¸­
import { useUserInfoStore } from '@/stores/userInfo'

const userInfoStore = useUserInfoStore()

async function batchLoadUserInfo(): Promise<void> {
  try {
    // 1. æ”¶é›†è¡¨æ ¼æ•°æ®ä¸­çš„ç”¨æˆ·
    const userFields = visibleFields.value.filter((field: FieldConfig) => field.widget?.type === 'user')
    if (userFields.length === 0) {
      userInfoMap.value = new Map()
      return
    }
    
    const tableUsernames = new Set<string>()
    tableData.value.forEach((row: any) => {
      userFields.forEach((field: FieldConfig) => {
        const value = row[field.code]
        if (value !== null && value !== undefined && value !== '') {
          tableUsernames.add(String(value))
        }
      })
    })
    
    // 2. æ”¶é›†æœç´¢è¡¨å•ä¸­çš„ç”¨æˆ·
    const searchUsernames = new Set<string>()
    searchableFields.value.forEach((field: FieldConfig) => {
      if (field.widget?.type === 'user' && searchForm.value[field.code]) {
        const value = searchForm.value[field.code]
        if (Array.isArray(value)) {
          value.forEach(v => {
            if (v) searchUsernames.add(String(v))
          })
        } else if (value) {
          searchUsernames.add(String(value))
        }
      }
    })
    
    // 3. åˆå¹¶æ‰€æœ‰ç”¨æˆ·å
    const allUsernames = [...new Set([...tableUsernames, ...searchUsernames])]
    
    if (allUsernames.length === 0) {
      userInfoMap.value = new Map()
      return
    }
    
    // 4. ç»Ÿä¸€æ‰¹é‡æŸ¥è¯¢ï¼ˆstore ä¼šè‡ªåŠ¨å¤„ç†ç¼“å­˜ï¼‰
    const users = await userInfoStore.batchGetUserInfo(allUsernames)
    
    // 5. æ„å»ºæ˜ å°„ï¼ˆä¾›è¡¨æ ¼æ¸²æŸ“ä½¿ç”¨ï¼‰
    const map = new Map<string, any>()
    users.forEach(user => {
      if (user.username) {
        map.set(user.username, user)
      }
    })
    
    userInfoMap.value = map
  } catch (error) {
    console.error('[TableRenderer] æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error)
    userInfoMap.value = new Map()
  }
}
```

#### 3. ä¿®æ”¹ UserSearchInput

```typescript
// åœ¨ UserSearchInput.vue ä¸­
import { useUserInfoStore } from '@/stores/userInfo'

const userInfoStore = useUserInfoStore()

const initSelectedUsers = async () => {
  // ... å‰é¢çš„é€»è¾‘ä¸å˜ï¼Œè·å– usernames ...
  
  try {
    const missingUsernames = usernames.filter(u => !currentUsernames.includes(u))
    
    if (missingUsernames.length > 0) {
      // ğŸ”¥ ä½¿ç”¨ store æ‰¹é‡æŸ¥è¯¢ï¼ˆä¼šè‡ªåŠ¨å¤„ç†ç¼“å­˜ï¼‰
      const loadedUsers = await userInfoStore.batchGetUserInfo(missingUsernames)
      
      // ... åé¢çš„é€»è¾‘ä¸å˜ ...
    }
  } catch (error) {
    // ...
  }
}
```

## ä¼˜åŒ–æ•ˆæœ

### ä¼˜åŒ–å‰
- è¡¨æ ¼æ•°æ®æŸ¥è¯¢ï¼š1 æ¬¡ï¼ˆå‡è®¾æœ‰ 5 ä¸ªç”¨æˆ·ï¼‰
- å¤„ç†äººæœç´¢æ¡†ï¼š1 æ¬¡ï¼ˆ2 ä¸ªç”¨æˆ·ï¼‰
- åˆ›å»ºäººæœç´¢æ¡†ï¼š1 æ¬¡ï¼ˆ1 ä¸ªç”¨æˆ·ï¼‰
- **æ€»è®¡ï¼š3 æ¬¡æ¥å£è°ƒç”¨**

### ä¼˜åŒ–å
- ç»Ÿä¸€æ”¶é›†ï¼šè¡¨æ ¼ 5 ä¸ª + å¤„ç†äºº 2 ä¸ª + åˆ›å»ºäºº 1 ä¸ª = 8 ä¸ªç”¨æˆ·åï¼ˆå»é‡åå¯èƒ½åªæœ‰ 6 ä¸ªï¼‰
- ç»Ÿä¸€æŸ¥è¯¢ï¼š1 æ¬¡æ¥å£è°ƒç”¨
- **æ€»è®¡ï¼š1 æ¬¡æ¥å£è°ƒç”¨**

### é¢å¤–ä¼˜åŠ¿
- **ç¼“å­˜æœºåˆ¶**ï¼šå¦‚æœåç»­æœ‰ç»„ä»¶éœ€è¦ç›¸åŒçš„ç”¨æˆ·ä¿¡æ¯ï¼Œç›´æ¥ä»ç¼“å­˜è·å–ï¼Œæ— éœ€å†æ¬¡æŸ¥è¯¢
- **é¿å…é‡å¤æŸ¥è¯¢**ï¼šå³ä½¿å¤šä¸ªç»„ä»¶åŒæ—¶éœ€è¦åŒä¸€ä¸ªç”¨æˆ·ï¼Œä¹ŸåªæŸ¥è¯¢ä¸€æ¬¡

## å®ç°éš¾åº¦è¯„ä¼°

- **éš¾åº¦**ï¼šâ­â­ï¼ˆç®€å•ï¼‰
- **å·¥ä½œé‡**ï¼šçº¦ 2-3 å°æ—¶
- **é£é™©**ï¼šä½ï¼ˆå‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼‰

## ç»“è®º

**æ¨èä½¿ç”¨æ–¹æ¡ˆ2ï¼ˆå…¨å±€ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼‰**ï¼Œå› ä¸ºï¼š
1. âœ… å®ç°ç®€å•ï¼Œä»£ç é‡å°‘
2. âœ… è§£è€¦ï¼Œå¯å¤ç”¨
3. âœ… æœ‰ç¼“å­˜æœºåˆ¶ï¼Œæ€§èƒ½æ›´å¥½
4. âœ… å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½
5. âœ… æ˜“äºç»´æŠ¤å’Œæ‰©å±•


# æ¶æ„è®¾è®¡ - ç»„ä»¶å¿«ç…§æœºåˆ¶

## æ ¸å¿ƒæ€è·¯

> **æ¯ä¸ªç»„ä»¶å®ç°å¿«ç…§æ¥å£ï¼Œè´Ÿè´£ä¿å­˜å’Œæ¢å¤è‡ªå·±çš„çŠ¶æ€**

### è®¾è®¡åŸåˆ™

1. **å„è‡ªç®¡å„è‡ª**ï¼šæ¯ä¸ªç»„ä»¶åªè´Ÿè´£ä¿å­˜è‡ªå·±çš„æ•°æ®ï¼Œä¸ç®¡å­ç»„ä»¶
2. **å¹³é“ºç»“æ„**ï¼šæ‰€æœ‰ Widget å¿«ç…§å¹³é“ºå­˜å‚¨ï¼Œé€šè¿‡ `field_path` æ ‡è¯†
3. **ç»Ÿä¸€æ”¶é›†**ï¼šFormRenderer ç»Ÿä¸€æ”¶é›†æ‰€æœ‰ Widgetï¼ˆåŒ…æ‹¬åµŒå¥—çš„ï¼‰
4. **ç»Ÿä¸€æ¥å£**ï¼šBaseWidget å®šä¹‰æ ‡å‡†å¿«ç…§æ¥å£
5. **ç±»å‹å®‰å…¨**ï¼šæ¯ä¸ªç»„ä»¶æœ‰è‡ªå·±çš„å¿«ç…§ç±»å‹å®šä¹‰
6. **é»˜è®¤å®ç°**ï¼šBaseWidget æä¾›é»˜è®¤å®ç°ï¼Œå­ç±»æŒ‰éœ€è¦†ç›–

---

## å¿«ç…§æ¥å£è®¾è®¡

### 1. BaseWidget å¿«ç…§æ¥å£

```typescript
/**
 * Widget å¿«ç…§æ¥å£
 */
interface IWidgetSnapshot {
  /**
   * æ•è·ç»„ä»¶å¿«ç…§
   * ğŸ”¥ æ¯ä¸ªç»„ä»¶å®ç°è‡ªå·±çš„å¿«ç…§é€»è¾‘
   */
  captureSnapshot(): WidgetSnapshot
  
  /**
   * æ¢å¤ç»„ä»¶å¿«ç…§
   * ğŸ”¥ æ¯ä¸ªç»„ä»¶å®ç°è‡ªå·±çš„æ¢å¤é€»è¾‘
   */
  restoreSnapshot(snapshot: WidgetSnapshot): void
}

/**
 * Widget å¿«ç…§æ•°æ®
 * ğŸ”¥ å¹³é“ºç»“æ„ï¼šä¸åŒ…å«å­ç»„ä»¶å¿«ç…§
 */
interface WidgetSnapshot {
  // ç»„ä»¶ç±»å‹
  widget_type: string
  
  // å­—æ®µè·¯å¾„ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
  field_path: string
  
  // å­—æ®µç¼–ç 
  field_code: string
  
  // å­—æ®µå€¼ï¼ˆFieldValueï¼‰
  field_value: FieldValueSnapshot
  
  // ç»„ä»¶ç‰¹å®šæ•°æ®ï¼ˆå„ç»„ä»¶è‡ªå·±å®šä¹‰ï¼‰
  component_data?: any
}

/**
 * FieldValue å¿«ç…§
 */
interface FieldValueSnapshot {
  raw: any
  display: string
  meta?: {
    displayInfo?: any
    rowStatistics?: any      // ğŸ”¥ MultiSelect è¡Œå†…èšåˆ
    listStatistics?: any     // ğŸ”¥ List å±‚èšåˆ
    dataType: string
    fromCallback?: boolean
  }
}
```

### 2. BaseWidget å®ç°

```typescript
/**
 * Widget åŸºç±»
 * æä¾›é»˜è®¤çš„å¿«ç…§å®ç°
 */
abstract class BaseWidget implements IWidgetSnapshot {
  protected field: FieldConfig
  protected fieldPath: string
  protected value: FieldValue
  protected formManager: ReactiveFormDataManager
  
  constructor(props: WidgetRenderProps) {
    this.field = props.field
    this.fieldPath = props.currentFieldPath
    this.value = props.value
    this.formManager = props.formManager
  }
  
  /**
   * æ•è·å¿«ç…§ï¼ˆé»˜è®¤å®ç°ï¼‰
   * ğŸ”¥ åªä¿å­˜è‡ªå·±çš„æ•°æ®ï¼Œä¸é€’å½’
   */
  captureSnapshot(): WidgetSnapshot {
    console.log(`[BaseWidget] ${this.fieldPath} æ•è·å¿«ç…§`)
    
    return {
      widget_type: this.field.widget.type,
      field_path: this.fieldPath,
      field_code: this.field.code,
      field_value: {
        raw: this.value.raw,
        display: this.value.display,
        meta: this.value.meta
      },
      component_data: this.captureComponentData()  // ğŸ”¥ å­ç±»å®ç°
    }
  }
  
  /**
   * æ¢å¤å¿«ç…§ï¼ˆé»˜è®¤å®ç°ï¼‰
   * ğŸ”¥ å­ç±»å¯ä»¥è¦†ç›–æ­¤æ–¹æ³•ï¼Œæ¢å¤è‡ªå·±çš„æ•°æ®
   */
  restoreSnapshot(snapshot: WidgetSnapshot): void {
    console.log(`[BaseWidget] ${this.fieldPath} æ¢å¤å¿«ç…§`)
    
    // 1. æ¢å¤ FieldValue
    this.formManager.setValue(this.fieldPath, {
      raw: snapshot.field_value.raw,
      display: snapshot.field_value.display,
      meta: snapshot.field_value.meta
    }, true)  // silent=true
    
    // 2. æ¢å¤ç»„ä»¶ç‰¹å®šæ•°æ®
    if (snapshot.component_data) {
      this.restoreComponentData(snapshot.component_data)
    }
  }
  
  /**
   * æ•è·ç»„ä»¶ç‰¹å®šæ•°æ®ï¼ˆå­ç±»å®ç°ï¼‰
   * ğŸ”¥ é»˜è®¤è¿”å› nullï¼Œå­ç±»æŒ‰éœ€è¦†ç›–
   */
  protected captureComponentData(): any {
    return null
  }
  
  /**
   * æ¢å¤ç»„ä»¶ç‰¹å®šæ•°æ®ï¼ˆå­ç±»å®ç°ï¼‰
   * ğŸ”¥ é»˜è®¤ä¸åšä»»ä½•äº‹ï¼Œå­ç±»æŒ‰éœ€è¦†ç›–
   */
  protected restoreComponentData(data: any): void {
    // å­ç±»å®ç°
  }
  
  abstract render(): VNode
}
```

---

## å„ç»„ä»¶çš„å¿«ç…§å®ç°

### 1. InputWidget - æœ€ç®€å•

```typescript
/**
 * Input ç»„ä»¶
 * æ²¡æœ‰é¢å¤–æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å®ç°å³å¯
 */
class InputWidget extends BaseWidget {
  // âœ… ä¸éœ€è¦è¦†ç›– captureSnapshot å’Œ restoreSnapshot
  // âœ… ä½¿ç”¨ BaseWidget çš„é»˜è®¤å®ç°
  
  render(): VNode {
    return h(ElInput, {
      modelValue: this.value.display,
      onInput: (val: string) => {
        this.onChange({
          raw: val,
          display: val,
          meta: { dataType: this.field.data.type }
        })
      }
    })
  }
}
```

### 2. SelectWidget - ä¿å­˜é€‰é¡¹åˆ—è¡¨

```typescript
/**
 * Select ç»„ä»¶
 * éœ€è¦ä¿å­˜ï¼šå½“å‰é€‰é¡¹åˆ—è¡¨
 */
class SelectWidget extends BaseWidget {
  private options = ref<SelectOption[]>([])
  
  /**
   * æ•è·å¿«ç…§
   * ğŸ”¥ ä¿å­˜å½“å‰çš„é€‰é¡¹åˆ—è¡¨
   */
  protected captureComponentData(): any {
    return {
      options: this.options.value  // ğŸ”¥ ä¿å­˜é€‰é¡¹åˆ—è¡¨
    }
  }
  
  /**
   * æ¢å¤å¿«ç…§
   * ğŸ”¥ æ¢å¤é€‰é¡¹åˆ—è¡¨
   */
  protected restoreComponentData(data: any): void {
    if (data.options) {
      this.options.value = data.options
    }
  }
  
  render(): VNode {
    return h(ElSelect, {
      modelValue: this.value.raw,
      options: this.options.value
    })
  }
}
```

### 3. MultiSelectWidget - ä¿å­˜é€‰é¡¹åˆ—è¡¨ + è¡Œå†…èšåˆ

```typescript
/**
 * MultiSelect ç»„ä»¶å¿«ç…§æ•°æ®
 */
interface MultiSelectSnapshotData {
  options: SelectOption[]           // é€‰é¡¹åˆ—è¡¨
  row_statistics: Record<string, any>  // ğŸ”¥ è¡Œå†…èšåˆç»“æœ
  statistics_config: Record<string, string>  // èšåˆè¡¨è¾¾å¼é…ç½®
}

/**
 * MultiSelect ç»„ä»¶
 * éœ€è¦ä¿å­˜ï¼šé€‰é¡¹åˆ—è¡¨ + è¡Œå†…èšåˆç»“æœ
 */
class MultiSelectWidget extends BaseWidget {
  private options = ref<SelectOption[]>([])
  private rowStatistics = ref<Record<string, any>>({})
  private statisticsConfig = ref<Record<string, string>>({})
  
  /**
   * æ•è·å¿«ç…§
   * ğŸ”¥ ä¿å­˜é€‰é¡¹åˆ—è¡¨å’Œè¡Œå†…èšåˆç»“æœ
   */
  protected captureComponentData(): MultiSelectSnapshotData {
    return {
      options: this.options.value,
      row_statistics: this.rowStatistics.value,  // ğŸ”¥ è¡Œå†…èšåˆ
      statistics_config: this.statisticsConfig.value
    }
  }
  
  /**
   * æ¢å¤å¿«ç…§
   * ğŸ”¥ æ¢å¤é€‰é¡¹åˆ—è¡¨å’Œè¡Œå†…èšåˆç»“æœ
   */
  protected restoreComponentData(data: MultiSelectSnapshotData): void {
    this.options.value = data.options || []
    this.rowStatistics.value = data.row_statistics || {}
    this.statisticsConfig.value = data.statistics_config || {}
  }
  
  render(): VNode {
    return h('div', [
      h(ElSelect, {
        modelValue: this.value.raw,
        multiple: true,
        options: this.options.value
      }),
      
      // æ˜¾ç¤ºè¡Œå†…èšåˆ
      this.renderRowStatistics()
    ])
  }
  
  private renderRowStatistics(): VNode {
    return h('div', { class: 'row-statistics' },
      Object.entries(this.rowStatistics.value).map(([label, value]) =>
        h('div', [
          h('span', label + ':'),
          h('span', value)
        ])
      )
    )
  }
}
```

### 4. ListWidget - åªä¿å­˜è‡ªå·±çš„æ•°æ®ï¼ˆå¹³é“ºç»“æ„ï¼‰

```typescript
/**
 * List ç»„ä»¶å¿«ç…§æ•°æ®
 */
interface ListSnapshotData {
  list_statistics: Record<string, any>  // ğŸ”¥ List å±‚èšåˆç»“æœ
  statistics_config: Record<string, string>  // èšåˆè¡¨è¾¾å¼é…ç½®
}

/**
 * List ç»„ä»¶
 * ğŸ”¥ åªä¿å­˜è‡ªå·±çš„æ•°æ®ï¼ˆList å±‚èšåˆï¼‰
 * ğŸ”¥ ä¸ä¿å­˜å­ç»„ä»¶å¿«ç…§ï¼ˆå­ç»„ä»¶ç”± FormRenderer ç»Ÿä¸€æ”¶é›†ï¼‰
 */
class ListWidget extends BaseWidget {
  private rows = ref<any[]>([])
  private rowManagers = new Map<number, ReactiveFormDataManager>()
  private listStatistics = ref<Record<string, any>>({})
  private statisticsConfig = ref<Record<string, string>>({})
  private childWidgets = new Map<string, BaseWidget>()  // æœ¬åœ°ç¼“å­˜å­ç»„ä»¶å®ä¾‹
  private formRenderer: FormRenderer  // ç”¨äºæ³¨å†Œå­ç»„ä»¶
  
  /**
   * æ•è·å¿«ç…§
   * ğŸ”¥ åªä¿å­˜ List è‡ªå·±çš„æ•°æ®ï¼Œä¸é€’å½’
   */
  protected captureComponentData(): ListSnapshotData {
    console.log(`[ListWidget] ${this.fieldPath} æ•è·å¿«ç…§`)
    
    return {
      list_statistics: this.listStatistics.value,  // ğŸ”¥ åªä¿å­˜è‡ªå·±çš„æ•°æ®
      statistics_config: this.statisticsConfig.value
    }
  }
  
  /**
   * æ¢å¤å¿«ç…§
   * ğŸ”¥ åªæ¢å¤ List è‡ªå·±çš„æ•°æ®ï¼Œä¸é€’å½’
   */
  protected restoreComponentData(data: ListSnapshotData): void {
    console.log(`[ListWidget] ${this.fieldPath} æ¢å¤å¿«ç…§`)
    
    // æ¢å¤ List å±‚èšåˆ
    this.listStatistics.value = data.list_statistics || {}
    this.statisticsConfig.value = data.statistics_config || {}
  }
  
  /**
   * æ¸²æŸ“è¡Œ
   */
  private renderRow(rowIndex: number): VNode {
    const subFields = this.field.sub_fields || []
    
    return h('tr', 
      subFields.map(subField => {
        const widget = this.createOrGetWidget(rowIndex, subField)
        
        return h('td', [
          widget.render()
        ])
      })
    )
  }
  
  /**
   * åˆ›å»ºæˆ–è·å–å­ç»„ä»¶å®ä¾‹
   * ğŸ”¥ åˆ›å»ºåæ³¨å†Œåˆ° FormRendererï¼ˆå¹³é“ºç»“æ„ï¼‰
   */
  private createOrGetWidget(rowIndex: number, field: FieldConfig): BaseWidget {
    const fieldPath = this.buildChildFieldPath(field.code, rowIndex)
    
    // æ£€æŸ¥æœ¬åœ°ç¼“å­˜
    let widget = this.childWidgets.get(fieldPath)
    
    if (!widget) {
      const WidgetClass = widgetFactory.getWidgetClass(field.widget.type)
      widget = new WidgetClass({
        field: field,
        currentFieldPath: fieldPath,
        value: this.getChildValue(rowIndex, field.code),
        onChange: (newValue) => this.handleChildChange(rowIndex, field.code, newValue),
        formManager: this.getRowManager(rowIndex),
        formRenderer: this.formRenderer  // ä¼ é€’ FormRenderer
      })
      
      // ğŸ”¥ ç¼“å­˜åˆ°æœ¬åœ°
      this.childWidgets.set(fieldPath, widget)
      
      // ğŸ”¥ æ³¨å†Œåˆ° FormRendererï¼ˆå¹³é“ºç»“æ„ï¼‰
      this.formRenderer.registerWidget(fieldPath, widget)
    }
    
    return widget
  }
  
  /**
   * åˆ é™¤è¡Œ
   */
  deleteRow(rowIndex: number): void {
    const subFields = this.field.sub_fields || []
    
    // ğŸ”¥ ä» FormRenderer å’Œæœ¬åœ°ç¼“å­˜ç§»é™¤è¯¥è¡Œæ‰€æœ‰å­ Widget
    for (const subField of subFields) {
      const fieldPath = this.buildChildFieldPath(subField.code, rowIndex)
      this.formRenderer.unregisterWidget(fieldPath)  // ä»å…¨å±€ç§»é™¤
      this.childWidgets.delete(fieldPath)  // ä»æœ¬åœ°ç§»é™¤
    }
    
    // åˆ é™¤è¡Œæ•°æ®
    this.rows.value.splice(rowIndex, 1)
    this.rowManagers.delete(rowIndex)
  }
  
  /**
   * æ„å»ºå­å­—æ®µçš„ field_path
   */
  private buildChildFieldPath(fieldCode: string, rowIndex: number): string {
    return `${this.fieldPath}[${rowIndex}].${fieldCode}`
  }
  
  render(): VNode {
    return h('div', { class: 'list-widget' }, [
      // è¡¨æ ¼
      h('table', [
        h('thead', this.renderHeader()),
        h('tbody', 
          this.rows.value.map((row, index) => this.renderRow(index))
        )
      ]),
      
      // List å±‚èšåˆ
      this.renderListStatistics()
    ])
  }
  
  private renderListStatistics(): VNode {
    return h('div', { class: 'list-statistics' },
      Object.entries(this.listStatistics.value).map(([label, value]) =>
        h('div', [
          h('span', label + ':'),
          h('span', value)
        ])
      )
    )
  }
}
```

---

## FormRenderer ç»Ÿä¸€è°ƒåº¦

### FormRenderer çš„å¿«ç…§é€»è¾‘

```typescript
/**
 * FormRenderer
 * ğŸ”¥ ç»Ÿä¸€æ”¶é›†æ‰€æœ‰ Widgetï¼ˆåŒ…æ‹¬åµŒå¥—çš„ï¼‰ï¼Œå¹³é“ºå­˜å‚¨
 */
class FormRenderer {
  private allWidgets = new Map<string, BaseWidget>()  // ğŸ”¥ æ‰€æœ‰ Widgetï¼ˆå¹³é“ºï¼‰
  
  /**
   * æ³¨å†Œ Widget
   * ğŸ”¥ æ‰€æœ‰ Widget åˆ›å»ºæ—¶éƒ½è¦æ³¨å†Œï¼ˆåŒ…æ‹¬ List å†…çš„å­ Widgetï¼‰
   */
  registerWidget(fieldPath: string, widget: BaseWidget): void {
    this.allWidgets.set(fieldPath, widget)
    console.log(`[FormRenderer] æ³¨å†Œ Widget: ${fieldPath}`)
  }
  
  /**
   * æ³¨é”€ Widget
   * ğŸ”¥ Widget é”€æ¯æ—¶æ³¨é”€ï¼ˆå¦‚ List è¡Œåˆ é™¤ï¼‰
   */
  unregisterWidget(fieldPath: string): void {
    this.allWidgets.delete(fieldPath)
    console.log(`[FormRenderer] æ³¨é”€ Widget: ${fieldPath}`)
  }
  
  /**
   * æ•è·å®Œæ•´å¿«ç…§
   * ğŸ”¥ éå†æ‰€æœ‰ Widgetï¼ˆå¹³é“ºï¼‰ï¼Œå„è‡ªæ•è·è‡ªå·±çš„å¿«ç…§
   */
  captureSnapshot(): SharedViewSnapshot {
    console.log('[FormRenderer] å¼€å§‹æ•è·å¿«ç…§ï¼ˆå¹³é“ºç»“æ„ï¼‰')
    
    const widgetSnapshots: WidgetSnapshot[] = []
    
    // ğŸ”¥ éå†æ‰€æœ‰ Widgetï¼ˆåŒ…æ‹¬åµŒå¥—çš„ï¼‰
    for (const [fieldPath, widget] of this.allWidgets) {
      const snapshot = widget.captureSnapshot()
      widgetSnapshots.push(snapshot)
    }
    
    console.log(`[FormRenderer] æ•è·å®Œæˆï¼Œå…± ${widgetSnapshots.length} ä¸ªå­—æ®µ`)
    
    return {
      view_id: '',
      function_code: this.functionDetail.code,
      namespace: this.namespace,
      app_name: this.appName,
      widget_snapshots: widgetSnapshots,  // ğŸ”¥ å¹³é“ºç»“æ„
      metadata: {
        created_at: new Date().toISOString(),
        title: this.generateTitle()
      }
    }
  }
  
  /**
   * æ¢å¤å®Œæ•´å¿«ç…§
   * ğŸ”¥ éå†æ‰€æœ‰å¿«ç…§ï¼Œæ ¹æ® field_path åŒ¹é… Widget
   */
  async restoreSnapshot(snapshot: SharedViewSnapshot): Promise<void> {
    console.log('[FormRenderer] å¼€å§‹æ¢å¤å¿«ç…§ï¼ˆå¹³é“ºç»“æ„ï¼‰:', snapshot.view_id)
    
    // ğŸ”¥ éå†æ‰€æœ‰å¿«ç…§
    for (const widgetSnapshot of snapshot.widget_snapshots) {
      const widget = this.allWidgets.get(widgetSnapshot.field_path)
      if (widget) {
        widget.restoreSnapshot(widgetSnapshot)
      } else {
        console.warn(`[FormRenderer] æœªæ‰¾åˆ° Widget: ${widgetSnapshot.field_path}`)
      }
    }
    
    // è§¦å‘é‡æ–°æ¸²æŸ“
    await nextTick()
    console.log('[FormRenderer] å¿«ç…§æ¢å¤å®Œæˆ')
  }
  
  /**
   * åˆ›å»ºæˆ–è·å– Widget å®ä¾‹
   * ğŸ”¥ åˆ›å»ºåç«‹å³æ³¨å†Œåˆ° allWidgets
   */
  private createOrGetWidget(field: FieldConfig): BaseWidget {
    if (!this.allWidgets.has(field.field_path)) {
      const WidgetClass = widgetFactory.getWidgetClass(field.widget.type)
      const widget = new WidgetClass({
        field: field,
        currentFieldPath: field.field_path,
        value: this.formManager.getValue(field.field_path),
        onChange: (newValue) => this.formManager.setValue(field.field_path, newValue),
        formManager: this.formManager,
        formRenderer: this  // ğŸ”¥ ä¼ é€’è‡ªå·±ï¼Œä¾›å­ç»„ä»¶æ³¨å†Œ
      })
      
      // ğŸ”¥ æ³¨å†Œåˆ° allWidgets
      this.registerWidget(field.field_path, widget)
    }
    
    return this.allWidgets.get(field.field_path)!
  }
  
  /**
   * æ¸²æŸ“è¡¨å•
   */
  render(): VNode {
    return h('div', { class: 'form-renderer' },
      this.functionDetail.request.map(field => {
        const widget = this.createOrGetWidget(field)
        return h('div', { class: 'form-field' }, [
          h('label', field.name),
          widget.render()
        ])
      })
    )
  }
}
```

---

## å¿«ç…§æ•°æ®ç»“æ„ï¼ˆå®Œæ•´ç‰ˆï¼‰

```typescript
/**
 * åˆ†äº«è§†å›¾å¿«ç…§ï¼ˆå®Œæ•´ç‰ˆï¼‰
 */
interface SharedViewSnapshot {
  view_id: string
  function_code: string
  namespace: string
  app_name: string
  
  // ğŸ”¥ æ‰€æœ‰ Widget çš„å¿«ç…§ï¼ˆå¹³é“ºç»“æ„ï¼‰
  widget_snapshots: WidgetSnapshot[]
  
  metadata: {
    created_at: string
    created_by?: string
    expires_at?: string
    title?: string
    description?: string
  }
  
  permissions?: {
    is_public: boolean
    allowed_users?: string[]
    password?: string
  }
}

/**
 * Widget å¿«ç…§
 * ğŸ”¥ å¹³é“ºç»“æ„ï¼šæ‰€æœ‰ Widget å¿«ç…§å¹³é“ºå­˜å‚¨
 */
interface WidgetSnapshot {
  widget_type: string              // 'input', 'select', 'multiselect', 'list'
  field_path: string               // 'customer_name', 'products', 'products[0].product_id', etc.
  field_code: string               // 'customer_name', 'products', 'product_id', etc.
  
  // FieldValue
  field_value: FieldValueSnapshot
  
  // ç»„ä»¶ç‰¹å®šæ•°æ®
  component_data?: any  // å„ç»„ä»¶è‡ªå·±å®šä¹‰
}

/**
 * FieldValue å¿«ç…§
 */
interface FieldValueSnapshot {
  raw: any
  display: string
  meta?: {
    displayInfo?: any
    rowStatistics?: any      // MultiSelect è¡Œå†…èšåˆ
    listStatistics?: any     // List å±‚èšåˆï¼ˆæš‚æ—¶ä¿ç•™ï¼‰
    dataType: string
    fromCallback?: boolean
  }
}
```

---

## å¹³é“ºç»“æ„ç¤ºä¾‹

### å®Œæ•´å¿«ç…§æ•°æ®ï¼ˆæ”¶é“¶å°åœºæ™¯ï¼‰

```json
{
  "view_id": "abc123xyz",
  "function_code": "cashier_desk",
  "namespace": "luobei",
  "app_name": "wal",
  "widget_snapshots": [
    // ğŸ”¥ é¡¶å±‚å­—æ®µï¼šcustomer_name
    {
      "widget_type": "input",
      "field_path": "customer_name",
      "field_code": "customer_name",
      "field_value": {
        "raw": "å¼ ä¸‰",
        "display": "å¼ ä¸‰",
        "meta": { "dataType": "string" }
      },
      "component_data": null
    },
    
    // ğŸ”¥ é¡¶å±‚å­—æ®µï¼šproducts (List)
    {
      "widget_type": "list",
      "field_path": "products",
      "field_code": "products",
      "field_value": {
        "raw": [
          { "product_id": 1, "quantity": 2 },
          { "product_id": 4, "quantity": 1 }
        ],
        "display": "",
        "meta": {
          "listStatistics": {
            "total_price": 35,
            "total_quantity": 3
          }
        }
      },
      "component_data": {
        "list_statistics": { "total_price": 35, "total_quantity": 3 },
        "statistics_config": { "total_price": "sum(ä»·æ ¼,*quantity)" }
      }
    },
    
    // ğŸ”¥ åµŒå¥—å­—æ®µï¼šproducts[0].product_id (å¹³é“º)
    {
      "widget_type": "select",
      "field_path": "products[0].product_id",
      "field_code": "product_id",
      "field_value": {
        "raw": 1,
        "display": "è‹¹æœ",
        "meta": {
          "displayInfo": {
            "id": 1,
            "name": "è‹¹æœ",
            "price": 10
          }
        }
      },
      "component_data": {
        "options": [
          { "label": "è‹¹æœ", "value": 1, "price": 10 }
        ]
      }
    },
    
    // ğŸ”¥ åµŒå¥—å­—æ®µï¼šproducts[0].quantity (å¹³é“º)
    {
      "widget_type": "input",
      "field_path": "products[0].quantity",
      "field_code": "quantity",
      "field_value": {
        "raw": 2,
        "display": "2",
        "meta": { "dataType": "number" }
      },
      "component_data": null
    },
    
    // ğŸ”¥ åµŒå¥—å­—æ®µï¼šproducts[1].product_id (å¹³é“º)
    {
      "widget_type": "select",
      "field_path": "products[1].product_id",
      "field_code": "product_id",
      "field_value": {
        "raw": 4,
        "display": "æ©™å­",
        "meta": {
          "displayInfo": {
            "id": 4,
            "name": "æ©™å­",
            "price": 15
          }
        }
      },
      "component_data": {
        "options": [
          { "label": "æ©™å­", "value": 4, "price": 15 }
        ]
      }
    },
    
    // ğŸ”¥ åµŒå¥—å­—æ®µï¼šproducts[1].quantity (å¹³é“º)
    {
      "widget_type": "input",
      "field_path": "products[1].quantity",
      "field_code": "quantity",
      "field_value": {
        "raw": 1,
        "display": "1",
        "meta": { "dataType": "number" }
      },
      "component_data": null
    }
  ],
  "metadata": {
    "created_at": "2025-10-31T10:30:00Z",
    "title": "å¼ ä¸‰çš„æ”¶é“¶å•"
  }
}
```

**å…³é”®ç‰¹ç‚¹**ï¼š
- âœ… æ‰€æœ‰å­—æ®µå¿«ç…§å¹³é“ºåœ¨ `widget_snapshots` æ•°ç»„ä¸­
- âœ… é€šè¿‡ `field_path` å”¯ä¸€æ ‡è¯†ï¼ˆ`customer_name`, `products`, `products[0].product_id` ç­‰ï¼‰
- âœ… List åªä¿å­˜è‡ªå·±çš„ `list_statistics`ï¼Œä¸åŒ…å«å­ç»„ä»¶å¿«ç…§
- âœ… å­ç»„ä»¶å¿«ç…§ç‹¬ç«‹å­˜åœ¨ï¼ˆ`products[0].product_id`, `products[0].quantity` ç­‰ï¼‰
- âœ… æ¢å¤æ—¶ç›´æ¥é€šè¿‡ `field_path` åŒ¹é…ï¼Œæ— éœ€é€’å½’æŸ¥æ‰¾

---

## å¿«ç…§æµç¨‹å›¾

### æ•è·å¿«ç…§æµç¨‹ï¼ˆå¹³é“ºç»“æ„ï¼‰

```
ç”¨æˆ·ç‚¹å‡»"åˆ†äº«"æŒ‰é’®
    â†“
FormRenderer.captureSnapshot()
    â†“
éå† allWidgetsï¼ˆæ‰€æœ‰ Widgetï¼ŒåŒ…æ‹¬åµŒå¥—çš„ï¼‰
    â†“
è°ƒç”¨æ¯ä¸ª Widget.captureSnapshot()
    â”‚
    â”œâ”€ InputWidget('customer_name').captureSnapshot()
    â”‚   â””â”€ è¿”å› { field_path: 'customer_name', field_value, component_data: null }
    â”‚
    â”œâ”€ ListWidget('products').captureSnapshot()
    â”‚   â””â”€ è¿”å› { field_path: 'products', field_value, component_data: { list_statistics } }
    â”‚
    â”œâ”€ SelectWidget('products[0].product_id').captureSnapshot()  // ğŸ”¥ å¹³é“º
    â”‚   â””â”€ è¿”å› { field_path: 'products[0].product_id', field_value, component_data: { options } }
    â”‚
    â”œâ”€ InputWidget('products[0].quantity').captureSnapshot()  // ğŸ”¥ å¹³é“º
    â”‚   â””â”€ è¿”å› { field_path: 'products[0].quantity', field_value, component_data: null }
    â”‚
    â”œâ”€ SelectWidget('products[1].product_id').captureSnapshot()  // ğŸ”¥ å¹³é“º
    â”‚   â””â”€ è¿”å› { field_path: 'products[1].product_id', field_value, component_data: { options } }
    â”‚
    â””â”€ InputWidget('products[1].quantity').captureSnapshot()  // ğŸ”¥ å¹³é“º
        â””â”€ è¿”å› { field_path: 'products[1].quantity', field_value, component_data: null }
    â†“
è¿”å›å®Œæ•´çš„ SharedViewSnapshotï¼ˆæ‰€æœ‰å¿«ç…§å¹³é“ºåœ¨ widget_snapshots æ•°ç»„ä¸­ï¼‰
    â†“
ä¿å­˜åˆ°åç«¯
    â†“
è¿”å› view_id
```

### æ¢å¤å¿«ç…§æµç¨‹ï¼ˆå¹³é“ºç»“æ„ï¼‰

```
ç”¨æˆ·æ‰“å¼€é“¾æ¥ï¼ˆ?view_id=abc123xyzï¼‰
    â†“
ä»åç«¯åŠ è½½ SharedViewSnapshot
    â†“
FormRenderer.restoreSnapshot(snapshot)
    â†“
éå† widget_snapshotsï¼ˆå¹³é“ºæ•°ç»„ï¼‰
    â†“
æ ¹æ® field_path åŒ¹é… Widget
    â”‚
    â”œâ”€ allWidgets.get('customer_name') â†’ InputWidget.restoreSnapshot()
    â”‚   â””â”€ æ¢å¤ field_value
    â”‚
    â”œâ”€ allWidgets.get('products') â†’ ListWidget.restoreSnapshot()
    â”‚   â””â”€ æ¢å¤ field_value + list_statistics
    â”‚
    â”œâ”€ allWidgets.get('products[0].product_id') â†’ SelectWidget.restoreSnapshot()
    â”‚   â””â”€ æ¢å¤ field_value + options
    â”‚
    â”œâ”€ allWidgets.get('products[0].quantity') â†’ InputWidget.restoreSnapshot()
    â”‚   â””â”€ æ¢å¤ field_value
    â”‚
    â”œâ”€ allWidgets.get('products[1].product_id') â†’ SelectWidget.restoreSnapshot()
    â”‚   â””â”€ æ¢å¤ field_value + options
    â”‚
    â””â”€ allWidgets.get('products[1].quantity') â†’ InputWidget.restoreSnapshot()
        â””â”€ æ¢å¤ field_value
    â†“
è§¦å‘é‡æ–°æ¸²æŸ“
    â†“
é¡µé¢å®Œå…¨æ¢å¤
```

---

## ç»„ä»¶å¿«ç…§å¯¹æ¯”è¡¨ï¼ˆå¹³é“ºç»“æ„ï¼‰

| ç»„ä»¶ | éœ€è¦ä¿å­˜çš„æ•°æ® | captureComponentData è¿”å› | restoreComponentData æ¢å¤ |
|------|--------------|--------------------------|--------------------------|
| **InputWidget** | æ—  | `null` | æ— æ“ä½œ |
| **SelectWidget** | é€‰é¡¹åˆ—è¡¨ | `{ options }` | æ¢å¤ `options` |
| **MultiSelectWidget** | é€‰é¡¹åˆ—è¡¨ + è¡Œå†…èšåˆ | `{ options, row_statistics, statistics_config }` | æ¢å¤å…¨éƒ¨ |
| **ListWidget** | List å±‚èšåˆ | `{ list_statistics, statistics_config }` | æ¢å¤ List å±‚èšåˆ |
| **NumberWidget** | æ—  | `null` | æ— æ“ä½œ |
| **TextAreaWidget** | æ—  | `null` | æ— æ“ä½œ |

**è¯´æ˜**ï¼š
- ğŸ”¥ **ListWidget ä¸ä¿å­˜å­ç»„ä»¶å¿«ç…§**ï¼Œå­ç»„ä»¶ç”± FormRenderer ç»Ÿä¸€æ”¶é›†
- ğŸ”¥ æ‰€æœ‰å¿«ç…§å¹³é“ºå­˜å‚¨åœ¨ `widget_snapshots` æ•°ç»„ä¸­ï¼Œé€šè¿‡ `field_path` æ ‡è¯†

---

## å®ç°è¦ç‚¹

### 1. Widget å®ä¾‹ç¼“å­˜ï¼ˆå¹³é“ºç»“æ„ï¼‰

```typescript
// âœ… FormRenderer ç»Ÿä¸€ç¼“å­˜æ‰€æœ‰ Widgetï¼ˆåŒ…æ‹¬åµŒå¥—çš„ï¼‰
class FormRenderer {
  private allWidgets = new Map<string, BaseWidget>()  // ğŸ”¥ å¹³é“ºç¼“å­˜
  
  registerWidget(fieldPath: string, widget: BaseWidget): void {
    this.allWidgets.set(fieldPath, widget)
  }
}

// âœ… ListWidget åˆ›å»ºå­ Widget æ—¶æ³¨å†Œåˆ° FormRenderer
class ListWidget {
  private createChildWidget(rowIndex: number, field: FieldConfig): BaseWidget {
    const fieldPath = `${this.fieldPath}[${rowIndex}].${field.code}`
    const widget = new SelectWidget(...)
    
    // ğŸ”¥ æ³¨å†Œåˆ° FormRendererï¼ˆå¹³é“ºï¼‰
    this.formRenderer.registerWidget(fieldPath, widget)
    
    return widget
  }
}

// âŒ ä¸èƒ½æ¯æ¬¡éƒ½åˆ›å»ºæ–°å®ä¾‹
function render() {
  const widget = new SelectWidget(props)  // æ¯æ¬¡éƒ½æ–°å»ºï¼Œæ— æ³•å¿«ç…§
  return widget.render()
}
```

### 2. å¹³é“ºå¿«ç…§ï¼ˆå„è‡ªç®¡å„è‡ªï¼‰

```typescript
// ListWidget åªä¿å­˜è‡ªå·±çš„æ•°æ®ï¼Œä¸é€’å½’
protected captureComponentData(): ListSnapshotData {
  return {
    list_statistics: this.listStatistics.value,  // ğŸ”¥ åªä¿å­˜è‡ªå·±çš„
    statistics_config: this.statisticsConfig.value
  }
  // ğŸ”¥ ä¸ä¿å­˜å­ç»„ä»¶å¿«ç…§ï¼Œå­ç»„ä»¶ç”± FormRenderer ç»Ÿä¸€æ”¶é›†
}
```

### 3. ç±»å‹å®‰å…¨

```typescript
// æ¯ä¸ªç»„ä»¶å®šä¹‰è‡ªå·±çš„å¿«ç…§æ•°æ®ç±»å‹
interface MultiSelectSnapshotData {
  options: SelectOption[]
  row_statistics: Record<string, any>
  statistics_config: Record<string, string>
}

// åœ¨ captureComponentData ä¸­è¿”å›ç±»å‹åŒ–æ•°æ®
protected captureComponentData(): MultiSelectSnapshotData {
  return {
    options: this.options.value,
    row_statistics: this.rowStatistics.value,
    statistics_config: this.statisticsConfig.value
  }
}
```

---

## æ€»ç»“

### æ ¸å¿ƒæœºåˆ¶

| æœºåˆ¶ | è¯´æ˜ | è´Ÿè´£è€… |
|------|------|-------|
| **å¿«ç…§æ¥å£** | `captureSnapshot()` / `restoreSnapshot()` | BaseWidget |
| **é»˜è®¤å®ç°** | ä¿å­˜/æ¢å¤ FieldValue | BaseWidget |
| **ç»„ä»¶æ‰©å±•** | ä¿å­˜/æ¢å¤ç»„ä»¶ç‰¹å®šæ•°æ® | å„å­ç±»è¦†ç›– |
| **å¹³é“ºç»“æ„** | æ‰€æœ‰ Widget å¿«ç…§å¹³é“ºå­˜å‚¨ï¼Œé€šè¿‡ `field_path` æ ‡è¯† | FormRenderer |
| **ç»Ÿä¸€æ”¶é›†** | ç»Ÿä¸€æ”¶é›†æ‰€æœ‰ Widgetï¼ˆåŒ…æ‹¬åµŒå¥—çš„ï¼‰ | FormRenderer |
| **ç»Ÿä¸€è°ƒåº¦** | éå†æ‰€æœ‰ Widgetï¼Œè°ƒç”¨å¿«ç…§æ–¹æ³• | FormRenderer |
| **å®ä¾‹ç¼“å­˜** | ç¼“å­˜æ‰€æœ‰ Widget å®ä¾‹ï¼ˆå¹³é“ºï¼‰ | FormRenderer |

### è®¾è®¡ä¼˜åŠ¿

âœ… **å„è‡ªç®¡å„è‡ª**ï¼šæ¯ä¸ªç»„ä»¶åªè´Ÿè´£è‡ªå·±çš„æ•°æ®ï¼Œä¸ç®¡å­ç»„ä»¶  
âœ… **å¹³é“ºç»“æ„**ï¼šç®€å•ç›´è§‚ï¼ŒæŸ¥æ‰¾æ¢å¤é«˜æ•ˆ  
âœ… **ç»Ÿä¸€æ¥å£**ï¼šæ‰€æœ‰ç»„ä»¶éµå¾ªç›¸åŒçš„å¿«ç…§æ¥å£  
âœ… **ç±»å‹å®‰å…¨**ï¼šæ¯ä¸ªç»„ä»¶æœ‰è‡ªå·±çš„å¿«ç…§æ•°æ®ç±»å‹  
âœ… **æ˜“æ‰©å±•**ï¼šæ–°å¢ç»„ä»¶åªéœ€å®ç°å¿«ç…§æ¥å£  
âœ… **ç®€å•é«˜æ•ˆ**ï¼šæ¢å¤æ—¶ O(n) å¤æ‚åº¦ï¼Œæ— éœ€é€’å½’æŸ¥æ‰¾  

### æœ€ç»ˆç­”æ¡ˆ

**å¹³é“ºç»“æ„å®Œå…¨æ­£ç¡®ï¼**

1. âœ… æ¯ä¸ªç»„ä»¶éœ€è¦å®ç°å¿«ç…§æ–¹æ³•ï¼ˆ`captureSnapshot` / `restoreSnapshot`ï¼‰
2. âœ… Select çš„èšåˆç»“æœä¿å­˜åœ¨ `component_data` ä¸­
3. âœ… List çš„èšåˆç»“æœä¹Ÿä¿å­˜åœ¨ `component_data` ä¸­
4. âœ… **List åªä¿å­˜è‡ªå·±çš„æ•°æ®ï¼Œä¸é€’å½’ä¿å­˜å­ç»„ä»¶å¿«ç…§**
5. âœ… **FormRenderer ç»Ÿä¸€æ”¶é›†æ‰€æœ‰ Widgetï¼ˆåŒ…æ‹¬åµŒå¥—çš„ï¼‰ï¼Œå¹³é“ºå­˜å‚¨**
6. âœ… **é€šè¿‡ `field_path` å”¯ä¸€æ ‡è¯†æ¯ä¸ªå­—æ®µï¼Œæ¢å¤æ—¶ç›´æ¥åŒ¹é…**
7. âœ… åœ°å€æ å›è½¦ â†’ åŠ è½½è§†å›¾ â†’ è°ƒç”¨ç»„ä»¶çš„ `restoreSnapshot()` â†’ æ¸²æŸ“

**é€šè¿‡ BaseWidget æä¾›ç»Ÿä¸€æ¥å£å’Œé»˜è®¤å®ç°ï¼Œå¤§å¤§ç®€åŒ–äº†å„ç»„ä»¶çš„å¼€å‘ï¼** ğŸ‰


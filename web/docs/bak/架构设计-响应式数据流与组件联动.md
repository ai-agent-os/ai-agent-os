# æ¶æ„è®¾è®¡ - å“åº”å¼æ•°æ®æµä¸ç»„ä»¶è”åŠ¨

## æ ¸å¿ƒç†å¿µ

> **æ¯ä¸ªç»„ä»¶éƒ½èƒ½è®¿é—®å…¨éƒ¨æ•°æ®ï¼Œæ¯ä¸ªç»„ä»¶éƒ½èƒ½æ›´æ–°å…¶ä»–ç»„ä»¶**

åŸºäºè¿™ä¸ªç†å¿µï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª**ä¸­å¤®å“åº”å¼æ•°æ®å­˜å‚¨**ï¼Œç±»ä¼¼ Vuex/Piniaï¼Œä½†æ›´è½»é‡ã€æ›´ä¸“æ³¨äºè¡¨å•åœºæ™¯ã€‚

---

## 1. å“åº”å¼è¡¨å•æ•°æ®ç®¡ç†å™¨

### 1.1 è®¾è®¡æ€è·¯

```typescript
/**
 * å“åº”å¼è¡¨å•æ•°æ®ç®¡ç†å™¨
 * 
 * æ ¸å¿ƒç‰¹æ€§ï¼š
 * 1. æ‰€æœ‰æ•°æ®é›†ä¸­å­˜å‚¨
 * 2. æ•°æ®å˜åŒ–å¯è®¢é˜…
 * 3. ç»„ä»¶å¯ä»¥è¯»å–ä»»æ„å­—æ®µ
 * 4. ç»„ä»¶å¯ä»¥æ›´æ–°ä»»æ„å­—æ®µ
 * 5. å›è°ƒæ—¶è‡ªåŠ¨ä¼ é€’å®Œæ•´ä¸Šä¸‹æ–‡
 */
class ReactiveFormDataManager {
  // å“åº”å¼æ•°æ®å­˜å‚¨ï¼ˆä½¿ç”¨ Vue çš„ reactiveï¼‰
  private store = reactive<Map<string, FieldValue>>(new Map())
  
  // å­—æ®µå®šä¹‰
  private fields = new Map<string, FieldConfig>()
  
  // å˜åŒ–ç›‘å¬å™¨
  private watchers = new Map<string, Set<WatchCallback>>()
  
  // å…¨å±€å˜åŒ–ç›‘å¬
  private globalWatchers = new Set<GlobalWatchCallback>()
  
  /**
   * è·å–å­—æ®µå€¼ï¼ˆå“åº”å¼ï¼‰
   * @param code å­—æ®µä»£ç 
   * @returns FieldValueï¼ˆå“åº”å¼å¯¹è±¡ï¼‰
   */
  getValue(code: string): FieldValue | undefined {
    return this.store.get(code)
  }
  
  /**
   * è·å–å­—æ®µçš„åŸå§‹å€¼ï¼ˆç”¨äºæäº¤ï¼‰
   */
  getRawValue(code: string): any {
    return this.store.get(code)?.raw
  }
  
  /**
   * è·å–å­—æ®µçš„æ˜¾ç¤ºå€¼ï¼ˆç”¨äºUIï¼‰
   */
  getDisplayValue(code: string): string {
    return this.store.get(code)?.display || ''
  }
  
  /**
   * è·å–æ‰€æœ‰å­—æ®µçš„åŸå§‹å€¼ï¼ˆå¿«ç…§ï¼‰
   * ç”¨äºå›è°ƒæ—¶ä¼ é€’ä¸Šä¸‹æ–‡
   */
  getAllRawValues(): Record<string, any> {
    const result: Record<string, any> = {}
    
    for (const [code, fieldValue] of this.store) {
      result[code] = this.extractRawValue(fieldValue)
    }
    
    return result
  }
  
  /**
   * æå–åŸå§‹å€¼ï¼ˆé€’å½’å¤„ç†åµŒå¥—ç»“æ„ï¼‰
   */
  private extractRawValue(fieldValue: FieldValue): any {
    const raw = fieldValue.raw
    
    // å¤„ç†æ•°ç»„
    if (Array.isArray(raw)) {
      return raw.map(item => {
        if (item && typeof item === 'object' && 'raw' in item) {
          return this.extractRawValue(item)
        }
        if (typeof item === 'object') {
          // é€’å½’å¤„ç†å¯¹è±¡æ•°ç»„
          const obj: Record<string, any> = {}
          for (const [key, value] of Object.entries(item)) {
            if (value && typeof value === 'object' && 'raw' in value) {
              obj[key] = this.extractRawValue(value as FieldValue)
            } else {
              obj[key] = value
            }
          }
          return obj
        }
        return item
      })
    }
    
    return raw
  }
  
  /**
   * è®¾ç½®å­—æ®µå€¼
   * @param code å­—æ®µä»£ç 
   * @param value æ–°å€¼ï¼ˆä»»æ„æ ¼å¼ï¼Œä¼šè‡ªåŠ¨è§„èŒƒåŒ–ï¼‰
   * @param silent æ˜¯å¦é™é»˜æ›´æ–°ï¼ˆä¸è§¦å‘ç›‘å¬å™¨ï¼‰
   */
  setValue(code: string, value: any, silent = false): void {
    const field = this.fields.get(code)
    const oldValue = this.store.get(code)
    const newValue = this.normalizeValue(value, field)
    
    // æ›´æ–°å€¼
    this.store.set(code, newValue)
    
    // è§¦å‘ç›‘å¬å™¨
    if (!silent) {
      this.notifyWatchers(code, newValue, oldValue)
      this.notifyGlobalWatchers(code, newValue, oldValue)
    }
  }
  
  /**
   * æ‰¹é‡æ›´æ–°å­—æ®µï¼ˆäº‹åŠ¡æ€§ï¼‰
   * æ‰€æœ‰æ›´æ–°å®Œæˆåç»Ÿä¸€è§¦å‘ç›‘å¬å™¨
   */
  batchUpdate(updates: Record<string, any>): void {
    const changes: Array<{
      code: string
      newValue: FieldValue
      oldValue: FieldValue | undefined
    }> = []
    
    // å…ˆå…¨éƒ¨æ›´æ–°
    for (const [code, value] of Object.entries(updates)) {
      const field = this.fields.get(code)
      const oldValue = this.store.get(code)
      const newValue = this.normalizeValue(value, field)
      
      this.store.set(code, newValue)
      changes.push({ code, newValue, oldValue })
    }
    
    // ç»Ÿä¸€è§¦å‘ç›‘å¬å™¨
    for (const change of changes) {
      this.notifyWatchers(change.code, change.newValue, change.oldValue)
    }
    
    // è§¦å‘å…¨å±€ç›‘å¬å™¨
    for (const change of changes) {
      this.notifyGlobalWatchers(change.code, change.newValue, change.oldValue)
    }
  }
  
  /**
   * ç›‘å¬å­—æ®µå˜åŒ–
   * @param code å­—æ®µä»£ç ï¼ˆæˆ– '*' è¡¨ç¤ºç›‘å¬æ‰€æœ‰å­—æ®µï¼‰
   * @param callback å›è°ƒå‡½æ•°
   * @returns å–æ¶ˆç›‘å¬çš„å‡½æ•°
   */
  watch(code: string, callback: WatchCallback): () => void {
    if (code === '*') {
      // å…¨å±€ç›‘å¬
      this.globalWatchers.add(callback)
      return () => this.globalWatchers.delete(callback)
    } else {
      // å­—æ®µç›‘å¬
      if (!this.watchers.has(code)) {
        this.watchers.set(code, new Set())
      }
      this.watchers.get(code)!.add(callback)
      
      return () => {
        const callbacks = this.watchers.get(code)
        if (callbacks) {
          callbacks.delete(callback)
        }
      }
    }
  }
  
  /**
   * è§¦å‘å­—æ®µç›‘å¬å™¨
   */
  private notifyWatchers(
    code: string,
    newValue: FieldValue,
    oldValue: FieldValue | undefined
  ): void {
    const callbacks = this.watchers.get(code)
    if (callbacks) {
      for (const callback of callbacks) {
        callback(newValue, oldValue, code)
      }
    }
  }
  
  /**
   * è§¦å‘å…¨å±€ç›‘å¬å™¨
   */
  private notifyGlobalWatchers(
    code: string,
    newValue: FieldValue,
    oldValue: FieldValue | undefined
  ): void {
    for (const callback of this.globalWatchers) {
      callback(newValue, oldValue, code)
    }
  }
  
  /**
   * å‡†å¤‡æäº¤æ•°æ®
   */
  prepareSubmitData(): Record<string, any> {
    return this.getAllRawValues()
  }
}

/**
 * ç›‘å¬å›è°ƒç±»å‹
 */
type WatchCallback = (
  newValue: FieldValue,
  oldValue: FieldValue | undefined,
  code: string
) => void

type GlobalWatchCallback = WatchCallback
```

---

## 2. ç»„ä»¶å¢å¼ºï¼šè®¿é—®å’Œæ›´æ–°æ•°æ®

### 2.1 Widget æ¸²æŸ“å±æ€§å¢å¼º

```typescript
/**
 * Widget æ¸²æŸ“å±æ€§ï¼ˆå¢å¼ºç‰ˆï¼‰
 */
interface WidgetRenderProps {
  // ========== ç»„ä»¶è‡ªèº« ==========
  
  // å½“å‰å­—æ®µé…ç½®
  field: FieldConfig
  
  // å½“å‰å­—æ®µå€¼
  value: FieldValue
  
  // æ›´æ–°å½“å‰å­—æ®µ
  onChange: (value: FieldValue) => void
  
  // ========== å…¨å±€è®¿é—®èƒ½åŠ› ========== ğŸ”¥ æ ¸å¿ƒèƒ½åŠ›
  
  /**
   * æ•´ä¸ªå‡½æ•°çš„è¯·æ±‚å‚æ•°ç»“æ„å®šä¹‰ï¼ˆå®Œæ•´çš„ FieldConfig[]ï¼‰
   * ç”¨é€”ï¼š
   * 1. è®©ç»„ä»¶çŸ¥é“å…¨å±€æœ‰å“ªäº›å­—æ®µ
   * 2. åˆ¤æ–­å­—æ®µä¹‹é—´çš„å±‚çº§å…³ç³»ï¼ˆçˆ¶å­—æ®µã€å­å­—æ®µã€å…„å¼Ÿå­—æ®µï¼‰
   * 3. ç”¨äºå›è°ƒæ—¶æ„å»ºå®Œæ•´çš„å­—æ®µç»“æ„ä¸Šä¸‹æ–‡
   */
  allFields: FieldConfig[]
  
  /**
   * å½“å‰å­—æ®µåœ¨ç»“æ„ä¸­çš„è·¯å¾„
   * ä¾‹å¦‚ï¼š
   * - é¡¶å±‚å­—æ®µ: "member_card_id"
   * - List å†…å­—æ®µ: "products[0].product_id"
   * - Struct å†…å­—æ®µ: "config.theme"
   * - Listå†…Structå­—æ®µ: "orders[0].customer.name"
   * 
   * ç”¨é€”ï¼š
   * 1. åˆ¤æ–­è‡ªå·±åœ¨ç»“æ„ä¸­çš„ä½ç½®ï¼ˆæ˜¯å¦åœ¨ List å†…ã€æ˜¯å¦åœ¨ Struct å†…ã€åµŒå¥—æ·±åº¦ï¼‰
   * 2. æ‰¾åˆ°çˆ¶çº§å­—æ®µã€å…„å¼Ÿå­—æ®µ
   * 3. ç”¨äºè°ƒè¯•å’Œæ—¥å¿—è¾“å‡º
   */
  currentFieldPath: string
  
  // ========== æ•°æ®è®¿é—®å’Œæ›´æ–°èƒ½åŠ› ==========
  
  /**
   * æ•°æ®ç®¡ç†å™¨å¼•ç”¨
   * ç»„ä»¶å¯ä»¥é€šè¿‡å®ƒè®¿é—®å’Œæ›´æ–°ä»»æ„å­—æ®µ
   */
  formManager: ReactiveFormDataManager
  
  /**
   * ä¾¿æ·æ–¹æ³•ï¼šè·å–å…¶ä»–å­—æ®µçš„å€¼
   */
  getFieldValue: (code: string) => FieldValue | undefined
  
  /**
   * ä¾¿æ·æ–¹æ³•ï¼šæ›´æ–°å…¶ä»–å­—æ®µ
   */
  updateField: (code: string, value: any) => void
  
  /**
   * ä¾¿æ·æ–¹æ³•ï¼šæ‰¹é‡æ›´æ–°å¤šä¸ªå­—æ®µ
   */
  batchUpdateFields: (updates: Record<string, any>) => void
  
  /**
   * ä¾¿æ·æ–¹æ³•ï¼šç›‘å¬å…¶ä»–å­—æ®µå˜åŒ–
   */
  watchField: (code: string, callback: WatchCallback) => () => void
  
  // ========== çˆ¶çº§è®¿é—®ï¼ˆList/Struct åµŒå¥—åœºæ™¯ï¼‰ ==========
  
  /**
   * çˆ¶çº§è¡¨å•æ•°æ®ç®¡ç†å™¨ï¼ˆå½“å‰ç»„ä»¶åœ¨ List/Struct å†…æ—¶å¯ç”¨ï¼‰
   * ä¾‹å¦‚ï¼šList å†…çš„å­—æ®µå¯ä»¥è®¿é—® List å¤–çš„çˆ¶è¡¨å•å­—æ®µ
   */
  parentFormManager?: ReactiveFormDataManager
  
  /**
   * ä¾¿æ·æ–¹æ³•ï¼šè·å–çˆ¶è¡¨å•å­—æ®µå€¼
   * ä¾‹å¦‚ï¼šList å†…çš„ product_id select å¯ä»¥è·å–çˆ¶è¡¨å•çš„ member_card_id
   */
  getParentFieldValue?: (code: string) => FieldValue | undefined
  
  // ========== å…¶ä»– ==========
  
  disabled?: boolean
  readonly?: boolean
}
```

### 2.2 SelectWidget ä½¿ç”¨ç¤ºä¾‹

```typescript
const SelectWidget: IWidget = {
  type: 'select',
  supportedCallbacks: ['OnSelectFuzzy'],
  
  render(props: WidgetRenderProps) {
    const {
      field,
      value,
      onChange,
      formManager,
      getFieldValue,
      updateField,
      watchField
    } = props
    
    const dialogVisible = ref(false)
    const options = ref<SelectOption[]>([])
    
    /**
     * æ‰“å¼€æ¨¡ç³Šæœç´¢å¯¹è¯æ¡†
     */
    const openDialog = async () => {
      dialogVisible.value = true
      
      // ğŸ”¥ å…³é”®ï¼šè·å–å®Œæ•´çš„è¡¨å•æ•°æ®ä½œä¸ºä¸Šä¸‹æ–‡
      const context = formManager.getAllRawValues()
      
      console.log('å›è°ƒä¸Šä¸‹æ–‡:', context)
      // ä¾‹å¦‚: { department: "æŠ€æœ¯éƒ¨", role: "å¼€å‘", ... }
      
      try {
        // è°ƒç”¨å›è°ƒï¼Œä¼ é€’å®Œæ•´ä¸Šä¸‹æ–‡
        const result = await callbackManager.executeSelectFuzzy(
          field,
          '',  // åˆå§‹æœç´¢å€¼
          context  // ğŸ”¥ å®Œæ•´çš„è¡¨å•æ•°æ®
        )
        
        options.value = result.values
      } catch (error) {
        ElMessage.error('åŠ è½½æ•°æ®å¤±è´¥')
      }
    }
    
    /**
     * é€‰æ‹©åçš„å¤„ç†
     */
    const handleSelect = (option: SelectOption) => {
      // æ›´æ–°å½“å‰å­—æ®µ
      onChange({
        raw: option.value,
        display: option.label,
        meta: {
          option,
          displayInfo: option.displayInfo,
          dataType: field.data.type,
          fromCallback: true
        }
      })
      
      // ğŸ”¥ å…³é”®ï¼šå¯èƒ½éœ€è¦è”åŠ¨æ›´æ–°å…¶ä»–å­—æ®µ
      
      // ç¤ºä¾‹1ï¼šé€‰æ‹©éƒ¨é—¨åï¼Œæ¸…ç©ºç”¨æˆ·å­—æ®µ
      if (field.code === 'department') {
        updateField('user', null)
        updateField('manager', null)
      }
      
      // ç¤ºä¾‹2ï¼šé€‰æ‹©çœä»½åï¼Œæ¸…ç©ºåŸå¸‚å­—æ®µ
      if (field.code === 'province') {
        updateField('city', null)
        updateField('district', null)
      }
      
      // ç¤ºä¾‹3ï¼šæ ¹æ®é…ç½®è‡ªåŠ¨æ›´æ–°å…¶ä»–å­—æ®µ
      const linkedFields = field.widget.config.linkedFields
      if (linkedFields) {
        const updates: Record<string, any> = {}
        for (const linkedCode of linkedFields.clear || []) {
          updates[linkedCode] = null
        }
        
        // æ‰¹é‡æ›´æ–°
        if (Object.keys(updates).length > 0) {
          formManager.batchUpdate(updates)
        }
      }
      
      dialogVisible.value = false
    }
    
    /**
     * ç›‘å¬å…¶ä»–å­—æ®µå˜åŒ–
     * ä¾‹å¦‚ï¼šéƒ¨é—¨å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨æ¸…ç©ºç”¨æˆ·
     */
    onMounted(() => {
      if (field.code === 'user') {
        // ç›‘å¬éƒ¨é—¨å­—æ®µå˜åŒ–
        const unwatch = watchField('department', (newVal, oldVal) => {
          if (newVal?.raw !== oldVal?.raw) {
            // éƒ¨é—¨å˜åŒ–äº†ï¼Œæ¸…ç©ºç”¨æˆ·
            onChange({
              raw: null,
              display: '',
              meta: { dataType: field.data.type }
            })
          }
        })
        
        // ç»„ä»¶å¸è½½æ—¶å–æ¶ˆç›‘å¬
        onUnmounted(() => unwatch())
      }
    })
    
    return h('div', [
      h(ElInput, {
        modelValue: value.display,
        readonly: true,
        placeholder: `è¯·é€‰æ‹©${field.name}`,
        onClick: openDialog
      }),
      
      // æ¨¡ç³Šæœç´¢å¯¹è¯æ¡†
      h(FuzzySearchDialog, {
        visible: dialogVisible.value,
        options: options.value,
        onSelect: handleSelect,
        onClose: () => dialogVisible.value = false
      })
    ])
  }
}
```

### 2.3 InputWidget å¸¦éªŒè¯å›è°ƒ

```typescript
const InputWidget: IWidget = {
  type: 'input',
  supportedCallbacks: ['OnInputValidate'],
  
  render(props: WidgetRenderProps) {
    const {
      field,
      value,
      onChange,
      formManager,
      getFieldValue
    } = props
    
    const validationState = ref<ValidateCallbackResult | null>(null)
    const isValidating = ref(false)
    
    /**
     * é˜²æŠ–éªŒè¯
     */
    const validateDebounced = debounce(async (val: string) => {
      if (!val) return
      
      isValidating.value = true
      
      try {
        // ğŸ”¥ å…³é”®ï¼šè·å–å®Œæ•´çš„è¡¨å•æ•°æ®ä½œä¸ºä¸Šä¸‹æ–‡
        const context = formManager.getAllRawValues()
        
        // è°ƒç”¨éªŒè¯å›è°ƒ
        const result = await callbackManager.executeInputValidate(
          field,
          val,
          context  // ğŸ”¥ ä¼ é€’å®Œæ•´ä¸Šä¸‹æ–‡
        )
        
        validationState.value = result
      } finally {
        isValidating.value = false
      }
    }, 500)
    
    return h('div', { class: 'input-with-validation' }, [
      h(ElInput, {
        modelValue: value.display,
        loading: isValidating.value,
        onInput: (val: string) => {
          onChange({
            raw: val,
            display: val,
            meta: { dataType: field.data.type }
          })
          
          // å¦‚æœæœ‰éªŒè¯å›è°ƒï¼Œè§¦å‘éªŒè¯
          if (field.callbacks?.includes('OnInputValidate')) {
            validateDebounced(val)
          }
        }
      }),
      
      // éªŒè¯çŠ¶æ€
      validationState.value && h('div', {
        class: ['validation-msg', validationState.value.valid ? 'valid' : 'invalid']
      }, [
        h('el-icon', validationState.value.valid ? h(Check) : h(Close)),
        h('span', validationState.value.message)
      ]),
      
      // å»ºè®®å€¼
      validationState.value?.suggestions && h('div', { class: 'suggestions' },
        validationState.value.suggestions.map(s =>
          h('div', {
            class: 'suggestion-item',
            onClick: () => onChange({
              raw: s,
              display: s,
              meta: { dataType: field.data.type }
            })
          }, s)
        )
      )
    ])
  }
}
```

---

## 3. å­—æ®µé…ç½®å¢å¼ºï¼šå£°æ˜å¼è”åŠ¨

### 3.1 å­—æ®µé…ç½®æ”¯æŒè”åŠ¨å£°æ˜

```typescript
interface FieldConfig {
  code: string
  name: string
  // ... å…¶ä»–åŸºç¡€é…ç½®
  
  /**
   * å­—æ®µè”åŠ¨é…ç½®ï¼ˆæ–°å¢ï¼‰
   */
  linkage?: {
    // ç›‘å¬å“ªäº›å­—æ®µçš„å˜åŒ–
    watch?: string[]
    
    // å½“ç›‘å¬çš„å­—æ®µå˜åŒ–æ—¶ï¼Œè¦åšä»€ä¹ˆ
    onChange?: LinkageAction[]
  }
}

/**
 * è”åŠ¨åŠ¨ä½œ
 */
interface LinkageAction {
  // åŠ¨ä½œç±»å‹
  type: 'clear' | 'set' | 'update' | 'callback'
  
  // ç›®æ ‡å­—æ®µ
  target?: string | string[]
  
  // è®¾ç½®çš„å€¼ï¼ˆtype=setæ—¶ï¼‰
  value?: any
  
  // æ¡ä»¶ï¼ˆå¯é€‰ï¼‰
  condition?: (context: Record<string, any>) => boolean
  
  // å›è°ƒå‡½æ•°ï¼ˆtype=callbackæ—¶ï¼‰
  handler?: (context: Record<string, any>) => void | Promise<void>
}
```

### 3.2 ä½¿ç”¨ç¤ºä¾‹

```json
{
  "code": "city",
  "name": "åŸå¸‚",
  "widget": { "type": "select" },
  "linkage": {
    "watch": ["province"],
    "onChange": [
      {
        "type": "clear",
        "target": ["city", "district"],
        "condition": "(context) => context.province !== oldContext.province"
      }
    ]
  }
}
```

### 3.3 FormRenderer è‡ªåŠ¨å¤„ç†è”åŠ¨

```typescript
class FormRenderer {
  private setupLinkages(): void {
    // éå†æ‰€æœ‰å­—æ®µé…ç½®
    for (const field of this.fields) {
      if (field.linkage?.watch) {
        // ç›‘å¬æŒ‡å®šå­—æ®µ
        for (const watchCode of field.linkage.watch) {
          this.formManager.watch(watchCode, (newVal, oldVal) => {
            this.handleLinkage(field, newVal, oldVal)
          })
        }
      }
    }
  }
  
  private handleLinkage(
    field: FieldConfig,
    newVal: FieldValue,
    oldVal: FieldValue | undefined
  ): void {
    const actions = field.linkage?.onChange || []
    const context = this.formManager.getAllRawValues()
    
    for (const action of actions) {
      // æ£€æŸ¥æ¡ä»¶
      if (action.condition && !action.condition(context)) {
        continue
      }
      
      // æ‰§è¡ŒåŠ¨ä½œ
      switch (action.type) {
        case 'clear':
          if (Array.isArray(action.target)) {
            const updates: Record<string, any> = {}
            for (const target of action.target) {
              updates[target] = null
            }
            this.formManager.batchUpdate(updates)
          } else if (action.target) {
            this.formManager.setValue(action.target, null)
          }
          break
          
        case 'set':
          if (action.target && action.value !== undefined) {
            this.formManager.setValue(action.target, action.value)
          }
          break
          
        case 'callback':
          if (action.handler) {
            action.handler(context)
          }
          break
      }
    }
  }
}
```

---

## 4. List åµŒå¥—åœºæ™¯çš„å¤„ç†

### 4.1 List ä¸­æ¯ä¸€è¡Œä¹Ÿæ˜¯ç‹¬ç«‹çš„ FormDataManager

```typescript
class ListWidget implements IWidget {
  render(props: WidgetRenderProps) {
    const { field, value, formManager } = props
    const listData = (value.raw as any[]) || []
    
    return h('div', { class: 'list-widget' }, [
      h(ElTable, { data: listData }, {
        default: () => [
          // æ¸²æŸ“æ¯ä¸€åˆ—
          ...this.renderColumns(field, listData, formManager)
        ]
      })
    ])
  }
  
  private renderColumns(
    field: FieldConfig,
    listData: any[],
    parentFormManager: ReactiveFormDataManager
  ) {
    const subFields = this.getSubFields(field)
    
    return subFields.map(subField =>
      h(ElTableColumn, {
        label: subField.name,
        prop: subField.code
      }, {
        default: ({ row, $index }) => {
          // ğŸ”¥ å…³é”®ï¼šä¸ºæ¯ä¸€è¡Œåˆ›å»ºå­ FormDataManager
          const rowManager = this.getRowManager(row, $index)
          
          // æ¸²æŸ“å­å­—æ®µçš„ Widget
          return widgetFactory.create(subField, {
            field: subField,
            value: rowManager.getValue(subField.code) || this.getDefaultFieldValue(subField),
            onChange: (newValue) => {
              // æ›´æ–°è¡Œæ•°æ®
              rowManager.setValue(subField.code, newValue)
              
              // åŒæ­¥åˆ°çˆ¶è¡¨å•
              this.syncRowToParent(row, rowManager, parentFormManager)
              
              // ğŸ”¥ å¦‚æœè¿™ä¸€è¡Œæœ‰ select æ›´æ–°äº†ï¼Œé‡æ–°è®¡ç®—èšåˆç»Ÿè®¡
              if (subField.widget.type === 'select' && subField.callbacks?.includes('OnSelectFuzzy')) {
                this.updateStatistics(parentFormManager)
              }
            },
            
            // ğŸ”¥ å…³é”®ï¼šå­ç»„ä»¶å¯ä»¥è®¿é—®è¡Œå†…çš„å…¶ä»–å­—æ®µ
            formManager: rowManager,
            
            getFieldValue: (code) => rowManager.getValue(code),
            updateField: (code, value) => {
              rowManager.setValue(code, value)
              this.syncRowToParent(row, rowManager, parentFormManager)
            },
            watchField: (code, callback) => rowManager.watch(code, callback)
          })
        }
      })
    )
  }
  
  /**
   * è·å–æˆ–åˆ›å»ºè¡Œçš„ FormDataManager
   */
  private getRowManager(row: any, index: number): ReactiveFormDataManager {
    // ç¼“å­˜æ¯ä¸€è¡Œçš„ manager
    if (!this.rowManagers.has(index)) {
      const manager = new ReactiveFormDataManager()
      
      // åˆå§‹åŒ–è¡Œæ•°æ®
      for (const [key, value] of Object.entries(row)) {
        manager.setValue(key, value, true)  // silent=trueï¼Œä¸è§¦å‘ç›‘å¬
      }
      
      this.rowManagers.set(index, manager)
    }
    
    return this.rowManagers.get(index)!
  }
  
  /**
   * åŒæ­¥è¡Œæ•°æ®åˆ°çˆ¶è¡¨å•
   */
  private syncRowToParent(
    row: any,
    rowManager: ReactiveFormDataManager,
    parentFormManager: ReactiveFormDataManager
  ): void {
    // è·å–è¡Œçš„æ‰€æœ‰æ•°æ®
    const rowData = rowManager.getAllRawValues()
    
    // æ›´æ–° row å¯¹è±¡
    Object.assign(row, rowData)
    
    // è§¦å‘çˆ¶è¡¨å•çš„æ›´æ–°ï¼ˆä½†ä¸è§¦å‘ç›‘å¬å™¨ï¼Œé¿å…å¾ªç¯ï¼‰
    // è¿™é‡Œåªæ˜¯æ ‡è®°æ•°æ®å·²å˜åŒ–
    parentFormManager.markDirty()
  }
}
```

### 4.2 æ”¶é“¶å°åœºæ™¯å®Œæ•´ç¤ºä¾‹

```typescript
// åç«¯å‡½æ•°å®šä¹‰
{
  request: [
    {
      code: "member_id",
      name: "ä¼šå‘˜å¡",
      widget: { type: "select" },
      callbacks: ["OnSelectFuzzy"]
    },
    {
      code: "product_quantities",
      name: "å•†å“æ¸…å•",
      widget: { type: "list" },
      subFields: [
        {
          code: "product_id",
          name: "å•†å“",
          widget: { type: "select" },
          callbacks: ["OnSelectFuzzy"],
          // ğŸ”¥ å…³é”®ï¼šselect å›è°ƒæ—¶éœ€è¦è®¿é—®åŒä¸€è¡Œçš„å…¶ä»–å­—æ®µ
          // ä½†è¿™æ˜¯è‡ªåŠ¨çš„ï¼Œå› ä¸ºæ¯ä¸€è¡Œæœ‰ç‹¬ç«‹çš„ rowManager
        },
        {
          code: "quantity",
          name: "æ•°é‡",
          widget: { type: "number" }
        }
      ]
    }
  ]
}

// ç”¨æˆ·é€‰æ‹©å•†å“æ—¶çš„å›è°ƒ
async function onProductSelect(rowManager, productField) {
  // ğŸ”¥ è·å–å½“å‰è¡Œçš„å®Œæ•´æ•°æ®
  const rowContext = rowManager.getAllRawValues()
  // { product_id: xxx, quantity: 1 }
  
  // ğŸ”¥ è·å–æ•´ä¸ªè¡¨å•çš„æ•°æ®ï¼ˆåŒ…æ‹¬ä¼šå‘˜ä¿¡æ¯ï¼‰
  const formContext = parentFormManager.getAllRawValues()
  // { member_id: 1, product_quantities: [...], remarks: "..." }
  
  // è°ƒç”¨å›è°ƒ
  const result = await callbackManager.executeSelectFuzzy(
    productField,
    searchValue,
    formContext  // ä¼ é€’å®Œæ•´ä¸Šä¸‹æ–‡ï¼Œåç«¯å¯ä»¥æ ¹æ®ä¼šå‘˜å¡è¿”å›ä¼šå‘˜ä»·
  )
  
  // è¿”å›ç»“æœåŒ…å« displayInfo å’Œ statistics
  // displayInfo: { ä»·æ ¼: 5, ä¼šå‘˜ä»·: 4.5, åº“å­˜: 97 }
  // statistics: { å•†å“æ€»æ•°: "sum(quantity)", æ€»é‡‘é¢: "sum(ä¼šå‘˜ä»·,*quantity)" }
  
  return result
}
```

---

## 5. æ€»ç»“

### 5.1 æ ¸å¿ƒèƒ½åŠ›

| èƒ½åŠ› | å®ç°æ–¹å¼ | ç”¨é€” |
|-----|---------|------|
| **è®¿é—®å…¨éƒ¨æ•°æ®** | `formManager.getAllRawValues()` | å›è°ƒæ—¶ä¼ é€’å®Œæ•´ä¸Šä¸‹æ–‡ |
| **è¯»å–å…¶ä»–å­—æ®µ** | `getFieldValue(code)` | ç»„ä»¶é—´ä¾èµ– |
| **æ›´æ–°å…¶ä»–å­—æ®µ** | `updateField(code, value)` | å­—æ®µè”åŠ¨ |
| **æ‰¹é‡æ›´æ–°** | `batchUpdateFields(updates)` | äº‹åŠ¡æ€§æ›´æ–° |
| **ç›‘å¬å˜åŒ–** | `watchField(code, callback)` | å“åº”å¼è”åŠ¨ |
| **åµŒå¥—æ•°æ®** | æ¯è¡Œç‹¬ç«‹çš„ `rowManager` | List åœºæ™¯ |

### 5.2 å¤æ‚åœºæ™¯æ”¯æŒ

#### âœ… åœºæ™¯1ï¼šçº§è”é€‰æ‹©
```typescript
// é€‰æ‹©çœä»½ â†’ åŸå¸‚åˆ—è¡¨æ ¹æ®çœä»½è¿‡æ»¤
context: { province: "å¹¿ä¸œçœ" }
â†’ åç«¯è¿”å›å¹¿ä¸œçœçš„åŸå¸‚
```

#### âœ… åœºæ™¯2ï¼šè‡ªåŠ¨è”åŠ¨
```typescript
// é€‰æ‹©éƒ¨é—¨ â†’ è‡ªåŠ¨æ¸…ç©ºç”¨æˆ·ã€ç»ç†å­—æ®µ
updateField('user', null)
updateField('manager', null)
```

#### âœ… åœºæ™¯3ï¼šListå†…è”åŠ¨
```typescript
// åœ¨æ”¶é“¶å°ä¸­ï¼Œé€‰æ‹©å•†å“ â†’ æ ¹æ®ä¼šå‘˜å¡è¿”å›ä¼šå‘˜ä»·
rowContext: { product_id: 1, quantity: 2 }
formContext: { member_id: 1, ... }
â†’ åç«¯æ ¹æ®ä¼šå‘˜å¡è¿”å›ä¼šå‘˜ä»·æ ¼
```

#### âœ… åœºæ™¯4ï¼šè·¨è¡Œè®¿é—®ï¼ˆæç«¯åœºæ™¯ï¼‰
```typescript
// List ä¸­å¯ä»¥è®¿é—®çˆ¶è¡¨å•çš„å…¶ä»–å­—æ®µ
const memberId = parentFormManager.getRawValue('member_id')
```

### 5.3 æ¶æ„ä¼˜åŠ¿

1. **å®Œå…¨å“åº”å¼**
   - ä½¿ç”¨ Vue çš„ reactive
   - æ•°æ®å˜åŒ–è‡ªåŠ¨æ›´æ–°UI

2. **ä¸­å¤®åŒ–ç®¡ç†**
   - æ‰€æœ‰æ•°æ®åœ¨ä¸€å¤„
   - æ˜“äºè°ƒè¯•å’Œè¿½è¸ª

3. **çµæ´»çš„è”åŠ¨**
   - å£°æ˜å¼é…ç½®
   - ç¼–ç¨‹å¼æ›´æ–°
   - ç›‘å¬æœºåˆ¶

4. **åµŒå¥—æ”¯æŒ**
   - List çš„æ¯ä¸€è¡Œç‹¬ç«‹ç®¡ç†
   - ä½†å¯ä»¥è®¿é—®çˆ¶æ•°æ®

5. **å›è°ƒçµæ´»**
   - è‡ªåŠ¨ä¼ é€’å®Œæ•´ä¸Šä¸‹æ–‡
   - æ— éœ€æ‰‹åŠ¨æ”¶é›†æ•°æ®

---

## 6. ä¸æ—§ç‰ˆæœ¬å¯¹æ¯”

| ç‰¹æ€§ | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ |
|-----|-------|-------|
| æ•°æ®è®¿é—® | æ‰‹åŠ¨ä¼ é€’ï¼Œå®¹æ˜“æ¼ | è‡ªåŠ¨è·å–å®Œæ•´ä¸Šä¸‹æ–‡ |
| å­—æ®µè”åŠ¨ | åˆ†æ•£åœ¨å„å¤„ï¼Œéš¾ç»´æŠ¤ | ç»Ÿä¸€ç®¡ç†ï¼Œå£°æ˜å¼é…ç½® |
| List åµŒå¥— | é€’å½’æŸ¥æ‰¾ï¼Œå¤æ‚ | æ¯è¡Œç‹¬ç«‹ manager |
| å›è°ƒä¸Šä¸‹æ–‡ | æ‰‹åŠ¨æ„å»º | è‡ªåŠ¨ä¼ é€’ |
| å“åº”å¼ | æ‰‹åŠ¨è§¦å‘æ›´æ–° | è‡ªåŠ¨å“åº” |

---

## 7. ä¸‹ä¸€æ­¥

ç°åœ¨çš„æ¶æ„å·²ç»å®Œå…¨æ»¡è¶³ï¼š
- âœ… æ¯ä¸ªç»„ä»¶èƒ½è®¿é—®å…¨éƒ¨æ•°æ®
- âœ… æ¯ä¸ªç»„ä»¶èƒ½æ›´æ–°å…¶ä»–ç»„ä»¶
- âœ… å›è°ƒè‡ªåŠ¨ä¼ é€’å®Œæ•´ä¸Šä¸‹æ–‡
- âœ… æ”¯æŒå¤æ‚çš„å­—æ®µè”åŠ¨
- âœ… æ”¯æŒ List åµŒå¥—åœºæ™¯

**è¿™ä¸ªæ–¹æ¡ˆæ˜¯å¦è§£å†³äº†ä½ æ‰€æœ‰çš„é¡¾è™‘ï¼Ÿ** ğŸš€


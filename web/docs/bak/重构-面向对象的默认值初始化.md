# é‡æ„ï¼šé¢å‘å¯¹è±¡çš„é»˜è®¤å€¼åˆå§‹åŒ–

## ğŸ¯ é‡æ„ç›®æ ‡

å°†è¡¨å•å­—æ®µé»˜è®¤å€¼çš„åˆå§‹åŒ–é€»è¾‘ä»**é¢å‘è¿‡ç¨‹**æ”¹ä¸º**é¢å‘å¯¹è±¡**ï¼Œç¬¦åˆ OOP è®¾è®¡åŸåˆ™ã€‚

---

## ğŸ”´ é‡æ„å‰ï¼ˆé¢å‘è¿‡ç¨‹ï¼‰

### é—®é¢˜ä»£ç 

```typescript
// âŒ FormRenderer ä¸­çš„é¢å‘è¿‡ç¨‹ä»£ç 
function initFormData() {
  const data: Record<string, any> = {}
  
  props.fields.forEach(field => {
    // å¤§é‡çš„ if-else é€»è¾‘æ¥å¤„ç†ä¸åŒç±»å‹çš„é»˜è®¤å€¼
    if (props.initialData && field.code in props.initialData) {
      data[field.code] = props.initialData[field.code]
    }
    else if (field.widget.config && field.widget.config.default) {
      data[field.code] = field.widget.config.default
    }
    else {
      switch (field.data?.type) {
        case 'int':
        case 'float':
          data[field.code] = undefined
          break
        case 'bool':
          data[field.code] = false
          break
        case 'array':
          data[field.code] = []
          break
        default:
          data[field.code] = ''
      }
    }
  })
}
```

### é—®é¢˜åˆ†æ

1. **èŒè´£ä¸æ¸…**ï¼š`FormRenderer` è´Ÿè´£äº†æ‰€æœ‰ç»„ä»¶çš„é»˜è®¤å€¼é€»è¾‘
2. **æ‰©å±•å›°éš¾**ï¼šæ–°å¢ç»„ä»¶ç±»å‹éœ€è¦ä¿®æ”¹ `FormRenderer`
3. **è¿åå¼€é—­åŸåˆ™**ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼ˆOCPï¼‰
4. **ä»£ç é‡å¤**ï¼šæ¯ä¸ªä½¿ç”¨è¡¨å•çš„åœ°æ–¹éƒ½éœ€è¦é‡å¤è¿™äº›é€»è¾‘

---

## ğŸŸ¢ é‡æ„åï¼ˆé¢å‘å¯¹è±¡ï¼‰

### è§£å†³æ–¹æ¡ˆ

#### 1. **BaseWidget æ·»åŠ é™æ€æ–¹æ³•**

```typescript
// âœ… BaseWidget.ts
export abstract class BaseWidget {
  /**
   * è·å–å­—æ®µçš„é»˜è®¤å€¼
   * æ¯ä¸ª Widget å­ç±»å¯ä»¥é‡å†™æ­¤æ–¹æ³•æ¥æä¾›è‡ªå®šä¹‰çš„é»˜è®¤å€¼é€»è¾‘
   */
  static getDefaultValue(field: FieldConfig): FieldValue {
    // 1. ä¼˜å…ˆä½¿ç”¨ widget.config.default
    if (field.widget?.config?.default !== undefined && field.widget.config.default !== '') {
      return {
        raw: field.widget.config.default,
        display: String(field.widget.config.default),
        meta: {}
      }
    }

    // 2. æ ¹æ®å­—æ®µç±»å‹è®¾ç½®é»˜è®¤å€¼
    const fieldType = field.data?.type || 'string'
    
    switch (fieldType.toLowerCase()) {
      case 'int':
      case 'float':
      case 'number':
        return { raw: undefined, display: '', meta: {} }
      case 'bool':
        return { raw: false, display: 'å¦', meta: {} }
      case 'array':
      case '[]struct':
        return { raw: [], display: '[]', meta: {} }
      case 'struct':
        return { raw: {}, display: '{}', meta: {} }
      default:
        return { raw: '', display: '', meta: {} }
    }
  }
}
```

#### 2. **ListWidget é‡å†™é»˜è®¤å€¼æ–¹æ³•**

```typescript
// âœ… ListWidget.ts
export class ListWidget extends BaseWidget {
  /**
   * ListWidget çš„é»˜è®¤å€¼æ˜¯ç©ºæ•°ç»„
   */
  static getDefaultValue(field: FieldConfig): FieldValue {
    return {
      raw: [],
      display: '[]',
      meta: {}
    }
  }
}
```

#### 3. **FormRenderer ä½¿ç”¨ Widget çš„é™æ€æ–¹æ³•**

```typescript
// âœ… FormRenderer.vue
function initializeForm(): void {
  fields.value.forEach(field => {
    const fieldPath = field.code
    
    // ğŸ”¥ ä½¿ç”¨ Widget çš„é™æ€æ–¹æ³•è·å–é»˜è®¤å€¼ï¼ˆé¢å‘å¯¹è±¡ï¼‰
    const WidgetClass = widgetFactory.getWidgetClass(field.widget.type)
    const defaultValue = WidgetClass.getDefaultValue(field)
    
    // åˆå§‹åŒ– FormDataManager
    formManager.initializeField(fieldPath, defaultValue)
    
    // åˆå§‹åŒ– formDataï¼ˆç”¨äº el-formï¼‰
    formData[field.code] = defaultValue.raw
  })
}
```

#### 4. **ReactiveFormDataManager æ”¯æŒ FieldValue**

```typescript
// âœ… ReactiveFormDataManager.ts
initializeField(fieldPath: string, initialValue?: FieldValue): void {
  if (!this.data.has(fieldPath)) {
    const defaultFieldValue: FieldValue = initialValue || {
      raw: '',
      display: '',
      meta: {}
    }
    
    this.data.set(fieldPath, defaultFieldValue)
  }
}
```

---

## âœ… é‡æ„ä¼˜åŠ¿

### 1. **èŒè´£å•ä¸€**
- `FormRenderer`ï¼šåè°ƒè€…ï¼Œè´Ÿè´£è°ƒç”¨ Widget
- `BaseWidget`ï¼šå®šä¹‰é€šç”¨çš„é»˜è®¤å€¼é€»è¾‘
- å„ä¸ª Widget å­ç±»ï¼šå®šä¹‰è‡ªå·±çš„ç‰¹å®šé€»è¾‘

### 2. **æ˜“äºæ‰©å±•**
```typescript
// æ–°å¢ DateWidget æ—¶ï¼Œåªéœ€é‡å†™ getDefaultValue
export class DateWidget extends BaseWidget {
  static getDefaultValue(field: FieldConfig): FieldValue {
    return {
      raw: new Date().toISOString(),
      display: new Date().toLocaleDateString(),
      meta: {}
    }
  }
}
```

### 3. **ç¬¦åˆ OOP åŸåˆ™**
- âœ… **å•ä¸€èŒè´£åŸåˆ™**ï¼ˆSRPï¼‰ï¼šæ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä»¶äº‹
- âœ… **å¼€é—­åŸåˆ™**ï¼ˆOCPï¼‰ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
- âœ… **é‡Œæ°æ›¿æ¢åŸåˆ™**ï¼ˆLSPï¼‰ï¼šå­ç±»å¯ä»¥æ›¿æ¢çˆ¶ç±»
- âœ… **ä¾èµ–å€’ç½®åŸåˆ™**ï¼ˆDIPï¼‰ï¼šä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°

### 4. **ä»£ç å¤ç”¨**
- å…¶ä»–åœ°æ–¹éœ€è¦è·å–é»˜è®¤å€¼æ—¶ï¼Œç›´æ¥è°ƒç”¨ `WidgetClass.getDefaultValue(field)`
- æ— éœ€é‡å¤ç¼–å†™ç±»å‹åˆ¤æ–­é€»è¾‘

---

## ğŸ¯ æ‰©å±•ç¤ºä¾‹

### æ·»åŠ æ–°ç»„ä»¶ç±»å‹

```typescript
// NumberWidget.ts
export class NumberWidget extends BaseWidget {
  /**
   * NumberWidget çš„é»˜è®¤å€¼æ˜¯ 0
   */
  static getDefaultValue(field: FieldConfig): FieldValue {
    const defaultNum = field.widget?.config?.default ?? 0
    return {
      raw: defaultNum,
      display: String(defaultNum),
      meta: {}
    }
  }
  
  render() {
    // ... æ¸²æŸ“é€»è¾‘
  }
}
```

### æ·»åŠ å¤æ‚ç»„ä»¶

```typescript
// DateRangeWidget.ts
export class DateRangeWidget extends BaseWidget {
  /**
   * DateRangeWidget çš„é»˜è®¤å€¼æ˜¯è¿‡å» 7 å¤©
   */
  static getDefaultValue(field: FieldConfig): FieldValue {
    const end = new Date()
    const start = new Date()
    start.setDate(start.getDate() - 7)
    
    return {
      raw: [start.toISOString(), end.toISOString()],
      display: `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`,
      meta: { range_type: 'last_7_days' }
    }
  }
}
```

---

## ğŸ“Š å¯¹æ¯”æ€»ç»“

| ç»´åº¦ | é‡æ„å‰ï¼ˆé¢å‘è¿‡ç¨‹ï¼‰ | é‡æ„åï¼ˆé¢å‘å¯¹è±¡ï¼‰ |
|------|-------------------|-------------------|
| **ä»£ç ä½ç½®** | FormRenderer é›†ä¸­å¤„ç† | æ¯ä¸ª Widget è´Ÿè´£è‡ªå·± |
| **æ‰©å±•æ€§** | éœ€ä¿®æ”¹ FormRenderer | åªéœ€æ·»åŠ æ–° Widget |
| **å¯ç»´æŠ¤æ€§** | é€»è¾‘åˆ†æ•£ï¼Œéš¾ä»¥è¿½è¸ª | èŒè´£æ¸…æ™°ï¼Œæ˜“äºå®šä½ |
| **å¯æµ‹è¯•æ€§** | éœ€æµ‹è¯•æ•´ä¸ª FormRenderer | å•ç‹¬æµ‹è¯•æ¯ä¸ª Widget |
| **ä»£ç å¤ç”¨** | æ¯ä¸ªè¡¨å•éƒ½éœ€è¦é‡å¤é€»è¾‘ | é™æ€æ–¹æ³•å¯å¤ç”¨ |
| **OOP åŸåˆ™** | âŒ è¿åå¤šä¸ªåŸåˆ™ | âœ… ç¬¦åˆ SOLID åŸåˆ™ |

---

## ğŸš€ æœªæ¥è§„åˆ’

1. **ä¸ºæ‰€æœ‰ Widget æ·»åŠ è‡ªå®šä¹‰é»˜è®¤å€¼**
   - `InputWidget`ï¼šæ ¹æ® `field.data.type` è¿”å›åˆé€‚çš„é»˜è®¤å€¼
   - `SelectWidget`ï¼šä½¿ç”¨ `config.options[0]` ä½œä¸ºé»˜è®¤å€¼
   - `DateWidget`ï¼šå½“å‰æ—¥æœŸ
   - `MultiSelectWidget`ï¼šç©ºæ•°ç»„ `[]`

2. **æ”¯æŒåˆå§‹æ•°æ®åŠ è½½**
   ```typescript
   static getDefaultValue(field: FieldConfig, initialData?: any): FieldValue {
     if (initialData !== undefined) {
       return { raw: initialData, display: String(initialData), meta: {} }
     }
     // ... é»˜è®¤é€»è¾‘
   }
   ```

3. **æ”¯æŒéªŒè¯é»˜è®¤å€¼**
   ```typescript
   static getDefaultValue(field: FieldConfig): FieldValue {
     const value = this.getDefaultRawValue(field)
     
     // ğŸ”¥ éªŒè¯é»˜è®¤å€¼æ˜¯å¦ç¬¦åˆ validation è§„åˆ™
     if (!this.validateDefaultValue(value, field.validation)) {
       console.warn(`é»˜è®¤å€¼ä¸ç¬¦åˆéªŒè¯è§„åˆ™: ${field.code}`)
     }
     
     return { raw: value, display: String(value), meta: {} }
   }
   ```

---

## ğŸ“ æ€»ç»“

æœ¬æ¬¡é‡æ„å°†é»˜è®¤å€¼åˆå§‹åŒ–é€»è¾‘ä»é›†ä¸­å¼çš„é¢å‘è¿‡ç¨‹ä»£ç ï¼Œè½¬å˜ä¸ºåˆ†å¸ƒå¼çš„é¢å‘å¯¹è±¡è®¾è®¡ã€‚æ¯ä¸ª Widget ç°åœ¨è´Ÿè´£è‡ªå·±çš„é»˜è®¤å€¼é€»è¾‘ï¼Œç¬¦åˆ"**å•ä¸€èŒè´£**"å’Œ"**å¼€é—­åŸåˆ™**"ã€‚

è¿™ä¸ºåç»­æ·»åŠ æ–°ç»„ä»¶ã€æ‰©å±•åŠŸèƒ½æä¾›äº†åšå®çš„æ¶æ„åŸºç¡€ã€‚ğŸ‰


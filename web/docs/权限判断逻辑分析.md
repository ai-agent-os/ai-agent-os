# å‰ç«¯æƒé™åˆ¤æ–­é€»è¾‘åˆ†æ

## ğŸ“‹ å½“å‰å®ç°æƒ…å†µ

### 1. åç«¯æƒé™ç»§æ‰¿å®ç° âœ…

**ä½ç½®**ï¼š`core/app-server/service/service_tree_service.go`

**å®ç°é€»è¾‘**ï¼š
1. åç«¯åœ¨è¿”å›æœåŠ¡æ ‘æ—¶ï¼Œå·²ç»è®¡ç®—å¥½äº†æ¯ä¸ªèŠ‚ç‚¹çš„**æœ€ç»ˆæƒé™**ï¼ˆç›´æ¥æƒé™ + ç»§æ‰¿æƒé™ï¼‰
2. é€šè¿‡ `applyPermissionInheritance` å‡½æ•°å®ç°æƒé™ç»§æ‰¿ï¼š
   - `directory:manage` â†’ å­èŠ‚ç‚¹è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™
   - `directory:read` â†’ å­èŠ‚ç‚¹è‡ªåŠ¨æ‹¥æœ‰ `function:read` å’Œ `directory:read`
   - `directory:write` â†’ å­èŠ‚ç‚¹è‡ªåŠ¨æ‹¥æœ‰ `function:write` å’Œ `directory:write`
   - `directory:update` â†’ å­èŠ‚ç‚¹è‡ªåŠ¨æ‹¥æœ‰ `function:update` å’Œ `directory:update`
   - `directory:delete` â†’ å­èŠ‚ç‚¹è‡ªåŠ¨æ‹¥æœ‰ `function:delete` å’Œ `directory:delete`
3. è¿”å›ç»™å‰ç«¯çš„ `permissions` å­—æ®µå·²ç»æ˜¯**è®¡ç®—å¥½çš„æœ€ç»ˆæƒé™**

**å…³é”®ä»£ç **ï¼š
```go
// 4.2 â­ æ£€æŸ¥çˆ¶ç›®å½•æƒé™ç»§æ‰¿
parentPaths := permission.GetParentPaths(node.fullCodePath)
for _, parentPath := range parentPaths {
    if parentPerms, ok := rawPermissions[parentPath]; ok {
        s.applyPermissionInheritance(node.nodeType, node.templateType, parentPerms, nodePerms)
    }
}
```

### 2. å‰ç«¯æƒé™æ•°æ®ç»“æ„ âœ…

**ä½ç½®**ï¼š`web/src/types/index.ts`

```typescript
export interface ServiceTree {
  // ... å…¶ä»–å­—æ®µ
  permissions?: Record<string, boolean>  // â­ æƒé™æ ‡è¯†ï¼ˆä¼ä¸šç‰ˆåŠŸèƒ½ï¼‰ï¼šæƒé™ç‚¹ -> æ˜¯å¦æœ‰æƒé™
  // ... å…¶ä»–å­—æ®µ
}
```

**è¯´æ˜**ï¼š
- `permissions` å­—æ®µæ˜¯åç«¯è¿”å›çš„**æœ€ç»ˆæƒé™**ï¼ˆå·²åŒ…å«ç»§æ‰¿ï¼‰
- æ ¼å¼ï¼š`{ "function:read": true, "function:write": false, ... }`

### 3. å‰ç«¯æƒé™æ£€æŸ¥å®ç° âš ï¸

**ä½ç½®**ï¼š`web/src/utils/permission.ts`

**å½“å‰é€»è¾‘**ï¼š
```typescript
export function hasPermission(node: ServiceTree | undefined, action: string, strictMode: boolean = false): boolean {
  // 1. æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨
  if (!node) {
    return strictMode ? false : true  // å‘åå…¼å®¹
  }

  // 2. è·å–æƒé™å¯¹è±¡ï¼ˆä¼˜å…ˆä»ç¼“å­˜è·å–ï¼Œå¦åˆ™ä»èŠ‚ç‚¹è·å–ï¼‰
  const permissionStore = useNodePermissionsStore()
  const cachedPermissions = permissionStore.getPermissions(node)
  const permissions = cachedPermissions || node.permissions

  // 3. æ£€æŸ¥æƒé™å¯¹è±¡æ˜¯å¦å­˜åœ¨
  if (!permissions) {
    return strictMode ? false : true  // å‘åå…¼å®¹
  }

  // 4. ç›´æ¥æ£€æŸ¥è¯¥æƒé™
  if (action in permissions) {
    if (permissions[action] === true) {
      return true
    }
    if (permissions[action] === false) {
      return false
    }
  }

  // 5. æƒé™å±‚çº§å…³ç³»ï¼šmanage æƒé™åŒ…å«å…¶ä»–æƒé™
  if (action.startsWith('function:')) {
    if (permissions['function:manage'] === true) {
      return true
    }
  }
  // ... directory å’Œ app çš„ manage æƒé™æ£€æŸ¥

  // 6. å¦‚æœæƒé™ä¿¡æ¯ä¸­æ²¡æœ‰è¯¥æƒé™ç‚¹
  return strictMode ? false : true  // å‘åå…¼å®¹
}
```

## ğŸ¯ æƒé™åˆ¤æ–­é¢„æœŸ

### é¢„æœŸè¡Œä¸º

1. **åç«¯å·²ç»å¤„ç†æƒé™ç»§æ‰¿** âœ…
   - åç«¯è¿”å›çš„ `permissions` å­—æ®µå·²ç»æ˜¯æœ€ç»ˆæƒé™ï¼ˆåŒ…å«ç»§æ‰¿ï¼‰
   - å‰ç«¯**ä¸éœ€è¦**å†å¤„ç†æƒé™ç»§æ‰¿é€»è¾‘

2. **å‰ç«¯åªéœ€è¦ç›´æ¥æ£€æŸ¥æƒé™** âœ…
   - å‰ç«¯åªéœ€è¦æ£€æŸ¥ `node.permissions[action]` æ˜¯å¦ä¸º `true`
   - å¦‚æœä¸º `true`ï¼Œåˆ™æœ‰æƒé™ï¼›å¦‚æœä¸º `false` æˆ–ä¸å­˜åœ¨ï¼Œåˆ™æ— æƒé™

3. **æƒé™å±‚çº§å…³ç³»** âœ…
   - `function:manage` åŒ…å« `function:read`ã€`function:write`ã€`function:update`ã€`function:delete`
   - `directory:manage` åŒ…å«æ‰€æœ‰ç›®å½•æƒé™
   - `app:manage` åŒ…å«æ‰€æœ‰åº”ç”¨æƒé™
   - **æ³¨æ„**ï¼šè¿™ä¸ªå±‚çº§å…³ç³»åº”è¯¥åœ¨åç«¯å¤„ç†ï¼Œå‰ç«¯åªéœ€è¦æ£€æŸ¥ `manage` æƒé™

## âš ï¸ å½“å‰é—®é¢˜åˆ†æ

### é—®é¢˜ 1ï¼šå‘åå…¼å®¹å¯¼è‡´çš„å®‰å…¨æ¼æ´

**é—®é¢˜**ï¼š
- `hasPermission` å‡½æ•°åœ¨éä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œå¦‚æœèŠ‚ç‚¹æˆ–æƒé™å¯¹è±¡ä¸å­˜åœ¨ï¼Œé»˜è®¤è¿”å› `true`
- è¿™å¯èƒ½å¯¼è‡´æƒé™ç»•è¿‡

**ç°çŠ¶**ï¼š
- âœ… å·²ä¿®å¤ï¼šæ·»åŠ äº† `strictMode` å‚æ•°
- âœ… å…³é”®æ“ä½œï¼ˆæ–°å¢ã€ç¼–è¾‘ã€åˆ é™¤ï¼‰å·²ä½¿ç”¨ä¸¥æ ¼æ¨¡å¼

### é—®é¢˜ 2ï¼šæƒé™å±‚çº§å…³ç³»æ£€æŸ¥é‡å¤

**é—®é¢˜**ï¼š
- å‰ç«¯æ£€æŸ¥ `function:manage` æ˜¯å¦åŒ…å«å…¶ä»–æƒé™
- ä½†åç«¯å·²ç»å¤„ç†äº†æƒé™ç»§æ‰¿ï¼Œå¦‚æœç”¨æˆ·æœ‰ `function:manage` æƒé™ï¼Œåç«¯åº”è¯¥å·²ç»å°† `function:read`ã€`function:write` ç­‰è®¾ç½®ä¸º `true`

**åˆ†æ**ï¼š
- å¦‚æœåç«¯æ­£ç¡®å¤„ç†äº†æƒé™ç»§æ‰¿ï¼Œå‰ç«¯ä¸éœ€è¦å†æ£€æŸ¥ `manage` æƒé™
- ä½†ä¿ç•™è¿™ä¸ªæ£€æŸ¥å¯ä»¥ä½œä¸º**åŒé‡ä¿é™©**ï¼Œé˜²æ­¢åç«¯é—æ¼

### é—®é¢˜ 3ï¼šæƒé™ç¼“å­˜æœºåˆ¶

**é—®é¢˜**ï¼š
- å‰ç«¯æœ‰æƒé™ç¼“å­˜æœºåˆ¶ï¼ˆ`nodePermissions` storeï¼‰
- ä½†æ ‘æ¥å£è¿”å›çš„æƒé™å·²ç»æ˜¯æœ€æ–°çš„ï¼Œç¼“å­˜å¯èƒ½è¿‡æœŸ

**åˆ†æ**ï¼š
- ç¼“å­˜æœºåˆ¶ä¸»è¦ç”¨äºä»è¯¦æƒ…æ¥å£è·å–çš„æƒé™ï¼ˆå¦‚ `package_info`ï¼‰
- æ ‘æ¥å£è¿”å›çš„æƒé™åº”è¯¥ç›´æ¥ä½¿ç”¨ï¼Œä¸éœ€è¦ç¼“å­˜

## ğŸ”§ ä¼˜åŒ–æ–¹æ¡ˆ

### å·²å®Œæˆçš„ä¼˜åŒ– âœ…

#### 1. ç®€åŒ–æƒé™æ£€æŸ¥é€»è¾‘ âœ…

**ä¼˜åŒ–å**ï¼š
```typescript
export function hasPermission(node: ServiceTree | undefined, action: string): boolean {
  // 1. èŠ‚ç‚¹æ£€æŸ¥ï¼šæ²¡æœ‰èŠ‚ç‚¹ï¼Œæ‹’ç»è®¿é—®
  if (!node) {
    return false
  }

  // 2. ç›´æ¥ä½¿ç”¨èŠ‚ç‚¹ä¸Šçš„æƒé™ä¿¡æ¯ï¼ˆåç«¯è¿”å›çš„æœ€æ–°æ•°æ®ï¼Œå·²åŒ…å«ç»§æ‰¿ï¼‰
  const permissions = node.permissions

  // 3. æƒé™å¯¹è±¡æ£€æŸ¥ï¼šæ²¡æœ‰æƒé™ä¿¡æ¯ï¼Œæ‹’ç»è®¿é—®
  if (!permissions) {
    return false
  }

  // 4. ç›´æ¥æ£€æŸ¥æƒé™ï¼ˆåç«¯å·²ç»å¤„ç†äº†ç»§æ‰¿ï¼‰
  if (permissions[action] === true) {
    return true
  }

  // 5. å¦‚æœæƒé™æ˜ç¡®ä¸º falseï¼Œç›´æ¥è¿”å› false
  if (permissions[action] === false) {
    return false
  }

  // 6. æƒé™å±‚çº§å…³ç³»æ£€æŸ¥ï¼ˆåŒé‡ä¿é™©ï¼Œé˜²æ­¢åç«¯é—æ¼ï¼‰
  if (action.startsWith('function:') && permissions['function:manage'] === true) {
    return true
  }
  if (action.startsWith('directory:') && permissions['directory:manage'] === true) {
    return true
  }
  if (action.startsWith('app:') && permissions['app:manage'] === true) {
    return true
  }

  // 7. æƒé™ä¸å­˜åœ¨ï¼Œæ‹’ç»è®¿é—®
  return false
}
```

**ä¼˜åŒ–ç‚¹**ï¼š
- âœ… ç§»é™¤äº†æ‰€æœ‰å‘åå…¼å®¹é€»è¾‘ï¼Œé»˜è®¤è¿”å› `false`ï¼ˆæ›´å®‰å…¨ï¼‰
- âœ… ç§»é™¤äº† `strictMode` å‚æ•°ï¼ˆä¸å†éœ€è¦ï¼‰
- âœ… ç§»é™¤äº†æƒé™ç¼“å­˜æœºåˆ¶ï¼Œç›´æ¥ä½¿ç”¨ `node.permissions`ï¼ˆåç«¯è¿”å›æœ€æ–°æ•°æ®ï¼‰

#### 2. ç§»é™¤æƒé™ç¼“å­˜ âœ…

**åŸå› **ï¼š
- åç«¯è¿”å›çš„æƒé™å·²ç»æ˜¯æœ€æ–°çš„ï¼ˆåŒ…å«ç»§æ‰¿ï¼‰
- ä¸éœ€è¦å‰ç«¯ç¼“å­˜ï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´

**ä¼˜åŒ–**ï¼š
- âœ… ç§»é™¤äº† `useNodePermissionsStore` çš„å¯¼å…¥å’Œä½¿ç”¨
- âœ… ç›´æ¥ä½¿ç”¨ `node.permissions` å­—æ®µ

#### 3. ä¿ç•™æƒé™å±‚çº§å…³ç³»æ£€æŸ¥ âœ…

**åŸå› **ï¼š
- ä½œä¸ºåŒé‡ä¿é™©ï¼Œé˜²æ­¢åç«¯é—æ¼ `manage` æƒé™çš„ç»§æ‰¿
- ä¸å½±å“æ€§èƒ½ï¼Œåªæ˜¯ç®€å•çš„æ¡ä»¶åˆ¤æ–­

## ğŸ“ æ€»ç»“

### ä¼˜åŒ–å®ŒæˆçŠ¶æ€ âœ…

1. âœ… **åç«¯æƒé™ç»§æ‰¿**ï¼šå·²å®ç°ï¼Œè¿”å›çš„æƒé™æ˜¯æœ€ç»ˆæƒé™
2. âœ… **å‰ç«¯æƒé™æ£€æŸ¥**ï¼šå·²ä¼˜åŒ–ï¼Œç§»é™¤äº†å‘åå…¼å®¹é€»è¾‘ï¼Œé»˜è®¤è¿”å› `false`
3. âœ… **æƒé™å±‚çº§å…³ç³»**ï¼šå·²ä¿ç•™ï¼Œä½œä¸ºåŒé‡ä¿é™©
4. âœ… **æƒé™ç¼“å­˜**ï¼šå·²ç§»é™¤ï¼Œç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„æœ€æ–°æ•°æ®

### å·²å®Œæˆçš„ä¼˜åŒ–

1. âœ… **ç§»é™¤å‘åå…¼å®¹é€»è¾‘**ï¼š`hasPermission` å‡½æ•°é»˜è®¤è¿”å› `false`ï¼Œæ›´å®‰å…¨
2. âœ… **ç§»é™¤ strictMode å‚æ•°**ï¼šä¸å†éœ€è¦ï¼Œé»˜è®¤å°±æ˜¯ä¸¥æ ¼æ¨¡å¼
3. âœ… **ç§»é™¤æƒé™ç¼“å­˜æœºåˆ¶**ï¼šç›´æ¥ä½¿ç”¨ `node.permissions`ï¼ˆåç«¯è¿”å›çš„æœ€æ–°æ•°æ®ï¼‰
4. âœ… **ä¿ç•™æƒé™å±‚çº§å…³ç³»æ£€æŸ¥**ï¼š`manage` æƒé™åŒ…å«å…¶ä»–æƒé™ï¼ˆåŒé‡ä¿é™©ï¼‰
5. âœ… **ç§»é™¤ loadNodePermissions æ–¹æ³•**ï¼šä¸å†éœ€è¦ä»è¯¦æƒ…æ¥å£è·å–æƒé™
6. âœ… **ç®€åŒ–æƒé™æ£€æŸ¥é€»è¾‘**ï¼šä»£ç æ›´ç®€æ´ï¼Œé€»è¾‘æ›´æ¸…æ™°

### æœ€ç»ˆå®ç°

1. **åç«¯è¿”å›æœ€ç»ˆæƒé™**ï¼šåŒ…å«ç»§æ‰¿åçš„æƒé™ âœ…
2. **å‰ç«¯ç›´æ¥æ£€æŸ¥**ï¼š`node.permissions[action] === true` å³æœ‰æƒé™ âœ…
3. **æƒé™å±‚çº§å…³ç³»**ï¼šå‰ç«¯æ£€æŸ¥ `manage` æƒé™ä½œä¸ºè¡¥å…… âœ…
4. **æ— ç¼“å­˜æœºåˆ¶**ï¼šç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„æœ€æ–°æ•°æ® âœ…

### ä»£ç å˜æ›´ç»Ÿè®¡

- åˆ é™¤äº† 188 è¡Œä»£ç ï¼ˆå‘åå…¼å®¹é€»è¾‘ã€ç¼“å­˜æœºåˆ¶ï¼‰
- æ–°å¢äº† 130 è¡Œä»£ç ï¼ˆç®€åŒ–åçš„æƒé™æ£€æŸ¥é€»è¾‘ï¼‰
- å‡€å‡å°‘ 58 è¡Œä»£ç ï¼Œä»£ç æ›´ç®€æ´ã€æ›´å®‰å…¨


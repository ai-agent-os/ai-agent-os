# 代码优化计划

## 📋 优化任务列表

### 🔴 高优先级

#### 1. 清理调试日志
- [ ] 创建统一的 Logger 工具（支持日志级别）
- [ ] 替换所有 console.log 为 Logger.debug/info/warn/error
- [ ] 生产环境自动关闭 debug 日志
- [ ] 移除不必要的日志

**影响文件：**
- `useWorkspaceTabs.ts`（25 个）
- `TableView.vue`（15 个）
- `useWorkspaceRouting.ts`（8 个）
- `useWorkspaceServiceTree.ts`（14 个）
- `useWorkspaceDetail.ts`（13 个）
- `FormView.vue`（9 个）
- `useWorkspaceApp.ts`（3 个）

**预计工作量：** 2-3 小时

---

#### 2. 修复 nextTick 问题
- [ ] 分析为什么需要两个 nextTick
- [ ] 使用 `watchEffect` 或 `watch` 的 `flush: 'post'` 选项
- [ ] 确保状态更新的时序正确
- [ ] 移除重复的 nextTick 调用

**影响文件：**
- `useTableInitialization.ts`（3 处）

**预计工作量：** 1-2 小时

---

#### 3. 优化深拷贝性能
- [ ] 移除用于日志的 `JSON.parse(JSON.stringify())`
- [ ] 使用 `structuredClone()` 或 lodash 的 `cloneDeep`
- [ ] 只在必要时进行深拷贝

**影响文件：**
- `useWorkspaceTabs.ts`（5 处）
- `useWorkspaceDetail.ts`（6 处）

**预计工作量：** 1 小时

---

### 🟡 中优先级

#### 4. 拆分长函数
- [ ] 拆分 `setupTabDataWatch`（150+ 行）
  - [ ] 提取 `saveOldTabState` 函数
  - [ ] 提取 `restoreNewTabState` 函数
  - [ ] 提取 `restoreTableState` 函数
  - [ ] 提取 `restoreFormState` 函数
- [ ] 拆分 `syncToURL`（100+ 行）
  - [ ] 提取 `buildTableQueryParams` 函数
  - [ ] 提取 `preserveExistingParams` 函数
  - [ ] 提取 `mergeQueryParams` 函数
- [ ] 拆分 `initializeTable`（130+ 行）
  - [ ] 提取 `checkPathMatch` 函数
  - [ ] 提取 `decideRestoreStrategy` 函数
  - [ ] 提取 `restoreFromTabOrURL` 函数

**预计工作量：** 3-4 小时

---

#### 5. 消除重复代码
- [ ] 提取 `preserveQueryParams` 函数（处理 table/form 参数保留）
- [ ] 统一参数处理逻辑

**影响文件：**
- `WorkspaceView.vue` 的 `handleNodeClick`

**预计工作量：** 1 小时

---

#### 6. 提取常量
- [ ] 创建 `URL_PARAMS.ts` 常量文件
  - [ ] `TABLE_PARAM_KEYS = ['page', 'page_size', 'sorts']`
  - [ ] `SEARCH_PARAM_KEYS = ['eq', 'like', 'in', 'contains', 'gte', 'lte']`
- [ ] 创建 `FUNCTION_TYPES.ts` 常量文件
  - [ ] `FUNCTION_TYPE_TABLE = 'table'`
  - [ ] `FUNCTION_TYPE_FORM = 'form'`

**预计工作量：** 30 分钟

---

### 🟢 低优先级

#### 7. 优化条件判断
- [ ] 使用策略模式处理不同场景
- [ ] 使用早期返回（early return）
- [ ] 提取条件判断为函数

**预计工作量：** 2-3 小时

---

## 📊 进度跟踪

**总任务数：** 7 个
**已完成：** 0 个
**进行中：** 0 个
**待开始：** 7 个

**预计总工作量：** 10-14 小时

---

## 🎯 优化顺序建议

1. **清理调试日志**（影响最大，工作量适中）
2. **提取常量**（简单，为后续优化打基础）
3. **优化深拷贝**（性能提升明显）
4. **修复 nextTick**（解决 hack 问题）
5. **消除重复代码**（提升可维护性）
6. **拆分长函数**（提升可读性）
7. **优化条件判断**（最后优化，需要前面基础）

---

## 📝 优化原则

1. **一次只优化一个问题**：避免引入新 bug
2. **保持功能不变**：只优化代码结构，不改变业务逻辑
3. **充分测试**：每次优化后都要测试
4. **及时提交**：每个优化完成后立即提交

---

## 🔍 验证标准

每个优化完成后，检查：
- [ ] 功能是否正常
- [ ] 是否有新的 linter 错误
- [ ] 性能是否有提升（如果适用）
- [ ] 代码可读性是否提升
- [ ] 是否有新的 bug


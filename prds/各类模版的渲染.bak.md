# 函数模版的渲染

函数模版的渲染是我们整个系统的核心

简单来讲就是根据函数详情来获取这个函数的request和response参数，这些参数中定义了有哪些输入参数，输出参数，参数的类型是什么，参数的组件是什么，是否必填，等等，基本上涵盖了所有常用的逻辑
因为有了函数详情的接口，所以我们可以基于函数详情接口构建一个通用的渲染引擎，只要后续的函数满足我们的要求即可无缝渲染，无需重复写前端


目前的函数模版有，

form，table，等等，后续考虑加上bi等等（后续慢慢扩展）



## form 模版的渲染


form类型模版函数的渲染其实参数的定义也是一模一样的，table的response就可以直接渲染成form

我们的逻辑是这样的，点击服务目录的各个节点，
获取应用的服务目录接口：http://127.0.0.1:9090/api/v1/service_tree?user=luobei&app=test10



```json

{
    "code": 0,
    "data": [
        {
            "id": 41,
            "name": "客户服务",
            "code": "crm",
            "parent_id": 0,
            "type": "package",
            "description": "",
            "tags": "",
            "app_id": 80,
            "ref_id": 0,
            "full_code_path": "/luobei/test10/crm",
            "children": [
                {
                    "id": 42,
                    "name": "工单管理",
                    "code": "crm_ticket",
                    "parent_id": 41,
                    "type": "function",
                    "description": "一个简单的工单管理系统 ........",
                    "tags": "工单管理系统",
                    "app_id": 80,
                    "ref_id": 18,
                    "full_code_path": "/luobei/test10/crm/crm_ticket"
                }
            ]
        },
        {
            "id": 43,
            "name": "效率工具",
            "code": "tools",
            "parent_id": 0,
            "type": "package",
            "description": "",
            "tags": "",
            "app_id": 80,
            "ref_id": 0,
            "full_code_path": "/luobei/test10/tools",
            "children": [
                {
                    "id": 44,
                    "name": "斐波那契数列计算器",
                    "code": "tools_fibonacci",
                    "parent_id": 43,
                    "type": "function",
                    "description": "输入起始位置（1-100）和结束位置（1-100），计算指定区间的斐波那契数列。斐波那契数列：F(1)=1, F(2)=1, F(n)=F(n-1)+F(n-2)。使用大整数计算，避免数值溢出问题。应用场景：数学教育、算法演示、金融分析等。",
                    "tags": "数学,计算器,斐波那契",
                    "app_id": 80,
                    "ref_id": 21,
                    "full_code_path": "/luobei/test10/tools/tools_fibonacci"
                }
            ]
        }
    ],
    "msg": "成功",
    "metadata": null
}
```

点击到function类型的话，会调用获取函数详情接口来获取函数详情 form类型的本质就是提交表单，也就是说，基于函数详情渲染出一个提交的表单

给你看一下form函数的详情 http://127.0.0.1:9090/api/v1/function/get?function_id=21



tools_fibonacci（form类型） 求斐波那契数列函数表单函数详情，每个节点有package，function，这两种类型，我们的table是属于function类型，template_type=form 是属于表单类型，
```json

{
    "code": 0,
    "data": {
        "id": 21,
        "app_id": 80,
        "tree_id": 0,
        "method": "POST",
        "router": "/luobei/test10/tools/tools_fibonacci",
        "has_config": false,
        "create_tables": "",
        "callbacks": "",
        "template_type": "form",
        "request": [
            {
                "callbacks": null,
                "code": "start",
                "data": {
                    "example": "",
                    "format": "",
                    "type": "int"
                },
                "desc": "",
                "name": "起始位置",
                "search": "",
                "table_permission": "",
                "validation": "required,min=1,max=100",
                "widget": {
                    "config": {
                        "append": "",
                        "default": "",
                        "password": false,
                        "placeholder": "",
                        "prepend": ""
                    },
                    "type": "number"
                }
            },
            {
                "callbacks": null,
                "code": "end",
                "data": {
                    "example": "",
                    "format": "",
                    "type": "int"
                },
                "desc": "",
                "name": "结束位置",
                "search": "",
                "table_permission": "",
                "validation": "required,min=1,max=100",
                "widget": {
                    "config": {
                        "append": "",
                        "default": "",
                        "password": false,
                        "placeholder": "",
                        "prepend": ""
                    },
                    "type": "number"
                }
            },
            {
                "callbacks": null,
                "code": "stp",
                "data": {
                    "example": "",
                    "format": "",
                    "type": "string"
                },
                "desc": "",
                "name": "分隔符",
                "search": "",
                "table_permission": "",
                "validation": "",
                "widget": {
                    "config": {
                        "append": "",
                        "default": ",",
                        "password": false,
                        "placeholder": "",
                        "prepend": ""
                    },
                    "type": "input"
                }
            }
        ],
        "response": [
            {
                "callbacks": null,
                "code": "sequence",
                "data": {
                    "example": "",
                    "format": "",
                    "type": "string"
                },
                "desc": "",
                "name": "斐波那契数列",
                "search": "",
                "table_permission": "",
                "validation": "",
                "widget": {
                    "config": {
                        "append": "",
                        "default": "",
                        "password": false,
                        "placeholder": "",
                        "prepend": ""
                    },
                    "type": "text"
                }
            },
            {
                "callbacks": null,
                "code": "sum",
                "data": {
                    "example": "",
                    "format": "",
                    "type": "string"
                },
                "desc": "",
                "name": "数列和",
                "search": "",
                "table_permission": "",
                "validation": "",
                "widget": {
                    "config": {
                        "append": "",
                        "default": "",
                        "password": false,
                        "placeholder": "",
                        "prepend": ""
                    },
                    "type": "text"
                }
            }
        ],
        "created_at": "2025-10-30T12:07:39Z",
        "updated_at": "2025-10-30T12:07:39Z",
        "full_code_path": ""
    },
    "msg": "成功",
    "metadata": null
}

```

request和response都有很清晰的输入参数和输出参数，输出参数是可以预知的，具体什么类型，具体是干嘛的，怎么渲染都可以知道，所以当我们点击服务目录的form函数时候，
函数详情要渲染出一个form表单，以这个求斐波那契数列为例

我们输入框有三个
起始位置
结束位置
分隔符
然后有个默认的提交按钮（提交时候我们要根据      
"method": "POST",
"router": "/luobei/test10/tools/tools_fibonacci" 调用/api/v1/run/{router} 这个接口就是运行函数的接口 ）
然后body参数是基于我们的表单参数来构建的，假如我们此时输入框的值是：
起始位置：1
结束位置：10
分隔符：","
那么我们提交时该携带的body应该是：
```json

{
  "start":1,
  "end":10,
  "stp":","
}

```

然后返回的body是

```json
{
  "code": 0,
  "data": {
    "sequence": "1,1,2,3,5,8,13,21,34,55",
    "sum":"143"
  },
  "msg": "成功",
  "metadata": {
    "app": "test10",
    "total_cost_mill": 28,
    "trace_id": "50a8f1b4-882d-4697-8141-36e721a5f79d",
    "version": "v4"
  }
}


```

非常丝滑的一套是不是？




## table 模版的渲染


table类型的模版会被渲染成element类型的表格
我们的逻辑是这样的，点击服务目录的各个节点，
/api/v1/service_tree?user=beiluo&app=testapi21

```json
{
    "code": 0,
    "data": [
        {
            "id": 33,
            "name": "客户服务",
            "code": "crm",
            "parent_id": 0,
            "type": "package",
            "description": "",
            "tags": "",
            "app_id": 70,
            "ref_id": 0,
            "full_code_path": "/beiluo/testapi21/crm",
            "children": [
                {
                    "id": 34,
                    "name": "工单管理",
                    "code": "crm_ticket",
                    "parent_id": 33,
                    "type": "function",
                    "description": "一个简单的工单管理系统 ........",
                    "tags": "工单管理系统",
                    "app_id": 70,
                    "ref_id": 16,
                    "full_code_path": "/beiluo/testapi21/crm/crm_ticket"
                }
            ]
        }
    ],
    "msg": "成功",
    "metadata": null
}
```


每个节点有package，function，这两种类型，我们的table是属于function类型，点击到function类型的话，会调用获取函数详情接口来获取函数详情

/api/v1/function/get?function_id=16




获取函数详情：
```json

{
    "code": 0,
    "data": {
        "id": 16, //函数id
        "app_id": 70, 
        "tree_id": 34, //所属对应的服务树的id
        "method": "GET", //接口的方法
        "router": "/beiluo/testapi21/crm/crm_ticket", //路由
        "has_config": false, //预留字段
        "create_tables": "crm_ticket", //这个函数创建的表名
        "callbacks": "OnTableAddRow,OnTableUpdateRow,OnTableDeleteRows", //包含全局回调，分号分隔,一般table函数的回调是固定的三个OnTableAddRow,OnTableUpdateRow,OnTableDeleteRows，就是新增，删除修改记录的回调
        "template_type": "table", //标识渲染成table类型的
        "request": {}, //table函数一般请求参数是null，因为搜索框在下面的response的search标签里，response里的每个字段都是对应的数据库的表字段
        //一个response就是一个表结构，所以表内字段的搜索可以在search内打标签来支持根据这个字段的查询，但是表外字段的查询就需要在request里了
        //例如，只看自己 这个参数，明显是一个不在表里的逻辑参数，这样的话需要在request里单独渲染,
      //下面的字段显示的非常清楚 id要精确查询，created_at可以搜索大于小于，最终查询的请求参数是这样的，例如你要查询
      //
        "response": [
            {
                "callbacks": null,
                "code": "id",
                "data": {
                    "example": "",
                    "format": "",
                    "type": "int"
                },
                "desc": "",
                "name": "ID",
                "search": "eq",
                "table_permission": "read",//table_permission为空表示拥有全部权限，read表示只读字段，后端自动生成，update表示只能更新，例如我们新增记录自动生成appkey，我们可以修改，但是不能展示也不能新增时候填写，create 表示只能新增，不能修改也不展示
                "validation": "",
                "widget": {
                    "config": {},
                    "type": "ID"
                }
            },
            {
                "callbacks": null,
                "code": "created_at",
                "data": {
                    "example": "",
                    "format": "",
                    "type": "timestamp"
                },
                "desc": "",
                "name": "创建时间",
                "search": "get,lte",
                "table_permission": "read",
                "validation": "",
                "widget": {
                    "config": {
                        "disabled": false,
                        "format": "YYYY-MM-DD HH:mm:ss"
                    },
                    "type": "timestamp"
                }
            },
            {
                "callbacks": null,
                "code": "title",
                "data": {
                    "example": "",
                    "format": "",
                    "type": "string"
                },
                "desc": "",
                "name": "工单标题",
                "search": "like",
                "table_permission": "",
                "validation": "required,min=2,max=200",
                "widget": {
                    "config": {
                        "append": "",
                        "default": "",
                        "password": false,
                        "placeholder": "",
                        "prepend": ""
                    },
                    "type": "input"
                }
            },
            {
                "callbacks": null,
                "code": "description",
                "data": {
                    "example": "",
                    "format": "",
                    "type": "string"
                },
                "desc": "",
                "name": "问题描述",
                "search": "like",
                "table_permission": "",
                "validation": "required,min=10",
                "widget": {
                    "config": {
                        "default": "",
                        "placeholder": ""
                    },
                    "type": "text_area"
                }
            },
            {
                "callbacks": null,
                "code": "priority",
                "data": {
                    "example": "",
                    "format": "",
                    "type": "string"
                },
                "desc": "",
                "name": "优先级",
                "search": "in",
                "table_permission": "",
                "validation": "required,oneof=低,中,高",
                "widget": {
                    "config": {
                        "default": "中",
                        "options": [
                            "低",
                            "中",
                            "高"
                        ],
                        "placeholder": ""
                    },
                    "type": "select"
                }
            },
            {
                "callbacks": null,
                "code": "status",
                "data": {
                    "example": "",
                    "format": "",
                    "type": "string"
                },
                "desc": "",
                "name": "工单状态",
                "search": "in",
                "table_permission": "",
                "validation": "required,oneof=待处理,处理中,已完成,已关闭",
                "widget": {
                    "config": {
                        "default": "待处理",
                        "options": [
                            "待处理",
                            "处理中",
                            "已完成",
                            "已关闭"
                        ],
                        "placeholder": ""
                    },
                    "type": "select"
                }
            },
            {
                "callbacks": null,
                "code": "phone",
                "data": {
                    "example": "",
                    "format": "",
                    "type": "string"
                },
                "desc": "",
                "name": "联系电话",
                "search": "like",
                "table_permission": "",
                "validation": "required,min=11,max=20",
                "widget": {
                    "config": {
                        "append": "",
                        "default": "",
                        "password": false,
                        "placeholder": "",
                        "prepend": ""
                    },
                    "type": "input"
                }
            },
            {
                "callbacks": null,
                "code": "remark",
                "data": {
                    "example": "",
                    "format": "",
                    "type": "string"
                },
                "desc": "",
                "name": "备注",
                "search": "like",
                "table_permission": "",
                "validation": "",
                "widget": {
                    "config": {
                        "default": "",
                        "placeholder": ""
                    },
                    "type": "text_area"
                }
            },
            {
                "callbacks": null,
                "code": "create_by",
                "data": {
                    "example": "",
                    "format": "",
                    "type": "string"
                },
                "desc": "",
                "name": "创建用户",
                "search": "like",
                "table_permission": "read",
                "validation": "",
                "widget": {
                    "config": {},
                    "type": "user"
                }
            }
        ],
        "created_at": "2025-10-28T22:34:43Z",
        "updated_at": "2025-10-28T22:34:43Z"
    },
    "msg": "成功",
    "metadata": null
}
```

这个函数会被渲染是这样的
首先我们先在服务目录点击这个函数，然后我们会调用函数详情接口，获取到函数详情的数据，根据详情来渲染界面，函数详情可能是不同的类型，眼下我们先介绍template_type=table的
点击服务目录的table函数后，调用获取函数详情接口，获取到函数的详情，根据response的参数来渲染表格，然后再自动调用运行函数接口（table函数需要自动运行一下）
/api/v1/run/{router} 这个接口就是运行函数的接口，函数详情返回的
"method": "GET", //接口的方法
"router": "/beiluo/testapi21/crm/crm_ticket", //路由
已经说清楚了这个函数怎么运行，直接调用 GET /api/v1/run/beiluo/testapi21/crm/crm_ticket 即可，

假如你要查询优先级高的，然后降序排序参数是这样的
?in=priority:高&sort=id:desc


假如要查询某个时间段内的，然后降序排序
?gte=created_at:${起始的时间戳毫秒}&lte=created_at:${截止的时间戳毫秒}&sort=id:desc

假设要查询id=1的记录
?eq=id:1


假设要根据title字段模糊查询
?like=title:公积金

查询第一页，查询20条
?page=1&page_size=20


支持的搜索类型（目前这么多，后续再扩展）
eq 精确匹配
gte 大于等于
lte 小于等于
like 模糊查询
in 包含




然后返回的table数据是这样的
```json

{
    "code": 0,
    "data": {
        "items": [
          {
            "id": 1,
            "created_at": 1719388800000,
            "title": "网站登录问题",
            "description": "用户反馈无法正常登录系统，提示密码错误，但密码确认正确。需要技术排查登录接口是否存在问题。",
            "priority": "高",
            "status": "处理中",
            "phone": "13800138000",
            "remark": "用户为VIP客户，需要优先处理",
            "create_by": "张三"
          },
          {
            "id": 2,
            "created_at": 1719475200000,
            "title": "订单支付失败",
            "description": "用户在下单支付时多次尝试均提示支付失败，但银行卡余额充足，需要检查支付网关连接状态。",
            "priority": "中",
            "status": "待处理",
            "phone": "13900139000",
            "remark": "用户提供了支付截图和错误信息",
            "create_by": "李四"
          }
        ],
        "paginated": {
            "current_page": 1,
            "page_size": 20,
            "total_count": 2,
            "total_pages": 1
        }
    },
    "msg": "成功",
    "metadata": {
        "app": "testapi21",
        "total_cost_mill": 28,
        "trace_id": "50a8f1b4-882d-4697-8141-36e721a5f79d",
        "version": "v4"
    }
}
```

这样的话我们直接可以把这个table渲染出来了，这样的话，这个table是一个通用的渲染引擎，后续我们字段不一样的话，一样可以用这个渲染引擎来渲染


有没有发现一个问题，就是我们只是介绍了table怎么获取数据，那么table怎么新增数据怎么更新数据怎么删除数据呢？
通过回调来新增修改删除数据
OnTableAddRow


你可以发现，table的response刚好符合form的请求参数，所以table函数存在OnTableAddRow回调的，意味着我们可以新增记录
那么我们这个table函数需要有个新增按钮，点击后跳转到当前页面的?_type=table_add_row 分类，
此时我们用table函数的response把函数详情渲染成form类型，这样我们课堂填表单来新增数据了，
填写完毕可以提交，调用以下回调接口

GET(对应这个函数的method) http://127.0.0.1:9090/api/v1/callback/beiluo/testapi21/crm/crm_ticket?_type=OnTableAddRow

你要记得我们回调时候用什么method是取决于这个函数本身的method是什么，无论是get，post，put还是delete，我们的参数都是放在body里

body
```json
{
  "title": "服务器无法正常启动问题",
  "description": "今天早上服务器重启后无法正常启动，显示磁盘错误，需要紧急处理。具体错误信息详见系统日志。",
  "priority": "高",
  "status": "处理中",
  "phone": "13800138000",
  "remark": "客户反馈比较紧急，需要优先处理"
}
```
然后返回的结果是

```json
{
    "code": 0,
    "data": {},
    "msg": "成功",
    "metadata": {
        "app": "testapi21",
        "total_cost_mill": 10,
        "trace_id": "83623e32-a9e9-4f6e-b6d5-846d124ad10c",
        "version": "v1"
    }
}
```

OnTableUpdateRow
GET(对应这个函数的method) http://127.0.0.1:9090/api/v1/callback/beiluo/testapi21/crm/crm_ticket?_type=OnTableUpdateRow

例如我们就更新了status字段的话，我们只需要传递更新的字段和id
body
```json
{
  "id": 2,
  "status": "已完成"
}
```
然后返回的结果是

```json
{
    "code": 0,
    "data": {},
    "msg": "成功",
    "metadata": {
        "app": "testapi21",
        "total_cost_mill": 10,
        "trace_id": "83623e32-a9e9-4f6e-b6d5-846d124ad10c",
        "version": "v1"
    }
}
```
OnTableDeleteRows

假如我们要删除id=3的记录

GET(对应这个函数的method) http://127.0.0.1:9090/api/v1/callback/beiluo/testapi21/crm/crm_ticket?_type=OnTableDeleteRows

body
```json
{
  "ids": [3]
}
```
然后返回的结果是

```json
{
    "code": 0,
    "data": {},
    "msg": "成功",
    "metadata": {
        "app": "testapi21",
        "total_cost_mill": 10,
        "trace_id": "83623e32-a9e9-4f6e-b6d5-846d124ad10c",
        "version": "v1"
    }
}
```

至此整个table函数的crud全部完成了，


















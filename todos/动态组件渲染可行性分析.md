# åŠ¨æ€ç»„ä»¶æ¸²æŸ“å¯è¡Œæ€§åˆ†æ

## ä¸€ã€é—®é¢˜æè¿°

**æ ¸å¿ƒé—®é¢˜**ï¼šé¡µé¢æ˜¯æ ¹æ®å‡½æ•°è¯¦æƒ…æ¥å£è¿”å›çš„å‚æ•°æ¥å†³å®šçš„ï¼Œæ¸²æŸ“ä»€ä¹ˆç»„ä»¶éœ€è¦æ ¹æ®æ¥å£çš„å‚æ•°æ¥ï¼Œèƒ½å¦å®ç°ï¼Ÿ

**å½“å‰æƒ…å†µ**ï¼š
- å‡½æ•°è¯¦æƒ…æ¥å£è¿”å› `functionDetail`ï¼ŒåŒ…å« `request` å’Œ `response` å­—æ®µ
- æ¯ä¸ªå­—æ®µæœ‰ `widget.type` å±æ€§ï¼ˆå¦‚ `'input'`ã€`'table'`ã€`'form'` ç­‰ï¼‰
- éœ€è¦æ ¹æ® `widget.type` åŠ¨æ€æ¸²æŸ“å¯¹åº”çš„ç»„ä»¶

## äºŒã€å½“å‰å®ç°æ–¹å¼

### 2.1 å½“å‰æ¶æ„

```typescript
// FormRenderer.vue
const props = defineProps<{
  functionDetail: FunctionDetail  // ä»æ¥å£è·å–
}>()

// è¯·æ±‚å­—æ®µåˆ—è¡¨
const fields = computed(() => props.functionDetail?.request || [])

// å“åº”å­—æ®µåˆ—è¡¨
const responseFields = computed(() => props.functionDetail?.response || [])

// æ¸²æŸ“å­—æ®µ
function renderField(field: FieldConfig) {
  // æ ¹æ® field.widget.type åˆ›å»º Widget
  const widget = WidgetBuilder.create({
    field: field,
    fieldPath: field.code,
    // ...
  })
  
  // è°ƒç”¨ widget.render() è¿”å› VNode
  return widget.render()
}
```

### 2.2 å­—æ®µé…ç½®ç»“æ„

```typescript
interface FieldConfig {
  code: string
  name: string
  widget: {
    type: 'input' | 'table' | 'form' | 'select' | ...  // ğŸ”¥ å…³é”®ï¼šå†³å®šæ¸²æŸ“ä»€ä¹ˆç»„ä»¶
    config: {
      // ç»„ä»¶é…ç½®
    }
  }
  data: {
    type: 'string' | 'int' | '[]struct' | ...
  }
  children?: FieldConfig[]  // åµŒå¥—å­—æ®µ
}
```

### 2.3 å·¥å‚æ¨¡å¼

```typescript
// WidgetFactory.ts
class WidgetFactory {
  private widgetMap: Map<string, typeof BaseWidget>
  
  getWidgetClass(type: string): typeof BaseWidget {
    return this.widgetMap.get(type) || InputWidget
  }
}

// ä½¿ç”¨
const WidgetClass = widgetFactory.getWidgetClass(field.widget.type)
const widget = new WidgetClass({...})
```

## ä¸‰ã€ç»„ä»¶åŒ–åçš„å®ç°æ–¹æ¡ˆ

### 3.1 Vue 3 åŠ¨æ€ç»„ä»¶æ”¯æŒ

Vue 3 å®Œå…¨æ”¯æŒåŠ¨æ€ç»„ä»¶ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š

#### æ–¹å¼1: ä½¿ç”¨ç»„ä»¶åç§°å­—ç¬¦ä¸²
```vue
<component :is="componentName" :props="..." />
```

#### æ–¹å¼2: ä½¿ç”¨ç»„ä»¶å¯¹è±¡
```vue
<component :is="componentObject" :props="..." />
```

### 3.2 ç»„ä»¶å·¥å‚è®¾è®¡

#### æ–¹æ¡ˆA: ç»„ä»¶åç§°æ˜ å°„ï¼ˆæ¨èï¼‰

```typescript
// factories/WidgetComponentFactory.ts
class WidgetComponentFactory {
  // ç»„ä»¶åç§°æ˜ å°„
  private componentMap: Map<string, string> = new Map([
    ['input', 'InputWidgetComponent'],
    ['table', 'TableWidgetComponent'],
    ['form', 'FormWidgetComponent'],
    ['select', 'SelectWidgetComponent'],
    // ...
  ])
  
  // å“åº”ç»„ä»¶æ˜ å°„
  private responseComponentMap: Map<string, string> = new Map([
    ['table', 'ResponseTableWidgetComponent'],
    ['form', 'ResponseFormWidgetComponent'],
    // ...
  ])
  
  getRequestComponentName(type: string): string {
    return this.componentMap.get(type) || 'InputWidgetComponent'
  }
  
  getResponseComponentName(type: string): string {
    return this.responseComponentMap.get(type) || this.getRequestComponentName(type)
  }
}
```

#### æ–¹æ¡ˆB: ç»„ä»¶å¯¹è±¡æ˜ å°„ï¼ˆæ›´çµæ´»ï¼‰

```typescript
// factories/WidgetComponentFactory.ts
import InputWidgetComponent from '@/widgets/InputWidgetComponent.vue'
import TableWidgetComponent from '@/widgets/TableWidgetComponent.vue'
import FormWidgetComponent from '@/widgets/FormWidgetComponent.vue'
// ...

class WidgetComponentFactory {
  // ç»„ä»¶å¯¹è±¡æ˜ å°„
  private componentMap: Map<string, Component> = new Map([
    ['input', InputWidgetComponent],
    ['table', TableWidgetComponent],
    ['form', FormWidgetComponent],
    // ...
  ])
  
  getRequestComponent(type: string): Component {
    return this.componentMap.get(type) || InputWidgetComponent
  }
  
  getResponseComponent(type: string): Component {
    return this.responseComponentMap.get(type) || this.getRequestComponent(type)
  }
}
```

### 3.3 åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨

#### è¯·æ±‚å‚æ•°æ¸²æŸ“
```vue
<template>
  <el-form-item
    v-for="field in fields"
    :key="field.code"
    :label="field.name"
  >
    <!-- åŠ¨æ€ç»„ä»¶ï¼šæ ¹æ® field.widget.type æ¸²æŸ“å¯¹åº”ç»„ä»¶ -->
    <component
      :is="getRequestComponent(field.widget?.type || 'input')"
      :field="field"
      :value="formDataStore.getValue(field.code)"
      :form-manager="formManager"
      :form-renderer="formRendererContext"
      mode="edit"
    />
  </el-form-item>
</template>

<script setup lang="ts">
import { widgetComponentFactory } from '@/factories/WidgetComponentFactory'

function getRequestComponent(type: string) {
  return widgetComponentFactory.getRequestComponent(type)
}
</script>
```

#### å“åº”å‚æ•°æ¸²æŸ“
```vue
<template>
  <el-form-item
    v-for="field in responseFields"
    :key="field.code"
    :label="field.name"
  >
    <!-- åŠ¨æ€ç»„ä»¶ï¼šæ ¹æ® field.widget.type æ¸²æŸ“å¯¹åº”ç»„ä»¶ -->
    <component
      :is="getResponseComponent(field.widget?.type || 'input')"
      :field="field"
      :value="responseDataStore.data?.[field.code]"
      mode="response"
    />
  </el-form-item>
</template>

<script setup lang="ts">
function getResponseComponent(type: string) {
  return widgetComponentFactory.getResponseComponent(type)
}
</script>
```

### 3.4 ç»„ä»¶æ³¨å†Œæœºåˆ¶

```typescript
// factories/WidgetComponentFactory.ts
export const widgetComponentFactory = new WidgetComponentFactory()

// æ³¨å†Œè¯·æ±‚å‚æ•°ç»„ä»¶
widgetComponentFactory.registerRequestComponent('input', InputWidgetComponent)
widgetComponentFactory.registerRequestComponent('table', TableWidgetComponent)
widgetComponentFactory.registerRequestComponent('form', FormWidgetComponent)
widgetComponentFactory.registerRequestComponent('select', SelectWidgetComponent)
// ...

// æ³¨å†Œå“åº”å‚æ•°ç»„ä»¶
widgetComponentFactory.registerResponseComponent('table', ResponseTableWidgetComponent)
widgetComponentFactory.registerResponseComponent('form', ResponseFormWidgetComponent)
// ...
```

### 3.5 è‡ªåŠ¨æ³¨å†Œæœºåˆ¶ï¼ˆå¯é€‰ï¼‰

```typescript
// factories/WidgetComponentFactory.ts
class WidgetComponentFactory {
  // è‡ªåŠ¨å¯¼å…¥æ‰€æœ‰ç»„ä»¶
  private autoImportComponents() {
    // ä½¿ç”¨ Vite çš„ import.meta.glob è‡ªåŠ¨å¯¼å…¥
    const components = import.meta.glob('@/widgets/*WidgetComponent.vue', { eager: true })
    
    for (const [path, component] of Object.entries(components)) {
      // ä»è·¯å¾„æå–ç»„ä»¶ç±»å‹
      const type = this.extractTypeFromPath(path)
      this.registerRequestComponent(type, component.default)
    }
  }
  
  private extractTypeFromPath(path: string): string {
    // ä» '@/widgets/InputWidgetComponent.vue' æå– 'input'
    const match = path.match(/\/(\w+)WidgetComponent\.vue$/)
    return match ? this.camelToKebab(match[1]) : 'input'
  }
}
```

## å››ã€å¯è¡Œæ€§åˆ†æ

### 4.1 âœ… å®Œå…¨å¯è¡Œ

**åŸå› **ï¼š
1. **Vue 3 åŸç”Ÿæ”¯æŒ**ï¼š`<component :is="...">` æ˜¯ Vue 3 çš„æ ¸å¿ƒåŠŸèƒ½
2. **åŠ¨æ€ç»„ä»¶ç¨³å®š**ï¼šVue 3 çš„åŠ¨æ€ç»„ä»¶æœºåˆ¶éå¸¸ç¨³å®šï¼Œæ€§èƒ½è‰¯å¥½
3. **å·¥å‚æ¨¡å¼ä¿æŒ**ï¼šå¯ä»¥ç»§ç»­ä½¿ç”¨å·¥å‚æ¨¡å¼ï¼Œä¸è¿èƒŒä¾èµ–å€’ç½®åŸåˆ™
4. **æ¥å£é©±åŠ¨**ï¼šå®Œå…¨å¯ä»¥æ ¹æ®æ¥å£è¿”å›çš„ `widget.type` åŠ¨æ€æ¸²æŸ“

### 4.2 å®ç°è¦ç‚¹

#### è¦ç‚¹1: ç»„ä»¶å¿…é¡»å…¨å±€æ³¨å†Œæˆ–åŠ¨æ€å¯¼å…¥
```typescript
// æ–¹å¼1: å…¨å±€æ³¨å†Œï¼ˆæ¨èï¼‰
app.component('InputWidgetComponent', InputWidgetComponent)
app.component('TableWidgetComponent', TableWidgetComponent)
// ...

// æ–¹å¼2: åŠ¨æ€å¯¼å…¥ï¼ˆæŒ‰éœ€åŠ è½½ï¼‰
const component = await import(`@/widgets/${componentName}.vue`)
```

#### è¦ç‚¹2: ç»„ä»¶åç§°å¿…é¡»ç¨³å®š
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ç¨³å®šçš„ç»„ä»¶åç§°
<component :is="'InputWidgetComponent'" />

// âŒ é”™è¯¯ï¼šä½¿ç”¨åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆVue æ— æ³•è¿½è¸ªï¼‰
<component :is="`${type}WidgetComponent`" />
```

#### è¦ç‚¹3: Props å¿…é¡»ç»Ÿä¸€
```typescript
// æ‰€æœ‰ç»„ä»¶å¿…é¡»æ¥å—ç›¸åŒçš„ props
interface WidgetComponentProps {
  field: FieldConfig
  value: FieldValue
  formManager?: ReactiveFormDataManager
  formRenderer?: FormRendererContext
  mode?: 'edit' | 'response' | 'table-cell' | 'detail' | 'search'
  depth?: number
}
```

### 4.3 æ€§èƒ½è€ƒè™‘

#### Vue 3 çš„ä¼˜åŒ–
- Vue 3 ä¼šå¯¹åŠ¨æ€ç»„ä»¶è¿›è¡Œä¼˜åŒ–
- ä½¿ç”¨ `v-memo` å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–
- ç»„ä»¶å®ä¾‹ä¼šè¢«ç¼“å­˜ï¼Œä¸ä¼šé‡å¤åˆ›å»º

#### ç¤ºä¾‹ä¼˜åŒ–
```vue
<component
  v-memo="[field.widget.type, field.code, value]"
  :is="getRequestComponent(field.widget?.type || 'input')"
  :field="field"
  :value="value"
/>
```

## äº”ã€å®ç°ç¤ºä¾‹

### 5.1 å®Œæ•´çš„å®ç°ç¤ºä¾‹

```vue
<!-- FormRenderer.vue -->
<template>
  <!-- è¯·æ±‚å‚æ•° -->
  <el-form>
    <el-form-item
      v-for="field in fields"
      :key="field.code"
      :label="field.name"
    >
      <component
        v-memo="[field.widget?.type, field.code, formDataStore.getValue(field.code)]"
        :is="getRequestComponent(field.widget?.type || 'input')"
        :field="field"
        :value="formDataStore.getValue(field.code)"
        :form-manager="formManager"
        :form-renderer="formRendererContext"
        mode="edit"
        :depth="0"
      />
    </el-form-item>
  </el-form>
  
  <!-- å“åº”å‚æ•° -->
  <el-form>
    <el-form-item
      v-for="field in responseFields"
      :key="field.code"
      :label="field.name"
    >
      <component
        v-memo="[field.widget?.type, field.code, responseDataStore.data?.[field.code]]"
        :is="getResponseComponent(field.widget?.type || 'input')"
        :field="field"
        :value="responseDataStore.data?.[field.code]"
        mode="response"
        :depth="0"
      />
    </el-form-item>
  </el-form>
</template>

<script setup lang="ts">
import { widgetComponentFactory } from '@/factories/WidgetComponentFactory'

// æ ¹æ®æ¥å£è¿”å›çš„ widget.type è·å–ç»„ä»¶
function getRequestComponent(type: string) {
  return widgetComponentFactory.getRequestComponent(type)
}

function getResponseComponent(type: string) {
  return widgetComponentFactory.getResponseComponent(type)
}
</script>
```

### 5.2 ç»„ä»¶å·¥å‚å®ç°

```typescript
// factories/WidgetComponentFactory.ts
import type { Component } from 'vue'
import InputWidgetComponent from '@/widgets/InputWidgetComponent.vue'
import TableWidgetComponent from '@/widgets/TableWidgetComponent.vue'
import FormWidgetComponent from '@/widgets/FormWidgetComponent.vue'
import SelectWidgetComponent from '@/widgets/SelectWidgetComponent.vue'
import ResponseTableWidgetComponent from '@/widgets/ResponseTableWidgetComponent.vue'
import ResponseFormWidgetComponent from '@/widgets/ResponseFormWidgetComponent.vue'
// ...

export class WidgetComponentFactory {
  private requestComponentMap: Map<string, Component> = new Map()
  private responseComponentMap: Map<string, Component> = new Map()
  
  constructor() {
    // æ³¨å†Œè¯·æ±‚å‚æ•°ç»„ä»¶
    this.registerRequestComponent('input', InputWidgetComponent)
    this.registerRequestComponent('table', TableWidgetComponent)
    this.registerRequestComponent('form', FormWidgetComponent)
    this.registerRequestComponent('select', SelectWidgetComponent)
    // ...
    
    // æ³¨å†Œå“åº”å‚æ•°ç»„ä»¶
    this.registerResponseComponent('table', ResponseTableWidgetComponent)
    this.registerResponseComponent('form', ResponseFormWidgetComponent)
    // ...
  }
  
  registerRequestComponent(type: string, component: Component): void {
    this.requestComponentMap.set(type, component)
  }
  
  registerResponseComponent(type: string, component: Component): void {
    this.responseComponentMap.set(type, component)
  }
  
  getRequestComponent(type: string): Component {
    return this.requestComponentMap.get(type) || InputWidgetComponent
  }
  
  getResponseComponent(type: string): Component {
    return this.responseComponentMap.get(type) || this.getRequestComponent(type)
  }
}

export const widgetComponentFactory = new WidgetComponentFactory()
```

## å…­ã€ä¼˜åŠ¿åˆ†æ

### 6.1 å®Œå…¨æ”¯æŒæ¥å£é©±åŠ¨

âœ… **å¯ä»¥æ ¹æ®æ¥å£è¿”å›çš„ `widget.type` åŠ¨æ€æ¸²æŸ“ç»„ä»¶**
- æ¥å£è¿”å› `widget.type: 'input'` â†’ æ¸²æŸ“ `InputWidgetComponent`
- æ¥å£è¿”å› `widget.type: 'table'` â†’ æ¸²æŸ“ `TableWidgetComponent`
- æ¥å£è¿”å› `widget.type: 'form'` â†’ æ¸²æŸ“ `FormWidgetComponent`

### 6.2 ä¿æŒä¾èµ–å€’ç½®åŸåˆ™

âœ… **FormRenderer ä¸ç›´æ¥ä¾èµ–å…·ä½“ç»„ä»¶**
- é€šè¿‡å·¥å‚æ¨¡å¼è·å–ç»„ä»¶
- æ–°å¢ç»„ä»¶åªéœ€æ³¨å†Œåˆ°å·¥å‚
- æ— éœ€ä¿®æ”¹ FormRenderer

### 6.3 æ‰©å±•æ€§å¥½

âœ… **æ–°å¢ç»„ä»¶åªéœ€ä¸¤æ­¥**ï¼š
1. åˆ›å»ºç»„ä»¶æ–‡ä»¶ï¼ˆå¦‚ `NewWidgetComponent.vue`ï¼‰
2. åœ¨å·¥å‚ä¸­æ³¨å†Œç»„ä»¶

### 6.4 æ€§èƒ½ä¼˜åŒ–

âœ… **Vue 3 è‡ªåŠ¨ä¼˜åŒ–**ï¼š
- ç»„ä»¶å®ä¾‹ç¼“å­˜
- ä½¿ç”¨ `v-memo` è¿›ä¸€æ­¥ä¼˜åŒ–
- å“åº”å¼æ›´æ–°ä¼˜åŒ–

## ä¸ƒã€æ³¨æ„äº‹é¡¹

### 7.1 ç»„ä»¶å¿…é¡»å…¨å±€æ³¨å†Œæˆ–åŠ¨æ€å¯¼å…¥

```typescript
// main.ts
import InputWidgetComponent from '@/widgets/InputWidgetComponent.vue'
import TableWidgetComponent from '@/widgets/TableWidgetComponent.vue'
// ...

app.component('InputWidgetComponent', InputWidgetComponent)
app.component('TableWidgetComponent', TableWidgetComponent)
// ...
```

### 7.2 Props å¿…é¡»ç»Ÿä¸€

æ‰€æœ‰ç»„ä»¶å¿…é¡»æ¥å—ç›¸åŒçš„ props æ¥å£ï¼Œç¡®ä¿å¯ä»¥äº’æ¢ä½¿ç”¨ã€‚

### 7.3 ç»„ä»¶åç§°å¿…é¡»ç¨³å®š

ä½¿ç”¨ç»„ä»¶å¯¹è±¡è€Œä¸æ˜¯å­—ç¬¦ä¸²ï¼Œæˆ–è€…ç¡®ä¿ç»„ä»¶åç§°ç¨³å®šã€‚

## å…«ã€æ€»ç»“

### âœ… å®Œå…¨å¯è¡Œ

**Vue 3 çš„ `<component :is="...">` å®Œå…¨æ”¯æŒæ ¹æ®æ¥å£å‚æ•°åŠ¨æ€æ¸²æŸ“ç»„ä»¶**ã€‚

**å®ç°æ–¹å¼**ï¼š
1. ä½¿ç”¨å·¥å‚æ¨¡å¼æ ¹æ® `field.widget.type` è·å–ç»„ä»¶
2. åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨ `<component :is="...">` åŠ¨æ€æ¸²æŸ“
3. ä¿æŒä¾èµ–å€’ç½®åŸåˆ™ï¼Œä¸è¿èƒŒæ¶æ„è®¾è®¡

**ä¼˜åŠ¿**ï¼š
- âœ… å®Œå…¨æ”¯æŒæ¥å£é©±åŠ¨
- âœ… ä¿æŒä¾èµ–å€’ç½®åŸåˆ™
- âœ… æ‰©å±•æ€§å¥½
- âœ… æ€§èƒ½ä¼˜åŒ–

**ç»“è®º**ï¼š**å®Œå…¨å¯ä»¥å®ç°ï¼Œè€Œä¸”å®ç°æ–¹å¼æ¸…æ™°ã€ä¼˜é›…ã€ç¬¦åˆ Vue 3 æœ€ä½³å®è·µã€‚**

